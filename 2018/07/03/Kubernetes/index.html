<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.supercalifragilisticexpialidociouser.com').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="简介Kubernetes是一个容器编排引擎，它是Google Omega（之前叫Borg）的开源版本。">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes">
<meta property="og:url" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/index.html">
<meta property="og:site_name" content="人见人爱，花见花开，车见爆胎">
<meta property="og:description" content="简介Kubernetes是一个容器编排引擎，它是Google Omega（之前叫Borg）的开源版本。">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/deployment.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/scaling1.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/scaling2.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/rollingupdates1.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/rollingupdates2.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/rollingupdates3.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/rollingupdates4.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/arch.png">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/Kubernetes-cluster.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/nodes.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/pods.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/services.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/labels.svg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/Helm%E6%9E%B6%E6%9E%84.jpg">
<meta property="article:published_time" content="2018-07-03T00:21:46.000Z">
<meta property="article:modified_time" content="2020-05-09T15:25:49.999Z">
<meta property="article:author" content="周千涵">
<meta property="article:tag" content="1.11">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/Kubernetes/deployment.svg">

<link rel="canonical" href="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Kubernetes | 人见人爱，花见花开，车见爆胎</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">人见人爱，花见花开，车见爆胎</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一个程序猿的笔记</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-07-03 08:21:46" itemprop="dateCreated datePublished" datetime="2018-07-03T08:21:46+08:00">2018-07-03</time>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Kubernetes是一个容器编排引擎，它是Google Omega（之前叫Borg）的开源版本。</p>
<a id="more"></a>

<h1 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h1><p><a href="https://kubernetes.io" target="_blank" rel="noopener">Kubernetes.io</a> 上有一个基于Minikube的 <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/" target="_blank" rel="noopener">在线交互式教程</a> ，可以快速体验Kubernetes的功能和应用场景。</p>
<h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ minikube start</span><br></pre></td></tr></table></figure>

<p>查看集群信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl cluster-info</span><br></pre></td></tr></table></figure>

<p>查看集群中节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：当前执行命令的地方并不是集群中的节点，我们是通过Kubernetes的命令行工具kubectl远程管理集群（Kubectl使用Kubernetes API与集群进行交互）。可以使用命令<code>hostname</code>查看当前执行命令的主机。</p>
<p>kubectl命令的通用格式是：<code>kubectl action resource</code>。它对指定的资源（如node，container）执行指定的操作（如create，describe）。 </p>
<p>可在kubctl后带上<code>--help</code>选项，以获取相应帮助。例如，<code>kubectl get nodes --help</code>。</p>
</blockquote>
<p>要查看Kubernetes集群上部署的所有资源可用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all --all-namespaces</span><br></pre></td></tr></table></figure>

<h2 id="部署应用"><a href="#部署应用" class="headerlink" title="部署应用"></a>部署应用</h2><p>一旦运行了Kubernetes集群，就可以在其上部署容器化应用程序。为此，您需要创建Kubernetes Deployment配置。</p>
<p> Deployment指示Kubernetes如何创建和更新应用程序的实例。创建Deployment后，Kubernetes主调度将应用程序实例提到集群中的各个节点上。 </p>
<p>创建应用程序实例后，Kubernetes Deployment Controller会持续监视这些实例。如果托管实例的节点关闭或被删除，则Deployment控制器会替换它。 这提供了一种自我修复机制来解决机器故障或维护问题。 </p>
<p><img src="Kubernetes/deployment.svg" alt="deployment"></p>
<p>部署一个名为<code>kubernetes-bootcamp</code>的应用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1 --port:8080</span><br></pre></td></tr></table></figure>

<p><code>--image</code>指定应用的容器镜像。</p>
<p><code>--port</code>指定应用提供服务的端口。</p>
<p>这条命令执行了如下操作：</p>
<ul>
<li>搜索可以运行应用程序实例的合适节点（这里只有1个可用节点）。</li>
<li>安排应用程序在该节点上运行。</li>
<li>配置集群以在需要时重新安排实例到新节点上。</li>
</ul>
<p>查看集群上的Deployments：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployments</span><br></pre></td></tr></table></figure>

<h2 id="访问应用"><a href="#访问应用" class="headerlink" title="访问应用"></a>访问应用</h2><p>部署到Kubernetes集群的应用，将运行在一个私有、隔离的网络上。它们只能在集群内部可见，要从集群外部访问这些应用，需要将容器的端口映射到节点的端口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose deployment/kubernetes-bootcamp --<span class="built_in">type</span>=<span class="string">"NodePort"</span> --port 8080</span><br></pre></td></tr></table></figure>

<p>上面的命令创建了一个service，将容器的8080端口映射到<code>minikube</code>节点的随机分配端口（例如，30670）。</p>
<p>可以通过下面命令查看集群中的services：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get services</span><br></pre></td></tr></table></figure>

<p>要访问这个服务，只要：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl minikube:30670</span><br></pre></td></tr></table></figure>

<p>可以通过下列命令来获取NodePort：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template=<span class="string">'&#123;&#123;(index .spec.ports 0).nodePort&#125;&#125;'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="扩展应用"><a href="#扩展应用" class="headerlink" title="扩展应用"></a>扩展应用</h2><p>默认情况下，部署的应用只会运行一个副本，可以通过<code>kubectl get deployments</code>来查看副本数。</p>
<p>执行下列命令将副本数增加到4个：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale deployments/kubernetes-bootcamp --replicas=4</span><br></pre></td></tr></table></figure>

<p>扩展前：</p>
<p><img src="Kubernetes/scaling1.svg" alt="scaling1"></p>
<p>扩展后：</p>
<p><img src="Kubernetes/scaling2.svg" alt="scaling2"></p>
<blockquote>
<p>注意：每个Pod的集群IP都不一样。</p>
</blockquote>
<p>Kubernetes还支持Pod的自动缩放。缩放到零也是可能的，它将终止指定部署的所有Pod。 </p>
<p>通过<code>curl minikube:30670</code>访问应用，可以看到每次请求发送到不同的pod。4个副本（pod）轮询处理，这样就实现了负载均衡。</p>
<p>服务集成有负载平衡器，可将网络流量分配到公开部署的所有Pod副本。服务将使用端点连续监视正在运行的Pod，以确保流量仅发送到可用的Pod。 </p>
<p>要缩减服务的副本数到2，只需再次运行scale命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale deployments/kubernetes-bootcamp --replicas=2</span><br></pre></td></tr></table></figure>

<p>可以看到有两个副本被删除。</p>
<h2 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h2><p>滚动更新允许通过使用新的Pods实例逐步更新旧的Pods实例来实现部署的更新，而无需停机。新的Pod将在具有可用资源的节点上进行调度。 </p>
<p>滚动更新之前：</p>
<p><img src="Kubernetes/rollingupdates1.svg" alt="rollingupdates1"></p>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p>使用下列命令将应用的镜像版本从<code>v1</code>升级到<code>v2</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">set</span> image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2</span><br></pre></td></tr></table></figure>

<p>如果使用YAML定义文件，则只需要修改YAML文件，然后再次运行下列命令，就会触发滚动更新：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f kubernetes-bootcamp.yaml --record</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>--record</code>的作用是将当前命令记录到revision记录中，这样我们就可以知道每个revision对应的是哪个定义文件。</p>
<p>通过<code>kubectl rollout history deployments/kubernetes-bootcamp</code>可以查看revision历史记录。</p>
</blockquote>
<p>在更新期间，服务只会将网络流量负载均衡到可用的Pod上。 </p>
<p><img src="Kubernetes/rollingupdates2.svg" alt="rollingupdates2"></p>
<p><img src="Kubernetes/rollingupdates3.svg" alt="rollingupdates3"></p>
<p><img src="Kubernetes/rollingupdates4.svg" alt="rollingupdates4"></p>
<p>可以通过<code>maxSurge</code>和<code>maxUnavailable</code>字段来控制副本替换的数量：</p>
<ul>
<li><code>maxSurge</code>：控制滚动更新过程中副本总数超过DESIRED的上限。<code>maxSurge</code>可以取整数值，也可以是百分数（<strong>向上</strong>取整），默认值为<code>25%</code>。</li>
<li><code>maxUnavailable</code>：控制滚动更新过程中，不可用的副本的上限。<code>maxUnavailable</code>可以取整数值，也可以是百分数（<strong>向下</strong>取整），默认值为<code>25%</code>。</li>
</ul>
<p><code>maxSurge</code>影响新副本创建的速度，<code>maxUnavailable</code>影响旧副本销毁的速度。</p>
<p>例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">strategy:</span></span><br><span class="line">		<span class="attr">rollingUpdate:</span></span><br><span class="line">			<span class="attr">maxSurge:</span> <span class="number">35</span><span class="string">%</span></span><br><span class="line">			<span class="attr">maxUnavailable:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<h3 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h3><p>每次更新应用时，Kubernetes都会记录下当前的配置，保存为一个revision（修订版），这样就可以回滚到某个revision。</p>
<p>默认配置下，Kubernetes只会保留最近的几个revision，可以在Deployment定义文件中通过<code>revisionHistoryLimit</code>属性增加revision数量。</p>
<p>如果在滚动更新过程中，出现错误，要回滚到更新之前的状态，可以执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout undo deployments/kubernetes-bootcamp</span><br></pre></td></tr></table></figure>

<p>您可以恢复到之前已保留的任何revision：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout undo deployments/kubernetes-bootcamp --to-revision=2</span><br></pre></td></tr></table></figure>



<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p>Kubernetes用于协调一个高可用的计算机集群，这些计算机连接起来作为一个单元工作。 </p>
<p><img src="Kubernetes/arch.png" alt="arch"></p>
<h2 id="Kubernetes集群"><a href="#Kubernetes集群" class="headerlink" title="Kubernetes集群"></a>Kubernetes集群</h2><p>Kubernetes集群包含两种类型的资源： </p>
<ul>
<li><strong>Master</strong>节点（控制节点）负责管理集群。 例如，调度应用程序，维护应用程序的所需状态，扩展应用程序以及推出新更新。 </li>
<li><strong>Node</strong>节点（运行节点）是运行容器应用的工作器，它对应一个虚拟机或物理机（具体取决于集群）。每个Node都有一个Kubelet，它是一个管理Node并与Kubernetes Master通信的代理。Node还应具有用于处理容器操作的工具，例如Docker或rkt。 </li>
</ul>
<p>Kubernetes集群可以部署在虚拟机或物理机上。一个应对生产流量的Kubernetes集群应至少有三个节点。</p>
<p>Node使用Master公开的Kubernetes API与Master进行通信。终端用户还可以直接使用Kubernetes API与群集进行交互。 </p>
<p><img src="Kubernetes/Kubernetes-cluster.svg" alt="Kubernetes-cluster"></p>
<p>Node可以包含多个pod，Kubernetes master会自动处理在群集中的节点上调度pod。</p>
<p><img src="Kubernetes/nodes.svg" alt="nodes"> </p>
<h2 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h2><p>当我们在Kubernetes上创建一个Deployment时，Kubernetes会创建一个Pod（包含容器）来托管你的应用程序实例，而不是直接创建容器。 </p>
<p>Pod是一个Kubernetes抽象，表示紧密相关的一组（一个或多个）应用程序容器（如Docker或rkt），以及这些容器的一些共享资源。 这些资源包括：</p>
<ul>
<li>共享存储——Kubernetes中存储卷是在Pod级别中设置的，而不是容器级别。 </li>
<li>网络——Kubernetes集群中的每个Pod都有一个唯一的IP地址，Pod中的容器共享这个IP地址和端口空间。而同一个Pod的容器之间能直接通过localhost来发现和通信。 </li>
<li>有关如何运行每个容器的信息，例如容器映像版本或要使用的特定端口 </li>
</ul>
<p>Pod模拟一个特定于应用程序的“逻辑主机”，并且可以包含相对紧密耦合的不同应用程序容器。 </p>
<blockquote>
<p>只有需要直接共享资源的容器才应该放在一个Pod中。而象Tomcat和MySQL，它们是通过JDBC交换数据，而不是直接共享存储，因此不应该放在同一个Pod中。</p>
</blockquote>
<p>Pod是Kubernetes的最小调度单位，同一Pod中的容器始终作为一个整体被Master调度到一个Node上运行，并在同一节点的共享上下文中运行。 </p>
<p>每个Pod都与调度它的节点绑定，并保持在那里直到终止（根据重启策略）或删除。如果节点发生故障，则会在群集中的其他可用节点上安排相同的Pod。 </p>
<p><img src="Kubernetes/pods.svg" alt="pods"></p>
<p>可用下列命令获取Pods的名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> POD_NAME=$(kubectl get pods -o go-template --template <span class="string">'&#123;&#123;range .items&#125;&#125;&#123;&#123;.metadata.name&#125;&#125;&#123;&#123;"\n"&#125;&#125;&#123;&#123;end&#125;&#125;'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="控制器——运行Pod"><a href="#控制器——运行Pod" class="headerlink" title="控制器——运行Pod"></a>控制器——运行Pod</h2><p>Kubernetes通常不会直接创建Pods，而是通过控制器（Controller）来管理Pod。</p>
<p>为了满足不同业务场景，Kubernetes提供了多种控制器：</p>
<ul>
<li>Deployment：可管理Pod的多个副本，并确保Pod按照预期的状态运行。</li>
<li>ReplicaSet：实现了Pod的多副本管理。实际上，使用Deployment时会自动创建ReplicaSet，也就是说，Deployment是通过ReplicaSet来管理Pod的多个副本。我们通常不需要直接使用ReplicaSet。</li>
<li>DaemonSet：用于每个Node最多运行一个Pod副本的场景。</li>
<li>StatefuleSet：能够保证Pod的每个副本在整个生命周期中名称是不变的，并且保证副本按照固定的顺序启动、更新或删除。</li>
<li>Job：用到运行结束就删除的应用，常用于一次性的任务。其他控制中的Pod通常是长期持续运行，除非手动删除。</li>
</ul>
<h2 id="服务——发现Pod"><a href="#服务——发现Pod" class="headerlink" title="服务——发现Pod"></a>服务——发现Pod</h2><p>在K8s中Pod的实例是动态变化的，IP也不是固定的。这就给访问者带来了困难，而服务就是为了解决这个困难的。</p>
<p>服务是实际应用的抽象，它定义了一组逻辑的Pod集合和访问这个Pod集合的策略。服务降低了Pods之间的耦合度。服务使用标签和选择器匹配一组Pods。</p>
<p>服务将代理Pod对外表现为一个单一访问接口，外部不需要了解后端Pod如何运行，提供了一套简化的负载均衡、服务代理和发现机制。</p>
<p>与Pods一样，每个服务也有自己在集群中的唯一集群IP地址。</p>
<p><img src="Kubernetes/services.svg" alt="services"></p>
<p>在ServiceSpec中，通过<code>type</code>来指定服务公布的方式：</p>
<ul>
<li>ClusterIP（默认）：在群集中的内部IP上公开服务。此类型使服务只能从群集中访问。 </li>
<li>NodePort：使用NAT方式，在集群中每个选定节点（由LabelSelector确定）的<strong>同一端口</strong>上公开服务。在集群外部，通过<code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code> 访问服务。ClusterIP的超集。 </li>
<li>LoadBalancer：在当前云中创建外部负载均衡器（如果支持），并为服务分配固定的外部IP。 NodePort的超集。（minikube不支持）</li>
<li>ExternalName：通过返回带有名称的CNAME记录，使用任意名称（在规范中由externalName指定）公开服务。没有使用代理。此类型需要v1.7或更高版本的kube-dns。 </li>
</ul>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><p>标签是附加到对象的键/值对，它是一个允许对Kubernetes中的对象进行逻辑操作的分组原语。 </p>
<p><img src="Kubernetes/labels.svg" alt="labels"></p>
<p>标签可以在创建时或稍后附加到对象。它们可以随时修改。 </p>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p>命名空间可以将一个物理的集群逻辑地划分成多个虚拟集群。不同命名空间里的资源是完全隔离的。</p>
<p>Kubernetes默认创建了两个命名空间：</p>
<ul>
<li>default：默认命名空间。创建资源时如果不指定命名空间，将被放到default命名空间。</li>
<li>kube-system：Kubernetes自己创建的系统资源将放到这个命名空间。</li>
</ul>
<p>在使用<code>kubectl</code>工具管理kubernetes资源时，可用<code>-n 命名空间</code>选项来指定资源的命名空间。没有为资源显式指定命名空间，则属于<code>default</code>命名空间。</p>
<p>可用<code>--all-namespaces</code>选项表示所有命名空间。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="Minikube"><a href="#Minikube" class="headerlink" title="Minikube"></a>Minikube</h2><p>Minikube是一种轻量级Kubernetes实现，可在本地计算机上创建VM并部署仅包含一个节点的简单集群，它适用于开发和测试。 </p>
<p>显示Minikube版本号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ minikube version</span><br></pre></td></tr></table></figure>

<h2 id="kubeadm"><a href="#kubeadm" class="headerlink" title="kubeadm"></a>kubeadm</h2><p>参见：<a href="https://kubernetes.io/docs/setup/independent/high-availability/" target="_blank" rel="noopener">Creating Highly Available Clusters with kubeadm</a></p>
<h2 id="定制安装"><a href="#定制安装" class="headerlink" title="定制安装"></a>定制安装</h2><p>参见：<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="noopener">follow-me-install-kubernetes-cluster</a></p>
<h2 id="使用Photon-OS"><a href="#使用Photon-OS" class="headerlink" title="使用Photon OS"></a>使用Photon OS</h2><p>Photon OS是一个专注于容器的精简Linux操作系统。它的完全安装中已经包含Kubernetes和Mesos。</p>
<h2 id="使用kubekit搭建k8s集群"><a href="#使用kubekit搭建k8s集群" class="headerlink" title="使用kubekit搭建k8s集群"></a>使用kubekit搭建k8s集群</h2><p><a href="https://github.com/Orientsoft/kubekit" target="_blank" rel="noopener">Kubekit</a>是一个部署工具包，它为kubernetes提供离线安装解决方案。您可以使用它将Kubernetes部署到OFFLINE生产环境。</p>
<p>Kubekit将安装</p>
<ul>
<li>Docker（1.12.6）</li>
<li>Kubernetes及其所有组件</li>
<li>Kubernetes仪表板，默认节点端口：31234</li>
</ul>
<h3 id="安装操作系统"><a href="#安装操作系统" class="headerlink" title="安装操作系统"></a>安装操作系统</h3><p>首先官方支持下面两个操作系统，而且都要是最小化安装支持的</p>
<ul>
<li>CentOS release 7.3.1611</li>
<li>CentOS release 7.4.1708</li>
</ul>
<p>安装完成之后关闭防火墙：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>

<p>关闭selinux：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">vim &#x2F;etc&#x2F;selinux&#x2F;config</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELINUX&#x3D;disabled</span><br></pre></td></tr></table></figure>

<p>最好还可以同步一下时间什么的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install ntpdate</span><br><span class="line">ntpdate 0.cn.pool.ntp.org</span><br></pre></td></tr></table></figure>

<h3 id="下载kubekit"><a href="#下载kubekit" class="headerlink" title="下载kubekit"></a>下载kubekit</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install wget</span><br><span class="line">wget https:&#x2F;&#x2F;kubekit.orientsoft.cn&#x2F;kubekit-linux64-0.3.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf kubekit-linux64-0.3.tar.gz</span><br><span class="line">mv kubekit-release/ kubekit</span><br></pre></td></tr></table></figure>

<p>下载离线包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;kubekit.orientsoft.cn&#x2F;package-1.9.2.tar.gz</span><br><span class="line">tar -zxvf package-1.9.2.tar.gz</span><br><span class="line">mv package kubekit</span><br></pre></td></tr></table></figure>

<p>给脚本赋予可执行权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd kubekit&#x2F;package&#x2F;</span><br><span class="line">chmod +x .&#x2F;*.sh</span><br></pre></td></tr></table></figure>

<h3 id="安装并初始化master节点"><a href="#安装并初始化master节点" class="headerlink" title="安装并初始化master节点"></a>安装并初始化master节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kubekit init 192.168.38.166</span><br></pre></td></tr></table></figure>

<p>接着ctrl+c退出来，然后重新启动kubekit的dashboard并且放在后台</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;kubekit server &amp;</span><br></pre></td></tr></table></figure>

<h3 id="添加一个node"><a href="#添加一个node" class="headerlink" title="添加一个node"></a>添加一个node</h3><p>浏览器访问 ip:9000。</p>
<p>创建一个同样安装着centos 1708最小化安装的机器，之后打开修改主机名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname kubekit-node1</span><br></pre></td></tr></table></figure>

<p>接着点击web界面上的add node，输入ssh账号密码等信息，最后选中点击start deploy就可以了。</p>
<p>之后你就会在kubernetes的dashboard看到这个节点的详细信息了。</p>
<h1 id="网络管理"><a href="#网络管理" class="headerlink" title="网络管理"></a>网络管理</h1><h2 id="网络模型"><a href="#网络模型" class="headerlink" title="网络模型"></a>网络模型</h2><p>Kubernetes采用基于扁平地址空间的网络模型，集群中的每个Pod都有自己的IP地址，Pod之间不需要配置NAT就能直接通信。另外，同一个Pod中的容器共享Pod的IP，它们能够通过localhost通信。也就是说，每个Pod可以看作一个个独立的系统，面Pod中的容器则可被看作同一系统中的不同进程。</p>
<p>在Kubernetes集群中，Pod可能会频繁地销毁和创建，它们的IP是不固定的。为了解决这个问题，Service提供了访问Pod的抽象层。无论后端的Pod如何变化，Service都作为稳定的前端对外提供服务。同时，Service还提供了高可用和负载均衡功能，Service负责将请求转发给正确的Pod。</p>
<p>无论是Pod的IP，还是Service的集群IP，它们只能在Kubernetes集群中可见，对集群之外的世界，这些IP都是私有的。Kubernetes提供了多种方式对外公布服务（参见“对外公布服务”）。</p>
<h2 id="网络方案"><a href="#网络方案" class="headerlink" title="网络方案"></a>网络方案</h2><p>Kubernetes采用了Container Networking Interface（CNI）规范，它支持多种容器运行时，不仅仅是Docker。</p>
<p>CNI的插件模型支持不同组织和公司开发的第三方插件，可以灵活选择适合的网络方案。</p>
<p>目前已有多种支持Kubernetes的网络方案（例如：Flannel、Calico、Canal、Weave Net等），它们都实现了CNI规范。用户无论选择哪种方案，得到的网络模型都是一样的。</p>
<h2 id="网络政策"><a href="#网络政策" class="headerlink" title="网络政策"></a>网络政策</h2><p>网络政策（Network Policy）是Kubernetes的一种资源，它通过标签选择Pods，并指定其他Pods或外界如何与这些Pods通信。</p>
<p>默认情况下，任何来源的网络流量都能够访问Pods，没有任何限制。当为Pods定义了网络政策时，只有政策允许的流量才能访问Pods。</p>
<p>不是所有的Kubernetes网络方案都支持网络政策，比如Flannel就不支持，Calico、Canal是支持的。</p>
<h2 id="Canal"><a href="#Canal" class="headerlink" title="Canal"></a>Canal</h2><p>Canal用Fannel实现Kubernetes集群网络，同时又用Calico实现了网络政策。</p>
<h3 id="部署Canal"><a href="#部署Canal" class="headerlink" title="部署Canal"></a>部署Canal</h3><p>部署Canal与部署其他Kubernetes网络方案类似，就是在Kubernetes集群初始化（例如<code>kubeadm init</code>）之后，通过<code>kubectl apply</code>安装。</p>
<p>如果Kubernetes集群已经安装有其他的网络方案，则只能重建当前集群，再部署Canal。</p>
<blockquote>
<p>要销毁当前集群，最简单的方法是在每个节点上执行<code>kubeadm reset</code>。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/rbac.yaml</span><br><span class="line">$ kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/canal.yaml</span><br></pre></td></tr></table></figure>

<p>部署成功后，Canal作为DaemonSet部署到每个节点，并属于<code>kube-system</code>命名空间。</p>
<h3 id="应用网络政策"><a href="#应用网络政策" class="headerlink" title="应用网络政策"></a>应用网络政策</h3><p>policy.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">access-httpd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">podSelector:</span></span><br><span class="line">		<span class="attr">matchLabels:</span></span><br><span class="line">			<span class="attr">run:</span> <span class="string">httpd</span></span><br><span class="line">	<span class="attr">ingress:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">		  	<span class="attr">matchLabels:</span></span><br><span class="line">		  		<span class="attr">access:</span> <span class="string">"true"</span></span><br><span class="line">		<span class="attr">ports:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">			<span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>上面的网络政策中的访问规则应用于标签为<code>run: httpd</code>的Pods。</p>
<p>在<code>ingress</code>属性中定义只有标签为<code>access: &quot;true&quot;</code> 的Pod才能访问应用，且只能访问80端口。</p>
<p>除了通过<code>ingress</code>属性限制进入的流量，也可以用<code>egress</code>属性限制外出的流量。</p>
<p>创建网络政策：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f policy.yaml</span><br></pre></td></tr></table></figure>

<p>查看网络政策：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get networkpolicy</span><br></pre></td></tr></table></figure>

<h1 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h1><h1 id="应用部署"><a href="#应用部署" class="headerlink" title="应用部署"></a>应用部署</h1><h2 id="创建部署"><a href="#创建部署" class="headerlink" title="创建部署"></a>创建部署</h2><ul>
<li><p>用kubectl命令直接创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run foo --image=foo:1.0.0 --replicas=2</span><br></pre></td></tr></table></figure>

<p>在命令行中通过形如<code>--属性名=属性值</code>的参数指定资源的属性。</p>
</li>
<li><p>通过将资源属性写入到YAML格式或JSON格式的定义文件中，并用<code>kubect</code>命令带<code>-f</code>选项来创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f foo.yml</span><br><span class="line">或</span><br><span class="line">$ kubectl apply -f foo.yml</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="部署定义文件"><a href="#部署定义文件" class="headerlink" title="部署定义文件"></a>部署定义文件</h3><p>一个YAML格式的定义文件，可以定义多个资源，用<code>---</code>分割。</p>
<h2 id="删除部署"><a href="#删除部署" class="headerlink" title="删除部署"></a>删除部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete deployments foo</span><br><span class="line">或者</span><br><span class="line">$ kubectl delete deployments/foo</span><br><span class="line">或者</span><br><span class="line">$ kubectl delete -f foo.yml</span><br></pre></td></tr></table></figure>

<p>删除部署也会删除关联的Pod实例。 </p>
<h2 id="查询部署"><a href="#查询部署" class="headerlink" title="查询部署"></a>查询部署</h2><p>列出<code>myns</code>命名空间下所有的部署：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployments -n myns</span><br></pre></td></tr></table></figure>

<p>查询名叫<code>foo</code>的部署：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployments/foo</span><br></pre></td></tr></table></figure>

<h2 id="查看部署详情"><a href="#查看部署详情" class="headerlink" title="查看部署详情"></a>查看部署详情</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe deployments/foo</span><br></pre></td></tr></table></figure>

<h2 id="伸缩部署"><a href="#伸缩部署" class="headerlink" title="伸缩部署"></a>伸缩部署</h2><p>改变YAML文件中<code>replicas</code>属性的数量，然后再执行<code>kubectl apply -f</code>。或者使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale deployments/foo --replicas=4</span><br></pre></td></tr></table></figure>

<h2 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h2><p>模拟<code>k8s-node2</code>出现故障（关闭该节点）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-node2:~<span class="comment"># halt -h</span></span><br></pre></td></tr></table></figure>

<p>等待一段时间，Kubernetes会检查到<code>k8s-node2</code>不可用。假设原来在<code>k8s-node2</code>上运行2个Pods实例，则这些Pods将被标记为<code>Unknown</code>状态，并在<code>k8s-node1</code> 上新创建2个Pods实例，维持总副本数不变。</p>
<p>当<code>k8s-node2</code>恢复后，<code>Unknown</code>状态的Pods会被删除，不过已经运行的Pods不会重新调度回<code>k8s-node2</code>。</p>
<h2 id="用标签控制Pod的位置"><a href="#用标签控制Pod的位置" class="headerlink" title="用标签控制Pod的位置"></a>用标签控制Pod的位置</h2><p>默认配置下，Kubernetes会将Pods调度到任何可用的Node。不过有些情况我们希望将Pods部署到指定Node，比如将大量磁盘I/O的Pods部署到配置了SSD的Node上。Kubernetes是通过标签（label）来实现该功能的。</p>
<p>首先，给指定Node加一个标签（这里是<code>disktype=ssd</code>）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl label nodes/k8s-node1 disktype=ssd</span><br></pre></td></tr></table></figure>

<p>查看节点的标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes --show-labels</span><br></pre></td></tr></table></figure>

<p>然后，编辑部署定义文件的属性<code>nodeSelector</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">temlate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">			<span class="attr">nodeSelector:</span></span><br><span class="line">				<span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure>

<p>重新执行命令<code>kubectl apply -f</code>应用这个定义文件。</p>
<h1 id="存储管理"><a href="#存储管理" class="headerlink" title="存储管理"></a>存储管理</h1><p>容器中的磁盘文件是短暂的， 当一个Container崩溃时，kubelet将重新启动它，但文件将丢失 —— 容器以干净状态启动。此外，在Pod中一起运行的容器，通常需要在这些容器之间共享文件。 Kubernetes的卷（Volume）解决了这两个问题。 </p>
<p>从本质上讲，Kubernetes的卷只是一个目录，可能包含一些数据，这点与Docker的卷类似。当卷被挂载到Pod时，Pod中的所有容器都可以访问这个卷。该目录是如何形成的，支持它的介质以及它的内容由所使用的卷类型决定。 另外，Kubernetes</p>
<blockquote>
<p>Kubernetes 卷的类型详见：<a href="https://kubernetes.io/docs/concepts/storage/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/storage/</a></p>
</blockquote>
<p>卷不能挂载其他卷或具有到其他卷的硬链接。 Pod中的每个容器必须独立指定各自的卷的挂载路径。 </p>
<p>卷的使用分两步：首先，使用<code>.spec.volumes</code> 字段定义卷。然后，使用<code>.spec.containers.volumeMounts</code> 字段为Pod中的每个容器挂载相应的卷。</p>
<h2 id="emptyDir卷"><a href="#emptyDir卷" class="headerlink" title="emptyDir卷"></a>emptyDir卷</h2><p>emptyDir类型的卷是宿主节点上的一个目录（初始总是空的），它的生命周期与Pod一致。当Pod从节点上删除时，卷的内容也会被删除。但如果只是容器被销毁而Pod还在，则卷将保留。因此，emptyDir卷不具备持久性，它只适用于Pod中的容器需要临时共享存储空间的场景。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">k8s.gcr.io/test-webserver</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">    <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>不能指定emptyDir卷在节点上的位置，可以通过<code>docker inspect</code>命令查看容器中卷实际挂载目录。通常是<code>/var/lib/kubelet/pods/…</code>这样的目录。</p>
</blockquote>
<h2 id="hostPath卷"><a href="#hostPath卷" class="headerlink" title="hostPath卷"></a>hostPath卷</h2><p>hostPath卷与emptyDir卷一个，也是宿主节点上的一个目录，只不过emptyDir卷无法指定目录，而hostPath卷可以自己指定目录（必须是已存在的目录）。另外，当Pod被销毁后，hostPath卷还是会保留。</p>
<p>hostPath卷的缺点是，它的实际位置在宿主节点上，增加了Pod与节点的耦合，一旦宿主节点崩溃，hostPath卷将无法访问。</p>
<p>hostPath卷通常适用于那些需要访问Kubernetes或Docker内部数据的应用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">k8s.gcr.io/test-webserver</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test-pd</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># this field is optional</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure>

<h2 id="云存储卷"><a href="#云存储卷" class="headerlink" title="云存储卷"></a>云存储卷</h2><p>Kubernetes支持使用AWS、GCE、Azure等公有云上的云硬盘作为卷。</p>
<p>例如：AWS Elastic Block Store</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-ebs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">k8s.gcr.io/test-webserver</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test-ebs</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="comment"># This AWS EBS volume must already exist.</span></span><br><span class="line">    <span class="attr">awsElasticBlockStore:</span></span><br><span class="line">      <span class="attr">volumeID:</span> <span class="string">&lt;volume-id&gt;</span></span><br><span class="line">      <span class="attr">fsType:</span> <span class="string">ext4</span></span><br></pre></td></tr></table></figure>

<h2 id="分布式存储卷"><a href="#分布式存储卷" class="headerlink" title="分布式存储卷"></a>分布式存储卷</h2><p>Kubernetes卷可以使用主流的分布式存储，例如Ceph、GlusterFS等。</p>
<p>分布式存储最大特点是不依赖Kubernetes，与Kubernetes集群是分离的，数据被持久化后，即使整个Kubernetes集群崩溃也不会受损。</p>
<p>例如：Cephfs</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cephfs-rw</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kubernetes/pause</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/mnt/cephfs"</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cephfs</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cephfs</span></span><br><span class="line">    <span class="attr">cephfs:</span></span><br><span class="line">      <span class="attr">monitors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.16</span><span class="number">.154</span><span class="number">.78</span><span class="string">:6789</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.16</span><span class="number">.154</span><span class="number">.82</span><span class="string">:6789</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.16</span><span class="number">.154</span><span class="number">.83</span><span class="string">:6789</span></span><br><span class="line">      <span class="comment"># by default the path is /, but you can override and mount a specific path of the filesystem by using the path attribute</span></span><br><span class="line">      <span class="comment"># path: /some/path/in/side/cephfs</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">secretRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">ceph-secret</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">QVFCMTZWMVZvRjVtRXhBQTVrQ1FzN2JCajhWVUxSdzI2Qzg0SEE9PQ==</span></span><br></pre></td></tr></table></figure>

<h2 id="PersistentVolume和PersistentVolumeClaim"><a href="#PersistentVolume和PersistentVolumeClaim" class="headerlink" title="PersistentVolume和PersistentVolumeClaim"></a>PersistentVolume和PersistentVolumeClaim</h2><p>详见：<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/storage/persistent-volumes/</a></p>
<p>PersistentVolume（PV）是外部存储系统中的一块存储空间，由存储系统管理员创建和维护。与卷一样，PV具有持久性，生命周期独立于Pod。</p>
<p>PersistentVolumeClaim（PVC）是对PV的申请（Claim），用于将PersistentVolume挂载到Pod中 。PVC通常由用户（开发人员）创建和维护。需要为Pod分配存储资源时，用户可以创建一个PVC，指明存储资源的容量大小、访问模式等要求，Kubernetes会查找并提供满足条件的PV。</p>
<p>有个PVC，用户只需要告诉Kubernetes需要什么样的存储资源，而不必关心真正的空间从哪里分配、如何访问等底层细节信息。这些存储Provider的底层信息交给存储系统管理员来处理，从而实现了用户与系统管理员的职责分离。</p>
<p>Kubernetes支持多种类型的PV，例如AWS EBS、Ceph等。</p>
<p>PV有两种供应方式：静态和动态。</p>
<h3 id="静态供应"><a href="#静态供应" class="headerlink" title="静态供应"></a>静态供应</h3><p>静态供应PV是指，我们提前创建PV，然后再通过PVC申请PV。</p>
<p>下面以NFS为例：</p>
<p>Persistent Volume：mysql-pv.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span>    <span class="comment"># PV的容量</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span>    <span class="comment"># 访问模式。有：ReadWriteOnce、ReadOnlyMany、ReadWriteMany三种。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span>    <span class="comment"># 回收策略。Retain：手动回收。Recycle：自动清除PV中的数据。Delete：自动删除Storage Provider上的对应存储资源。</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span>   <span class="comment"># 为PV设置一个分类</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nfsvers=4.1</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfsdata/mysql-pv</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>

<p>创建PV：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f pv0003.yml</span><br></pre></td></tr></table></figure>

<p>Persistent Volume Claim：mysql-pvc.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">8Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">slow</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span>   <span class="comment"># 请求的PV必须具有此标签</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">"stable"</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#123;key:</span> <span class="string">environment,</span> <span class="attr">operator:</span> <span class="string">In,</span> <span class="attr">values:</span> <span class="string">[dev]&#125;</span></span><br></pre></td></tr></table></figure>

<p>创建PVC：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f myclaim.yml</span><br></pre></td></tr></table></figure>

<p>可以通过命令<code>kubectl get pvc</code>和<code>kubectl get pv</code>的输出看到<code>mysql-pvc</code>已经绑定到<code>mysql-pv</code>了。</p>
<p>接下来，就可以在容器中使用该存储了：（PVC必须与使用它的Pod存在于同一命名空间中 ）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">selector:</span></span><br><span class="line">		<span class="attr">matchLabels:</span></span><br><span class="line">			<span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">	<span class="attr">template:</span></span><br><span class="line">		<span class="attr">metadata:</span></span><br><span class="line">			<span class="attr">labels:</span></span><br><span class="line">				<span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">		<span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mysql:5.6</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">password</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/var/lib/mysql"</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql-persistent-storage</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-persistent-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">mysql-pvc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">ports:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">	<span class="attr">selector:</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure>

<h3 id="动态供应"><a href="#动态供应" class="headerlink" title="动态供应"></a>动态供应</h3><p>动态供应PV是指，如果没有满足PVC条件的PV时，会动态创建PV。</p>
<p>动态供应是通过StorageClass实现的，StorageClass定义了如何创建PV。</p>
<blockquote>
<p>详见：<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/storage/storage-classes/</a></p>
</blockquote>
<p>为启用基于StorageClass的动态供应，群集管理员需要在API服务器上启用DefaultStorageClass的 <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#defaultstorageclass" target="_blank" rel="noopener">admission controller</a> 。 也就是说，<code>kube-apiserver.service</code> 文件中，配置<code>--enable-admission-plugins</code>参数的值中包含<code>DefaultStorageClass</code>。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">…</span><br><span class="line">--enable-admission-plugins=Initializers,NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota</span><br><span class="line">…</span><br></pre></td></tr></table></figure>

<p>首先，系统管理员创建StorageClass：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">standard</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/aws-ebs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">	<span class="attr">type:</span> <span class="string">gp2</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span>  <span class="comment"># 支持Delete和Retain两种，默认是Delete。</span></span><br><span class="line"><span class="attr">mountOptions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>然后，在PVC申请PV时，只需要指定StorageClass、容量以及访问模式即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">8Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">standard</span></span><br></pre></td></tr></table></figure>



<h3 id="回收PV"><a href="#回收PV" class="headerlink" title="回收PV"></a>回收PV</h3><p>当不需要使用PV时，可以删除PVC回收PV：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pvc/myclaim</span><br></pre></td></tr></table></figure>

<p>当PVC被删除后，如果<code>persistentVolumeReclaimPolicy</code>为<code>Recycle</code>或<code>Delete</code>时，Kubernetes会启动一个新的Pod——recycler-for-mysql-pvc，这个Pod的作用就是清除PV <code>mysql-pv</code>的数据。此时，<code>mysql-pv</code>的状态为“Released”，表示已经解除了与<code>mysql-pvc</code>的绑定，正在清除数据，不过此时还不可用。当数据清除完毕，<code>mysql-pv</code>的状态重新变为“Available”，此时可以被新的PVC申请。</p>
<p>如果<code>persistentVolumeReclaimPolicy</code>为<code>Retain</code>时，Kubernetes不会启动用于清除数据的Pod，<code>mysql-pv</code>中的数据得到保留，但其PV状态会一直处于“Released”，不能被其他PVC申请。这时，如果删除了PV<code>mysql-pv</code>，只是删除了<code>mysql-pv</code>对象，存储空间中的数据仍然不会被删除。重新创建<code>mysql-pv</code>后，它的状态将变为“Available”，此时可以被新的PVC申请。</p>
<h1 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h1><h2 id="DNS访问服务"><a href="#DNS访问服务" class="headerlink" title="DNS访问服务"></a>DNS访问服务</h2><p>在集群中，除了可以通过集群IP访问服务外，Kubernetes还提供了更为方便的DNS访问。</p>
<p>要使用DNS访问服务，要先安装kube-dns组件，它是一个DNS服务器。</p>
<p>每当有新的服务被创建，kube-dns会添加该服务的DNS记录。集群中的Pods可以通过<code>服务名.命名空间名</code> 域名形式访问服务。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget httpd-svc.default:8080</span><br></pre></td></tr></table></figure>

<p>如果Pods与服务在同一个命名空间中，可以省略<code>.命名空间名</code>部分，直接使用服务名进行访问。</p>
<blockquote>
<p>服务的完整域名，可以进入它对应的Pod中，查看<code>/etc/resolv.conf</code>文件。例如：<code>httpd-svc.default.svc.cluster.local</code>。</p>
</blockquote>
<h2 id="服务对Pods的负载均衡"><a href="#服务对Pods的负载均衡" class="headerlink" title="服务对Pods的负载均衡"></a>服务对Pods的负载均衡</h2><p>服务通过标签与一组Pods关联，会将外部流量负载均衡到它所关联的每一个Pod。</p>
<h2 id="对外公布服务"><a href="#对外公布服务" class="headerlink" title="对外公布服务"></a>对外公布服务</h2><h3 id="ClusterIP方式"><a href="#ClusterIP方式" class="headerlink" title="ClusterIP方式"></a>ClusterIP方式</h3><p>默认情况下，Kubernetes服务的公布类型是<code>ClusterIP</code>，即通过集群内部的IP对外公布服务，这种方式公布的服务，只有集群内的节点和Pod可以访问。</p>
<h3 id="NodePort方式"><a href="#NodePort方式" class="headerlink" title="NodePort方式"></a>NodePort方式</h3><p>通过集群节点的静态端口对外提供服务，集群外部可以通过<code>节点IP:节点端口号</code>访问服务。</p>
<p>httpd-svc.yml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">httpd-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">	<span class="attr">selector:</span></span><br><span class="line">		<span class="attr">run:</span> <span class="string">httpd</span></span><br><span class="line">	<span class="attr">ports:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">		<span class="attr">nodePort:</span> <span class="number">30000</span>      <span class="string">（节点上监听的端口。如果未设置，则默认是随机产生一个端口号）</span></span><br><span class="line">		<span class="attr">port:</span> <span class="number">8080</span>           <span class="string">（服务集群IP上监听的端口）</span></span><br><span class="line">		<span class="attr">targetPort:</span> <span class="number">80</span>       <span class="string">（目标Pods上监听的端口）</span></span><br></pre></td></tr></table></figure>

<p>创建NodePort类型的服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f httpd-svc.yml</span><br></pre></td></tr></table></figure>

<p>也可以直接使用<code>kubectl expose --type=&quot;NodePort&quot;</code>命令为已有部署创建NodePort服务。</p>
<p>如果使用<code>kubectl get services/httpd-svc</code>，就会发现有一个“EXTERNAL-IP”，它就是节点的IP。</p>
<p>这种方式发布的服务，实际上并不是高可用的，因为它是通过某个节点IP来访问的。</p>
<h3 id="LoadBalancer方式"><a href="#LoadBalancer方式" class="headerlink" title="LoadBalancer方式"></a>LoadBalancer方式</h3><h3 id="ExternalName方式"><a href="#ExternalName方式" class="headerlink" title="ExternalName方式"></a>ExternalName方式</h3><h2 id="Ingress服务"><a href="#Ingress服务" class="headerlink" title="Ingress服务"></a>Ingress服务</h2><p>Ingress服务可以简单的理解成k8s内部的nginx, 用作负载均衡器。它的好处有：</p>
<ul>
<li>动态配置服务：按照传统方式，当新增加一个服务时，我们可能需要在流量入口加一个反向代理指向我们新的k8s服务。而如果用了Ingress，只需要配置好这个服务，当服务启动时，会自动注册到Ingress的中，不需要而外的操作。</li>
<li>减少不必要的端口暴露：使用Ingress服务后，只有Ingress自身服务可能需要映射出去, 其他服务都不需要用NodePort方式对外公布。</li>
</ul>
<h1 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h1><h2 id="敏感信息"><a href="#敏感信息" class="headerlink" title="敏感信息"></a>敏感信息</h2><p>敏感信息使用Secret管理。（详见：<a href="https://kubernetes.io/docs/concepts/configuration/secret/）" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/configuration/secret/）</a></p>
<p>Secret会以密文的方式存储数据，避免了直接在配置文件中保存敏感信息。</p>
<p>Secret会以卷的形式被挂载到Pod，容器可通过文件的方式使用Secret中的敏感数据。此外，容器也可以环境变量的方式使用这些数据。</p>
<h3 id="创建Secret"><a href="#创建Secret" class="headerlink" title="创建Secret"></a>创建Secret</h3><h4 id="通过-from-literal"><a href="#通过-from-literal" class="headerlink" title="通过--from-literal"></a>通过<code>--from-literal</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create secret generic mysecret --from-literal=username=admin --from-literal=password=123456</span><br></pre></td></tr></table></figure>

<p>每个<code>--from-literal</code>定义一条信息。</p>
<p>每条信息的值的内容使用明文，创建secret时，会自动使用base64编码。</p>
<h4 id="通过-from-file"><a href="#通过-from-file" class="headerlink" title="通过--from-file"></a>通过<code>--from-file</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n admin &gt; ./username</span><br><span class="line">$ <span class="built_in">echo</span> -n 123456 &gt; ./password</span><br><span class="line">$ kubectl create secret generic mysecret --from-file=./username --from-file=./password</span><br></pre></td></tr></table></figure>

<p>每个文件内容对应一条信息，文件名就是键，文件内容是值。</p>
<p>每文件的内容使用明文，创建secret时，会自动使用base64编码。</p>
<h4 id="通过-from-env-file"><a href="#通过-from-env-file" class="headerlink" title="通过--from-env-file"></a>通过<code>--from-env-file</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt; EOF &gt; env.txt</span><br><span class="line">username=admin</span><br><span class="line">password=123456</span><br><span class="line">EOF</span><br><span class="line">$ kubectl create secret generic mysecret --from-env-file=env.txt</span><br></pre></td></tr></table></figure>

<p>文件<code>env.txt</code>中每行对应一条信息。</p>
<p>每条信息的值的内容使用明文，创建secret时，会自动使用base64编码。</p>
<h4 id="通过YAML或JSON文件定义"><a href="#通过YAML或JSON文件定义" class="headerlink" title="通过YAML或JSON文件定义"></a>通过YAML或JSON文件定义</h4><p>首先，必须自己手动将敏感信息使用base64编码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n admin | base64</span><br><span class="line">YWRtaW4=</span><br><span class="line">$ <span class="built_in">echo</span> -n 123456 | base64</span><br><span class="line">MTIzNDU2</span><br></pre></td></tr></table></figure>

<p>然后，使用上面编码的信息创建<code>mysecret.yml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">	<span class="attr">username:</span> <span class="string">YWRtaW4=</span></span><br><span class="line">	<span class="attr">password:</span> <span class="string">MTIzNDU2</span></span><br></pre></td></tr></table></figure>

<p>最后，调用命令创建<code>mysecret</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f mysecret.yml</span><br></pre></td></tr></table></figure>

<h3 id="查看Secret"><a href="#查看Secret" class="headerlink" title="查看Secret"></a>查看Secret</h3><p>查看Secret：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get secret/mysecret -o yaml</span><br></pre></td></tr></table></figure>

<p>查看Secret详情：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe secret/mysecret</span><br></pre></td></tr></table></figure>

<p>输出的结果中，只会显示敏感信息占用的字节数，不会显示敏感信息内容。</p>
<p>编辑Secret：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit secret/mysecret</span><br></pre></td></tr></table></figure>

<p>在编辑界面可以看到经过base64编码后的敏感信息。</p>
<p>可自行通过下列命令解码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n YWRtaW4= | base64 --decode</span><br><span class="line">admin</span><br><span class="line">$ <span class="built_in">echo</span> -n MTIzNDU2 | base64 --decode</span><br><span class="line">123456</span><br></pre></td></tr></table></figure>

<h3 id="使用Secret"><a href="#使用Secret" class="headerlink" title="使用Secret"></a>使用Secret</h3><h4 id="通过卷的方式使用"><a href="#通过卷的方式使用" class="headerlink" title="通过卷的方式使用"></a>通过卷的方式使用</h4><p>在Pod的定义文件中将Secret配置成卷：mypod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">	  <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">	  <span class="attr">args:</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">sleep</span> <span class="number">10</span><span class="string">;</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line">	  <span class="attr">volumeMounts:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">	    <span class="attr">mountPath:</span> <span class="string">"/etc/foo"</span></span><br><span class="line">	    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">	<span class="attr">volumes:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">	  <span class="attr">secret:</span></span><br><span class="line">	  	<span class="attr">secretName:</span> <span class="string">mysecret</span></span><br></pre></td></tr></table></figure>

<p>Kubernetes会在<code>mountPath</code>指定的路径<code>/etc/foo</code>下为每条敏感信息创建一个文件，文件名就是信息条目的键（这里是<code>/etc/foo/username</code>和<code>/etc/foo/password</code>），值是以明文（自动使用base64解码）存放在文件中的内容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f mypod.yml</span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it mypod sh</span><br><span class="line">/ <span class="comment"># ls /etc/foo</span></span><br><span class="line">password username</span><br><span class="line">/ <span class="comment"># cat /etc/foo/username</span></span><br><span class="line">admin</span><br><span class="line">/ <span class="comment"># cat /etc/foo/password</span></span><br><span class="line">123456</span><br></pre></td></tr></table></figure>

<p>我们也可以自定义存放数据的文件名和位置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">	  <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">	  <span class="attr">args:</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">sleep</span> <span class="number">10</span><span class="string">;</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line">	  <span class="attr">volumeMounts:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">	    <span class="attr">mountPath:</span> <span class="string">"/etc/foo"</span></span><br><span class="line">	    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">	<span class="attr">volumes:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">	  <span class="attr">secret:</span></span><br><span class="line">	  	<span class="attr">secretName:</span> <span class="string">mysecret</span></span><br><span class="line">	  	<span class="attr">items:</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">	  	  <span class="attr">path:</span> <span class="string">my-group/my-username</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">	  	  <span class="attr">path:</span> <span class="string">my-group/my-password</span></span><br></pre></td></tr></table></figure>

<p>以卷方式使用的Secret支持动态更新，即Secret更新后，所有使用该Secret的容器中的数据也会更新。</p>
<h4 id="通过环境变量方式使用"><a href="#通过环境变量方式使用" class="headerlink" title="通过环境变量方式使用"></a>通过环境变量方式使用</h4><p>在Pod的定义文件中，将Secret的信息读取到环境变量：mypod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">	  <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">	  <span class="attr">args:</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">sleep</span> <span class="number">10</span><span class="string">;</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line">	  <span class="attr">env:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SECRET_USERNAME</span></span><br><span class="line">	    <span class="attr">valueFrom:</span></span><br><span class="line">	    	<span class="attr">secretKeyRef:</span></span><br><span class="line">	    		<span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">	    		<span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SECRET_PASSWORD</span></span><br><span class="line">	    <span class="attr">valueFrom:</span></span><br><span class="line">	    	<span class="attr">secretKeyRef:</span></span><br><span class="line">	    		<span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">	    		<span class="attr">key:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure>

<p>通过环境变量读取Secret很方便，但无法支持Secret动态更新。</p>
<h2 id="普通信息"><a href="#普通信息" class="headerlink" title="普通信息"></a>普通信息</h2><p>普通信息使用ConfigMap管理。（详见：<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/）" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/）</a></p>
<p>ConfigMap的创建和使用方式与Secret非常类似，主要不同是ConfigMap的数据以明文形式存放。</p>
<h3 id="创建ConfigMap"><a href="#创建ConfigMap" class="headerlink" title="创建ConfigMap"></a>创建ConfigMap</h3><h4 id="通过-from-literal-1"><a href="#通过-from-literal-1" class="headerlink" title="通过--from-literal"></a>通过<code>--from-literal</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create configmap myconfigmap --from-literal=config1=xxx --from-literal=config2=yyy</span><br></pre></td></tr></table></figure>

<h4 id="通过-from-file-1"><a href="#通过-from-file-1" class="headerlink" title="通过--from-file"></a>通过<code>--from-file</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n xxx &gt; ./config1</span><br><span class="line">$ <span class="built_in">echo</span> -n yyy &gt; ./config2</span><br><span class="line">$ kubectl create configmap myconfigmap --from-file=./config1 --from-file=./config2</span><br><span class="line">$ kubectl get configmap/myconfigmap -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  config1: xxx</span><br><span class="line">  config2: yyy</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2018-07-20T03:21:10Z</span><br><span class="line">  name: myconfigmap</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">"311435"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/myconfigmap</span><br><span class="line">  uid: f2c0f646-8bcb-11e8-a64f-005056b1d7ee</span><br></pre></td></tr></table></figure>

<p><code>--from-file</code>指定的文件，也可以包含多行信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt; EOF &gt; ui.properties</span><br><span class="line">&gt; color.good=purple</span><br><span class="line">&gt; color.bad=yellow</span><br><span class="line">&gt; allow.textmode=<span class="literal">true</span></span><br><span class="line">&gt; how.nice.to.look=fairlyNice</span><br><span class="line">&gt; EOF</span><br><span class="line">$ kubectl create configmap ui-config --from-file=./ui.properties</span><br><span class="line">$ kubectl get configmap/ui-config -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  ui.properties: |    <span class="comment"># 只要有一个文件包含多条信息，就会生成默认以文件名命名的键，整个文件内容（不管内容格式）为值。注意：行尾的“|”符号。</span></span><br><span class="line">    color.good=purple  <span class="comment"># 由于是整个文件内容原封不动照搬，因此这里有等号。</span></span><br><span class="line">    color.bad=yellow</span><br><span class="line">    allow.textmode=<span class="literal">true</span></span><br><span class="line">    how.nice.to.look=fairlyNice</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2018-07-20T03:02:52Z</span><br><span class="line">  name: ui-config</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">"310013"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/ui-config</span><br><span class="line">  uid: 6455dfa6-8bc9-11e8-a64f-005056b1d7ee</span><br></pre></td></tr></table></figure>

<p>可以为加载的文件自定义键：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt; EOF &gt; logging.conf</span><br><span class="line">&gt; class: logging.handlers.RotatingFileHandler</span><br><span class="line">&gt; formatter: precise</span><br><span class="line">&gt; level: INFO</span><br><span class="line">&gt; filename: %hostname-%timestamp.log</span><br><span class="line">&gt; EOF</span><br><span class="line">$ kubectl create configmap logging-conf --from-file=logging=./logging.conf</span><br><span class="line">$ kubectl get configmap/logging-conf -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  logging: |</span><br><span class="line">    class: logging.handlers.RotatingFileHandler</span><br><span class="line">    formatter: precise</span><br><span class="line">    level: INFO</span><br><span class="line">    filename: %hostname-%timestamp.log</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2018-07-20T04:15:03Z</span><br><span class="line">  name: logging-conf</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">"315620"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/logging-conf</span><br><span class="line">  uid: 7a0ed236-8bd3-11e8-a64f-005056b1d7ee</span><br></pre></td></tr></table></figure>

<p>如果<code>--from-file</code>的值是一个目录，则会加载该目录下所有文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir bar</span><br><span class="line">$ <span class="built_in">cd</span> bar</span><br><span class="line">$ <span class="built_in">echo</span> -n example.com &gt; ./baseurl</span><br><span class="line">$ mv ui.properties bar/</span><br><span class="line">$ kubectl create configmap my-config --from-file=bar</span><br><span class="line">$ kubectl get configmap/my-config -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  baseurl: |</span><br><span class="line">    example.com</span><br><span class="line">  ui.properties: |</span><br><span class="line">    color.good=purple</span><br><span class="line">    color.bad=yellow</span><br><span class="line">    allow.textmode=<span class="literal">true</span></span><br><span class="line">    how.nice.to.look=fairlyNice</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2018-07-20T03:38:21Z</span><br><span class="line">  name: my-config</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">"312775"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/my-config</span><br><span class="line">  uid: 59b12c48-8bce-11e8-a64f-005056b1d7ee</span><br></pre></td></tr></table></figure>

<h4 id="通过-from-env-file-1"><a href="#通过-from-env-file-1" class="headerlink" title="通过--from-env-file"></a>通过<code>--from-env-file</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt; EOF &gt; env.txt</span><br><span class="line">config1=xxx</span><br><span class="line">config2=yyy</span><br><span class="line">EOF</span><br><span class="line">$ kubectl create configmap myconfigmap --from-env-file=env.txt</span><br></pre></td></tr></table></figure>

<p>当在同一个命令行中，使用多个<code>--from-env-file</code>时，只有最后一个有效。</p>
<h4 id="通过YAML或JSON文件定义-1"><a href="#通过YAML或JSON文件定义-1" class="headerlink" title="通过YAML或JSON文件定义"></a>通过YAML或JSON文件定义</h4><p>创建ConfigMap的YAML定义文件：myconfigmap.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">myconfigmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">	<span class="attr">config1:</span> <span class="string">xxx</span>   <span class="comment"># 使用明文存储</span></span><br><span class="line">	<span class="attr">config2:</span> <span class="string">yyy</span></span><br></pre></td></tr></table></figure>

<h3 id="使用ConfigMap"><a href="#使用ConfigMap" class="headerlink" title="使用ConfigMap"></a>使用ConfigMap</h3><h4 id="通过卷的方式使用-1"><a href="#通过卷的方式使用-1" class="headerlink" title="通过卷的方式使用"></a>通过卷的方式使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">	  <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">	  <span class="attr">args:</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">sleep</span> <span class="number">10</span><span class="string">;</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line">	  <span class="attr">volumeMounts:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">	    <span class="attr">mountPath:</span> <span class="string">"/etc/foo"</span></span><br><span class="line">	    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">	<span class="attr">volumes:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">	  <span class="attr">configMap:</span></span><br><span class="line">	  	<span class="attr">name:</span> <span class="string">logging-conf</span></span><br></pre></td></tr></table></figure>

<p>则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f mypod.yml</span><br><span class="line">$ ls /etc/foo</span><br><span class="line">logging.conf</span><br><span class="line">$ cat /etc/foo/logging.conf</span><br><span class="line">class: logging.handlers.RotatingFileHandler</span><br><span class="line">formatter: precise</span><br><span class="line">level: INFO</span><br><span class="line">filename: %hostname-%timestamp.log</span><br></pre></td></tr></table></figure>

<p>还可以自定义存放数据的文件名和位置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">  <span class="attr">configMap:</span></span><br><span class="line">  	<span class="attr">name:</span> <span class="string">logging-conf</span></span><br><span class="line">  	<span class="attr">items:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">key:</span> <span class="string">logging.conf</span></span><br><span class="line">  	  <span class="attr">path:</span> <span class="string">myapp/logging.conf</span></span><br></pre></td></tr></table></figure>



<h4 id="通过环境变量方式使用-1"><a href="#通过环境变量方式使用-1" class="headerlink" title="通过环境变量方式使用"></a>通过环境变量方式使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">containers:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">	  <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">	  <span class="attr">args:</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">	  	<span class="bullet">-</span> <span class="string">sleep</span> <span class="number">10</span><span class="string">;</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line">	  <span class="attr">env:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG1</span></span><br><span class="line">	    <span class="attr">valueFrom:</span></span><br><span class="line">	    	<span class="attr">secretKeyRef:</span></span><br><span class="line">	    		<span class="attr">name:</span> <span class="string">myconfigmap</span></span><br><span class="line">	    		<span class="attr">key:</span> <span class="string">config1</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG2</span></span><br><span class="line">	    <span class="attr">valueFrom:</span></span><br><span class="line">	    	<span class="attr">secretKeyRef:</span></span><br><span class="line">	    		<span class="attr">name:</span> <span class="string">myconfigmap</span></span><br><span class="line">	    		<span class="attr">key:</span> <span class="string">config2</span></span><br></pre></td></tr></table></figure>

<h1 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h1><p>DaemonSet部署的Pods副本会分布到每个节点上，并且每个节点最多只能运行一个副本。</p>
<p>典型应用场景：</p>
<ul>
<li>在集群的每个节点上运行存储守护进程，比如ceph。</li>
<li>在每个节点上运行日志收集守护进程，比如logstash。</li>
<li>在每个节点上运行监控守护进程，比如 Prometheus Node Exporter。</li>
</ul>
<h1 id="作业管理"><a href="#作业管理" class="headerlink" title="作业管理"></a>作业管理</h1><p>Job用于完成一次性任务，比如批处理程序，完成后容器就退出。</p>
<p>Job的<code>restartPolicy</code>属性只能设置为<code>Never</code>或<code>OnFailure</code>。</p>
<h2 id="Job的并行性"><a href="#Job的并行性" class="headerlink" title="Job的并行性"></a>Job的并行性</h2><h2 id="定时Job"><a href="#定时Job" class="headerlink" title="定时Job"></a>定时Job</h2><h1 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h1><h2 id="默认健康检查机制"><a href="#默认健康检查机制" class="headerlink" title="默认健康检查机制"></a>默认健康检查机制</h2><p>Kubernetes默认健康检查机制：当容器进程（由Dockerfile的CMD或ENTRYPOINT指定）返回值为非零时，则认为容器发生故障，Kubernetes就会根据<code>restartPolicy</code> 设置重启容器。</p>
<h2 id="Liveness探测"><a href="#Liveness探测" class="headerlink" title="Liveness探测"></a>Liveness探测</h2><p>Liveness探测让用户可以自定义判断容器是否健康的条件。如果探测失败，Kubernetes就会根据<code>restartPolicy</code> 设置重启容器。</p>
<p>Liveness探测是在YAML定义文件中由<code>livenessProbe</code>设置的。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/liveness</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/server</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span>     <span class="string">（默认是HTTP）</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">httpHeaders:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">X-Custom-Header</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Awesome</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>为了执行探测，kubelet向Container中运行的服务器发送HTTP GET请求并侦听端口8080。如果服务器的<code>/healthz</code>路径的处理程序返回成功代码（任何大于或等于200且小于400的代码表示成功，任何其他代码表示失败），则kubelet认为Container是活动的并且健康。如果处理程序返回失败代码，则kubelet会终止Container并重新启动它。 </p>
<p><code>initialDelaySeconds 10</code>表示在开始执行第一次Liveness探测之前等待10秒，通常根据应用的启动时间来设置。</p>
<p><code>periodSeconds 5</code>表示第5秒执行一次Liveness探测。Kubernetes如果连续执行3次Liveness探测均失败，则会杀掉容器，重建并重启容器。</p>
<p>详细使用方式，参见：<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/</a></p>
<h2 id="Readiness探测"><a href="#Readiness探测" class="headerlink" title="Readiness探测"></a>Readiness探测</h2><p>Readiness探测可自定义Kubernetes什么时候可以将容器加入到Service负载均衡池中，对外提供服务。</p>
<p>Readiness的配置方式同Liveness，唯一的区别是使用<code>readinessProbe</code>字段代替<code>livenessProbe</code> 字段。例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">readinessProbe:</span></span><br><span class="line">  <span class="attr">exec:</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>通过<code>cat</code>命令检查<code>/tmp/healthy</code>文件是否存在。如果命令执行成功，返回值为零，则认为本次Readiness探测成功；否则，返回值为非零，本次Readiness探测失败。</p>
<p>Liveness探测和Readiness探测是独立执行的，二者之间没有依赖，因此，可以单独使用，也可以同时使用。</p>
<h1 id="包管理"><a href="#包管理" class="headerlink" title="包管理"></a>包管理</h1><p>Helm之于Kubernetes好比yum之于RHEL，或者apt-get之于Ubuntu，Helm 可以理解为 Kubernetes 的包管理工具 。 </p>
<h2 id="Helm架构"><a href="#Helm架构" class="headerlink" title="Helm架构"></a>Helm架构</h2><p>Helm的基本概念：</p>
<ul>
<li>Chart：Helm的应用打包格式（类似于apt、yum的软件安装包），它由一系列文件组成，这些文件描述了Kubernetes部署应用时所需要的资源。通常将整个chart打包成tar包，而且标注上版本信息，便于Helm部署。</li>
<li>Repository：Chart的存储库。</li>
<li>Release：Chart的运行实例，当Chart被安装到Kubernetes集群，就会生成一个Release。Chart可以多次安装到同一个集群，每次安装都是一个新的Release。例如，如果需要在集群上安装两个MySQL，则可以在群集中运行两个MySQL的Chart，这将运行两个MySQL的Release。</li>
</ul>
<p>Helm包括两个组件，Helm客户端和Tiller服务端。 </p>
<p>Helm客户端是终端用户使用的命令行工具。Tiller服务端运行在Kubernetes集群中，它会处理Helm客户端的请求，与Kubernetes API Server交互。简单地讲，Helm客户端负责管理Chart，Tiller服务端负责管理Release。</p>
<p><img src="Kubernetes/Helm%E6%9E%B6%E6%9E%84.jpg" alt="Helm架构"></p>
<h2 id="安装Helm"><a href="#安装Helm" class="headerlink" title="安装Helm"></a>安装Helm</h2><h3 id="Helm客户端安装"><a href="#Helm客户端安装" class="headerlink" title="Helm客户端安装"></a>Helm客户端安装</h3><p>通常将Helm客户端安装在能够执行<code>kubectl</code>命令的节点上。</p>
<p>下载相应版本Helm：<a href="https://github.com/helm/helm/releases" target="_blank" rel="noopener">https://github.com/helm/helm/releases</a></p>
<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://storage.googleapis.com/kubernetes-helm/helm-v2.9.1-linux-amd64.tar.gz</span><br><span class="line">$ tar -zxvf helm-v2.9.1-linux-amd64.tar.gz</span><br><span class="line">$ mv linux-amd64/helm /usr/<span class="built_in">local</span>/bin/helm</span><br><span class="line">$ helm <span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<p>为了提高使用命令行的效率，建议安装helm的bash命令补全脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm completion bash &gt; .helmrc</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"source .helmrc"</span> &gt;&gt; .bashrc</span><br></pre></td></tr></table></figure>

<h3 id="Tiller服务器安装"><a href="#Tiller服务器安装" class="headerlink" title="Tiller服务器安装"></a>Tiller服务器安装</h3><p>Tiller是Helm的服务器部分，通常在您的Kubernetes集群内部运行。但是为了开发，它也可以在本地运行，并配置为与远程Kubernetes集群通信。</p>
<p>安装Tiller只需要：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm init</span><br></pre></td></tr></table></figure>

<p>Tiller本身也是作为容器化应用运行在Kubernetes集群上。 </p>
<p>上面的默认安装，将Tiller安装在<code>kubectl config view</code>或<code>kubectl config current-context</code>所指定的集群内，并且安装在<code>kube--system</code>命名空间中。可以使用<code>--kube-context</code>选项指定特定的集群，使用<code>--tiller-namespace</code>选项指定要安装到哪个命名空间，使用<code>--tiller-image</code>选项指定Tiller的特定镜像。</p>
<p>默认情况下，安装Tiller时，它没有启用身份验证。 </p>
<p>可以使用<code>kubectl get</code>命令来查看Tiller的Pod、Service、Deployment等信息。</p>
<blockquote>
<p>安装过程中，会从<code>gcr.io/kubernetes-helm/tiller</code>拉取镜像。如果由于网络问题无法访问镜像地址，则可以通过<code>-i</code>或<code>--tiller-image</code>选项自己指定tiller镜像。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm init --upgrade -i fishead/gcr.io.kubernetes-helm.tiller:v2.9.1</span><br></pre></td></tr></table></figure>

<p>如果是首次安装，可以省略<code>--upgrade</code>选项。</p>
</blockquote>
<h4 id="基于角色的访问控制"><a href="#基于角色的访问控制" class="headerlink" title="基于角色的访问控制"></a>基于角色的访问控制</h4><p>如果您的群集启用了基于角色的访问控制（RBAC），则可能需要先配置服务帐户和角色，然后才能继续使用Helm完成各种操作。</p>
<h5 id="管理整个集群资源"><a href="#管理整个集群资源" class="headerlink" title="管理整个集群资源"></a>管理整个集群资源</h5><p>首先，要为Tiller创建一个服务帐户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create serviceaccount tiller --namespace kube-system</span><br></pre></td></tr></table></figure>

<p>然后，将服务帐户<code>tiller</code>绑定到集群角色<code>cluster-admin</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br></pre></td></tr></table></figure>

<p>上面两步，也可以使用YAML定义文件创建：rbac-config.yaml </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>

<p>然后，执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f rbac-config.yaml</span><br></pre></td></tr></table></figure>

<p>创建完成服务帐户和集群角色绑定后，如果这时Tiller服务器还没安装，则使用下列命令安装Tiller服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm init --service-account tiller</span><br></pre></td></tr></table></figure>

<p>如果已经安装过Tiller服务器，则需要将服务帐户添加到<code>tiller-deploy</code>中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl patch deployments/tiller-deploy -n kube-system -p <span class="string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span></span><br></pre></td></tr></table></figure>

<h5 id="限制Tiller只管理某个命名空间的资源"><a href="#限制Tiller只管理某个命名空间的资源" class="headerlink" title="限制Tiller只管理某个命名空间的资源"></a>限制Tiller只管理某个命名空间的资源</h5><p>在上面的示例中，我们为Tiller提供了对整个群集的管理访问权限。您根本不需要授予Tiller <code>cluster-admin</code>访问权限。您可以指定Role和RoleBinding来将Tiller的范围限制到特定的命名空间，而不是指定ClusterRole或ClusterRoleBinding。</p>
<p>假设，我们希望Tiller只能管理<code>tiller-world</code>命名空间下的所有资源，则在该命名空间下创建一个服务帐户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create serviceaccount tiller --namespace tiller-world</span><br></pre></td></tr></table></figure>

<p>然后，定义一个角色，允许Tiller管理<code>tiller-world</code>中的所有资源。例如：role-tiller.yaml </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">tiller-world</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">["",</span> <span class="string">"batch"</span><span class="string">,</span> <span class="string">"extensions"</span><span class="string">,</span> <span class="string">"apps"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["*"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["*"]</span></span><br></pre></td></tr></table></figure>

<p> 创建<code>tiller-manager</code>角色：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f role-tiller.yaml</span><br></pre></td></tr></table></figure>

<p>接着将<code>tiller-manager</code>角色与之前创建的服务帐户<code>tiller</code>绑定：rolebinding-tiller.yaml </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller-binding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">tiller-world</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">tiller-world</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller-manager</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<p>创建<code>tiller-binding</code>绑定：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f rolebinding-tiller.yaml</span><br></pre></td></tr></table></figure>

<p>之后，可以使用该服务帐户和命名空间安装Tiller服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm init --service-account tiller --tiller-namespace tiller-world</span><br></pre></td></tr></table></figure>

<p>在安装Chart时，也要指定命名空间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm install nginx --tiller-namespace tiller-world --namespace tiller-world</span><br></pre></td></tr></table></figure>

<h5 id="准许Tiller对其他命名资源的管理"><a href="#准许Tiller对其他命名资源的管理" class="headerlink" title="准许Tiller对其他命名资源的管理"></a>准许Tiller对其他命名资源的管理</h5><p>假设，我们在命名空间<code>myorg-system</code>中安装Tiller，并允许Tiller在命名空间<code>myorg-users</code>中部署资源。</p>
<h4 id="升级Tiller"><a href="#升级Tiller" class="headerlink" title="升级Tiller"></a>升级Tiller</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm init --upgrade</span><br></pre></td></tr></table></figure>

<h4 id="卸载Tiller"><a href="#卸载Tiller" class="headerlink" title="卸载Tiller"></a>卸载Tiller</h4><p>由于Tiller将其数据存储在Kubernetes ConfigMaps中，因此您可以安全地删除并重新安装Tiller，而无需担心丢失任何数据。删除Tiller的推荐方法是使用<code>kubectl delete deployment tiller-deploy --namespace kube-system</code>，或更简洁的<code>helm reset</code>（如果已经有Releases被安装，或者Tiller未安装成功，则还要加上<code>-f</code>选项）。 </p>
<h3 id="使用TLS-SSL保护Helm"><a href="#使用TLS-SSL保护Helm" class="headerlink" title="使用TLS/SSL保护Helm"></a>使用TLS/SSL保护Helm</h3><h4 id="为Tiller创建证书"><a href="#为Tiller创建证书" class="headerlink" title="为Tiller创建证书"></a>为Tiller创建证书</h4><p>创建证书签名请求：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; tiller-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"tiller-server"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"172.16.160.121"</span>,</span><br><span class="line">    <span class="string">"172.16.160.122"</span>,</span><br><span class="line">    <span class="string">"172.16.160.123"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Fujian"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Xiamen"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Maks"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成证书和私钥：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert -ca=/etc/kubernetes/cert/ca.pem \</span><br><span class="line">  -ca-key=/etc/kubernetes/cert/ca-key.pem \</span><br><span class="line">  -config=/etc/kubernetes/cert/ca-config.json \</span><br><span class="line">  -profile=kubernetes tiller-csr.json | cfssljson -bare tiller</span><br></pre></td></tr></table></figure>

<h4 id="为Helm客户端创建证书"><a href="#为Helm客户端创建证书" class="headerlink" title="为Helm客户端创建证书"></a>为Helm客户端创建证书</h4><p>创建证书签名请求：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; helm-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"helm-client"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Fujian"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Xiamen"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Maks"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成证书和私钥：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert -ca=/etc/kubernetes/cert/ca.pem \</span><br><span class="line">  -ca-key=/etc/kubernetes/cert/ca-key.pem \</span><br><span class="line">  -config=/etc/kubernetes/cert/ca-config.json \</span><br><span class="line">  -profile=kubernetes helm-csr.json | cfssljson -bare helm</span><br></pre></td></tr></table></figure>

<h4 id="使用SSL配置安装Tiller"><a href="#使用SSL配置安装Tiller" class="headerlink" title="使用SSL配置安装Tiller"></a>使用SSL配置安装Tiller</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm init --tiller-tls --tiller-tls-cert ./tiller.pem --tiller-tls-key ./tiller-key.pem --tiller-tls-verify --tls-ca-cert ca.pem --service-account tiller</span><br></pre></td></tr></table></figure>

<h4 id="使用SSL配置Helm客户端"><a href="#使用SSL配置Helm客户端" class="headerlink" title="使用SSL配置Helm客户端"></a>使用SSL配置Helm客户端</h4><p>方式一：每条helm命令都带上SSL配置。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm ls --tls --tls-ca-cert ca.pem --tls-cert helm.pem --tls-key helm-key.pem</span><br></pre></td></tr></table></figure>

<p>方式二：</p>
<p>将Helm证书和私钥复制到<code>$HELM_HOME</code>（通常为<code>~/.helm</code>）下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cp ca.pem <span class="variable">$HELM_HOME</span>/ca.pem</span><br><span class="line">$ cp helm.pem <span class="variable">$HELM_HOME</span>/cert.pem</span><br><span class="line">$ cp helm-key.pem <span class="variable">$HELM_HOME</span>/key.pem</span><br></pre></td></tr></table></figure>

<p>这样，每条需要与Tiller交互的helm命令都要带上<code>--tls</code>选项（启用TLS/SSL）即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm ls --tls</span><br></pre></td></tr></table></figure>

<p>如果在执行Helm命令时，出现“unable to do port forwarding: socat not found”，则表示缺少socat软件包。执行下列命令安装（CentOS）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install socat</span><br></pre></td></tr></table></figure>

<h2 id="使用Helm"><a href="#使用Helm" class="headerlink" title="使用Helm"></a>使用Helm</h2><h3 id="查看帮助"><a href="#查看帮助" class="headerlink" title="查看帮助"></a>查看帮助</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm --<span class="built_in">help</span></span><br><span class="line">$ helm init -h</span><br></pre></td></tr></table></figure>

<h3 id="查找可用的Chart"><a href="#查找可用的Chart" class="headerlink" title="查找可用的Chart"></a>查找可用的Chart</h3><p>查看当前可安装的Chart：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm search</span><br></pre></td></tr></table></figure>

<p>关键字搜索Chart：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm search mysql</span><br></pre></td></tr></table></figure>

<h3 id="查看Chart详情"><a href="#查看Chart详情" class="headerlink" title="查看Chart详情"></a>查看Chart详情</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm inspect stable/mariadb</span><br><span class="line">$ helm inspect values stable/mariabd     <span class="comment"># 查看Chart的values.yaml的内容</span></span><br></pre></td></tr></table></figure>

<h3 id="安装Chart"><a href="#安装Chart" class="headerlink" title="安装Chart"></a>安装Chart</h3><p>例如通过官方存储库安装mysql：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo update              <span class="comment"># Make sure we get the latest list of charts</span></span><br><span class="line">$ helm install stable/mysql</span><br></pre></td></tr></table></figure>

<p>helm会自动为新创建的Release提供一个名字。如果希望自己指定Release名字，则可以加上<code>--name</code>选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm install stable/mysql --name mysql-release</span><br></pre></td></tr></table></figure>

<p>一旦安装了某个Chart，就可以在<code>~/.helm/cache/archive/</code>中找到该Chart的tar包。</p>
<p>可以通过<code>--namespace</code>选项来指定将Release发布到哪个Kubernetes命名空间中。</p>
<p>可以通过<code>--version</code>选项选择特定的Chart版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm install stable/mysql --version 0.8.2</span><br></pre></td></tr></table></figure>

<p>没指定<code>--version</code>选项，则选择最新版本的Chart。</p>
<p>除了通过官方Chart存储库安装Chart外，Helm还支持如下安装：</p>
<p>通过tar包安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm install ./nginx-1.2.3.tgz   <span class="comment"># 使用本地的tar包安装</span></span><br><span class="line">$ helm install https://example.com/charts/nginx-1.2.3.tgz   <span class="comment"># 通过远程tar包安装</span></span><br></pre></td></tr></table></figure>

<p>通过本地Chart目录安装 ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm install ./nginx</span><br></pre></td></tr></table></figure>



<h3 id="列出已安装的Release"><a href="#列出已安装的Release" class="headerlink" title="列出已安装的Release"></a>列出已安装的Release</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ helm ls</span><br><span class="line">或者</span><br><span class="line">$ helm list</span><br></pre></td></tr></table></figure>

<h3 id="查看Release的状态"><a href="#查看Release的状态" class="headerlink" title="查看Release的状态"></a>查看Release的状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm status mysql-release</span><br></pre></td></tr></table></figure>

<h3 id="更新Release"><a href="#更新Release" class="headerlink" title="更新Release"></a>更新Release</h3><p>Release发布后可以执行<code>helm upgrade</code>对其进行升级：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm upgrade --<span class="built_in">set</span> imageTag=5.7.15 mysql-release stable/mysql</span><br></pre></td></tr></table></figure>

<h3 id="列出Release的所有修订历史"><a href="#列出Release的所有修订历史" class="headerlink" title="列出Release的所有修订历史"></a>列出Release的所有修订历史</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm <span class="built_in">history</span> mysql-release</span><br></pre></td></tr></table></figure>

<h3 id="回滚Release"><a href="#回滚Release" class="headerlink" title="回滚Release"></a>回滚Release</h3><p>通过<code>helm rollback</code>可以回滚到上面<code>helm histroy</code>列出的任意修订版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm rollback mysql-release 1</span><br></pre></td></tr></table></figure>

<h3 id="删除Release"><a href="#删除Release" class="headerlink" title="删除Release"></a>删除Release</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm delete mysql-release</span><br></pre></td></tr></table></figure>

<h2 id="Charts"><a href="#Charts" class="headerlink" title="Charts"></a>Charts</h2><p>Chart是Helm的应用打包格式，它由一系列文件组成，通常整个Chart被打成tar包。这些文件描述了Kubernetes部署应用时所需要的资源，比如 Service、Deployment、PersistentVolumeClaim、Secret、ConfigMap等。</p>
<p>Chart可以非常简单，只用于部署一个服务；也可以非常复杂，部署整个应用。</p>
<h3 id="Chart目录结构"><a href="#Chart目录结构" class="headerlink" title="Chart目录结构"></a>Chart目录结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">├── charts&#x2F;              # 可选：包含该Chart所依赖的其他Chart的目录</span><br><span class="line">├── Chart.yaml           # 包含该Chart信息的YAML文件</span><br><span class="line">├── LICENSE              # 可选：包含该Chart许可信息的文本文件</span><br><span class="line">├── README.md            # 可选：一个人类可读的README文件</span><br><span class="line">├── requirements.yaml    # 可选：列出该Chart依赖的YAML文件</span><br><span class="line">├── templates            # 包含Kubernetes manifest文件的模板</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl     # 包含子模板的定义</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt        # 可选：该Chart的简易使用文档</span><br><span class="line">│   └── service.yaml</span><br><span class="line">└── values.yaml          # 包含该Chart默认配置值</span><br></pre></td></tr></table></figure>

<p>除了上述列出的文件外，其他任何文件或目录将保留原样。</p>
<h3 id="创建Chart"><a href="#创建Chart" class="headerlink" title="创建Chart"></a>创建Chart</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm create mychart</span><br></pre></td></tr></table></figure>

<p>Chart.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">The</span> <span class="string">chart</span> <span class="string">API</span> <span class="string">version,</span> <span class="string">always</span> <span class="string">"v1"</span> <span class="string">(required)</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">The</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">chart</span> <span class="string">(required)</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">A</span> <span class="string">SemVer</span> <span class="number">2</span> <span class="string">version</span> <span class="string">(https://semver.org/，required)</span></span><br><span class="line"><span class="attr">kubeVersion:</span> <span class="string">A</span> <span class="string">SemVer</span> <span class="string">range</span> <span class="string">of</span> <span class="string">compatible</span> <span class="string">Kubernetes</span> <span class="string">versions</span> <span class="string">(optional)</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">single-sentence</span> <span class="string">description</span> <span class="string">of</span> <span class="string">this</span> <span class="string">project</span> <span class="string">(optional)</span></span><br><span class="line"><span class="attr">keywords:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">A</span> <span class="string">list</span> <span class="string">of</span> <span class="string">keywords</span> <span class="string">about</span> <span class="string">this</span> <span class="string">project</span> <span class="string">(optional)</span></span><br><span class="line"><span class="attr">home:</span> <span class="string">The</span> <span class="string">URL</span> <span class="string">of</span> <span class="string">this</span> <span class="string">project's</span> <span class="string">home</span> <span class="string">page</span> <span class="string">(optional)</span></span><br><span class="line"><span class="attr">sources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">A</span> <span class="string">list</span> <span class="string">of</span> <span class="string">URLs</span> <span class="string">to</span> <span class="string">source</span> <span class="string">code</span> <span class="string">for</span> <span class="string">this</span> <span class="string">project</span> <span class="string">(optional)</span></span><br><span class="line"><span class="attr">maintainers:</span> <span class="comment"># (optional)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">The</span> <span class="string">maintainer's</span> <span class="string">name</span> <span class="string">(required</span> <span class="string">for</span> <span class="string">each</span> <span class="string">maintainer)</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">The</span> <span class="string">maintainer's</span> <span class="string">email</span> <span class="string">(optional</span> <span class="string">for</span> <span class="string">each</span> <span class="string">maintainer)</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">A</span> <span class="string">URL</span> <span class="string">for</span> <span class="string">the</span> <span class="string">maintainer</span> <span class="string">(optional</span> <span class="string">for</span> <span class="string">each</span> <span class="string">maintainer)</span></span><br><span class="line"><span class="attr">engine:</span> <span class="string">gotpl</span> <span class="comment"># The name of the template engine (optional, defaults to gotpl)</span></span><br><span class="line"><span class="attr">icon:</span> <span class="string">A</span> <span class="string">URL</span> <span class="string">to</span> <span class="string">an</span> <span class="string">SVG</span> <span class="string">or</span> <span class="string">PNG</span> <span class="string">image</span> <span class="string">to</span> <span class="string">be</span> <span class="string">used</span> <span class="string">as</span> <span class="string">an</span> <span class="string">icon</span> <span class="string">(optional).</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">The</span> <span class="string">version</span> <span class="string">of</span> <span class="string">the</span> <span class="string">app</span> <span class="string">that</span> <span class="string">this</span> <span class="string">contains</span> <span class="string">(optional).</span> <span class="string">This</span> <span class="string">needn't</span> <span class="string">be</span> <span class="string">SemVer.</span></span><br><span class="line"><span class="attr">deprecated:</span> <span class="string">Whether</span> <span class="string">this</span> <span class="string">chart</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">(optional,</span> <span class="string">boolean)</span></span><br><span class="line"><span class="attr">tillerVersion: The version of Tiller that this chart requires. This should be expressed as a SemVer range:</span> <span class="string">"&gt;2.0.0"</span> <span class="string">(optional)</span></span><br></pre></td></tr></table></figure>

<h3 id="Chart依赖"><a href="#Chart依赖" class="headerlink" title="Chart依赖"></a>Chart依赖</h3><p>在Helm中，一个Chart可能依赖于任意多的其他Charts。这些依赖项可以通过<code>requirements.yaml</code>文件动态链接，或者将依赖的Charts复制到<code>charts/</code>目录并手动管理。 推荐使用<code>requirements.yaml</code>文件来声明依赖项。</p>
<p>在安装过程中，依赖的Charts也会被一起安装。</p>
<h4 id="使用requirements-yaml文件管理依赖（推荐）"><a href="#使用requirements-yaml文件管理依赖（推荐）" class="headerlink" title="使用requirements.yaml文件管理依赖（推荐）"></a>使用<code>requirements.yaml</code>文件管理依赖（推荐）</h4><p>requirements.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.2</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">http://example.com/charts</span>    <span class="comment"># Note that you must also use "helm repo add" to add that repo locally.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">3.2</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">http://another.example.com/charts</span></span><br></pre></td></tr></table></figure>

<p>一旦配置了依赖项，就可以运行 <code>helm dependency update</code> ，它将根据<code>requirements.yaml</code> 上的配置，自动将所有依赖的Charts下载到<code>charts/</code> 目录中。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">├── charts&#x2F;</span><br><span class="line">│   ├── apache-1.2.3.tgz</span><br><span class="line">│   └── mysql-3.2.1.tgz</span><br></pre></td></tr></table></figure>

<h4 id="通过charts-目录手动管理依赖"><a href="#通过charts-目录手动管理依赖" class="headerlink" title="通过charts/目录手动管理依赖"></a>通过<code>charts/</code>目录手动管理依赖</h4><p>直接将Chart需要的依赖Charts复制到<code>charts/</code>即可。依赖Charts可以是Chart存档（如foo-1.2.3.tgz）或解压缩的Chart目录。但它的名称不能以<code>_</code>或<code>..</code>开头，Chart加载器会忽略这些文件。 </p>
<p>要将依赖项下载到<code>charts/</code>目录中，可使用<code>helm fetch</code>命令。</p>
<h3 id="Chart的模板"><a href="#Chart的模板" class="headerlink" title="Chart的模板"></a>Chart的模板</h3><p>Chart的所有模板文件保存在<code>templates/</code>目录中，Helm通过这些模板文件来创建Kubernetes的资源定义文件。</p>
<p>在Chart模板文件中使用形如<code></code>的<a href="https://golang.org/pkg/text/template/" target="_blank" rel="noopener">Go模板语言</a>来编写。</p>
<p>下面是一个<code>ReplicationController</code>的模板文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deis-database</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">deis</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">heritage:</span> <span class="string">deis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">deis-database</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">deis-database</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">deis-database</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deis-database</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">&#123;&#123;.Values.imageRegistry&#125;&#125;/postgres:&#123;&#123;.Values.dockerTag&#125;&#125;</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">&#123;&#123;.Values.pullPolicy&#125;&#125;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_STORAGE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#123;&#123;default</span> <span class="string">"minio"</span> <span class="string">.Values.storage&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="预定义对象"><a href="#预定义对象" class="headerlink" title="预定义对象"></a>预定义对象</h4><h5 id="自定义值"><a href="#自定义值" class="headerlink" title="自定义值"></a>自定义值</h5><p>在模板中，可以通过<code>.Values</code>对象可访问如下方式提供的自定义值：</p>
<ul>
<li><p>通过<code>values.yaml</code> 定义的属性。（优先级最低，通常用于提供默认值）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imageRegistry:</span> <span class="string">"quay.io/deis"</span></span><br><span class="line"><span class="attr">dockerTag:</span> <span class="string">"latest"</span></span><br><span class="line"><span class="attr">pullPolicy:</span> <span class="string">"Always"</span></span><br><span class="line"><span class="attr">storage:</span> <span class="string">"s3"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>-f</code>或<code>--values</code>选项，为命令<code>helm install</code>或<code>helm upgrade</code>指定一个YAML文件。它定义的属性将覆盖<code>values.yaml</code>中的同名定义。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm install -f myvalues.yaml -f override.yaml stable/redis</span><br></pre></td></tr></table></figure>

<p>如果在同一条命令中，多次使用<code>-f</code>指定YAML文件，则这些自己指定的YAML文件将与默认的<code>values.yaml</code>合并。并且在多个YAML文件中重复出现的属性，越后面的指定的优先级越高，而<code>values.yaml</code>优先级总是最低的。</p>
</li>
<li><p>通过使用<code>--set</code>或<code>--set-string</code>选项定义的属性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm install --<span class="built_in">set</span>-string long_int=1234567890 ./redis</span><br><span class="line">$ helm upgrade --<span class="built_in">set</span> foo=bar --<span class="built_in">set</span> foo=newbar redis ./redis</span><br></pre></td></tr></table></figure>

<p><code>--set-string</code>选项强制参数值是字符串。</p>
<p>如果在同一条命令中，多次使用<code>--set</code>或<code>--set-string</code>选项指定YAML文件，则越后面的指定的优先级越高。</p>
<h6 id="值的作用域"><a href="#值的作用域" class="headerlink" title="值的作用域"></a>值的作用域</h6><p>假设下面是<code>WordPress</code>Chart的<code>values.yaml</code>文件，并且<code>WordPress</code>Chart依赖于<code>mysql</code>Chart和<code>apache</code>Chart。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">title:</span> <span class="string">"My WordPress Site"</span>   <span class="comment"># 只有WordPress Chart才能访问（通过“.Values.title”访问）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">global:</span>  <span class="comment"># 这是全局属性，可以被WordPress及它的依赖Chart所访问（通过“.Values.global.app”）</span></span><br><span class="line">  <span class="attr">app:</span> <span class="string">MyWordPress</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysql:</span>  <span class="comment"># mysql Chart只能访问这一命名空间下的属性（例如“.Values.password”），WordPress Chart也可以访问该命名空间下的属性（例如“.Values.mysql.password”）。</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">AnotherWordPress</span></span><br><span class="line">  <span class="attr">max_connections:</span> <span class="number">100</span> </span><br><span class="line">  <span class="attr">password:</span> <span class="string">"secret"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apache:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>父级Chart定义的全局属性优先于子级Chart定义的全局属性。也就是说全局属性只能向下传递。因此，通过<code>.Values.global.app</code>总是<code>MyWordPress</code>。</p>
</li>
</ul>
<h5 id="Release对象"><a href="#Release对象" class="headerlink" title="Release对象"></a>Release对象</h5><ul>
<li><code>.Release.Name</code>：Release的名称。</li>
<li><code>.Release.Time</code> ：Release最后更新时间，这将匹配Release对象上的Last Released时间 。</li>
<li><code>.Release.Namespace</code>：Release所在的命名空间。</li>
<li><code>.Release.Service</code>：管理该Release的服务，通常这是Tiller。</li>
<li><code>.Release.IsUpgrade</code>：如果当前操作是升级或回滚，则设置为true。 </li>
<li><code>.Release.IsInstall</code>：如果当前操作是安装，则设置为true。</li>
<li><code>.Release.Revision</code>：Release的修订号。它从1开始，随着每次<code>helm upgrade</code>的执行而递增。 </li>
</ul>
<h5 id="Chart对象"><a href="#Chart对象" class="headerlink" title="Chart对象"></a>Chart对象</h5><p><code>.Chart</code>对象用于访问<code>Chart.yaml</code>中定义的属性。例如：<code>.Chart.Version</code>。</p>
<blockquote>
<p>自定义属性要放在<code>values.yaml</code>中，而不是<code>Chart.yaml</code>中。在<code>Chart.yaml</code>中只能放置Helm预定义的属性，所有未知属性将被忽略。</p>
</blockquote>
<h5 id="File对象"><a href="#File对象" class="headerlink" title="File对象"></a>File对象</h5><h5 id="Capabilities对象"><a href="#Capabilities对象" class="headerlink" title="Capabilities对象"></a>Capabilities对象</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;.Capabilities.KubeVersion&#125;&#125;：用于访问Kubernetes版本。</span><br><span class="line"></span><br><span class="line">&#123;&#123;.Capabilities.TillerVersion&#125;&#125;：用于访问Tiller版本。</span><br><span class="line"></span><br><span class="line">&#123;&#123;Capabilities.APIVersions.Has &quot;batch&#x2F;v1&quot;&#125;&#125;：用于访问Kubernetes API版本。</span><br></pre></td></tr></table></figure>

<h4 id="子模板"><a href="#子模板" class="headerlink" title="子模板"></a>子模板</h4><p>如果存在一些信息多个模板都会用到，则可在<code>templates/_helpers.tpl</code>中将其定义为子模板，然后通过<code>templates</code>函数引用。</p>
<p>service.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"mychart.fullname"</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"mychart.name"</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"mychart.chart"</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">heritage:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Service</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.type</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"mychart.name"</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>_helpers.tpl：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x2F;* vim: set filetype&#x3D;mustache: *&#x2F;&#125;&#125;</span><br><span class="line">&#123;&#123;&#x2F;*</span><br><span class="line">Expand the name of the chart.</span><br><span class="line">*&#x2F;&#125;&#125;</span><br><span class="line">&#123;&#123;- define &quot;mychart.name&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix &quot;-&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;&#x2F;*</span><br><span class="line">Create a default fully qualified app name.</span><br><span class="line">We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).</span><br><span class="line">If release name contains chart name it will be used as a full name.</span><br><span class="line">*&#x2F;&#125;&#125;</span><br><span class="line">&#123;&#123;- define &quot;mychart.fullname&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- if .Values.fullnameOverride -&#125;&#125;</span><br><span class="line">&#123;&#123;- .Values.fullnameOverride | trunc 63 | trimSuffix &quot;-&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- else -&#125;&#125;</span><br><span class="line">&#123;&#123;- $name :&#x3D; default .Chart.Name .Values.nameOverride -&#125;&#125;</span><br><span class="line">&#123;&#123;- if contains $name .Release.Name -&#125;&#125;</span><br><span class="line">&#123;&#123;- .Release.Name | trunc 63 | trimSuffix &quot;-&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- else -&#125;&#125;</span><br><span class="line">&#123;&#123;- printf &quot;%s-%s&quot; .Release.Name $name | trunc 63 | trimSuffix &quot;-&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;&#x2F;*</span><br><span class="line">Create chart name and version as used by the chart label.</span><br><span class="line">*&#x2F;&#125;&#125;</span><br><span class="line">&#123;&#123;- define &quot;mychart.chart&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- printf &quot;%s-%s&quot; .Chart.Name .Chart.Version | replace &quot;+&quot; &quot;_&quot; | trunc 63 | trimSuffix &quot;-&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调试Chart"><a href="#调试Chart" class="headerlink" title="调试Chart"></a>调试Chart</h3><p><code>helm lint</code>用于检查Chart的所有工件语法是否正确：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm lint ./mychart</span><br></pre></td></tr></table></figure>

<p><code>helm install --dry-run --debug</code>会模拟安装Chart，并输出每个模板生成的YAML文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm install --dry-run --debug mychart</span><br></pre></td></tr></table></figure>

<h3 id="打包Chart"><a href="#打包Chart" class="headerlink" title="打包Chart"></a>打包Chart</h3><p>存储库中的包名：<code>Chart名称-版本.tgz</code>。 例如：<code>nginx-1.2.3.tgz</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm package ./nginx</span><br></pre></td></tr></table></figure>

<p>该命令也会自动将生成的<code>nginx-1.2.3.tgz</code>添加到<code>local</code>存储库中。</p>
<h3 id="Chart存储库"><a href="#Chart存储库" class="headerlink" title="Chart存储库"></a>Chart存储库</h3><p>Helm安装时已经默认配置好了两个存储库：stable和local。stable是官方存储库，local是用户本地存储库（位于<code>~/.helm/repository/local</code> 下）。</p>
<h4 id="搭建自己的Chart存储库"><a href="#搭建自己的Chart存储库" class="headerlink" title="搭建自己的Chart存储库"></a>搭建自己的Chart存储库</h4><p>任何HTTP Server都可以用作Chart的存储库。例如：（假设位于节点：192.168.56.106）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /var/www</span><br><span class="line">$ docker run -d -p 8080:80 -v /var/www:/usr/<span class="built_in">local</span>/apache2/htdocs/ httpd</span><br></pre></td></tr></table></figure>

<p>然后，通过执行<code>helm repo index</code>生成存储库的<code>index.yaml</code>文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir myrepo</span><br><span class="line">$ mv mychart-0.1.0.tgz myrepo/</span><br><span class="line">$ helm repo index myrepo/ --url http://192.168.56.106:8080/charts</span><br></pre></td></tr></table></figure>

<p>Helm会扫描<code>myrepo</code>目录中所有tgz包并生成<code>index.yaml</code> （记录了当前仓库中所有Chart信息）。<code>--url</code>指定新存储库的访问路径。</p>
<p>接着，将<code>myrepo</code>目录下的所有tgz包和<code>index.yaml</code>文件上传到<code>192.168.56.106</code>服务器的<code>/var/www/charts</code>目录下。</p>
<h4 id="向Helm注册Chart存储库"><a href="#向Helm注册Chart存储库" class="headerlink" title="向Helm注册Chart存储库"></a>向Helm注册Chart存储库</h4><p>用户可以通过<code>helm repo add</code>向Helm添加更多存储库，比如企业私有存储库等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add newrepo http://192.168.56.106:8080/charts</span><br></pre></td></tr></table></figure>

<h4 id="列出所有已注册的Chart存储库"><a href="#列出所有已注册的Chart存储库" class="headerlink" title="列出所有已注册的Chart存储库"></a>列出所有已注册的Chart存储库</h4><p>可以通过<code>helm repo list</code>查看所有已经向Helm注册的Chart存储库。（所有Chart存储库的本地缓存位置是<code>~/.helm/repository/cache</code> 下）</p>
<h4 id="安装新存储库中的Chart"><a href="#安装新存储库中的Chart" class="headerlink" title="安装新存储库中的Chart"></a>安装新存储库中的Chart</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ helm install newrepo/mychart</span><br><span class="line">或者</span><br><span class="line">$ helm install --repo http://192.168.56.106:8080/charts/ mychart   <span class="comment"># 该方法无需先注册Chart存储库</span></span><br></pre></td></tr></table></figure>

<h4 id="向存储库中添加新的Chart"><a href="#向存储库中添加新的Chart" class="headerlink" title="向存储库中添加新的Chart"></a>向存储库中添加新的Chart</h4><p>以后只要向存储库上传新的Chart，那么用<code>helm repo update</code>更新一下存储库的<code>index.yaml</code>即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo update</span><br></pre></td></tr></table></figure>

<h1 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h1><p>Kubernetes Dashboard是一个基于Web的应用，它提供了kubectl的绝大部分功能。</p>
<blockquote>
<p>安装成功后：</p>
<ol>
<li>需要将根证书 ca.pem 导入<strong>客户</strong>操作系统（不是Kubernetes集群服务器），并设置永久信任。这样，通过HTTPS访问Dashboard时，就不会出现“不安全”警告。</li>
<li>同时为自己的浏览器（不是在Kubernetes集群服务器）生成一个 client 证书，并导入该证书。这样，通过浏览器访问Dashboard时，就不会出现”401 Unauthorized“提示。</li>
</ol>
<p>可以通过<code>kubectl cluster-info</code>来获取Kubernetes Dashboard的访问地址。</p>
<p>用浏览器打开Kubernetes Dashboard的访问地址后，选择使用token 或 kubeconfig 进行登陆。</p>
</blockquote>
<h1 id="集群监控"><a href="#集群监控" class="headerlink" title="集群监控"></a>集群监控</h1><h2 id="Metrics-Server"><a href="#Metrics-Server" class="headerlink" title="Metrics Server"></a>Metrics Server</h2><p>K8S从1.8版本开始，CPU、内存等资源的指标信息可以通过 Metrics API来获取，用户可以直接获取这些指标信息（例如通过执行kubect top命令），HPA使用这些metics信息来实现动态伸缩。 </p>
<p><a href="https://github.com/kubernetes-incubator/metrics-server" target="_blank" rel="noopener">Metrics Server</a> 实现了Resource Metrics API，是集群范围资源使用数据的聚合器，它从每个节点上的 Kubelet Summary API 中采集指标信息。 </p>
<blockquote>
<p>原来的Heapster已经废弃。</p>
</blockquote>
<h2 id="Prometheus-Operator"><a href="#Prometheus-Operator" class="headerlink" title="Prometheus Operator"></a>Prometheus Operator</h2><h1 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h1><h1 id="Istio"><a href="#Istio" class="headerlink" title="Istio"></a>Istio</h1><h1 id="Deis"><a href="#Deis" class="headerlink" title="Deis"></a>Deis</h1><p><a href="https://deis.com/" target="_blank" rel="noopener">Deis</a> 是一个Kubernetes的原生PaaS。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/1-11/" rel="tag"># 1.11</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/06/26/C/" rel="prev" title="C">
      <i class="fa fa-chevron-left"></i> C
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/08/29/Smalltalk/" rel="next" title="Smalltalk">
      Smalltalk <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#入门"><span class="nav-number">2.</span> <span class="nav-text">入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建集群"><span class="nav-number">2.1.</span> <span class="nav-text">创建集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署应用"><span class="nav-number">2.2.</span> <span class="nav-text">部署应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#访问应用"><span class="nav-number">2.3.</span> <span class="nav-text">访问应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展应用"><span class="nav-number">2.4.</span> <span class="nav-text">扩展应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#滚动更新"><span class="nav-number">2.5.</span> <span class="nav-text">滚动更新</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#更新"><span class="nav-number">2.5.1.</span> <span class="nav-text">更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回滚"><span class="nav-number">2.5.2.</span> <span class="nav-text">回滚</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#架构"><span class="nav-number">3.</span> <span class="nav-text">架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes集群"><span class="nav-number">3.1.</span> <span class="nav-text">Kubernetes集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pods"><span class="nav-number">3.2.</span> <span class="nav-text">Pods</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制器——运行Pod"><span class="nav-number">3.3.</span> <span class="nav-text">控制器——运行Pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务——发现Pod"><span class="nav-number">3.4.</span> <span class="nav-text">服务——发现Pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#标签"><span class="nav-number">3.5.</span> <span class="nav-text">标签</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命名空间"><span class="nav-number">3.6.</span> <span class="nav-text">命名空间</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装"><span class="nav-number">4.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Minikube"><span class="nav-number">4.1.</span> <span class="nav-text">Minikube</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubeadm"><span class="nav-number">4.2.</span> <span class="nav-text">kubeadm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定制安装"><span class="nav-number">4.3.</span> <span class="nav-text">定制安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Photon-OS"><span class="nav-number">4.4.</span> <span class="nav-text">使用Photon OS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用kubekit搭建k8s集群"><span class="nav-number">4.5.</span> <span class="nav-text">使用kubekit搭建k8s集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装操作系统"><span class="nav-number">4.5.1.</span> <span class="nav-text">安装操作系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载kubekit"><span class="nav-number">4.5.2.</span> <span class="nav-text">下载kubekit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装并初始化master节点"><span class="nav-number">4.5.3.</span> <span class="nav-text">安装并初始化master节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加一个node"><span class="nav-number">4.5.4.</span> <span class="nav-text">添加一个node</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#网络管理"><span class="nav-number">5.</span> <span class="nav-text">网络管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#网络模型"><span class="nav-number">5.1.</span> <span class="nav-text">网络模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络方案"><span class="nav-number">5.2.</span> <span class="nav-text">网络方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络政策"><span class="nav-number">5.3.</span> <span class="nav-text">网络政策</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Canal"><span class="nav-number">5.4.</span> <span class="nav-text">Canal</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署Canal"><span class="nav-number">5.4.1.</span> <span class="nav-text">部署Canal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用网络政策"><span class="nav-number">5.4.2.</span> <span class="nav-text">应用网络政策</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#集群管理"><span class="nav-number">6.</span> <span class="nav-text">集群管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#应用部署"><span class="nav-number">7.</span> <span class="nav-text">应用部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建部署"><span class="nav-number">7.1.</span> <span class="nav-text">创建部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署定义文件"><span class="nav-number">7.1.1.</span> <span class="nav-text">部署定义文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#删除部署"><span class="nav-number">7.2.</span> <span class="nav-text">删除部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询部署"><span class="nav-number">7.3.</span> <span class="nav-text">查询部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看部署详情"><span class="nav-number">7.4.</span> <span class="nav-text">查看部署详情</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#伸缩部署"><span class="nav-number">7.5.</span> <span class="nav-text">伸缩部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#故障转移"><span class="nav-number">7.6.</span> <span class="nav-text">故障转移</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用标签控制Pod的位置"><span class="nav-number">7.7.</span> <span class="nav-text">用标签控制Pod的位置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#存储管理"><span class="nav-number">8.</span> <span class="nav-text">存储管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#emptyDir卷"><span class="nav-number">8.1.</span> <span class="nav-text">emptyDir卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hostPath卷"><span class="nav-number">8.2.</span> <span class="nav-text">hostPath卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#云存储卷"><span class="nav-number">8.3.</span> <span class="nav-text">云存储卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式存储卷"><span class="nav-number">8.4.</span> <span class="nav-text">分布式存储卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PersistentVolume和PersistentVolumeClaim"><span class="nav-number">8.5.</span> <span class="nav-text">PersistentVolume和PersistentVolumeClaim</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#静态供应"><span class="nav-number">8.5.1.</span> <span class="nav-text">静态供应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态供应"><span class="nav-number">8.5.2.</span> <span class="nav-text">动态供应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回收PV"><span class="nav-number">8.5.3.</span> <span class="nav-text">回收PV</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#服务管理"><span class="nav-number">9.</span> <span class="nav-text">服务管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS访问服务"><span class="nav-number">9.1.</span> <span class="nav-text">DNS访问服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务对Pods的负载均衡"><span class="nav-number">9.2.</span> <span class="nav-text">服务对Pods的负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对外公布服务"><span class="nav-number">9.3.</span> <span class="nav-text">对外公布服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ClusterIP方式"><span class="nav-number">9.3.1.</span> <span class="nav-text">ClusterIP方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NodePort方式"><span class="nav-number">9.3.2.</span> <span class="nav-text">NodePort方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LoadBalancer方式"><span class="nav-number">9.3.3.</span> <span class="nav-text">LoadBalancer方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ExternalName方式"><span class="nav-number">9.3.4.</span> <span class="nav-text">ExternalName方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ingress服务"><span class="nav-number">9.4.</span> <span class="nav-text">Ingress服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置管理"><span class="nav-number">10.</span> <span class="nav-text">配置管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#敏感信息"><span class="nav-number">10.1.</span> <span class="nav-text">敏感信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Secret"><span class="nav-number">10.1.1.</span> <span class="nav-text">创建Secret</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通过-from-literal"><span class="nav-number">10.1.1.1.</span> <span class="nav-text">通过--from-literal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过-from-file"><span class="nav-number">10.1.1.2.</span> <span class="nav-text">通过--from-file</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过-from-env-file"><span class="nav-number">10.1.1.3.</span> <span class="nav-text">通过--from-env-file</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过YAML或JSON文件定义"><span class="nav-number">10.1.1.4.</span> <span class="nav-text">通过YAML或JSON文件定义</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看Secret"><span class="nav-number">10.1.2.</span> <span class="nav-text">查看Secret</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Secret"><span class="nav-number">10.1.3.</span> <span class="nav-text">使用Secret</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通过卷的方式使用"><span class="nav-number">10.1.3.1.</span> <span class="nav-text">通过卷的方式使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过环境变量方式使用"><span class="nav-number">10.1.3.2.</span> <span class="nav-text">通过环境变量方式使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#普通信息"><span class="nav-number">10.2.</span> <span class="nav-text">普通信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建ConfigMap"><span class="nav-number">10.2.1.</span> <span class="nav-text">创建ConfigMap</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通过-from-literal-1"><span class="nav-number">10.2.1.1.</span> <span class="nav-text">通过--from-literal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过-from-file-1"><span class="nav-number">10.2.1.2.</span> <span class="nav-text">通过--from-file</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过-from-env-file-1"><span class="nav-number">10.2.1.3.</span> <span class="nav-text">通过--from-env-file</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过YAML或JSON文件定义-1"><span class="nav-number">10.2.1.4.</span> <span class="nav-text">通过YAML或JSON文件定义</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用ConfigMap"><span class="nav-number">10.2.2.</span> <span class="nav-text">使用ConfigMap</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通过卷的方式使用-1"><span class="nav-number">10.2.2.1.</span> <span class="nav-text">通过卷的方式使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过环境变量方式使用-1"><span class="nav-number">10.2.2.2.</span> <span class="nav-text">通过环境变量方式使用</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DaemonSet"><span class="nav-number">11.</span> <span class="nav-text">DaemonSet</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#作业管理"><span class="nav-number">12.</span> <span class="nav-text">作业管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Job的并行性"><span class="nav-number">12.1.</span> <span class="nav-text">Job的并行性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定时Job"><span class="nav-number">12.2.</span> <span class="nav-text">定时Job</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#健康检查"><span class="nav-number">13.</span> <span class="nav-text">健康检查</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#默认健康检查机制"><span class="nav-number">13.1.</span> <span class="nav-text">默认健康检查机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Liveness探测"><span class="nav-number">13.2.</span> <span class="nav-text">Liveness探测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Readiness探测"><span class="nav-number">13.3.</span> <span class="nav-text">Readiness探测</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#包管理"><span class="nav-number">14.</span> <span class="nav-text">包管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm架构"><span class="nav-number">14.1.</span> <span class="nav-text">Helm架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Helm"><span class="nav-number">14.2.</span> <span class="nav-text">安装Helm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Helm客户端安装"><span class="nav-number">14.2.1.</span> <span class="nav-text">Helm客户端安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tiller服务器安装"><span class="nav-number">14.2.2.</span> <span class="nav-text">Tiller服务器安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基于角色的访问控制"><span class="nav-number">14.2.2.1.</span> <span class="nav-text">基于角色的访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#管理整个集群资源"><span class="nav-number">14.2.2.1.1.</span> <span class="nav-text">管理整个集群资源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#限制Tiller只管理某个命名空间的资源"><span class="nav-number">14.2.2.1.2.</span> <span class="nav-text">限制Tiller只管理某个命名空间的资源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#准许Tiller对其他命名资源的管理"><span class="nav-number">14.2.2.1.3.</span> <span class="nav-text">准许Tiller对其他命名资源的管理</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#升级Tiller"><span class="nav-number">14.2.2.2.</span> <span class="nav-text">升级Tiller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#卸载Tiller"><span class="nav-number">14.2.2.3.</span> <span class="nav-text">卸载Tiller</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用TLS-SSL保护Helm"><span class="nav-number">14.2.3.</span> <span class="nav-text">使用TLS&#x2F;SSL保护Helm</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#为Tiller创建证书"><span class="nav-number">14.2.3.1.</span> <span class="nav-text">为Tiller创建证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为Helm客户端创建证书"><span class="nav-number">14.2.3.2.</span> <span class="nav-text">为Helm客户端创建证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用SSL配置安装Tiller"><span class="nav-number">14.2.3.3.</span> <span class="nav-text">使用SSL配置安装Tiller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用SSL配置Helm客户端"><span class="nav-number">14.2.3.4.</span> <span class="nav-text">使用SSL配置Helm客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Helm"><span class="nav-number">14.3.</span> <span class="nav-text">使用Helm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看帮助"><span class="nav-number">14.3.1.</span> <span class="nav-text">查看帮助</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查找可用的Chart"><span class="nav-number">14.3.2.</span> <span class="nav-text">查找可用的Chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看Chart详情"><span class="nav-number">14.3.3.</span> <span class="nav-text">查看Chart详情</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Chart"><span class="nav-number">14.3.4.</span> <span class="nav-text">安装Chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#列出已安装的Release"><span class="nav-number">14.3.5.</span> <span class="nav-text">列出已安装的Release</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看Release的状态"><span class="nav-number">14.3.6.</span> <span class="nav-text">查看Release的状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新Release"><span class="nav-number">14.3.7.</span> <span class="nav-text">更新Release</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#列出Release的所有修订历史"><span class="nav-number">14.3.8.</span> <span class="nav-text">列出Release的所有修订历史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回滚Release"><span class="nav-number">14.3.9.</span> <span class="nav-text">回滚Release</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除Release"><span class="nav-number">14.3.10.</span> <span class="nav-text">删除Release</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Charts"><span class="nav-number">14.4.</span> <span class="nav-text">Charts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Chart目录结构"><span class="nav-number">14.4.1.</span> <span class="nav-text">Chart目录结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Chart"><span class="nav-number">14.4.2.</span> <span class="nav-text">创建Chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chart依赖"><span class="nav-number">14.4.3.</span> <span class="nav-text">Chart依赖</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用requirements-yaml文件管理依赖（推荐）"><span class="nav-number">14.4.3.1.</span> <span class="nav-text">使用requirements.yaml文件管理依赖（推荐）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过charts-目录手动管理依赖"><span class="nav-number">14.4.3.2.</span> <span class="nav-text">通过charts&#x2F;目录手动管理依赖</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chart的模板"><span class="nav-number">14.4.4.</span> <span class="nav-text">Chart的模板</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#预定义对象"><span class="nav-number">14.4.4.1.</span> <span class="nav-text">预定义对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#自定义值"><span class="nav-number">14.4.4.1.1.</span> <span class="nav-text">自定义值</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#值的作用域"><span class="nav-number">14.4.4.1.1.1.</span> <span class="nav-text">值的作用域</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Release对象"><span class="nav-number">14.4.4.1.2.</span> <span class="nav-text">Release对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Chart对象"><span class="nav-number">14.4.4.1.3.</span> <span class="nav-text">Chart对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#File对象"><span class="nav-number">14.4.4.1.4.</span> <span class="nav-text">File对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Capabilities对象"><span class="nav-number">14.4.4.1.5.</span> <span class="nav-text">Capabilities对象</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#子模板"><span class="nav-number">14.4.4.2.</span> <span class="nav-text">子模板</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调试Chart"><span class="nav-number">14.4.5.</span> <span class="nav-text">调试Chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打包Chart"><span class="nav-number">14.4.6.</span> <span class="nav-text">打包Chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chart存储库"><span class="nav-number">14.4.7.</span> <span class="nav-text">Chart存储库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#搭建自己的Chart存储库"><span class="nav-number">14.4.7.1.</span> <span class="nav-text">搭建自己的Chart存储库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#向Helm注册Chart存储库"><span class="nav-number">14.4.7.2.</span> <span class="nav-text">向Helm注册Chart存储库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#列出所有已注册的Chart存储库"><span class="nav-number">14.4.7.3.</span> <span class="nav-text">列出所有已注册的Chart存储库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装新存储库中的Chart"><span class="nav-number">14.4.7.4.</span> <span class="nav-text">安装新存储库中的Chart</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#向存储库中添加新的Chart"><span class="nav-number">14.4.7.5.</span> <span class="nav-text">向存储库中添加新的Chart</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dashboard"><span class="nav-number">15.</span> <span class="nav-text">Dashboard</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#集群监控"><span class="nav-number">16.</span> <span class="nav-text">集群监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Metrics-Server"><span class="nav-number">16.1.</span> <span class="nav-text">Metrics Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prometheus-Operator"><span class="nav-number">16.2.</span> <span class="nav-text">Prometheus Operator</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#日志管理"><span class="nav-number">17.</span> <span class="nav-text">日志管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Istio"><span class="nav-number">18.</span> <span class="nav-text">Istio</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Deis"><span class="nav-number">19.</span> <span class="nav-text">Deis</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">周千涵</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:supremeadministrator@supercalifragilisticexpialidociouser.com" title="E-Mail → mailto:supremeadministrator@supercalifragilisticexpialidociouser.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周千涵</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
