<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.supercalifragilisticexpialidociouser.com').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="Spring MVCSpring Web MVC是构建在Servlet API上的Web框架。 Spring MVC架构  客户端（如浏览器）发出一个HTTP请求，Web应用服务器接收到这个请求。如果匹配Spring MVC的前端控制器DispatcherServlet的URL映射模式，则Web容器将该请求转交给DispatcherServlet处理。  DispatcherServlet接收到这">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringWeb">
<meta property="og:url" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringWeb/index.html">
<meta property="og:site_name" content="人见人爱，花见花开，车见爆胎">
<meta property="og:description" content="Spring MVCSpring Web MVC是构建在Servlet API上的Web框架。 Spring MVC架构  客户端（如浏览器）发出一个HTTP请求，Web应用服务器接收到这个请求。如果匹配Spring MVC的前端控制器DispatcherServlet的URL映射模式，则Web容器将该请求转交给DispatcherServlet处理。  DispatcherServlet接收到这">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringWeb/SpringWeb/Spring-MVC-%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringWeb/SpringWeb/mvc-context-hierarchy.png">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringWeb/SpringWeb/flash.png">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringWeb/SpringWeb/JSP%E8%A7%86%E5%9B%BE%E8%A7%A3%E6%9E%90%E5%9B%BE%E7%A4%BA.png">
<meta property="article:published_time" content="2018-06-01T13:57:58.000Z">
<meta property="article:modified_time" content="2020-05-09T15:25:50.029Z">
<meta property="article:author" content="周千涵">
<meta property="article:tag" content="5.1.2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringWeb/SpringWeb/Spring-MVC-%E6%9E%B6%E6%9E%84.png">

<link rel="canonical" href="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringWeb/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>SpringWeb | 人见人爱，花见花开，车见爆胎</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">人见人爱，花见花开，车见爆胎</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一个程序猿的笔记</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringWeb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringWeb
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-06-01 21:57:58" itemprop="dateCreated datePublished" datetime="2018-06-01T21:57:58+08:00">2018-06-01</time>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h1><p>Spring Web MVC是构建在Servlet API上的Web框架。</p>
<h2 id="Spring-MVC架构"><a href="#Spring-MVC架构" class="headerlink" title="Spring MVC架构"></a>Spring MVC架构</h2><p><img src="SpringWeb/Spring-MVC-%E6%9E%B6%E6%9E%84.png" alt="Spring MVC架构"></p>
<ol>
<li><p>客户端（如浏览器）发出一个HTTP请求，Web应用服务器接收到这个请求。如果匹配Spring MVC的前端控制器<code>DispatcherServlet</code>的URL映射模式，则Web容器将该请求转交给<code>DispatcherServlet</code>处理。</p>
</li>
<li><p><code>DispatcherServlet</code>接收到这个请求后，将根据请求的信息（包括URL、HTTP方法、请求报文头、请求参数、Cookie等）及处理器映射（HandlerMapping，可看作路由控制器）的配置找到处理请求的处理器（Handler）。</p>
<blockquote>
<p>注意：在Spring MVC中并没有定义一个Handler接口，实际上，任何一个类都可以成为请求处理器。</p>
</blockquote>
</li>
<li><p>当<code>DispatcherServlet</code>找到对应当前请求的处理器后，通过<code>HandlerAdapter</code>对处理器进行封装，再以统一的适配器接口调用处理器。</p>
</li>
<li><p>处理器完成业务逻辑的处理后（实际上，设计良好的控制器本身只处理很少甚至不处理工作，而是将业务逻辑委托给一个或多个服务对象进行处理），将返回一个<code>ModelAndView</code>给<code>DispatcherServlet</code>。<code>ModelAndView</code>包含了逻辑视图名和模型数据信息。</p>
</li>
<li><p><code>DispatcherServlet</code>借由视图解析器（ViewResolver）来将逻辑视图名匹配为一个特定的视图实现（如JSP）。</p>
</li>
<li><p><code>DispatcherServlet</code>将模型数据交付给上一步得到的视图，并由该视图进行渲染。</p>
</li>
<li><p>渲染输出（如HTML、JSON、图片等）最终通过响应对象传递给客户端。</p>
</li>
</ol>
<h2 id="搭建Spring-MVC"><a href="#搭建Spring-MVC" class="headerlink" title="搭建Spring MVC"></a>搭建Spring MVC</h2><h3 id="配置DispatcherServlet"><a href="#配置DispatcherServlet" class="headerlink" title="配置DispatcherServlet"></a>配置DispatcherServlet</h3><p>传统配置DispatcherServlet的方式是在web.xml文件中进行配置。借助于Servlet 3规范和Spring 3.1的功能增强，现在更推荐在Java中配置DispatcherServlet。</p>
<h4 id="传统的web-xml配置"><a href="#传统的web-xml配置" class="headerlink" title="传统的web.xml配置"></a>传统的web.xml配置</h4><p>web.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 加载后端的中间层和数据层组件的应用上下文（根应用上下文） --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span><span class="comment">&lt;!-- ContextLoaderListener加载的Spring配置文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/app-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 加载Web组件的应用上下文 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>app<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 如果缺省init-param元素，则默认加载 /WEB-INF/Servlet名称-servlet.xml （这里是 /WEB-INF/app-servlet.xml）的Spring配置文件。这里将contextConfigLocation显式设置为空，表示不加载Web组件的应用上下文 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span><span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>app<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/app/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>一个web.xml可以配置多个<code>DispatcherServlet</code>，通过不同的<code>&lt;servlet-mapping&gt;</code>配置，让每个<code>DispatcherServlet</code>处理不同的请求。</p>
<p>另外，还可以在web.xml中配置使用基于Java的配置，只需要告诉<code>ContextLoaderListener</code>和<code>DispatcherServlet</code>使用<code>AnnotationConfigWebApplicationContext</code>，它是<code>WebApplicationContext</code>的实现类，它会加载Java配置类，而不是使用XML配置。要实现这种配置，可以设置<code>contextClass</code>参数：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 加载后端的中间层和数据层组件的应用上下文（根应用上下文） --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span><span class="comment">&lt;!-- 指定根配置类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>foo.bar.RootConfig<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span><span class="comment">&lt;!-- 使用Java配置类 --&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.springframework.web.context.support.AnnotationConfigWebApplicationContext<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 加载Web组件的应用上下文 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>app<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span><span class="comment">&lt;!-- 指定DispatcherServlet配置类 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>foo.bar.WebConfig<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span><span class="comment">&lt;!-- 使用Java配置类 --&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.springframework.web.context.support.AnnotationConfigWebApplicationContext<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>app<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/app/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="使用Java配置"><a href="#使用Java配置" class="headerlink" title="使用Java配置"></a>使用Java配置</h4><p>在Servlet 3环境中，容器会在类路径中查找实现了<code>javax.servlet.ServletContainerInitializer</code>接口的类，如果能发现的话，就会用它来配置Servlet容器上下文。</p>
<p>Spring提供了这个接口的实现——<code>SpringServletContainerInitializer</code>，这个类会查找实现<code>WebApplicationInitializer</code>接口的类，并将配置的任务交给它们来完成。因此，可通过实现<code>WebApplicationInitializer</code>接口来配置<code>DispatcherServlet</code>和Spring应用上下文。当部署到Servlet 3.0容器中时，容器会自动发现它，并用它来配置Servlet上下文。Spring应用上下文会位于应用程序的Servlet上下文之中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebApplicationInitializer</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletCxt)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Load Spring web application configuration</span></span><br><span class="line">    AnnotationConfigWebApplicationContext ac = <span class="keyword">new</span> AnnotationConfigWebApplicationContext();</span><br><span class="line">    ac.register(AppConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    ac.refresh();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create and register the DispatcherServlet</span></span><br><span class="line">    DispatcherServlet servlet = <span class="keyword">new</span> DispatcherServlet(ac);</span><br><span class="line">    ServletRegistration.Dynamic registration = servletCxt.addServlet(<span class="string">"app"</span>, servlet);</span><br><span class="line">    registration.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    registration.addMapping(<span class="string">"/app/*"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring 3.2引入了一个便利的<code>WebApplicationInitializer</code>基础实现，也就是<code>AbstractAnnotationConfigDispatcherServletInitializer</code> ，也可以扩展这个类来配置<code>DispatcherServlet</code>和Spring应用上下文：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebAppInitializer</span> <span class="keyword">extends</span> <span class="title">AbstractAnnotationConfigDispatcherServletInitializer</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123; AppConfig<span class="class">.<span class="keyword">class</span> &#125;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123; <span class="string">"/app/*"</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="自定义DispatcherServlet配置"><a href="#自定义DispatcherServlet配置" class="headerlink" title="自定义DispatcherServlet配置"></a>自定义DispatcherServlet配置</h5><p>可以通过重写<code>customizeRegistration</code>方法（属于<code>AbstractDispatcherServletInitializer</code>类），利用它的参数<code>ServletRegistration.Dynamic</code>的方法来自定义<code>DispatcherServlet</code>配置。</p>
<p>例如，调用<code>setLoadOnStartup</code>方法设置<code>load-on-startup</code>优先级；调用<code>setInitParameter</code>方法设置初始化参数等。</p>
<h3 id="上下文的层次结构"><a href="#上下文的层次结构" class="headerlink" title="上下文的层次结构"></a>上下文的层次结构</h3><p>对于许多应用程序，拥有单个<code>WebApplicationContext</code>就足够。但Spring应用上下文之间可以设置为父子级关系，以实现更好的解耦。子上下文可以访问父上下文中的Bean，反之则不行。</p>
<p>在Spring MVC中，通常包含两个应用上下文，并且<code>DispatcherServlet</code>加载的Web层应用上下文，将作为<code>ContextLoaderListener</code>加载的后端应用上下文的子上下文。</p>
<p><img src="SpringWeb/mvc-context-hierarchy.png" alt="mvc-context-hierarchy"></p>
<p>下面的示例配置了这种WebApplicationContext层次结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebAppInitializer</span> <span class="keyword">extends</span> <span class="title">AbstractAnnotationConfigDispatcherServletInitializer</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123; RootConfig<span class="class">.<span class="keyword">class</span> &#125;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123; WebConfig<span class="class">.<span class="keyword">class</span> &#125;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123; <span class="string">"/app/*"</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebAppInitializer</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext container)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Create the 'root' Spring application context</span></span><br><span class="line">    AnnotationConfigWebApplicationContext rootContext =</span><br><span class="line">      <span class="keyword">new</span> AnnotationConfigWebApplicationContext();</span><br><span class="line">    rootContext.register(RootConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Manage the lifecycle of the root application context</span></span><br><span class="line">    container.addListener(<span class="keyword">new</span> ContextLoaderListener(rootContext));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the dispatcher servlet's Spring application context</span></span><br><span class="line">    AnnotationConfigWebApplicationContext dispatcherContext =</span><br><span class="line">      <span class="keyword">new</span> AnnotationConfigWebApplicationContext();</span><br><span class="line">    dispatcherContext.register(WebConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register and map the dispatcher servlet</span></span><br><span class="line">    ServletRegistration.Dynamic dispatcher =</span><br><span class="line">      container.addServlet(<span class="string">"dispatcher"</span>, <span class="keyword">new</span> DispatcherServlet(dispatcherContext));</span><br><span class="line">    dispatcher.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    dispatcher.addMapping(<span class="string">"/"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/root-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>app<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/web-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>app<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/app/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="MVC配置"><a href="#MVC配置" class="headerlink" title="MVC配置"></a>MVC配置</h3><h4 id="启用Spring-MVC"><a href="#启用Spring-MVC" class="headerlink" title="启用Spring MVC"></a>启用Spring MVC</h4><p>在基于Java的配置中，可以在Servlet的应用上下文配置类中通过<code>@EnableWebMvc</code>标注来启用Spring MVC：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在基于XML的配置中，可以使用下面配置启用标注驱动的Spring MVC：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="启用组件扫描"><a href="#启用组件扫描" class="headerlink" title="启用组件扫描"></a>启用组件扫描</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"spitter.web"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AOP代理"><a href="#AOP代理" class="headerlink" title="AOP代理"></a>AOP代理</h4><p>在某些情况下，您需要在运行时使用AOP代理装饰控制器。例如，如果您选择在控制器上直接使用<code>@Transactional</code>注释。在这种情况下，对于控制器而言，我们建议使用基于类的代理。这通常是控制器的默认选择。但是，如果控制器必须实现不是Spring Context回调的接口（例如<code>InitializingBean</code>，<code>*Aware</code>等），则可能需要显式配置基于类的代理。例如，使用<code>&lt;tx：annotation-driven /&gt;</code>，您可以更改为<code>&lt;tx：annotation-driven proxy-target-class =“true”/&gt;</code>。</p>
<h3 id="根上下文配置"><a href="#根上下文配置" class="headerlink" title="根上下文配置"></a>根上下文配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> spittr.config;</span><br><span class="line"></span><br><span class="line">…</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(</span><br><span class="line">  basePackages=&#123;<span class="string">"spitter"</span>&#125;,</span><br><span class="line">  excludeFilters=&#123;</span><br><span class="line">    <span class="meta">@Filter</span>(type=FilterType.ANNOTATION, value=EnableWebMvc<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RootConfig</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>组件扫描时，过滤掉以<code>@EnableWebMvc</code>标注的类。</p>
<h2 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h2><h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><p>Spring MVC的控制器不需要继承任何类或接口，只需要在控制器的方法上标注上<code>@RequestMapping</code>即可。<code>@RequestMapping</code>将HTTP请求映射到指定的方法。而<code>@Controller</code>标注主要是在自动装配时辅助组件扫描的。</p>
<p><code>@RequestMapping</code>既可只作用在方法上，也可以同时作用在方法和类上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/foo"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@RequestMapping</span>(<span class="string">"/bar"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">bar</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">    model.addAttribute(<span class="string">"name"</span>, <span class="string">"Mary"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"/bar.ftl"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码对<code>/foo/bar</code>的请求，将交由<code>FooController.bar</code>方法处理。</p>
<p>控制器方法返回值默认是视图的名称，<code>DispatcherServlet</code>会要求视图解析器将这个逻辑视图名称解析为实际的视图。</p>
<p>如果希望返回内容本身，而不是视图名称，则需要在方法上加上<code>@ResponseBody</code>。<code>@ResponseBody</code>用于将控制器的方法返回值，通过相应的<code>HttpMessageConverter</code>转换为指定格式后，写入<code>Response</code>对象的body。默认情况下，如果返回值是字符串类型，则直接返回这个字符串；否则，默认使用Jackson将返回值序列化为JSON字符串后输出。</p>
<p>如果需要的是一个RESTful风格的控制器，则需要使用<code>@RestController</code>标注，它相当于<code>@Controller</code>+<code>@ResponseBody</code>，用于返回JSON格式数据。</p>
<h3 id="请求映射"><a href="#请求映射" class="headerlink" title="请求映射"></a>请求映射</h3><p><code>@RequestMapping</code>的属性：</p>
<ul>
<li><p>value：请求的URL路径，支持URL模板、正则表达式。<code>value</code>属性能够接受一个<code>String</code>类型的数组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(&#123;<span class="string">"/"</span>, <span class="string">"/home"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>method：HTTP请求方法，有GET、POST等；</p>
</li>
<li><p>consumes：接受的媒体类型。对应HTTP的<code>Content-Type</code>；</p>
</li>
<li><p>produces：响应的媒体类型。对应HTTP的<code>Accept</code>；</p>
</li>
<li><p>params：请求参数；</p>
</li>
<li><p>headers：请求的HTTP头。</p>
</li>
</ul>
<h4 id="指定HTTP方法"><a href="#指定HTTP方法" class="headerlink" title="指定HTTP方法"></a>指定HTTP方法</h4><p>请求的HTTP方法可以通过<code>@RequestMapping</code>标注的<code>method</code>属性来指定，也可以使用如下便捷的标注来指定：</p>
<ul>
<li><code>@GetMapping</code></li>
<li><code>@PostMapping</code></li>
<li><code>@PutMapping</code></li>
<li><code>@DeleteMapping</code></li>
<li><code>@PatchMapping</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/persons"</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Person <span class="title">getPerson</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping</span></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.CREATED)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(@RequestBody Person person)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="URL模式"><a href="#URL模式" class="headerlink" title="URL模式"></a>URL模式</h4><h5 id="路径参数"><a href="#路径参数" class="headerlink" title="路径参数"></a>路径参数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/get/&#123;id&#125;.json"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">User <span class="title">getById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id) </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>则访问路径是<code>/get/1.json</code>，时将调用<code>getById</code>方法，并且参数<code>id</code>的值为<code>1</code>。</p>
<blockquote>
<p>标注中如果只设置一个<code>value</code>参数时，可以省略<code>value=</code>部分。例如：<code>@RequestMapping(&quot;/get/{id}.json&quot;)</code>。</p>
</blockquote>
<p>同一个处理器方法允许有任意多个参数带有<code>@PathVariable</code>标注，并且可以在类和方法级别声明URI变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/owners/&#123;ownerId&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OwnerController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"/pets/&#123;petId&#125;"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Pet <span class="title">findPet</span><span class="params">(@PathVariable Long ownerId, @PathVariable Long petId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果URI变量名称与方法参数相同，并且您的代码使用调试信息或Java 8上的<code>-parameters</code>编译器标志进行编译，则<code>@PathVariable</code>可以省略<code>value</code>属性。（其他诸如<code>@RequestParam</code>等标注也类似）</p>
<p>URI变量自动转换为适当的类型，如果转换失败将引发<code>TypeMismatchException</code>。默认情况下支持简单类型（int，long，Date等），您可以注册对任何其他数据类型的支持。请参见“类型转换”和“数据绑定”。</p>
<h5 id="Ant路径表达式"><a href="#Ant路径表达式" class="headerlink" title="Ant路径表达式"></a>Ant路径表达式</h5><p><code>*</code>匹配任意多个字符（除了路径分隔符”/“），<code>**</code>匹配任意多个字符（包括路径分隔符），<code>?</code>匹配单个字符。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user/*.html"</span>)  <span class="comment">//匹配：/user/1.html、/user/abc.html，但不匹配：/user/add/1.html</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/**/1.html"</span>)  <span class="comment">//匹配：/1.html、/user/1.html、/user/add/1.html</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user/?.html"</span>)  <span class="comment">//匹配：/user/1.html，但不匹配：/user/abc.html</span></span><br></pre></td></tr></table></figure>

<p>如果一个请求有多个<code>@RequestMapping</code>能够匹配，则更具体的匹配优先。另外，有通配符的优先级低于无通配符的，有<code>**</code>的低于有<code>*</code>的。默认映射模式（<code>/**</code>）总是具有最低优先级。</p>
<h5 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h5><p>语法<code>{varName：regex}</code>声明一个URI变量，它的值必须匹配正则表达式<code>regex</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;name:[a-z-]+&#125;-&#123;version:\\d\\.\\d\\.\\d&#125;&#123;ext:\\.[a-z]+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(@PathVariable String version, @PathVariable String ext)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的正则表达式可以匹配类似于<code>/spring-web-3.0.5 .jar</code>的URL。</p>
<h5 id="占位符"><a href="#占位符" class="headerlink" title="占位符"></a>占位符</h5><p>URI路径模式还可以嵌入<code>$ {…}</code>占位符，这些占位符在启动时通过<code>PropertyPlaceHolderConfigurer</code>来解析本地、系统、环境和其他属性源。例如，您可以使用它来根据某些外部配置参数化基本URL：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/$&#123;query.all&#125;.json"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="接受请求的输入"><a href="#接受请求的输入" class="headerlink" title="接受请求的输入"></a>接受请求的输入</h3><p>Spring MVC提供了下面几种方式将客户端的数据传送到控制器的处理器方法中：</p>
<ul>
<li>查询参数（Query Parameter）：面向操作（控制）。</li>
<li>表单参数（Form Parameter）：面向数据。</li>
<li>路径变量（Path Variable）：面向资源，详见“路径参数”。</li>
<li>Matrix 变量。</li>
</ul>
<h4 id="查询参数"><a href="#查询参数" class="headerlink" title="查询参数"></a>查询参数</h4><p>下面的处理器方法将匹配：<code>GET: /spittles?max=238900&amp;count=50</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/spittles"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittleController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MAX_LONG_AS_STRING = <span class="string">"9223372036854775807"</span>;</span><br><span class="line">  …</span><br><span class="line">  <span class="meta">@RequestMapping</span>(method=RequestMethod.GET)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Spittle&gt; <span class="title">spittles</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @RequestParam(value=<span class="string">"max"</span>, defaultValue=MAX_LONG_AS_STRING)</span> <span class="keyword">long</span> max,</span></span><br><span class="line"><span class="function">      @<span class="title">RequestParam</span><span class="params">(value=<span class="string">"count"</span>, defaultValue=<span class="string">"20"</span>)</span> <span class="keyword">int</span> count) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> spittleRepository.findSpittles(max, count);</span><br><span class="line">  &#125;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：<code>@RequestParam</code>的<code>value</code>和<code>defaultValue</code>属性都是<code>String</code>类型，但是当绑定到方法的参数时，会自动转换为相应类型。</p>
<h4 id="表单参数"><a href="#表单参数" class="headerlink" title="表单参数"></a>表单参数</h4><p>控制器代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/spitter"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpitterController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> SpitterRepository spitterRepository;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SpitterController</span><span class="params">(SpitterRepository spitterRepository)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.spitterRepository = spitterRepository;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//显示注册表单</span></span><br><span class="line">  <span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=GET)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">showRegistrationForm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"registerForm"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//处理注册表单</span></span><br><span class="line">  <span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">    spitterRepository.save(spitter);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:/spitter/"</span> + spitter.getUsername();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//显示个人信息</span></span><br><span class="line">  <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;username&#125;"</span>, method=GET)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">showSpitterProfile</span><span class="params">(@PathVariable String username, Model model)</span> </span>&#123;</span><br><span class="line">    Spitter spitter = spitterRepository.findByUsername(username);</span><br><span class="line">    model.addAttribute(spitter);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"profile"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>processRegistration</code>方法的<code>spitter</code>参数的属性将会使用POST请求中同名的参数进行填充。</p>
<p>在处理POST类型的请求时，在请求处理完成后，最好进行一下重定向，这样浏览器的刷新就不会重复提交表单了。</p>
<p>本例假定使用<code>InternalResourceViewResolver</code>视图解析器，它会将以<code>redirect:</code>为前缀的视图格式解析为重定向到指定视图。</p>
<p><code>InternalResourceViewResolver</code>视图解析器还会识别<code>forward:</code>前缀的视图格式，它将解析为将请求转发到指定视图。</p>
</blockquote>
<p>registerForm.jsp：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> prefix=<span class="string">"c"</span> %&gt;</span><br><span class="line">&lt;%@ page session=<span class="string">"false"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;Spitter&lt;/title&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> </span><br><span class="line">          href=<span class="string">"&lt;c:url value="</span>/resources/style.css<span class="string">" /&gt;"</span> &gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Register&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">    &lt;form method=<span class="string">"POST"</span>&gt;</span><br><span class="line">      First Name: &lt;input type=<span class="string">"text"</span> name=<span class="string">"firstName"</span> /&gt;&lt;br/&gt;</span><br><span class="line">      Last Name: &lt;input type=<span class="string">"text"</span> name=<span class="string">"lastName"</span> /&gt;&lt;br/&gt;</span><br><span class="line">      Email: &lt;input type=<span class="string">"email"</span> name=<span class="string">"email"</span> /&gt;&lt;br/&gt;</span><br><span class="line">      Username: &lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span> /&gt;&lt;br/&gt;</span><br><span class="line">      Password: &lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span> /&gt;&lt;br/&gt;</span><br><span class="line">      &lt;input type=<span class="string">"submit"</span> value=<span class="string">"Register"</span> /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>这里<code>&lt;form&gt;</code>元素中并没有设置<code>action</code>属性。在这种情况下，当表单提交时，它会提交到与展现当前视图时相同的URL路径上，本例中就是<code>/spitter/register</code>。</p>
<p>profile.jsp：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> prefix=<span class="string">"c"</span> %&gt;</span><br><span class="line">&lt;%@ page session=<span class="string">"false"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;Spitter&lt;/title&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"&lt;c:url value="</span>/resources/style.css<span class="string">" /&gt;"</span> &gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Your Profile&lt;/h1&gt;</span><br><span class="line">    &lt;c:out value=<span class="string">"$&#123;spitter.username&#125;"</span> /&gt;&lt;br/&gt;</span><br><span class="line">    &lt;c:out value=<span class="string">"$&#123;spitter.firstName&#125;"</span> /&gt; &lt;c:out value=<span class="string">"$&#123;spitter.lastName&#125;"</span> /&gt;&lt;br/&gt;</span><br><span class="line">    &lt;c:out value=<span class="string">"$&#123;spitter.email&#125;"</span> /&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h5 id="校验表单"><a href="#校验表单" class="headerlink" title="校验表单"></a>校验表单</h5><p>从Spring 3.0开始，Spring MVC提供了对Java Validation API的支持。在Spring MVC中使用Java Validation API，并不需要什么额外的配置，只要保证在类路径下包含Java Validation API的实现（例如Hibernate Validator）。</p>
<p>Spitter.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Spitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@NotNull</span></span><br><span class="line">  <span class="meta">@Size</span>(min=<span class="number">5</span>, max=<span class="number">16</span>)</span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NotNull</span></span><br><span class="line">  <span class="meta">@Size</span>(min=<span class="number">5</span>, max=<span class="number">25</span>)</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@NotNull</span></span><br><span class="line">  <span class="meta">@Size</span>(min=<span class="number">2</span>, max=<span class="number">30</span>)</span><br><span class="line">  <span class="keyword">private</span> String firstName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NotNull</span></span><br><span class="line">  <span class="meta">@Size</span>(min=<span class="number">2</span>, max=<span class="number">30</span>)</span><br><span class="line">  <span class="keyword">private</span> String lastName;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@NotNull</span></span><br><span class="line">  <span class="meta">@Email</span></span><br><span class="line">  <span class="keyword">private</span> String email;</span><br><span class="line">  </span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们已经为<code>Spitter</code>添加了校验标注，接下来需要修改<code>processRegistration</code>方法来应用校验功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  @Valid Spitter spitter, </span></span></span><br><span class="line"><span class="function"><span class="params">  Errors errors)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (errors.hasErrors()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"registerForm"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  spitterRepository.save(spitter);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"redirect:/spitter/"</span> + spitter.getUsername();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>spitter</code>参数添加了<code>@Valid</code>标注，这会告知Spring，需要确保这个对象满足校验限制。</p>
<p>在<code>Spitter</code>类的属性上添加校验限制并不能阻止表单提交，不管校验有没有通过，<code>processRegistration</code>方法都会被调用。因此，我们要在<code>processRegistration</code>方法中处理校验的错误。</p>
<p>如果有校验出现错误，那么这些错误可以通过<code>Errors</code>对象进行访问。注意，<code>Errors</code>参数必须紧跟在带有<code>@Valid</code>标注的参数之后。</p>
<blockquote>
<p>校验的更详细用法，请参见“SpringCore”的“校验”。</p>
</blockquote>
<h4 id="Matrix-变量"><a href="#Matrix-变量" class="headerlink" title="Matrix 变量"></a>Matrix 变量</h4><h3 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h3><h3 id="控制器通知"><a href="#控制器通知" class="headerlink" title="控制器通知"></a>控制器通知</h3><p>Spring 3.2引入了控制器通知，它能将控制器类的特定切面运用到整个应用程序的所有控制器中。</p>
<p>控制器通知是任意带有<code>@ControllerAdvice</code>标注的类，这个类会包含一个或多个如下类型的方法：</p>
<ul>
<li>带<code>@ExceptionHandler</code>标注的方法：用于处理异常；</li>
<li>带<code>@InitBinder</code>标注的方法；</li>
<li>带<code>@ModelAttribute</code>标注的方法。</li>
</ul>
<p>以上这些方法会应用到整个应用程序所有控制器中带有<code>@RequestMapping</code>标注的方法（即处理器方法）。</p>
<p><code>@ControllerAdvice</code>标注本身已经使用了<code>@Component</code>标注，因此<code>@ControllerAdvice</code>标注的类会自动被组件扫描获取到。</p>
<p><code>@ControllerAdvice</code>标注最为实用的一个场景是将所有的<code>@ExceptionHandler</code>方法收集到一个类中，这样所有控制器的异常就能在一个地方进行一致处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppWideExceptionHandler</span> </span>&#123;</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(DuplicateSpittleException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">String</span> <span class="title">duplicateSpittleHandler</span>() </span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="string">"error/duplicate"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，任意控制器类的处理器方法抛出<code>DuplicateSpittleException</code>异常，都将调用<code>duplicateSpittleHandler</code>方法来处理异常。</p>
<h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><h3 id="传递模型数据到视图中"><a href="#传递模型数据到视图中" class="headerlink" title="传递模型数据到视图中"></a>传递模型数据到视图中</h3><p>Spring提供了多种方式将模型数据传递到视图中。</p>
<h4 id="通过Model参数"><a href="#通过Model参数" class="headerlink" title="通过Model参数"></a>通过Model参数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">spittles</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">  model.addAttribute(<span class="string">"spittleList"</span>, spittleRepository.findSpittles(Long.MAX_VALUE, <span class="number">20</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"spittles"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，在视图中就可以通过<code>${spittles.属性名}</code>方式访问这些模型数据。</p>
<blockquote>
<p>当视图是JSP时，模型数据实际上会作为请求属性放在请求（request）之中。</p>
<p><code>Model</code>参数的位置可任意。</p>
</blockquote>
<h4 id="通过Map参数"><a href="#通过Map参数" class="headerlink" title="通过Map参数"></a>通过Map参数</h4><p>如果你希望使用非Spring类型的话，可以用<code>java.util.Map</code>来代替<code>Model</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">spittles</span><span class="params">(Map model)</span> </span>&#123;</span><br><span class="line">  model.put(<span class="string">"spittleList"</span>, spittleRepository.findSpittles(Long.MAX_VALUE, <span class="number">20</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"spittles"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Map</code>参数的位置可任意。</p>
</blockquote>
<h4 id="通过返回值"><a href="#通过返回值" class="headerlink" title="通过返回值"></a>通过返回值</h4><p>当处理器方法的返回值是除了<code>String</code>类型之外的对象时，该返回值将不会被当作是视图的逻辑名称，而是会被放到模型中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/spittles"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittleController</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">  <span class="meta">@RequestMapping</span>(method=RequestMethod.GET)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Spittle&gt; <span class="title">spittles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> spittleRepository.findSpittles(Long.MAX_VALUE, <span class="number">20</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里返回值是一个<code>List</code>对象，将被放到模型中，并且它在模型中的键名会根据其类型推断得出，本例中就是<code>spittleList</code>。而逻辑视图的名称将会根据请求路径推断得出，本例中就是<code>spittles</code></p>
<h3 id="跨重定向请求传递数据"><a href="#跨重定向请求传递数据" class="headerlink" title="跨重定向请求传递数据"></a>跨重定向请求传递数据</h3><p>通常，在执行重定向后，原始的请求就结束了，并且会发起一个新的GET请求。原始请求中所带有的模型数据也就随着请求一起消亡了，在新的请求属性中，没有任何模型数据。</p>
<p>但是，Spring MVC能够从发起重定向的方法传递数据给处理重定向方法中。</p>
<h4 id="通过URL模板以路径变量和-或查询参数的形式传递数据"><a href="#通过URL模板以路径变量和-或查询参数的形式传递数据" class="headerlink" title="通过URL模板以路径变量和/或查询参数的形式传递数据"></a>通过URL模板以路径变量和/或查询参数的形式传递数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(Spitter spitter, Model model)</span> </span>&#123;</span><br><span class="line">	spitterRepository.save(spitter);</span><br><span class="line">  model.addAttribute(<span class="string">"username"</span>, spitter.getUsername());</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"redirect:/spitter/&#123;username&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>username</code>作为占位符填充到URL模板（即带占位符的字符串）中，而不是如下面代码中直接使用字符串拼接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="string">"redirect:/spitter/"</span> + spitter.getUsername();</span><br></pre></td></tr></table></figure>

<p>主要原因是由于使用URL模板更安全，占位符中所有不安全字符都会进行转义。</p>
</blockquote>
<p>此外，<code>Model</code>中没有与占位符匹配的属性将会自动作为URL中的查询参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(Spitter spitter, Model model)</span> </span>&#123;</span><br><span class="line">  spitterRepository.save(spitter);</span><br><span class="line">  model.addAttribute(<span class="string">"username"</span>, spitter.getUsername());</span><br><span class="line">  model.addAttribute(<span class="string">"spitterId"</span>, spitter.getId());</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"redirect:/spitter/&#123;username&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设<code>username</code>的值是<code>habuma</code>，<code>spitterId</code>的值是<code>42</code>，则重定向的URL将会是：<code>/spitter/habuma?spitterId=42</code>。</p>
<p>通过路径变量和查询参数的形式跨重定向传递数据，只能用来发送简单的值（例如字符串和数值）。在URL中，并没有办法发送复杂的值。要发送复杂的值可通过flash属性。</p>
<h4 id="通过flash属性传递复杂数据"><a href="#通过flash属性传递复杂数据" class="headerlink" title="通过flash属性传递复杂数据"></a>通过flash属性传递复杂数据</h4><p>假如要将<code>Spitter</code>对象传递给重定向后的处理器方法，但<code>Spitter</code>对象是一个复杂的对象，不能通过路径变量和查询参数发送。</p>
<p>一种可行的方法是只传递<code>Spitter</code>对象的ID，但这样重定向后的处理器方法还要从数据库中再查询一次<code>Spitter</code>对象。</p>
<p>另一种可行的方法是将<code>Spitter</code>对象放到会话（session）中，但这要我们负责会话的清理。</p>
<p>Spring通过<code>RedirectAttributes</code>接口（Spring 3.1引入的<code>Model</code>的一个子接口）将数据添加到flash属性，而flash属性会一直携带这些数据直到下一次请求才会消失。从而既实现了跨重定向传递复杂数据，又不需要手动清理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(Spitter spitter, RedirectAttributes model)</span> </span>&#123;</span><br><span class="line">  spitterRepository.save(spitter);</span><br><span class="line">  model.addAttribute(<span class="string">"username"</span>, spitter.getUsername());</span><br><span class="line">  model.addFlashAttribute(<span class="string">"spitter"</span>, spitter);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"redirect:/spitter/&#123;username&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>addFlashAttribute</code>方法的第一参数用来设置flash属性的key，可以省略。如果缺省，则key将根据值的类型进行推断得出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.addFlashAttribute(spitter);</span><br></pre></td></tr></table></figure>

<p>因为我们传递了一个<code>Spitter</code>对象，所以推断得到的key将会是<code>spitter</code>。</p>
</blockquote>
<p>可以多次调用<code>addFlashAttribute</code>方法来设置多个flash属性。在重定向执行之前，所有的flash属性都会被复制到会话中。在重定向后，存在会话中的flash属性会被取出，并从会话转移到模型之中。这样，处理重定向的方法就能从模型中访问<code>Spitter</code>对象了，就像获取其他的模型对象一样。</p>
<p><img src="SpringWeb/flash.png" alt="flash属性"></p>
<p>处理重定向的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;username&#125;"</span>, method=GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">showSpitterProfile</span><span class="params">(@PathVariable String username, Model model)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!model.containsAttribute(<span class="string">"spitter"</span>)) &#123;</span><br><span class="line">    model.addAttribute(spitterRepository.findByUsername(username));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"profile"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><h3 id="视图控制器"><a href="#视图控制器" class="headerlink" title="视图控制器"></a>视图控制器</h3><h3 id="视图解析器"><a href="#视图解析器" class="headerlink" title="视图解析器"></a>视图解析器</h3><p>控制器只提供了逻辑视图名，而Spring视图解析器则负责根据逻辑视图名来确定使用哪一个视图实现来渲染模型。</p>
<p>Spring MVC定义了一个名为<code>ViewResolver</code>的接口，它大致如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewResolver</span> </span>&#123;</span><br><span class="line">  <span class="function">View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> throw Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当给<code>resolveViewName</code>方法传递一个视图名和语言环境对象时，它会返回一个<code>View</code>实例。<code>View</code>也是一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">View</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">getContentType</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">render</span><span class="params">(Map&lt;String, ?&gt;model, HttpServletRequest request, HttpServletResponse response)</span> throw Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>View</code>接口的任务就是接受模型以及Servlet的请求和响应对象，并将输出结果渲染到响应对象中。</p>
<p>当需要与具体视图技术整合时，我们实际上只需要实现上述两个接口。但是，Spring MVC已经为我们提供了许多内置的实现：</p>
<table>
<thead>
<tr>
<th>视图解析器</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>BeanNameViewResolver</td>
<td>将视图解析为Spring应用上下文中的Bean，其中Bean的ID与视图名字相同。</td>
</tr>
<tr>
<td>ContentNegotiatingViewResolver</td>
<td>根据内容类型来解析视图，委托给另一个能够产生对应内容类型的视图解析器。</td>
</tr>
<tr>
<td>FreeMarkerViewResolver</td>
<td>将视图解析为FreeMarker模板。</td>
</tr>
<tr>
<td>InternalResourceViewResolver</td>
<td>将视图解析为Web应用的内部资源（一般为JSP）。</td>
</tr>
<tr>
<td>JasperReportsViewResolver</td>
<td>将视图解析为JasperReports定义。</td>
</tr>
<tr>
<td>ResourceBundleViewResolver</td>
<td>将视图解析为资源Bundle（一般为属性文件）。</td>
</tr>
<tr>
<td>TilesViewResolver</td>
<td>将视图解析为Apache Tile定义，其中tile ID与视图名相同。</td>
</tr>
<tr>
<td>UrlBasedViewResolver</td>
<td>直接根据视图的名称解析视图，视图的名称会匹配一个物理视图的定义。</td>
</tr>
<tr>
<td>VelocityLayoutViewResolver</td>
<td>将视图解析为Velocity布局，从不同的Velocity模板中组合页面。</td>
</tr>
<tr>
<td>VelocityViewResolver</td>
<td>将视图解析为Velocity模板。</td>
</tr>
<tr>
<td>XmlViewResolver</td>
<td>将视图解析为特定XML文件中的bean定义。类似于BeanNameViewResolver。</td>
</tr>
<tr>
<td>XsltViewResolver</td>
<td>将视图解析为XSLT转换后的结果。</td>
</tr>
</tbody></table>
<h3 id="视图技术"><a href="#视图技术" class="headerlink" title="视图技术"></a>视图技术</h3><h4 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h4><h5 id="配置视图解析器"><a href="#配置视图解析器" class="headerlink" title="配置视图解析器"></a>配置视图解析器</h5><p>基于Java的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"spittr.web"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    InternalResourceViewResolver resolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">    resolver.setPrefix(<span class="string">"/WEB-INF/views/"</span>);</span><br><span class="line">    resolver.setSuffix(<span class="string">".jsp"</span>);</span><br><span class="line">    <span class="keyword">return</span> resolver;</span><br><span class="line">  &#125;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者基于XML的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"viewResolver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:prefix</span>=<span class="string">"/WEB-INF/views/"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:suffix</span>=<span class="string">".jsp"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>解析示例：</p>
<ul>
<li>逻辑视图<code>home</code>将会解析为<code>/WEB-INF/views/home.jsp</code>。<br><img src="SpringWeb/JSP%E8%A7%86%E5%9B%BE%E8%A7%A3%E6%9E%90%E5%9B%BE%E7%A4%BA.png" alt="JSP视图解析图示"></li>
<li>逻辑视图<code>productList</code>将会解析为<code>/WEB-INF/views/productList.jsp</code>。</li>
<li>逻辑视图<code>books/detail</code>将会解析为<code>/WEB-INF/views/books/detail.jsp</code>。</li>
</ul>
<p>上面的配置最终会将逻辑视图名解析为<code>InternalResourceView</code>实例，这个实例会引用JSP文件。但是如果这些JSP使用JSTL标签来处理格式化和信息的话，那么我们会希望<code>InternalResourceViewResolver</code>将视图解析为<code>JstlView</code>。要让<code>InternalResourceViewResolver</code>将视图解析为<code>JstlView</code>，而不是<code>InternalResourceView</code>，只需要多设置个<code>viewClass</code>属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  InternalResourceViewResolver resolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">  resolver.setPrefix(<span class="string">"/WEB-INF/views/"</span>);</span><br><span class="line">  resolver.setSuffix(<span class="string">".jsp"</span>);</span><br><span class="line">  resolver.setViewClass(org.springframework.web.servlet.view.JstlView<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="keyword">return</span> resolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"viewResolver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:prefix</span>=<span class="string">"/WEB-INF/views/"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:suffix</span>=<span class="string">".jsp"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:viewClass</span>=<span class="string">"org.springframework.web.servlet.view.JstlView"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Thymeleaf"><a href="#Thymeleaf" class="headerlink" title="Thymeleaf"></a>Thymeleaf</h4><p>JSP作为视图技术是有很大缺点的：</p>
<ul>
<li>缺乏良好的格式：JSP模板虽然采用HTML的形式，但又掺杂上了各种JSP标签库的标签，使其变得很混乱，在浏览器上展示的效果很难接近模板最终所渲染出来的效果。</li>
<li>JSP规范与Servlet规范紧密耦合，只能在基于Servlet的Web应用之中使用。</li>
</ul>
<p>Thymeleaf模板是原生的，不依赖于标签库。它通过自定义的命名空间，为标准的HTML标签集合添加Thymeleaf属性，从而能在接受原始HTML的地方进行编辑和渲染。它也没有与Servlet规范耦合，因此可以进入JSP无法涉足的领域。</p>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p>为了在Spring中使用Thymeleaf，需要配置三个Bean：</p>
<ul>
<li>ThymeleafViewResolver：将逻辑视图名称解析为Thymeleaf模板；（Thymeleaf视图解析器不是Spring内置的）</li>
<li>SpringTemplateEngine：处理模板并渲染结果；</li>
<li>TemplateResolver：加载Thymeleaf模板。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"spittr.web"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">(SpringTemplateEngine templateEngine)</span> </span>&#123;</span><br><span class="line">    ThymeleafViewResolver viewResolver = <span class="keyword">new</span> ThymeleafViewResolver();</span><br><span class="line">    viewResolver.setTemplateEngine(templateEngine);</span><br><span class="line">    <span class="keyword">return</span> viewResolver;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SpringTemplateEngine <span class="title">templateEngine</span><span class="params">(TemplateResolver templateResolver)</span> </span>&#123;</span><br><span class="line">    SpringTemplateEngine templateEngine = <span class="keyword">new</span> SpringTemplateEngine();</span><br><span class="line">    templateEngine.setTemplateResolver(templateResolver);</span><br><span class="line">    <span class="keyword">return</span> templateEngine;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TemplateResolver <span class="title">templateResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TemplateResolver templateResolver = <span class="keyword">new</span> ServletContextTemplateResolver();</span><br><span class="line">    templateResolver.setPrefix(<span class="string">"/WEB-INF/templates/"</span>);</span><br><span class="line">    templateResolver.setSuffix(<span class="string">".html"</span>);</span><br><span class="line">    templateResolver.setTemplateMode(<span class="string">"HTML5"</span>);</span><br><span class="line">    <span class="keyword">return</span> templateResolver;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"viewResolver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.thymeleaf.spring3.view.ThymeleafViewResolver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:templateEngine-ref</span>=<span class="string">"templateEngine"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"templateEngine"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.thymeleaf.spring3.SpringTemplateEngine"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:templateResolver-ref</span>=<span class="string">"templateResolver"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"templateResolver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.thymeleaf.templateresolver.ServletContextTemplateResolver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:prefix</span>=<span class="string">"/WEB-INF/templates"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:suffix</span>=<span class="string">".html"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:templateMode</span>=<span class="string">"HTML5"</span> /&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="静态资源"><a href="#静态资源" class="headerlink" title="静态资源"></a>静态资源</h3><h3 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h3><h2 id="内容类型"><a href="#内容类型" class="headerlink" title="*内容类型"></a>*内容类型</h2><p>默认情况下，Spring MVC执行<code>.*</code>后缀模式匹配，以便映射到<code>/person</code>的控制器也隐式映射到<code>/person.*</code>。这种机制主要是为了可以使用文件扩展名来指明响应的请求内容类型（而不是<code>Accept</code>头）。但是，使用文件扩展名来指定请求内容类型已经证明存在多种问题，可能会导致歧义。因此，使用<code>Accept</code>头应该是首选。</p>
<p>要完全禁用文件扩展名，必须同时设置以下两项：</p>
<ul>
<li><p>useSuffixPatternMatching(false)</p>
</li>
<li><p>favorPathExtension(false)</p>
</li>
</ul>
<p>基于Java的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> </span>&#123;</span><br><span class="line">    configurer.setUseSuffixPatternMatch(<span class="keyword">false</span>);</span><br><span class="line">    …</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> UrlPathHelper <span class="title">urlPathHelper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PathMatcher <span class="title">antPathMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于XML配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:path-matching</span></span></span><br><span class="line"><span class="tag">    <span class="attr">suffix-pattern</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">    …/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"pathHelper"</span> <span class="attr">class</span>=<span class="string">"org.example.app.MyPathHelper"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"pathMatcher"</span> <span class="attr">class</span>=<span class="string">"org.example.app.MyPathMatcher"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>基于URL的内容协商（content negotiation）仍然有用（例如，在浏览器中键入URL时）。为此，我们建议使用基于查询参数的策略来避免文件扩展名带来的大多数问题。或者，如果必须使用文件扩展名，请考虑通过<code>ContentNegotiationConfigurer</code>的<code>mediaTypes</code>属性将它们限制为显式注册的扩展名列表。</p>
<h2 id="注册其他Servlet、Filter和Listener"><a href="#注册其他Servlet、Filter和Listener" class="headerlink" title="注册其他Servlet、Filter和Listener"></a>注册其他Servlet、Filter和Listener</h2><h3 id="基于Java的配置"><a href="#基于Java的配置" class="headerlink" title="基于Java的配置"></a>基于Java的配置</h3><p>基于Java的初始化器（Initializer）的一个好处是我们可以定义任意数量的初始化器类。因此，我们如果想往Web容器中注册其他组件，只需要创建一个新的初始化器就可以了。最简单的方式是就是实现Spring的<code>WebApplicationInitializer</code>接口。</p>
<p>注册Servlet：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServletInitializer</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    ServletRegistration.Dynamic myServlet = servletContext.addServlet(<span class="string">"myServlet"</span>, MyServlet<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    myServlet.addMapping(<span class="string">"/custom/**"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册Filter：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">  FilterRegistration.Dynamic filter = servletContext.addFilter(<span class="string">"myFilter"</span>, MyFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  filter.addMappingForUrlPatterns(<span class="keyword">null</span>, <span class="keyword">false</span>, <span class="string">"/custom/**"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册Filter并将其映射到<code>DispatcherServlet</code>，有一个快捷方式，就是重写<code>AbstractAnnotationConfigDispatcherServletInitializer</code>类的<code>getServletFilter</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Filter[] getServletFilters() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Filter[] &#123;<span class="keyword">new</span> MyFilter()&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getServletFilter</code>方法返回的所有Filter都会映射到<code>DispatcherServlet</code>上。</p>
<h3 id="基于web-xml的配置"><a href="#基于web-xml的配置" class="headerlink" title="基于web.xml的配置"></a>基于web.xml的配置</h3><p>参见“传统的web.xml配置。</p>
<h2 id="Multipart请求"><a href="#Multipart请求" class="headerlink" title="Multipart请求"></a>Multipart请求</h2><h3 id="通过Spring解析器处理"><a href="#通过Spring解析器处理" class="headerlink" title="通过Spring解析器处理"></a>通过Spring解析器处理</h3><h4 id="配置multipart解析器"><a href="#配置multipart解析器" class="headerlink" title="配置multipart解析器"></a>配置multipart解析器</h4><p><code>DispatcherServlet</code>并没有实现任何解析multipart请求数据的功能，它将该任务委托给了Spring中的<code>MultipartResolver</code>策略接口的实现。从Spring 3.1开始，Spring内置了两个<code>MultipartResolver</code>实现供我们选择：</p>
<ul>
<li><code>CommonsMultipartResolver</code>：使用Jakarta Commons FileUpload解析multipart请求。</li>
<li><code>StandardServletMultipartResolver</code>：依赖于Servlet 3对multipart请求的支持（始于Spring 3.1）。</li>
</ul>
<h5 id="使用Servlet-3-0解析multipart请求"><a href="#使用Servlet-3-0解析multipart请求" class="headerlink" title="使用Servlet 3.0解析multipart请求"></a>使用Servlet 3.0解析multipart请求</h5><p>首先，配置一个<code>StandardServletMultipartResolver</code> Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StandardServletMultipartResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，有关multipart的配置（例如上传文件大小限制、临时写入目录的位置等）则在<code>DispatcherServlet</code>中配置。</p>
<p>如果初始化器实现了<code>WebApplicationInitializer</code>，则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebApplicationInitializer</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletCxt)</span> </span>&#123;</span><br><span class="line">    …</span><br><span class="line">    DispatcherServlet ds = <span class="keyword">new</span> DispatcherServlet();</span><br><span class="line">    ServletRegistration.Dynamic registration = servletCxt.addServlet(<span class="string">"app"</span>, ds);</span><br><span class="line">    registration.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    registration.addMapping(<span class="string">"/app/*"</span>);</span><br><span class="line">    <span class="comment">//设置临时写入路径</span></span><br><span class="line">		registration.setMultipartConfig(<span class="keyword">new</span> MultipartConfigElement(<span class="string">"/tmp/uploads"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果初始化器继承了<code>AnnotationConfigDispatcherServletInitializer</code>，则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizeRegistration</span><span class="params">(Dynamic registration)</span> </span>&#123;</span><br><span class="line">  registration.setMultipartConfig(<span class="keyword">new</span> MultipartConfigElement(<span class="string">"/tmp/uploads"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MultipartConfigElement</code>还有一个构造器，能接受如下参数：</p>
<ul>
<li>临时写入目录；</li>
<li>上传文件的最大容量（以字节为单位），默认是没有限制的。</li>
<li>整个multipart请求的最大容量（以字节为单位），默认是没有限制的。（对part的个数，以及每个part的大小则不关心）。</li>
<li>在上传过程中，如果文件大小达到一个指定最大容量（以字节为单位）时，将会写入到临时文件路径中。默认值为0，即所有上传的文件都会写入到磁盘中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizeRegistration</span><span class="params">(Dynamic registration)</span> </span>&#123;</span><br><span class="line">  registration.setMultipartConfig(<span class="keyword">new</span> MultipartConfigElement(<span class="string">"/tmp/uploads"</span>, <span class="number">2097152</span>, <span class="number">4194304</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，也可以在web.xml中配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>app<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">multipart-config</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">location</span>&gt;</span>/tmp/uploads<span class="tag">&lt;/<span class="name">location</span>&gt;</span><span class="comment">&lt;!-- 必配选项 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">max-file-size</span>&gt;</span>2097152<span class="tag">&lt;/<span class="name">max-file-size</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">max-request-size</span>&gt;</span>4194304<span class="tag">&lt;/<span class="name">max-request-size</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">multipart-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="配置Jakarta-Commons-FileUpload-multipart解析器"><a href="#配置Jakarta-Commons-FileUpload-multipart解析器" class="headerlink" title="配置Jakarta Commons FileUpload multipart解析器"></a>配置Jakarta Commons FileUpload multipart解析器</h5><p>通常来讲，<code>StandardServletMultipartResolver</code> 会是最佳的选择，但是如果我们需要将应用部署到非Servlet 3.0的容器中，那么就需要使用替代方案——<code>CommonsMultipartResolver</code>。</p>
<p><code>CommonsMultipartResolver</code>的最简单配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> CommonsMultipartResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与<code>StandardServletMultipartResolver</code> 有所不同，<code>CommonsMultipartResolver</code>不会强制要求设置临时文件路径。默认情况下，这个路径就是Servlet容器的临时目录。另外，有关multipart的配置是通过<code>CommonsMultipartResolver</code>的方法来设置的，而不是在<code>DispatcherServlet</code>中设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  CommonsMultipartResolver multipartResolver = <span class="keyword">new</span> CommonsMultipartResolver();</span><br><span class="line">  multipartResolver.setUploadTempDir(<span class="keyword">new</span> FileSystemResource(<span class="string">"/tmp/uploads"</span>));</span><br><span class="line">  multipartResolver.setMaxUploadSize(<span class="number">2097152</span>); <span class="comment">//上传文件的最大容量</span></span><br><span class="line">  multipartResolver.setMaxInMemorySize(<span class="number">0</span>);<span class="comment">//相当于MultipartConfigElement第四个参数</span></span><br><span class="line">  <span class="keyword">return</span> multipartResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CommonsMultipartResolver</code>无法设置整个multipart请求的最大容量。</p>
<h4 id="创建Multipart表单"><a href="#创建Multipart表单" class="headerlink" title="创建Multipart表单"></a>创建Multipart表单</h4><p>表单视图：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">th:object</span>=<span class="string">"$&#123;spitter&#125;"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>Profile Picture<span class="tag">&lt;/<span class="name">label</span>&gt;</span>:</span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"profilePicture"</span> <span class="attr">accept</span>=<span class="string">"image/jpeg;image/png,image/gif"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;form&gt;</code>表单将<code>enctype</code>设置为<code>multipart/form-data</code>，会告诉浏览器以multipart数据的形式提交表单，而不是以表单数据形式提交。在multipart中，每个输入域都会对应一个part。</p>
<p>表单数据示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firstName&#x3D;Charles&amp;lastName&#x3D;Xavier&amp;email&#x3D;professorx%40xmen.org</span><br><span class="line">&amp;username&#x3D;professorx&amp;password&#x3D;letmein01</span><br></pre></td></tr></table></figure>

<p>multipart请求体示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;firstName&quot;</span><br><span class="line">Charles</span><br><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;lastName&quot;</span><br><span class="line">Xavier</span><br><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;email&quot;</span><br><span class="line">charles@xmen.com</span><br><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;username&quot;</span><br><span class="line">professorx</span><br><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;password&quot;</span><br><span class="line">letmein01</span><br><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;profilePicture&quot;; filename&#x3D;&quot;me.jpg&quot;</span><br><span class="line">Content-Type: image&#x2F;jpeg</span><br><span class="line">[[ Binary image data goes here ]]</span><br><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW--</span><br></pre></td></tr></table></figure>

<p>文件域的<code>accept</code>属性用来将文件类型限制为JPEG、PNG和GIF图片。</p>
<p><code>multipart/form-data</code>表单除了可以包含文件域外，也可以包含其他表单元素。</p>
<h4 id="处理Multipart请求"><a href="#处理Multipart请求" class="headerlink" title="处理Multipart请求"></a>处理Multipart请求</h4><p>Spring提供了多种方式来接收上传的文件，但都需要在接收上传文件的处理器方法参数上标上<code>@RequestPart</code>标注。</p>
<h5 id="接收为byte"><a href="#接收为byte" class="headerlink" title="接收为byte[]"></a>接收为byte[]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @RequestPart(<span class="string">"profilePicture"</span>)</span> <span class="keyword">byte</span>[] profilePicture,</span></span><br><span class="line"><span class="function">    @Valid Spitter spitter,</span></span><br><span class="line"><span class="function">    Errors errors) </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式只能获取上传文件的数据和大小，而无法获取上传文件的原来文件名、文件类型。</p>
<p>如果提交表单时，没有选择文件，则<code>profilePicture</code>为空数组，而不是<code>null</code>。</p>
<blockquote>
<p><code>@RequestPart</code>和<code>@RequestParam</code>都可用在multipart请求中，主要区别在于，当方法参数不是<code>String</code>或原始<code>MultipartFile</code> / <code>Part</code>时，<code>@ RequestParam</code>依赖于通过已注册的<code>Converter</code>或<code>PropertyEditor</code>进行类型转换，而<code>RequestPart</code>依赖于<code>HttpMessageConverters</code>，同时考虑到请求部分的“Content-Type”标头。 <code>RequestParam</code>可能与“名称 - 值”表单字段一起使用，而<code>RequestPart</code>可能与包含更复杂内容的部分一起使用，例如JSON，XML）。</p>
</blockquote>
<h5 id="接收为MultipartFile"><a href="#接收为MultipartFile" class="headerlink" title="接收为MultipartFile"></a>接收为MultipartFile</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @RequestPart(<span class="string">"profilePicture"</span>)</span> MultipartFile profilePicture,</span></span><br><span class="line"><span class="function">    @Valid Spitter spitter,</span></span><br><span class="line"><span class="function">    Errors errors) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!profilePicture.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = profilePicture.getBytes();</span><br><span class="line">    <span class="comment">// store the bytes somewhere</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:uploadSuccess"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"redirect:uploadFailure"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MultipartFile</code>接口为处理multipart数据提供了内容更为丰富的对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipartFile</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function">String <span class="title">getOriginalFilename</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function">String <span class="title">getContentType</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">long</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">byte</span>[] getBytes() <span class="keyword">throws</span> IOException;</span><br><span class="line">  <span class="function">InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">transferTo</span><span class="params">(File dest)</span> <span class="keyword">throws</span> IOException</span>; <span class="comment">//将上传文件写入dest文件中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当表单中，文件域允许多选时，可以将处理器参数声明为<code>List&lt;MultipartFile&gt;</code>类型。</p>
<p>当表单中存在多个文件域时，可以将一个处理器参数声明为<code>Map&lt;String, MultipartFile&gt;</code> 或 <code>MultiValueMap&lt;String, MultipartFile&gt;</code>类型。这时<code>@RequestPart</code>或<code>@RequestParam</code> 标注不需要设置<code>name</code>或<code>value</code>属性值，文件域的<code>name</code>属性自动成为<code>Map</code>或<code>MultiValueMap</code>的键。</p>
<h3 id="通过Part形式处理"><a href="#通过Part形式处理" class="headerlink" title="通过Part形式处理"></a>通过Part形式处理</h3><p>当使用Servlet 3.0容器时，Spring MVC也能接受<code>javax.servlet.http.Part</code>作为处理器接收上传文件的参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/register"</span>, method=POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processRegistration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @RequestPart(<span class="string">"profilePicture"</span>)</span> Part profilePicture,</span></span><br><span class="line"><span class="function">    @Valid Spitter spitter,</span></span><br><span class="line"><span class="function">    Errors errors) </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Part</code>接口与<code>MultipartFile</code>接口并没有太大的差别：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Part</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getContentType</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getSubmittedFileName</span><span class="params">()</span></span>;  <span class="comment">//对应于getOriginalFilename()</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> IOException</span>; <span class="comment">//对应于transferTo</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getHeader</span><span class="params">(String name)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">getHeaders</span><span class="params">(String name)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">getHeaderNames</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果使用<code>Part</code>代替<code>MultipartFile</code>接收上传文件，就没有必须配置<code>MultipartResolver</code>了。</p>
<h2 id="处理异常"><a href="#处理异常" class="headerlink" title="处理异常"></a>处理异常</h2><h3 id="自动将异常映射为HTTP状态码"><a href="#自动将异常映射为HTTP状态码" class="headerlink" title="自动将异常映射为HTTP状态码"></a>自动将异常映射为HTTP状态码</h3><p>在默认情况下，Spring会将自身的一些异常自动转换为合适的状态码：</p>
<table>
<thead>
<tr>
<th>Spring异常</th>
<th>HTTP状态码</th>
</tr>
</thead>
<tbody><tr>
<td>BindException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>ConversionNotSupportedException</td>
<td>500 - Internal Server Error</td>
</tr>
<tr>
<td>HttpMediaTypeNotAcceptableException</td>
<td>406 - Not Acceptable</td>
</tr>
<tr>
<td>HttpMediaTypeNotSupportedException</td>
<td>415 - Unsupported Media Type</td>
</tr>
<tr>
<td>HttpMessageNotReadableException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>HttpMessageNotWritableException</td>
<td>500 - Internal Server Error</td>
</tr>
<tr>
<td>HttpRequestMethodNotSupportedException</td>
<td>405 - Method Not Allowed</td>
</tr>
<tr>
<td>MethodArgumentNotValidException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>MissingServletRequestParameterException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>MissingServletRequestPartException</td>
<td>400 - Bad Request</td>
</tr>
<tr>
<td>NoSuchRequestHandlingMethodException</td>
<td>404 - Not Found</td>
</tr>
<tr>
<td>TypeMismatchException</td>
<td>400 - Bad Request</td>
</tr>
</tbody></table>
<h3 id="使用-ResponseStatus标注映射HTTP状态码"><a href="#使用-ResponseStatus标注映射HTTP状态码" class="headerlink" title="使用@ResponseStatus标注映射HTTP状态码"></a>使用<code>@ResponseStatus</code>标注映射HTTP状态码</h3><p>除了上节中Spring自动映射的异常外，其他任何异常如果没有显式映射，响应都会带有500状态码。我们可以使用<code>@ResponseStatus</code>标注，将自己定义的异常显式映射为指定HTTP状态码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseStatus</span>(value=HttpStatus.NOT_FOUND,</span><br><span class="line">                reason=<span class="string">"Spittle Not Found"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittleNotFoundException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在使用<code>@ResponseStatus</code>标注之后，如果控制器方法抛出<code>SpittleNotFoundException</code>异常，响应将会具有404状态码。</p>
<h3 id="编写异常处理的方法"><a href="#编写异常处理的方法" class="headerlink" title="编写异常处理的方法"></a>编写异常处理的方法</h3><p>在很多场景下，将异常映射为状态码就够了。但如果我们要处理这个异常，则传统的方式是使用try-catch语句来处理。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">saveSpittle</span><span class="params">(SpittleForm form, Model model)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    spittleRepository.save(</span><br><span class="line">    	<span class="keyword">new</span> Spittle(<span class="keyword">null</span>, form.getMessage(), <span class="keyword">new</span> Date(),</span><br><span class="line">    		form.getLongitude(), form.getLatitude()));</span><br><span class="line">  	<span class="keyword">return</span> <span class="string">"redirect:/spittles"</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DuplicateSpittleException e) &#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="string">"error/duplicate"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring允许我们将异常处理的代码从正常代码中剥离出来，让另外一个方法专门处理异常。</p>
<p>只处理正常逻辑的控制器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">saveSpittle</span><span class="params">(SpittleForm form, Model model)</span> </span>&#123;</span><br><span class="line">  spittleRepository.save(</span><br><span class="line">  	<span class="keyword">new</span> Spittle(<span class="keyword">null</span>, form.getMessage(), <span class="keyword">new</span> Date(),</span><br><span class="line">  		form.getLongitude(), form.getLatitude()));</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"redirect:/spittles"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<strong>同一个</strong>控制器类中添加一个处理异常的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler</span>(DuplicateSpittleException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">String</span> <span class="title">handleDuplicateSpittle</span>() </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"error/duplicate"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，不仅<code>saveSpittle</code>方法抛出<code>DuplicateSpittleException</code>异常时，会委托<code>handleDuplicateSpittle</code>方法处理，而且只要是与<code>handleDuplicateSpittle</code>方法在同一个控制器类中的所有处理器方法抛出<code>DuplicateSpittleException</code>异常，都会委托<code>handleDuplicateSpittle</code>方法处理。</p>
<p><code>@ExceptionHandler</code>只能处理同一个控制器类下的处理器方法抛出的异常。而如果要能够处理所有控制器中处理器方法抛出的异常，则需要将处理异常代码定义到控制器通知类中。（参见“控制器通知”）</p>
<h2 id="语言环境"><a href="#语言环境" class="headerlink" title="语言环境"></a>语言环境</h2><h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><h2 id="异步请求"><a href="#异步请求" class="headerlink" title="异步请求"></a>异步请求</h2><h2 id="HTTP缓存"><a href="#HTTP缓存" class="headerlink" title="HTTP缓存"></a>HTTP缓存</h2><h1 id="Spring-WebFlux"><a href="#Spring-WebFlux" class="headerlink" title="Spring WebFlux"></a>Spring WebFlux</h1><h1 id="Spring-REST"><a href="#Spring-REST" class="headerlink" title="Spring REST"></a>Spring REST</h1><p>REST就是将资源的状态以最适合客户端或服务端的表现形式（Representational）从服务器端转移（Transfer）到客户端（或者反过来）。</p>
<p>RPC是面向服务的，并关注于行为和动作；而REST是面向资源的，强调描述应用程序的事物和名词。</p>
<p>REST资源是通过URL进行识别和定位的。</p>
<p>REST中会有行为，它们是通过HTTP方法来定义的：</p>
<ul>
<li>POST：创建（非幂等性）</li>
<li>GET：获取</li>
<li>PUT：更新</li>
<li>PATCH：部分更新</li>
<li>DELETE：删除</li>
</ul>
<h2 id="REST端点"><a href="#REST端点" class="headerlink" title="REST端点"></a>REST端点</h2><p>在Spring MVC中，REST端点实际上就是Spring MVC的控制器。之前编写的Spring MVC控制器可以看作是响应以HTML为表现形式的REST端点。</p>
<h3 id="内容协商"><a href="#内容协商" class="headerlink" title="内容协商"></a>内容协商</h3><p>Spring提供了两种方法将资源的Java表现形式转换为发送给客户端的表现形式：</p>
<ul>
<li>内容协商（Content Negotiation）：选择一个视图，它能够将模型渲染为呈现给客户端的表现形式；</li>
<li>消息转换器（Message Convention）：通过一个消息转换器将控制器所返回的对象转换为呈现给客户端的表现形式。（推荐）</li>
</ul>
<h4 id="配置内容协商视图解析器"><a href="#配置内容协商视图解析器" class="headerlink" title="配置内容协商视图解析器"></a>配置内容协商视图解析器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewResolver <span class="title">cnViewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ContentNegotiatingViewResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，如果在URL结尾处有文件扩展名，则<code>ContentNegotiatingViewResolver</code>将会基于该扩展名确定所需的类型。例如，扩展名<code>.json</code>对应的内容类型是<code>application/json</code>。</p>
<p>如果根据文件扩展名不能得到任何媒体类型的话，则就会考虑请求中的<code>Accept</code>头部信息中指定的内容类型。</p>
<p>如果没有<code>Accept</code>头部信息，并且扩展名也无法提供帮助，则<code>ContentNegotiatingViewResolver</code>将会使用<code>/</code>作为默认的内容类型，即客户端必须要接收服务器发送的任何形式的表现形式。</p>
<p>一旦内容类型确定之后，<code>ContentNegotiatingViewResolver</code>将会委托其他的视图解析器将逻辑视图名解析为社图。解析得到的每个视图都会放到一个列表中，这个列表装配完成之后，<code>ContentNegotiatingViewResolver</code> 会循环客户端请求的所有媒体类型，在候选的视图中查找能够产生对应内容类型的视图，第一个匹配的视图会用来渲染模型。</p>
<h4 id="控制媒体类型的选择"><a href="#控制媒体类型的选择" class="headerlink" title="控制媒体类型的选择"></a>控制媒体类型的选择</h4><p>通过<code>ContentNegotiationManager</code>我们能够改变上面使用的确定请求媒体类型的默认策略。具体说，它能够：</p>
<ul>
<li>指定默认的内容类型，如果根据请求无法得到内容类型的话，将会使用默认值；</li>
<li>通过请求参数指定内容类型；</li>
<li>忽视请求的<code>Accept</code>头部信息；</li>
<li>将请求的扩展名映射为特定的媒体类型；</li>
<li>将JAF（Java Activation Framework）作为根据扩展名查找媒体类型的备用方案。</li>
</ul>
<p>有三种配置<code>ContentNegotiationManager</code>的方法：</p>
<ul>
<li>直接声明一个<code>ContentNegotiationManager</code>类型的Bean（比较复杂）；</li>
<li>通过<code>ContentNegotiationManagerFactoryBean</code>间接创建Bean；</li>
<li>重写<code>WebMvcConfigurerAdapter</code>的<code>configureContentNegotiation</code>方法。</li>
</ul>
<p>例如：将<code>application/json</code>作为默认的内容类型</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"contentNegotiationManager"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.http.ContentNegotiationManagerFactoryBean"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:defaultContentType</span>=<span class="string">"application/json"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span> </span>&#123;</span><br><span class="line">  configurer.defaultContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了<code>ContentNegotiationManager</code> Bean后，接下来就需要将它注入到<code>ContentNegotiatingViewResolver</code>的<code>contentNegotiationManager</code>属性中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewResolver <span class="title">cnViewResolver</span><span class="params">(ContentNegotiationManager cnm)</span> </span>&#123;</span><br><span class="line">  ContentNegotiatingViewResolver cnvr = <span class="keyword">new</span> ContentNegotiatingViewResolver();</span><br><span class="line">  cnvr.setContentNegotiationManager(cnm);</span><br><span class="line">  <span class="keyword">return</span> cnvr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ContentNegotiatingViewResolver-的优势和限制"><a href="#ContentNegotiatingViewResolver-的优势和限制" class="headerlink" title="ContentNegotiatingViewResolver 的优势和限制"></a>ContentNegotiatingViewResolver 的优势和限制</h4><p><code>ContentNegotiatingViewResolver</code>最大优势在于，它在Spring MVC之上构建了REST资源表现层，控制器代码无需修改。</p>
<p><code>ContentNegotiatingViewResolver</code>作为ViewResolver的实现，它只能决定资源该如何渲染到客户端，并没有涉及到客户端要发送什么样的表现形式给控制器使用。</p>
<p><code>ContentNegotiatingViewResolver</code>所选中的<code>View</code>会渲染<strong>模型</strong>给客户端，而不是资源。例如当客户端请求JSON格式的<code>Spittle</code>对象列表时，客户端希望得到的响应是：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">42</span>,</span><br><span class="line">    <span class="attr">"latitude"</span>: <span class="number">28.419489</span>,</span><br><span class="line">    <span class="attr">"longitude"</span>: <span class="number">-81.581184</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"Hello World!"</span>,</span><br><span class="line">    <span class="attr">"time"</span>: <span class="number">1400389200000</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">43</span>,</span><br><span class="line">    <span class="attr">"latitude"</span>: <span class="number">28.419136</span>,</span><br><span class="line">    <span class="attr">"longitude"</span>: <span class="number">-81.577225</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"Blast off!"</span>,</span><br><span class="line">    <span class="attr">"time"</span>: <span class="number">1400475600000</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>而模型是键值对组成的<code>Map</code>，实际的响应可能是：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"spittleList"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="number">42</span>,</span><br><span class="line">      <span class="attr">"latitude"</span>: <span class="number">28.419489</span>,</span><br><span class="line">      <span class="attr">"longitude"</span>: <span class="number">-81.581184</span>,</span><br><span class="line">      <span class="attr">"message"</span>: <span class="string">"Hello World!"</span>,</span><br><span class="line">      <span class="attr">"time"</span>: <span class="number">1400389200000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="number">43</span>,</span><br><span class="line">      <span class="attr">"latitude"</span>: <span class="number">28.419136</span>,</span><br><span class="line">      <span class="attr">"longitude"</span>: <span class="number">-81.577225</span>,</span><br><span class="line">      <span class="attr">"message"</span>: <span class="string">"Blast off!"</span>,</span><br><span class="line">      <span class="attr">"time"</span>: <span class="number">1400475600000</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HTTP信息转换器"><a href="#HTTP信息转换器" class="headerlink" title="HTTP信息转换器"></a>HTTP信息转换器</h3><p>消息转换器提供了一种更为直接的方式，它能够将控制器产生的数据转换为服务于客户端的表现形式。<code>DispatcherServlet</code>不再需要那么麻烦地将模型数据传到视图中。实际上，这里根本就没有模型，也没有视图，只有控制器产生的数据，以及消息转换器转换数据之后所产生的资源表现形式。</p>
<p>Spring提供了多个HTTP信息转换器，用于实现资源表现与各种Java类型之间的互相转换：</p>
<table>
<thead>
<tr>
<th>信息转换器</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>AtomFeedHttpMessageConverter</td>
<td>Rome Feed对象和Atom feed（<code>application/atom+xml</code>）之间的互相转换。<em>如果Rome包在类路径下将会自动进行注册</em>。</td>
</tr>
<tr>
<td>BufferedImageHttpMessageConverter</td>
<td>BufferedImages与图片二进制数据之间互相转换。默认注册。</td>
</tr>
<tr>
<td>ByteArrayHttpMessageConverter</td>
<td>读取/写入字节数组。从任意媒体类型（<code>*/*</code>）中读取，并以<code>application/octet-stream</code>格式写入。默认注册。</td>
</tr>
<tr>
<td>FormHttpMessageConverter</td>
<td>将<code>application/x-www-form-urlencoded</code>内容读入到<code>MultiValueMap&lt;String, String&gt;</code>中，也会将<code>MultiValueMap&lt;String, String&gt;</code>写入到<code>application/x-www-form-urlencoded</code>中，或将<code>MultiValueMap&lt;String, Object&gt;</code>写入到<code>multipart/form-data</code>中。默认注册。</td>
</tr>
<tr>
<td>Jaxb2RootElementHttpMessageConverter</td>
<td>在XML（<code>text/xml</code>或<code>application/xml</code>）和使用JAXB2标注的对象间互相转换。<em>如果JAXB v2包在类路径下将会自动进行注册</em>。</td>
</tr>
<tr>
<td>MappingJacksonHttpMessageConverter</td>
<td>在JSON和类型化的对象或非类型化的HashMap间互相转换。<em>如果Jackson JSON包在类路径下将会自动进行注册</em>。</td>
</tr>
<tr>
<td>MappingJackson2HttpMessageConverter</td>
<td>在JSON和类型化的对象或非类型化的HashMap间互相转换。<em>如果Jackson 2 JSON包在类路径下将会自动进行注册</em>。</td>
</tr>
<tr>
<td>MarshallingHttpMessageConverter</td>
<td>使用注入的编排器（marshaller）和解排器（unmarshaller）来读取和写入XML。支持的编排器和解排器包括Castor、JAXB2、JIBX、XMLBeans以及Xstream。默认注册。</td>
</tr>
<tr>
<td>ResourceHttpMessageConverter</td>
<td>读取或写入Resource。默认注册。</td>
</tr>
<tr>
<td>RssChannelHttpMessageConverter</td>
<td>在RSS feed和Rome Channel对象间互相转换。<em>如果Rome包在类路径下将会自动进行注册</em>。</td>
</tr>
<tr>
<td>SourceHttpMessageConverter</td>
<td>在XML和<code>javax.xml.transform.Source</code>对象间互相转换。默认注册。</td>
</tr>
<tr>
<td>StringHttpMessageConverter</td>
<td>将任意媒体类型（<code>*/*</code>）读取为<code>String</code>。将<code>String</code>写入为<code>text/plain</code>。默认注册。</td>
</tr>
<tr>
<td>XmlAwareFormHttpMessageConverter</td>
<td><code>FormHttpMessageConverter</code>的扩展，使用<code>SourceHttpMessageConverter</code>来支持基于XML的部分。默认注册。</td>
</tr>
</tbody></table>
<h4 id="在响应体中返回资源状态"><a href="#在响应体中返回资源状态" class="headerlink" title="在响应体中返回资源状态"></a>在响应体中返回资源状态</h4><p>正常情况下，当处理器方法返回Java对象（除了String或<code>View</code>实现以外）时，这个对象会放在模型中并在视图中渲染使用。但是，如果使用了消息转换功能，我们需要告诉Spring跳过正常的模型/视图流程，并使用消息转换器。最简单的做法是为控制器方法添加<code>@ResponseBody</code>标注，它会告知Spring，我们要将返回的对象作为资源发送给客户端，并将其转换为客户端可接受的表现形式。更具体地讲，<code>DispatcherServlet</code>将会考虑到请求中<code>Accept</code>头部信息，并查找能够为客户端提供所需要表现形式的消息转换器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(method=RequestMethod.GET, produces=<span class="string">"application/json"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">List&lt;Spittle&gt; <span class="title">spittles</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @RequestParam(value=<span class="string">"max"</span>, defaultValue=MAX_LONG_AS_STRING)</span> <span class="keyword">long</span> max,</span></span><br><span class="line"><span class="function">    @<span class="title">RequestParam</span><span class="params">(value=<span class="string">"count"</span>, defaultValue=<span class="string">"20"</span>)</span> <span class="keyword">int</span> count) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> spittleRepository.findSpittles(max, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>produces</code>属性表明这个方法只处理预期输出为JSON的请求，即只会处理<code>Accept</code>头部信息包含<code>application/json</code>的请求。</p>
<h4 id="在请求体中接收资源状态"><a href="#在请求体中接收资源状态" class="headerlink" title="在请求体中接收资源状态"></a>在请求体中接收资源状态</h4><p><code>@ResponseBody</code>能够告诉Spring在把数据发送给客户端时，要使用某个消息转换器。与之类似，<code>@RequestBody</code>也能告诉Spring查找一个消息转换器，将来自客户端的资源表现转换为对象。具体地说，<code>@RequestBody</code>会查看请求中的<code>Content-Type</code>头部信息，并查找能够将请求体转换为对象的消息转换器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(method=RequestMethod.POST, consumes=<span class="string">"application/json"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">Spittle <span class="title">saveSpittle</span><span class="params">(@RequestBody Spittle spittle)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> spittleRepository.save(spittle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>consumes</code>属性表示这个方法只处理<code>Content-Type</code>头部信息包含<code>application/json</code>的请求。</p>
<blockquote>
<p><code>@RequestBody</code>是针对请求体中的数据，而<code>@RequestParam</code>是针对请求头中的参数。</p>
</blockquote>
<h4 id="为控制器设置默认消息转换"><a href="#为控制器设置默认消息转换" class="headerlink" title="为控制器设置默认消息转换"></a>为控制器设置默认消息转换</h4><p>Spring 4.0引入了<code>@RestController</code>标注，如果在控制器类上使用<code>@RestController</code>来代替<code>@Controller</code>，Spring将会为该控制器的所有处理器方法应用消息转换功能，而不必为每个方法添加<code>@ResponseBody</code>标注。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/spittles"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittleController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MAX_LONG_AS_STRING=<span class="string">"9223372036854775807"</span>;</span><br><span class="line">  <span class="keyword">private</span> SpittleRepository spittleRepository;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SpittleController</span><span class="params">(SpittleRepository spittleRepository)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.spittleRepository = spittleRepository;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@RequestMapping</span>(method=RequestMethod.GET)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Spittle&gt; <span class="title">spittles</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      @RequestParam(value=<span class="string">"max"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                    defaultValue=MAX_LONG_AS_STRING)</span> <span class="keyword">long</span> max,</span></span><br><span class="line"><span class="function">      @<span class="title">RequestParam</span><span class="params">(value=<span class="string">"count"</span>, defaultValue=<span class="string">"20"</span>)</span> <span class="keyword">int</span> count) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> spittleRepository.findSpittles(max, count);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@RequestMapping</span>(</span><br><span class="line">    method=RequestMethod.POST</span><br><span class="line">    consumes=<span class="string">"application/json"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Spittle <span class="title">saveSpittle</span><span class="params">(@RequestBody Spittle spittle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> spittleRepository.save(spittle);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="发送错误信息到客户端"><a href="#发送错误信息到客户端" class="headerlink" title="发送错误信息到客户端"></a>发送错误信息到客户端</h3><p>前面Spring MVC中我们已经学会了使用<code>@ResponseStatus</code>标注来将错误映射到HTTP状态码，也学会了如何使用异常处理器来处理异常。</p>
<p>在Spring REST中，作为<code>@ResponseBody</code>的替代方案，控制器方法可以返回一个<code>ResponseEntity</code>对象，它可以包含响应相关的元数据（如头部信息和状态码）以及要转换成资源表现的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;id&#125;"</span>, method=RequestMethod.GET)</span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;?&gt; spittleById(<span class="meta">@PathVariable</span> <span class="keyword">long</span> id) &#123;</span><br><span class="line">  Spittle spittle = spittleRepository.findOne(id);</span><br><span class="line">  <span class="keyword">if</span> (spittle == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Error error = <span class="keyword">new</span> Error(<span class="number">4</span>, <span class="string">"Spittle ["</span> + id + <span class="string">"] not found"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;Error&gt;(error, HttpStatus.NOT_FOUND);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;Spittle&gt;(spittle, HttpStatus.OK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>错误对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Error</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">  <span class="keyword">private</span> String message;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Error</span><span class="params">(<span class="keyword">int</span> code, String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.code = code;</span><br><span class="line">    <span class="keyword">this</span>.message = message;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> code;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> message;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>控制器方法如果返回<code>ResponseEntity</code>对象，就没必要在方法上使用<code>@ResponseBody</code>标注了。</p>
</blockquote>
<h4 id="分离异常处理"><a href="#分离异常处理" class="headerlink" title="分离异常处理"></a>分离异常处理</h4><p>前面的代码将异常处理与正常逻辑混杂在一起，并且方法返回<code>ResponseEntity&lt;?&gt;</code>泛型，增加了复杂性。下面我们使用异常处理器将异常处理部分从正常逻辑中分离出来。</p>
<p>控制器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;id&#125;"</span>, method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Spittle <span class="title">spittleById</span><span class="params">(@PathVariable <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">  Spittle spittle = spittleRepository.findOne(id);</span><br><span class="line">  <span class="keyword">if</span> (spittle == <span class="keyword">null</span>) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> SpittleNotFoundException(id); &#125;</span><br><span class="line">  <span class="keyword">return</span> spittle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我们知道<code>spittleById</code>将会返回<code>Spittle</code>并且HTTP状态码始终会是200，因此就可以不使用<code>ResponseEntity</code>，而是将其替换为<code>@ResponseBody</code>。另外，假设这里控制器类使用了<code>@RestController</code>标注，则<code>@ResponseBody</code>也省略了。</p>
<p>异常处理器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler</span>(SpittleNotFoundException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ResponseStatus</span>(<span class="title">HttpStatus</span>.<span class="title">NOT_FOUND</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">ResponseBody</span> <span class="title">Error</span> <span class="title">spittleNotFound</span>(<span class="title">SpittleNotFoundException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> spittleId = e.getSpittleId();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Error(<span class="number">4</span>, <span class="string">"Spittle ["</span> + spittleId + <span class="string">"] not found"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样，如果控制器类使用了<code>@RestController</code>标注，则<code>@ResponseBody</code>也可以省略掉。</p>
<p>异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittleNotFoundException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> spittleId;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SpittleNotFoundException</span><span class="params">(<span class="keyword">long</span> spittleId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.spittleId = spittleId;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSpittleId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> spittleId;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在响应中设置头部信息"><a href="#在响应中设置头部信息" class="headerlink" title="在响应中设置头部信息"></a>在响应中设置头部信息</h3><p>前面提到的<code>ResponseEntity</code>更主要的用途是为响应设置头部信息。</p>
<p>假设我们希望在新建Spittle资源后，将新建资源的URL放在响应的<code>Location</code>头部信息中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(method=RequestMethod.POST, consumes=<span class="string">"application/json"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;Spittle&gt; <span class="title">saveSpittle</span><span class="params">(@RequestBody Spittle spittle, </span></span></span><br><span class="line"><span class="function"><span class="params">                                           UriComponentsBuilder ucb)</span> </span>&#123;</span><br><span class="line">  Spittle spittle = spittleRepository.save(spittle);</span><br><span class="line">  HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">  URI locationUri =</span><br><span class="line">    ucb.path(<span class="string">"/spittles/"</span>)</span><br><span class="line">       .path(String.valueOf(spittle.getId())) <span class="comment">//每次调用path()都会基于上次调用的结果。</span></span><br><span class="line">       .build() <span class="comment">//构建UriComponents对象</span></span><br><span class="line">       .toUri(); <span class="comment">//转换为URI对象</span></span><br><span class="line">  headers.setLocation(locationUri);</span><br><span class="line">  ResponseEntity&lt;Spittle&gt; responseEntity =</span><br><span class="line">    <span class="keyword">new</span> ResponseEntity&lt;Spittle&gt;(spittle, headers, HttpStatus.CREATED)</span><br><span class="line">  <span class="keyword">return</span> responseEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UriComponentsBuilder</code>用于帮助构建URL，它会从请求中获取host、端口号等信息，从而构建出一个完整的URL。</p>
<h2 id="REST客户端"><a href="#REST客户端" class="headerlink" title="REST客户端"></a>REST客户端</h2><h3 id="使用Apache-HTTP-Client"><a href="#使用Apache-HTTP-Client" class="headerlink" title="使用Apache HTTP Client"></a>使用Apache HTTP Client</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Profile <span class="title">fetchFacebookProfile</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//创建客户端</span></span><br><span class="line">    HttpClient client = HttpClients.createDefault();</span><br><span class="line">    <span class="comment">//创建请求</span></span><br><span class="line">    HttpGet request = <span class="keyword">new</span> HttpGet(<span class="string">"http://graph.facebook.com/"</span> + id);</span><br><span class="line">    request.setHeader(<span class="string">"Accept"</span>, <span class="string">"application/json"</span>);</span><br><span class="line">    <span class="comment">//执行请求</span></span><br><span class="line">    HttpResponse response = client.execute(request);</span><br><span class="line">    </span><br><span class="line">    HttpEntity entity = response.getEntity();</span><br><span class="line">    <span class="comment">//将响应映射为对象</span></span><br><span class="line">    ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">    <span class="keyword">return</span> mapper.readValue(entity.getContent(), Profile<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用RestTemplate"><a href="#使用RestTemplate" class="headerlink" title="使用RestTemplate"></a>使用RestTemplate</h3><h4 id="GET资源"><a href="#GET资源" class="headerlink" title="GET资源"></a>GET资源</h4><p><code>RestTemplate</code>提供了两种执行GET请求的方法：<code>getForObject</code>方法和<code>getForEntity</code>方法。</p>
<p>这两个方法将使用消息转换器来将响应体转换为对象的。</p>
<h5 id="getForObject方法"><a href="#getForObject方法" class="headerlink" title="getForObject方法"></a>getForObject方法</h5><p><code>getForObject</code>方法请求一个资源并按照所选择的Java类型接收该资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Profile <span class="title">fetchFacebookProfile</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">  RestTemplate rest = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">  <span class="keyword">return</span> rest.getForObject(<span class="string">"http://graph.facebook.com/&#123;spitter&#125;"</span>, Profile<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getForObject</code>方法有好几个重载版本，这个版本的最后一个参数是大小可变的参数列表，每个参数都会按出现顺序插入到第一个参数表示的URL的占位符中。例如本例中，<code>id</code>参数将插入到占位符<code>{spitter}</code>中。</p>
<p><code>getForObject</code>方法的另一个重载版本中，将参数放到<code>Map</code>中，这样占位符就可以根据key来引用参数，而不是基于参数的顺序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Spittle[] fetchFacebookProfile(String id) &#123;</span><br><span class="line">  Map&lt;String, String&gt; urlVariables = <span class="keyword">new</span> HashMap&lt;String, String();</span><br><span class="line">  urlVariables.put(<span class="string">"id"</span>, id);</span><br><span class="line">  RestTemplate rest = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">  <span class="keyword">return</span> rest.getForObject(<span class="string">"http://graph.facebook.com/&#123;id&#125;"</span>, Profile<span class="class">.<span class="keyword">class</span>, <span class="title">urlVariables</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getForObject</code>方法抛出的异常都是非检查型异常——<code>RestClientException</code>异常及其子类。</p>
<h5 id="getForEntity方法"><a href="#getForEntity方法" class="headerlink" title="getForEntity方法"></a>getForEntity方法</h5><p><code>getForEntity</code>与<code>getForObject</code>的区别是，前者返回<code>ResponseEntity</code>对象，可以携带有关于响应的元数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Spittle <span class="title">fetchSpittle</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">  RestTemplate rest = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">  ResponseEntity&lt;Spittle&gt; response = rest.getForEntity(</span><br><span class="line">    <span class="string">"http://localhost:8080/spittr-api/spittles/&#123;id&#125;"</span>,</span><br><span class="line">    Spittle<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">  <span class="keyword">if</span>(response.getStatusCode() == HttpStatus.NOT_MODIFIED) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NotModifiedException();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> response.getBody();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="PUT资源"><a href="#PUT资源" class="headerlink" title="PUT资源"></a>PUT资源</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateSpittle</span><span class="params">(Spittle spittle)</span> <span class="keyword">throws</span> SpitterException </span>&#123;</span><br><span class="line">  RestTemplate rest = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">  Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">  params.put(<span class="string">"id"</span>, spittle.getId());</span><br><span class="line">  rest.put(<span class="string">"http://localhost:8080/spittr-api/spittles/&#123;id&#125;"</span>,</span><br><span class="line">           spittle, params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>put</code>方法将使用消息转换器将对象转换成客户端需要的表现形式，并在请求体中将其发送给服务端。</p>
<p>对象将被转换成什么样的内容类型很大程序上取决于传递给<code>put</code>方法的类型。如果给定一个<code>String</code>值，则将会使用<code>StringHttpMessageConverter</code>，内容类型为<code>text/plain</code>；如果给定一个<code>MultiValueMap</code>值，则会使用<code>FormHttpMessageConverter</code>，内容类型为<code>application/x-www-form-urlencoded</code>；如果给定的是一个复杂对象，并且类路径下有Jackson 2库，则可能使用<code>MappingJackson2HttpMessageConverter</code>，内容类型为<code>application/json</code>。</p>
<h4 id="DELETE资源"><a href="#DELETE资源" class="headerlink" title="DELETE资源"></a>DELETE资源</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteSpittle</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">	RestTemplate rest = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">	rest.delete(<span class="string">"http://localhost:8080/spittr-api/spittles/&#123;id&#125;"</span>, id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="POST资源"><a href="#POST资源" class="headerlink" title="POST资源"></a>POST资源</h4><p><code>RestTemplate</code>提供了三种方法来发送POST请求：</p>
<ul>
<li>postForEntity()：POST数据到一个URL，返回包含新创建资源的<code>ResponseEntity</code>对象；</li>
<li>postForLocation()：POST数据到一个URL，返回新创建资源的URL；</li>
<li>postForObject()：POST数据到一个URL，返回新创建资源的对象。</li>
</ul>
<h5 id="postForObject方法"><a href="#postForObject方法" class="headerlink" title="postForObject方法"></a>postForObject方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Spitter <span class="title">postSpitterForObject</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">  RestTemplate rest = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">  <span class="keyword">return</span> rest.postForObject(<span class="string">"http://localhost:8080/spittr-api/spitters"</span>,</span><br><span class="line">                            spitter, Spitter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="postForEntity方法"><a href="#postForEntity方法" class="headerlink" title="postForEntity方法"></a>postForEntity方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RestTemplate rest = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">ResponseEntity&lt;Spitter&gt; response = rest.postForEntity(</span><br><span class="line">  <span class="string">"http://localhost:8080/spittr-api/spitters"</span>,</span><br><span class="line">  spitter, Spitter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">Spitter spitter = response.getBody(); <span class="comment">//获取包含的资源对象</span></span><br><span class="line">URI url = response.getHeaders().getLocation();</span><br></pre></td></tr></table></figure>

<h5 id="postForLocation方法"><a href="#postForLocation方法" class="headerlink" title="postForLocation方法"></a>postForLocation方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">postSpitter</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">  RestTemplate rest = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">  <span class="keyword">return</span> rest.postForLocation(<span class="string">"http://localhost:8080/spittr-api/spitters"</span>, spitter)</span><br><span class="line">    	       .toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="HEAD资源"><a href="#HEAD资源" class="headerlink" title="HEAD资源"></a>HEAD资源</h4><p>可以使用<code>RestTemplate</code>的<code>headForHeaders</code>方法来发送HTTP HEAD请求，它返回包含特定资源URL的HTTP头。</p>
<h4 id="OPTIONS资源"><a href="#OPTIONS资源" class="headerlink" title="OPTIONS资源"></a>OPTIONS资源</h4><p>可以使用<code>RestTemplate</code>的<code>optionsForAllow</code>方法来发送HTTP OPTIONS请求，并返回对特定URL的Allow头信息。</p>
<h4 id="通用操作"><a href="#通用操作" class="headerlink" title="通用操作"></a>通用操作</h4><h5 id="exchange方法"><a href="#exchange方法" class="headerlink" title="exchange方法"></a>exchange方法</h5><p><code>exchange</code>方法在指定URL上执行特定的HTTP方法，返回包含对象的<code>ResponseEntity</code>。</p>
<p>如果你想在发送给服务端的请求中设置头信息，就需要使用<code>exchange</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MultiValueMap&lt;String, String&gt; headers = <span class="keyword">new</span> LinkedMultiValueMap&lt;String, String&gt;();</span><br><span class="line">headers.add(<span class="string">"Accept"</span>, <span class="string">"application/json"</span>);</span><br><span class="line">HttpEntity&lt;Object&gt; requestEntity = <span class="keyword">new</span> HttpEntity&lt;Object&gt;(headers);</span><br><span class="line">ResponseEntity&lt;Spitter&gt; response = rest.exchange(</span><br><span class="line">  <span class="string">"http://localhost:8080/spittr-api/spitters/&#123;spitter&#125;"</span>,</span><br><span class="line">  HttpMethod.GET, requestEntity, Spitter<span class="class">.<span class="keyword">class</span>, <span class="title">spitterId</span>)</span>;</span><br><span class="line">Spitter spitter = response.getBody();</span><br></pre></td></tr></table></figure>

<p>头部信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;Spitter&#x2F;spitters&#x2F;habuma HTTP&#x2F;1.1</span><br><span class="line">Accept: application&#x2F;json</span><br><span class="line">Content-Length: 0</span><br><span class="line">User-Agent: Java&#x2F;1.6.0_20</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<h5 id="execute方法"><a href="#execute方法" class="headerlink" title="execute方法"></a>execute方法</h5><p><code>execute</code>方法在指定URL上执行特定的HTTP方法，返回资源对象。</p>
<h2 id="Spring-HATEOAS"><a href="#Spring-HATEOAS" class="headerlink" title="Spring HATEOAS"></a>Spring HATEOAS</h2><h2 id="Spring-REST-Docs"><a href="#Spring-REST-Docs" class="headerlink" title="Spring REST Docs"></a>Spring REST Docs</h2><h1 id="Spring-Web-Flow"><a href="#Spring-Web-Flow" class="headerlink" title="Spring Web Flow"></a>Spring Web Flow</h1><p>Spring Web Flow是Spring MVC的扩展，它支持开发基于流程的应用程序。它将流程定义与实现流程行为的类和视图分离开来。</p>
<h2 id="配置Web-Flow"><a href="#配置Web-Flow" class="headerlink" title="配置Web Flow"></a>配置Web Flow</h2><p>基于Java的配置类：（从Spring Web Flow 2.4开始）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.webflow.config.AbstractFlowConfiguration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebFlowConfig</span> <span class="keyword">extends</span> <span class="title">AbstractFlowConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于XML配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:webflow</span>=<span class="string">"http://www.springframework.org/schema/webflow-config"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/webflow-config</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/webflow-config/spring-webflow-config.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Setup Web Flow here --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置流程注册表"><a href="#配置流程注册表" class="headerlink" title="配置流程注册表"></a>配置流程注册表</h3><p>流程注册表用于加载流程定义并让流程执行器能够使用它们。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FlowDefinitionRegistry <span class="title">flowRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getFlowDefinitionRegistryBuilder()</span><br><span class="line">    .addFlowLocation(<span class="string">"/WEB-INF/flows/booking/booking.xml"</span>)</span><br><span class="line">    .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">webflow:flow-registry</span> <span class="attr">id</span>=<span class="string">"flowRegistry"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">webflow:flow-location</span> <span class="attr">path</span>=<span class="string">"/WEB-INF/flows/booking/booking.xml"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">webflow:flow-registry</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="显式指定流程ID"><a href="#显式指定流程ID" class="headerlink" title="显式指定流程ID"></a>显式指定流程ID</h4><p>上面每个<code>addFlowLocation</code>方法或<code>&lt;webflow:flow-location&gt;</code>元素加载一个流程定义文件，流程的ID默认就是流程定义文件名（不含扩展名），这里就是<code>booking</code>。也可以为流程显式指定ID：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> getFlowDefinitionRegistryBuilder()</span><br><span class="line">  .addFlowLocation(<span class="string">"/WEB-INF/flows/booking/booking.xml"</span>, <span class="string">"bookHotel"</span>)</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">webflow:flow-location</span> <span class="attr">path</span>=<span class="string">"/WEB-INF/flows/booking/booking.xml"</span> <span class="attr">id</span>=<span class="string">"bookHotel"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="使用位置模式注册流程"><a href="#使用位置模式注册流程" class="headerlink" title="使用位置模式注册流程"></a>使用位置模式注册流程</h4><p>除了具体指定每个流程定义文件路径外，也可以使用位置模式来匹配一组流程定义文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> getFlowDefinitionRegistryBuilder()</span><br><span class="line">  .addFlowLocationPattern(<span class="string">"/WEB-INF/flows/**/*-flow.xml"</span>)</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">webflow:flow-location-pattern</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/flows/**/*-flow.xml"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="设置流程位置基准路径"><a href="#设置流程位置基准路径" class="headerlink" title="设置流程位置基准路径"></a>设置流程位置基准路径</h4><p>使用<code>base-path</code>属性为应用程序中的所有流程定义基准位置。然后，所有流程位置都相对于基准路径。基准路径可以是资源路径，例如<code>/WEB-INF</code>，也可以是类路径上的位置，如<code>classpath:org/springframework/webflow/samples</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> getFlowDefinitionRegistryBuilder()</span><br><span class="line">  .setBasePath(<span class="string">"/WEB-INF"</span>)</span><br><span class="line">  .addFlowLocation(<span class="string">"/hotels/booking/booking.xml"</span>)</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">webflow:flow-registry</span> <span class="attr">id</span>=<span class="string">"flowRegistry"</span> <span class="attr">base-path</span>=<span class="string">"/WEB-INF"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">webflow:flow-location</span> <span class="attr">path</span>=<span class="string">"/hotels/booking/booking.xml"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">webflow:flow-registry</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当设置了基准位置后，流程默认的ID，将变成流程位置的完整路径中，扣除基准位置和流程定义文件名部分。在本例中就是<code>/hotels/booking</code>。</p>
<p>基准位置更经常是与位置模式一起使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> getFlowDefinitionRegistryBuilder()</span><br><span class="line">  .setBasePath(<span class="string">"/WEB-INF"</span>)</span><br><span class="line">  .addFlowLocationPattern(<span class="string">"/**/*-flow.xml"</span>)</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">webflow:flow-registry</span> <span class="attr">id</span>=<span class="string">"flowRegistry"</span> <span class="attr">base-path</span>=<span class="string">"/WEB-INF"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">webflow:flow-location-pattern</span> <span class="attr">value</span>=<span class="string">"/**/*-flow.xml"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">webflow:flow-registry</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="装配流程执行器"><a href="#装配流程执行器" class="headerlink" title="装配流程执行器"></a>装配流程执行器</h3><p>流程执行器驱动流程的执行。当用户进入一个流程时，流程执行器会为用户创建并启动一个流程执行实例。当流程暂停的时候（如为用户展示视图时），流程执行器会在用户执行操作后恢复流程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FlowExecutor <span class="title">flowExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getFlowExecutorBuilder(flowRegistry()).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">webflow:flow-executor</span> <span class="attr">id</span>=<span class="string">"flowExecutor"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="与Spring-MVC整合"><a href="#与Spring-MVC整合" class="headerlink" title="与Spring MVC整合"></a>与Spring MVC整合</h3><h4 id="定义流程映射"><a href="#定义流程映射" class="headerlink" title="定义流程映射"></a>定义流程映射</h4><p><code>DispatcherServlet</code>一般将请求分发给控制器，但是对于流程而言，我们需要一个<code>FlowHandlerMapping</code>来帮助<code>DispatcherServlet</code>将流程请求分发给Spring Web Flow。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Maps request paths to flows in the flowRegistry;</span></span><br><span class="line"><span class="comment">	e.g. a path of /hotels/booking looks for a flow with id "hotels/booking" --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.webflow.mvc.servlet.FlowHandlerMapping"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"flowRegistry"</span> <span class="attr">ref</span>=<span class="string">"flowRegistry"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="注册FlowHandlerAdapter"><a href="#注册FlowHandlerAdapter" class="headerlink" title="注册FlowHandlerAdapter"></a>注册FlowHandlerAdapter</h4><p><code>FlowHandlerMapping</code>仅仅是将流程请求定向到Spring Web Flow，响应请求的是<code>FlowHandlerAdapter</code>。</p>
<p><code>FlowHandlerAdapter</code>等同于Spring MVC的控制器，它会响应发送的流程请求并对其进行处理。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Enables FlowHandler URL mapping --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.webflow.mvc.servlet.FlowHandlerAdapter"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"flowExecutor"</span> <span class="attr">ref</span>=<span class="string">"flowExecutor"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><h3 id="定义流程"><a href="#定义流程" class="headerlink" title="定义流程"></a>定义流程</h3><p>流程由基于XML的流程定义语言编写：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/webflow"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/webflow</span></span></span><br><span class="line"><span class="tag"><span class="string">                          http://www.springframework.org/schema/webflow/spring-webflow.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"hotelId"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">on-start</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"bookingService.createBooking(hotelId, currentUser.name)"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">result</span>=<span class="string">"flowScope.booking"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">on-start</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"enterBookingDetails"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"submit"</span> <span class="attr">to</span>=<span class="string">"reviewBooking"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"reviewBooking"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"confirm"</span> <span class="attr">to</span>=<span class="string">"bookingConfirmed"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"revise"</span> <span class="attr">to</span>=<span class="string">"enterBookingDetails"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"bookingCancelled"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"bookingConfirmed"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"bookingCancelled"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h3><p>状态（State）就是流程中事件发生的地点。</p>
<h4 id="起始状态"><a href="#起始状态" class="headerlink" title="起始状态"></a>起始状态</h4><h4 id="视图状态"><a href="#视图状态" class="headerlink" title="视图状态"></a>视图状态</h4><p>视图状态用于为用户展现信息，并使用户参与到流程中来。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"welcome"</span> <span class="attr">view</span>=<span class="string">"greeting"</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line"><span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>view</code>属性指定了流程到达这个状态时要展现的逻辑视图名。如果流程定义文件放在<code>/WEB-INF/flows/pizza/</code>下，则视图将是<code>/WEB-INF/flows/pizza/greeting.jsp</code>（假设使用JSP）。</p>
<p><code>view</code>属性可以省略，则默认与<code>id</code>属性取相的值。</p>
<h5 id="绑定模型"><a href="#绑定模型" class="headerlink" title="绑定模型"></a>绑定模型</h5><p>可通过<code>model</code>属性为视图绑定一个模型对象：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"takePayment"</span> <span class="attr">model</span>=<span class="string">"flowScope.paymentDetails"</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line"><span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里指定<code>takePayment</code>视图中的表单将绑定流程作用域内的<code>paymentDetails</code>对象。</p>
<h4 id="行为状态"><a href="#行为状态" class="headerlink" title="行为状态"></a>行为状态</h4><p>行为状态用于在流程中执行一些任务。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">"saveOrder"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"pizzaFlowActions.saveOrder(order)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"thankYou"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>行为状态通过<code>&lt;evaluate&gt;</code>元素来指定要执行的操作，它的<code>expression</code>属性的值支持表达式语言。这里是<code>pizzaFlowActions</code> Bean的<code>saveOrder</code>方法，并且传给该方法一个<code>order</code>对象。</p>
<p>行为状态还可以基于表达式执行的结果来决定接下来的状态转换：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">"moreAnswersNeeded"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"interview.moreAnswersNeeded()"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"yes"</span> <span class="attr">to</span>=<span class="string">"answerQuestions"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"no"</span> <span class="attr">to</span>=<span class="string">"finish"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>事件ID与表达式结果的映射关系：</p>
<table>
<thead>
<tr>
<th>表达式结果类型</th>
<th>对应的事件ID</th>
</tr>
</thead>
<tbody><tr>
<td>java.lang.String</td>
<td>该字符串的值。</td>
</tr>
<tr>
<td>java.lang.Boolean</td>
<td><code>yes</code>（或<code>true</code>）、<code>no</code>（或<code>false</code>）</td>
</tr>
<tr>
<td>java.lang.Enum</td>
<td>枚举量的名称</td>
</tr>
<tr>
<td>其他类型</td>
<td><code>success</code></td>
</tr>
</tbody></table>
<h4 id="决策状态"><a href="#决策状态" class="headerlink" title="决策状态"></a>决策状态</h4><p>决策状态将计算一个Boolean类型的表达式，然后在两个状态转换中选择一个。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">decision-state</span> <span class="attr">id</span>=<span class="string">"checkDeliveryArea"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"pizzaFlowActions.checkDeliveryArea(order.customer.zipCode)"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">then</span>=<span class="string">"addCustomer"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">else</span>=<span class="string">"deliveryWarning"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">decision-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="子流程状态"><a href="#子流程状态" class="headerlink" title="子流程状态"></a>子流程状态</h4><p>子流程状态会在当前正在执行的流程上下文中启动另一个流程。父流程将等待子流程返回，然后响应子流程结果。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">subflow-state</span> <span class="attr">id</span>=<span class="string">"order"</span> <span class="attr">subflow</span>=<span class="string">"pizza/order"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"order"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"orderCreated"</span> <span class="attr">to</span>=<span class="string">"payment"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subflow-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;input&gt;</code>元素用于传递订单对象给子流程作为输入。</p>
<p>如果子流程结束的结束状态ID为<code>orderCreated</code>，则流程将会转换到名为<code>payment</code>的状态。</p>
<h4 id="结束状态"><a href="#结束状态" class="headerlink" title="结束状态"></a>结束状态</h4><p>当流程转换到结束状态时，它会终止并返回结果。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"customerReady"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>一个流程可能会有不止一个结束状态。</p>
<p>子流程的结束状态ID确定了激活的事件。</p>
<h3 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h3><p>在流程中，通过转换（Transaction）从一个状态到另一个状态。</p>
<p>流程中除了结束状态之外的每个状态，都至少需要一个转换。</p>
<p>转换通过<code>&lt;transaction&gt;</code>元素定义，它是状态元素的子元素。</p>
<h4 id="事件触发的转换"><a href="#事件触发的转换" class="headerlink" title="事件触发的转换"></a>事件触发的转换</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"phoneEntered"</span> <span class="attr">to</span>=<span class="string">"lookupCustomer"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>当触发了<code>phoneEntered</code>事件，流程将会进入<code>lookupCustomer</code>状态。</p>
<h4 id="异常触发的转换"><a href="#异常触发的转换" class="headerlink" title="异常触发的转换"></a>异常触发的转换</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"registrationForm"</span> </span></span><br><span class="line"><span class="tag">            <span class="attr">on-exception</span>=<span class="string">"com.springinaction.pizza.service.CustomerNotFoundException"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="默认转换"><a href="#默认转换" class="headerlink" title="默认转换"></a>默认转换</h4><p>缺省<code>on</code>或<code>on-exception</code>属性的转换称为默认转换。</p>
<p>默认转换通常位于所有转换之后。当没有其他可用转换时，就会执行默认转换。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">"lookupCustomer"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">result</span>=<span class="string">"order.customer"</span> </span></span><br><span class="line"><span class="tag">            <span class="attr">expression</span>=<span class="string">"pizzaFlowActions.lookupCustomer(requestParameters.phoneNumber)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"registrationForm"</span> </span></span><br><span class="line"><span class="tag">              <span class="attr">on-exception</span>=<span class="string">"com.springinaction.pizza.service.CustomerNotFoundException"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"customerReady"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="全局转换"><a href="#全局转换" class="headerlink" title="全局转换"></a>全局转换</h4><p>所有状态都具有的转换，可以定义为全局转换：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">global-transitions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"endState"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">global-transitions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="行为"><a href="#行为" class="headerlink" title="行为"></a>行为</h3><h4 id="定义行为"><a href="#定义行为" class="headerlink" title="定义行为"></a>定义行为</h4><p>行为使用表达式语言进行定义，Spring Web Flow默认使用Unified EL。</p>
<h4 id="执行行为"><a href="#执行行为" class="headerlink" title="执行行为"></a>执行行为</h4><p>通过<code>&lt;evaluate&gt;</code> 元素，可以对一个表达式进行计算。表达式中可以访问Spring Bean（如下例中的<code>entityManager</code>）和任何流程变量（如下例 中的<code>booking</code>）。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"entityManager.persist(booking)"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果表达式有返回值，则可以将表达式的值保存在<code>result</code>属性声明的变量中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"bookingService.findHotels(searchCriteria)"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">result</span>=<span class="string">"flowScope.hotels"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果表达式的值需要显式类型转换，可以使用<code>result-type</code>属性指定所需的类型：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"bookingService.findHotels(searchCriteria)"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">result</span>=<span class="string">"flowScope.hotels"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">result-type</span>=<span class="string">"dataModel"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="命名行为"><a href="#命名行为" class="headerlink" title="命名行为"></a>命名行为</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">"doTwoThings"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"service.thingOne()"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"thingOne"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">evaluate</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"service.thingTwo()"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"thingTwo"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">evaluate</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"thingTwo.success"</span> <span class="attr">to</span>=<span class="string">"showResults"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>每个行为的名字成为了行为结果事件的限定符。</p>
<h4 id="执行点"><a href="#执行点" class="headerlink" title="执行点"></a>执行点</h4><h5 id="在行为状态中执行行为"><a href="#在行为状态中执行行为" class="headerlink" title="在行为状态中执行行为"></a>在行为状态中执行行为</h5><p>参见“行为状态”。</p>
<h5 id="在决策状态中执行行为"><a href="#在决策状态中执行行为" class="headerlink" title="在决策状态中执行行为"></a>在决策状态中执行行为</h5><p>参见“决策状态”。</p>
<h5 id="在流程的开始执行行为"><a href="#在流程的开始执行行为" class="headerlink" title="在流程的开始执行行为"></a>在流程的开始执行行为</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/webflow"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/webflow</span></span></span><br><span class="line"><span class="tag"><span class="string">                          http://www.springframework.org/schema/webflow/spring-webflow.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"hotelId"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">on-start</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"bookingService.createBooking(hotelId, currentUser.name)"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">result</span>=<span class="string">"flowScope.booking"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">on-start</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="在状态的入口执行行为"><a href="#在状态的入口执行行为" class="headerlink" title="在状态的入口执行行为"></a>在状态的入口执行行为</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"changeSearchCriteria"</span> <span class="attr">view</span>=<span class="string">"enterSearchCriteria.xhtml"</span> <span class="attr">popup</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">on-entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">render</span> <span class="attr">fragments</span>=<span class="string">"hotelSearchForm"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">on-entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="在视图渲染之前执行行为"><a href="#在视图渲染之前执行行为" class="headerlink" title="在视图渲染之前执行行为"></a>在视图渲染之前执行行为</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"reviewHotels"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on-render</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"bookingService.findHotels(searchCriteria)"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">result</span>=<span class="string">"viewScope.hotels"</span> <span class="attr">result-type</span>=<span class="string">"dataModel"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">on-render</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"select"</span> <span class="attr">to</span>=<span class="string">"reviewHotel"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span> <span class="attr">name</span>=<span class="string">"flowScope.hotel"</span> <span class="attr">value</span>=<span class="string">"hotels.selectedRow"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="在转换执行时执行行为"><a href="#在转换执行时执行行为" class="headerlink" title="在转换执行时执行行为"></a>在转换执行时执行行为</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">subflow-state</span> <span class="attr">id</span>=<span class="string">"addGuest"</span> <span class="attr">subflow</span>=<span class="string">"createGuest"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"guestCreated"</span> <span class="attr">to</span>=<span class="string">"reviewBooking"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"booking.guestList.add(currentEvent.attributes.newGuest)"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subfow-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="在状态的出口执行行为"><a href="#在状态的出口执行行为" class="headerlink" title="在状态的出口执行行为"></a>在状态的出口执行行为</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"editOrder"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on-entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"orderService.selectForUpdate(orderId, currentUser)"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">result</span>=<span class="string">"viewScope.order"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">on-entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"save"</span> <span class="attr">to</span>=<span class="string">"finish"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"orderService.update(order, currentUser)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on-exit</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"orderService.releaseLock(order, currentUser)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">on-exit</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="在流程的结束执行行为"><a href="#在流程的结束执行行为" class="headerlink" title="在流程的结束执行行为"></a>在流程的结束执行行为</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/webflow"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/webflow</span></span></span><br><span class="line"><span class="tag"><span class="string">                          http://www.springframework.org/schema/webflow/spring-webflow.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"orderId"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">on-start</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"orderService.selectForUpdate(orderId, currentUser)"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">result</span>=<span class="string">"flowScope.order"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">on-start</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"editOrder"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"save"</span> <span class="attr">to</span>=<span class="string">"finish"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"orderService.update(order, currentUser)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">on-end</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"orderService.releaseLock(order, currentUser)"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">on-end</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="行为的实现"><a href="#行为的实现" class="headerlink" title="行为的实现"></a>行为的实现</h4><h5 id="POJO行为"><a href="#POJO行为" class="headerlink" title="POJO行为"></a>POJO行为</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"pojoAction.method(flowRequestContext)"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PojoAction</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">method</span><span class="params">(RequestContext context)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="基于Action接口的行为"><a href="#基于Action接口的行为" class="headerlink" title="基于Action接口的行为"></a>基于<code>Action</code>接口的行为</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"customAction"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomAction</span> <span class="keyword">implements</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Event <span class="title">execute</span><span class="params">(RequestContext context)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="基于MultiAction的行为"><a href="#基于MultiAction的行为" class="headerlink" title="基于MultiAction的行为"></a>基于<code>MultiAction</code>的行为</h5><p><code>MultiAction</code>是<code>Action</code>的一个实现类。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"multiAction.actionMethod1"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomMultiAction</span> <span class="keyword">extends</span> <span class="title">MultiAction</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Event <span class="title">actionMethod1</span><span class="params">(RequestContext context)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Event <span class="title">actionMethod2</span><span class="params">(RequestContext context)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有的行为方法的返回值必须是<code>Event</code>类，参数必须是<code>RequestContext</code>类。</p>
<h4 id="处理异常-1"><a href="#处理异常-1" class="headerlink" title="处理异常"></a>处理异常</h4><h5 id="在POJO行为中处理异常"><a href="#在POJO行为中处理异常" class="headerlink" title="在POJO行为中处理异常"></a>在POJO行为中处理异常</h5><p>下面示例在POJO行为中处理业务异常，将错误信息添加到上下文，并返回结果事件ID。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"bookingAction.makeBooking(booking, flowRequestContext)"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookingAction</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">makeBooking</span><span class="params">(Booking booking, RequestContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      BookingConfirmation confirmation = bookingService.make(booking);</span><br><span class="line">      context.getFlowScope().put(<span class="string">"confirmation"</span>, confirmation);</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RoomNotAvailableException e) &#123;</span><br><span class="line">      context.addMessage(<span class="keyword">new</span> MessageBuilder().error().defaultText(<span class="string">"No room is available at this hotel"</span>).build());</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="在MultiAction行为中处理异常"><a href="#在MultiAction行为中处理异常" class="headerlink" title="在MultiAction行为中处理异常"></a>在MultiAction行为中处理异常</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"bookingAction.makeBooking"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookingAction</span> <span class="keyword">extends</span> <span class="title">MultiAction</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Event <span class="title">makeBooking</span><span class="params">(RequestContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Booking booking = (Booking) context.getFlowScope().get(<span class="string">"booking"</span>);</span><br><span class="line">      BookingConfirmation confirmation = bookingService.make(booking);</span><br><span class="line">      context.getFlowScope().put(<span class="string">"confirmation"</span>, confirmation);</span><br><span class="line">      <span class="keyword">return</span> success();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RoomNotAvailableException e) &#123;</span><br><span class="line">      context.getMessageContext().addMessage(<span class="keyword">new</span> MessageBuilder().error().defaultText(<span class="string">"No room is available at this hotel"</span>).build());</span><br><span class="line">      <span class="keyword">return</span> error();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="使用-lt-exception-handler-gt-元素"><a href="#使用-lt-exception-handler-gt-元素" class="headerlink" title="使用&lt;exception-handler&gt;元素"></a>使用<code>&lt;exception-handler&gt;</code>元素</h5><h4 id="处理文件上传"><a href="#处理文件上传" class="headerlink" title="处理文件上传"></a>处理文件上传</h4><p>视图：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form:form modelAttribute=<span class="string">"fileUploadHandler"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">	Select file: &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span>/&gt;</span><br><span class="line">	&lt;input type=<span class="string">"submit"</span> name=<span class="string">"_eventId_upload"</span> value=<span class="string">"Upload"</span> /&gt;</span><br><span class="line">&lt;/form:form&gt;</span><br></pre></td></tr></table></figure>

<p>后端对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUploadHandler</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> MultipartFile file;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//Do something with the MultipartFile here</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFile</span><span class="params">(MultipartFile file)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.file = file;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>流程定义：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"uploadFile"</span> <span class="attr">model</span>=<span class="string">"uploadFileHandler"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">var</span> <span class="attr">name</span>=<span class="string">"fileUploadHandler"</span> </span></span><br><span class="line"><span class="tag">       <span class="attr">class</span>=<span class="string">"org.springframework.webflow.samples.booking.FileUploadHandler"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"upload"</span> <span class="attr">to</span>=<span class="string">"finish"</span> &gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"fileUploadHandler.processFile()"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"finish"</span> <span class="attr">bind</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h3><p>流程可以在开始时通过<code>&lt;input&gt;</code>元素接收输入属性，在结束时通过<code>&lt;output&gt;</code>返回输出属性。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/webflow"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/webflow</span></span></span><br><span class="line"><span class="tag"><span class="string">                          http://www.springframework.org/schema/webflow/spring-webflow.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"hotelId"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">on-start</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"bookingService.createBooking(hotelId, currentUser.name)"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">result</span>=<span class="string">"flowScope.booking"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">on-start</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"enterBookingDetails"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"submit"</span> <span class="attr">to</span>=<span class="string">"reviewBooking"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"reviewBooking"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"confirm"</span> <span class="attr">to</span>=<span class="string">"bookingConfirmed"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"revise"</span> <span class="attr">to</span>=<span class="string">"enterBookingDetails"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"bookingCancelled"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"bookingConfirmed"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">output</span> <span class="attr">name</span>=<span class="string">"bookingId"</span> <span class="attr">value</span>=<span class="string">"booking.id"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">end-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"bookingCancelled"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以通过<code>type</code>属性为输入属性指定类型，通过<code>value</code>属性为输入属性赋予一个值，通过<code>required</code>属性强制输入属性是否可空：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"hotelId"</span> <span class="attr">type</span>=<span class="string">"long"</span> <span class="attr">value</span>=<span class="string">"flowScope.hotelId"</span> <span class="attr">required</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;output&gt;</code>通常出现在<code>&lt;end-state&gt;</code>中，它指定了流程的结果。可以通过<code>value</code>属性为输出属性赋予一个值：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">output</span> <span class="attr">name</span>=<span class="string">"confirmationNumber"</span> <span class="attr">value</span>=<span class="string">"booking.confirmationNumber"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="流程变量"><a href="#流程变量" class="headerlink" title="流程变量"></a>流程变量</h3><p>流程可以声明一个或多个实例变量，这些变量在流程开始时分配。</p>
<h4 id="声明变量"><a href="#声明变量" class="headerlink" title="声明变量"></a>声明变量</h4><p>在流程中创建变量的最简单形式是使用<code>&lt;var&gt;</code>元素：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">var</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">class</span>=<span class="string">"com.springinaction.pizza.domain.Order"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>确保变量的类实现<code>java.io.Serializable</code>，因为实例状态在流程请求之间保存。</p>
<p>这个变量可以在流程的任意状态进行访问。</p>
<p><code>&lt;evaluate&gt;</code>也可以用来创建或设置变量：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">result</span>=<span class="string">"viewScope.paymentTypeList"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">expression</span>=<span class="string">"T(com.springinaction.pizza.domain.PaymentType).asList()"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>类似地，<code>&lt;set&gt;</code>元素也可以创建或设置变量：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">name</span>=<span class="string">"flowScope.paymentDetails"</span> </span></span><br><span class="line"><span class="tag">     <span class="attr">value</span>=<span class="string">"new com.springinaction.pizza.domain.PaymentDetails()"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h4><p>使用<code>&lt;var&gt;</code>元素声明的变量总是流程作用域的。</p>
<p>当使用<code>&lt;set&gt;</code>或<code>&lt;evaluate&gt;</code>声明变量时，作用域通过<code>name</code>或<code>result</code>属性的作用域前缀指定。</p>
<h5 id="流程作用域"><a href="#流程作用域" class="headerlink" title="流程作用域"></a>流程作用域</h5><p>流程作用域在流程开始时分配，在流程结束时销毁。只在创建它的流程中是可见的，即不包括子流程。</p>
<p>在默认实现中，存储在流程作用域中的任何对象都需要是<code>Serializable</code>。</p>
<h5 id="视图作用域"><a href="#视图作用域" class="headerlink" title="视图作用域"></a>视图作用域</h5><p>视图作用域在进入视图状态时分配，在退出视图状态时销毁。</p>
<p>视图作用域仅可在视图状态中引用。</p>
<p>在默认实现中，存储在流程作用域中的任何对象都需要是<code>Serializable</code>。</p>
<h5 id="请求作用域"><a href="#请求作用域" class="headerlink" title="请求作用域"></a>请求作用域</h5><p>请求作用域在一个请求进入流程时分配，在流程返回时销毁。</p>
<h5 id="Flash作用域"><a href="#Flash作用域" class="headerlink" title="Flash作用域"></a>Flash作用域</h5><p>流程作用域在流程开始时分配，在每个视图状态渲染后清除，并在流程结束时销毁。只在创建它的流程中是可见的，即不包括子流程。</p>
<p>在默认实现中，存储在流程作用域中的任何对象都需要是<code>Serializable</code>。</p>
<h5 id="Conversation作用域"><a href="#Conversation作用域" class="headerlink" title="Conversation作用域"></a>Conversation作用域</h5><p>Conversation作用域在最高层级的流程开始时分配，在最高层级的流程结束时销毁。被最高层级的流程及其任意层级的子流程所共享。</p>
<p>在默认实现中，Conversation作用域对象存储在HTTP会话中，并且通常应该是<code>Serializable</code>以考虑典型的会话复制。</p>
<h3 id="子流程"><a href="#子流程" class="headerlink" title="子流程"></a>子流程</h3><p>流程可以通过<code>&lt;subflow-state&gt;</code>元素调用一个子流程。父流程将等待子流程返回，然后响应子流程结果。</p>
<p>示例：</p>
<p>主流程定义：pizza-flow.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/webflow"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/webflow </span></span></span><br><span class="line"><span class="tag"><span class="string">                          http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">var</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">class</span>=<span class="string">"com.springinaction.pizza.domain.Order"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Customer --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">subflow-state</span> <span class="attr">id</span>=<span class="string">"customer"</span> <span class="attr">subflow</span>=<span class="string">"pizza/customer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"order"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"customerReady"</span> <span class="attr">to</span>=<span class="string">"order"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">subflow-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Order --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">subflow-state</span> <span class="attr">id</span>=<span class="string">"order"</span> <span class="attr">subflow</span>=<span class="string">"pizza/order"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"order"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"orderCreated"</span> <span class="attr">to</span>=<span class="string">"payment"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">subflow-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Payment --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">subflow-state</span> <span class="attr">id</span>=<span class="string">"payment"</span> <span class="attr">subflow</span>=<span class="string">"pizza/payment"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"order"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"paymentTaken"</span> <span class="attr">to</span>=<span class="string">"saveOrder"</span>/&gt;</span>      </span><br><span class="line">  <span class="tag">&lt;/<span class="name">subflow-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">"saveOrder"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"pizzaFlowActions.saveOrder(order)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"thankYou"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"thankYou"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"endState"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- End state --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"endState"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">global-transitions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"endState"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">global-transitions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>customer-flow.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/webflow"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/webflow </span></span></span><br><span class="line"><span class="tag"><span class="string">                          http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">required</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Customer --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"welcome"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"phoneEntered"</span> <span class="attr">to</span>=<span class="string">"lookupCustomer"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"cancel"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">"lookupCustomer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">result</span>=<span class="string">"order.customer"</span> <span class="attr">expression</span>=</span></span><br><span class="line"><span class="tag">              "<span class="attr">pizzaFlowActions.lookupCustomer</span>(<span class="attr">requestParameters.phoneNumber</span>)" /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"registrationForm"</span> <span class="attr">on-exception</span>=</span></span><br><span class="line"><span class="tag">                "<span class="attr">com.springinaction.pizza.service.CustomerNotFoundException</span>" /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"customerReady"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"registrationForm"</span> <span class="attr">model</span>=<span class="string">"order"</span> <span class="attr">popup</span>=<span class="string">"true"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">on-entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=</span></span><br><span class="line"><span class="tag">                "<span class="attr">order.customer.phoneNumber</span> = <span class="string">requestParameters.phoneNumber</span>" /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">on-entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"submit"</span> <span class="attr">to</span>=<span class="string">"checkDeliveryArea"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"cancel"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">decision-state</span> <span class="attr">id</span>=<span class="string">"checkDeliveryArea"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"pizzaFlowActions.checkDeliveryArea(order.customer.zipCode)"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">then</span>=<span class="string">"addCustomer"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">else</span>=<span class="string">"deliveryWarning"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">decision-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"deliveryWarning"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"accept"</span> <span class="attr">to</span>=<span class="string">"addCustomer"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"cancel"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">"addCustomer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"pizzaFlowActions.addCustomer(order.customer)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"customerReady"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- End state --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"cancel"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"customerReady"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>order-flow.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/webflow"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/webflow </span></span></span><br><span class="line"><span class="tag"><span class="string">                          http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">required</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Order --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"showOrder"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"createPizza"</span> <span class="attr">to</span>=<span class="string">"createPizza"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"checkout"</span> <span class="attr">to</span>=<span class="string">"orderCreated"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"cancel"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"createPizza"</span> <span class="attr">model</span>=<span class="string">"flowScope.pizza"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">on-entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">set</span> <span class="attr">name</span>=<span class="string">"flowScope.pizza"</span> </span></span><br><span class="line"><span class="tag">           <span class="attr">value</span>=<span class="string">"new com.springinaction.pizza.domain.Pizza()"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">result</span>=<span class="string">"viewScope.toppingsList"</span> </span></span><br><span class="line"><span class="tag">                <span class="attr">expression</span>=<span class="string">"T(com.springinaction.pizza.domain.Topping).asList()"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">on-entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"addPizza"</span> <span class="attr">to</span>=<span class="string">"showOrder"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">expression</span>=<span class="string">"order.addPizza(flowScope.pizza)"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"showOrder"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- End state --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"cancel"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"orderCreated"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>payment-flow.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/webflow"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/webflow </span></span></span><br><span class="line"><span class="tag"><span class="string">                          http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">required</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"takePayment"</span> <span class="attr">model</span>=<span class="string">"flowScope.paymentDetails"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">on-entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">set</span> <span class="attr">name</span>=<span class="string">"flowScope.paymentDetails"</span> </span></span><br><span class="line"><span class="tag">           <span class="attr">value</span>=<span class="string">"new com.springinaction.pizza.domain.PaymentDetails()"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">result</span>=<span class="string">"viewScope.paymentTypeList"</span> </span></span><br><span class="line"><span class="tag">                <span class="attr">expression</span>=<span class="string">"T(com.springinaction.pizza.domain.PaymentType).asList()"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">on-entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"paymentSubmitted"</span> <span class="attr">to</span>=<span class="string">"verifyPayment"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">on</span>=<span class="string">"cancel"</span> <span class="attr">to</span>=<span class="string">"cancel"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">action-state</span> <span class="attr">id</span>=<span class="string">"verifyPayment"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluate</span> <span class="attr">result</span>=<span class="string">"order.payment"</span> <span class="attr">expression</span>=</span></span><br><span class="line"><span class="tag">              "<span class="attr">pizzaFlowActions.verifyPayment</span>(<span class="attr">flowScope.paymentDetails</span>)" /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">to</span>=<span class="string">"paymentTaken"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">action-state</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- End state --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"cancel"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">end-state</span> <span class="attr">id</span>=<span class="string">"paymentTaken"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="流程继承"><a href="#流程继承" class="headerlink" title="流程继承"></a>流程继承</h3><h2 id="表达式语言"><a href="#表达式语言" class="headerlink" title="表达式语言"></a>表达式语言</h2><h2 id="流程持久化"><a href="#流程持久化" class="headerlink" title="流程持久化"></a>流程持久化</h2><h2 id="保护流程"><a href="#保护流程" class="headerlink" title="保护流程"></a>保护流程</h2><p>Spring Web Flow中的状态、转换甚至整个流程都可以借助<code>&lt;secured&gt;</code>元素实现安全性，该元素会作为这些元素的子元素。例如，为了保护对一个视图状态的访问，你可以这样：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-state</span> <span class="attr">id</span>=<span class="string">"restricted"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">secured</span> <span class="attr">attributes</span>=<span class="string">"ROLE_USER, ROLE_ANONYMOUS"</span> <span class="attr">match</span>=<span class="string">"any"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view-state</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里只授予<code>ROLE_USER</code>和<code>ROLE_ANONYMOUS</code>访问这个视图状态的权限。</p>
<p><code>match</code>属性可以设置为<code>any</code>或<code>all</code>。如果设置为<code>any</code>，则用户必须至少具有一个<code>attributes</code>属性所列的权限。如果设置为<code>all</code>，则用户必须具有所列的所有权限。</p>
<h2 id="测试流程"><a href="#测试流程" class="headerlink" title="测试流程"></a>测试流程</h2>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/5-1-2/" rel="tag"># 5.1.2</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/06/01/SpringCore/" rel="prev" title="SpringCore">
      <i class="fa fa-chevron-left"></i> SpringCore
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/06/01/SpringCloud/" rel="next" title="SpringCloud">
      SpringCloud <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-MVC"><span class="nav-number">1.</span> <span class="nav-text">Spring MVC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-MVC架构"><span class="nav-number">1.1.</span> <span class="nav-text">Spring MVC架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#搭建Spring-MVC"><span class="nav-number">1.2.</span> <span class="nav-text">搭建Spring MVC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置DispatcherServlet"><span class="nav-number">1.2.1.</span> <span class="nav-text">配置DispatcherServlet</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#传统的web-xml配置"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">传统的web.xml配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用Java配置"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">使用Java配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#自定义DispatcherServlet配置"><span class="nav-number">1.2.1.2.1.</span> <span class="nav-text">自定义DispatcherServlet配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上下文的层次结构"><span class="nav-number">1.2.2.</span> <span class="nav-text">上下文的层次结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MVC配置"><span class="nav-number">1.2.3.</span> <span class="nav-text">MVC配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#启用Spring-MVC"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">启用Spring MVC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启用组件扫描"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">启用组件扫描</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOP代理"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">AOP代理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根上下文配置"><span class="nav-number">1.2.4.</span> <span class="nav-text">根上下文配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制器"><span class="nav-number">1.3.</span> <span class="nav-text">控制器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#声明"><span class="nav-number">1.3.1.</span> <span class="nav-text">声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求映射"><span class="nav-number">1.3.2.</span> <span class="nav-text">请求映射</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#指定HTTP方法"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">指定HTTP方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#URL模式"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">URL模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#路径参数"><span class="nav-number">1.3.2.2.1.</span> <span class="nav-text">路径参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Ant路径表达式"><span class="nav-number">1.3.2.2.2.</span> <span class="nav-text">Ant路径表达式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#正则表达式"><span class="nav-number">1.3.2.2.3.</span> <span class="nav-text">正则表达式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#占位符"><span class="nav-number">1.3.2.2.4.</span> <span class="nav-text">占位符</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#接受请求的输入"><span class="nav-number">1.3.3.</span> <span class="nav-text">接受请求的输入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#查询参数"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">查询参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#表单参数"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">表单参数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#校验表单"><span class="nav-number">1.3.3.2.1.</span> <span class="nav-text">校验表单</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Matrix-变量"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">Matrix 变量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据绑定"><span class="nav-number">1.3.4.</span> <span class="nav-text">数据绑定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制器通知"><span class="nav-number">1.3.5.</span> <span class="nav-text">控制器通知</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型"><span class="nav-number">1.4.</span> <span class="nav-text">模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#传递模型数据到视图中"><span class="nav-number">1.4.1.</span> <span class="nav-text">传递模型数据到视图中</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通过Model参数"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">通过Model参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过Map参数"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">通过Map参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过返回值"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">通过返回值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨重定向请求传递数据"><span class="nav-number">1.4.2.</span> <span class="nav-text">跨重定向请求传递数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通过URL模板以路径变量和-或查询参数的形式传递数据"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">通过URL模板以路径变量和&#x2F;或查询参数的形式传递数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过flash属性传递复杂数据"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">通过flash属性传递复杂数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#视图"><span class="nav-number">1.5.</span> <span class="nav-text">视图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#视图控制器"><span class="nav-number">1.5.1.</span> <span class="nav-text">视图控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图解析器"><span class="nav-number">1.5.2.</span> <span class="nav-text">视图解析器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图技术"><span class="nav-number">1.5.3.</span> <span class="nav-text">视图技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JSP"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">JSP</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#配置视图解析器"><span class="nav-number">1.5.3.1.1.</span> <span class="nav-text">配置视图解析器</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Thymeleaf"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">Thymeleaf</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#配置"><span class="nav-number">1.5.3.2.1.</span> <span class="nav-text">配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#静态资源"><span class="nav-number">1.5.4.</span> <span class="nav-text">静态资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主题"><span class="nav-number">1.5.5.</span> <span class="nav-text">主题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内容类型"><span class="nav-number">1.6.</span> <span class="nav-text">*内容类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注册其他Servlet、Filter和Listener"><span class="nav-number">1.7.</span> <span class="nav-text">注册其他Servlet、Filter和Listener</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基于Java的配置"><span class="nav-number">1.7.1.</span> <span class="nav-text">基于Java的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于web-xml的配置"><span class="nav-number">1.7.2.</span> <span class="nav-text">基于web.xml的配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Multipart请求"><span class="nav-number">1.8.</span> <span class="nav-text">Multipart请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通过Spring解析器处理"><span class="nav-number">1.8.1.</span> <span class="nav-text">通过Spring解析器处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置multipart解析器"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">配置multipart解析器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#使用Servlet-3-0解析multipart请求"><span class="nav-number">1.8.1.1.1.</span> <span class="nav-text">使用Servlet 3.0解析multipart请求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置Jakarta-Commons-FileUpload-multipart解析器"><span class="nav-number">1.8.1.1.2.</span> <span class="nav-text">配置Jakarta Commons FileUpload multipart解析器</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建Multipart表单"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">创建Multipart表单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理Multipart请求"><span class="nav-number">1.8.1.3.</span> <span class="nav-text">处理Multipart请求</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#接收为byte"><span class="nav-number">1.8.1.3.1.</span> <span class="nav-text">接收为byte[]</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#接收为MultipartFile"><span class="nav-number">1.8.1.3.2.</span> <span class="nav-text">接收为MultipartFile</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过Part形式处理"><span class="nav-number">1.8.2.</span> <span class="nav-text">通过Part形式处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理异常"><span class="nav-number">1.9.</span> <span class="nav-text">处理异常</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自动将异常映射为HTTP状态码"><span class="nav-number">1.9.1.</span> <span class="nav-text">自动将异常映射为HTTP状态码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-ResponseStatus标注映射HTTP状态码"><span class="nav-number">1.9.2.</span> <span class="nav-text">使用@ResponseStatus标注映射HTTP状态码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写异常处理的方法"><span class="nav-number">1.9.3.</span> <span class="nav-text">编写异常处理的方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#语言环境"><span class="nav-number">1.10.</span> <span class="nav-text">语言环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#拦截器"><span class="nav-number">1.11.</span> <span class="nav-text">拦截器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CORS"><span class="nav-number">1.12.</span> <span class="nav-text">CORS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异步请求"><span class="nav-number">1.13.</span> <span class="nav-text">异步请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP缓存"><span class="nav-number">1.14.</span> <span class="nav-text">HTTP缓存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-WebFlux"><span class="nav-number">2.</span> <span class="nav-text">Spring WebFlux</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-REST"><span class="nav-number">3.</span> <span class="nav-text">Spring REST</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#REST端点"><span class="nav-number">3.1.</span> <span class="nav-text">REST端点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#内容协商"><span class="nav-number">3.1.1.</span> <span class="nav-text">内容协商</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置内容协商视图解析器"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">配置内容协商视图解析器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#控制媒体类型的选择"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">控制媒体类型的选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ContentNegotiatingViewResolver-的优势和限制"><span class="nav-number">3.1.1.3.</span> <span class="nav-text">ContentNegotiatingViewResolver 的优势和限制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP信息转换器"><span class="nav-number">3.1.2.</span> <span class="nav-text">HTTP信息转换器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在响应体中返回资源状态"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">在响应体中返回资源状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在请求体中接收资源状态"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">在请求体中接收资源状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为控制器设置默认消息转换"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">为控制器设置默认消息转换</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送错误信息到客户端"><span class="nav-number">3.1.3.</span> <span class="nav-text">发送错误信息到客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分离异常处理"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">分离异常处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在响应中设置头部信息"><span class="nav-number">3.1.4.</span> <span class="nav-text">在响应中设置头部信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#REST客户端"><span class="nav-number">3.2.</span> <span class="nav-text">REST客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Apache-HTTP-Client"><span class="nav-number">3.2.1.</span> <span class="nav-text">使用Apache HTTP Client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用RestTemplate"><span class="nav-number">3.2.2.</span> <span class="nav-text">使用RestTemplate</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GET资源"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">GET资源</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#getForObject方法"><span class="nav-number">3.2.2.1.1.</span> <span class="nav-text">getForObject方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getForEntity方法"><span class="nav-number">3.2.2.1.2.</span> <span class="nav-text">getForEntity方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PUT资源"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">PUT资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DELETE资源"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">DELETE资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#POST资源"><span class="nav-number">3.2.2.4.</span> <span class="nav-text">POST资源</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#postForObject方法"><span class="nav-number">3.2.2.4.1.</span> <span class="nav-text">postForObject方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#postForEntity方法"><span class="nav-number">3.2.2.4.2.</span> <span class="nav-text">postForEntity方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#postForLocation方法"><span class="nav-number">3.2.2.4.3.</span> <span class="nav-text">postForLocation方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HEAD资源"><span class="nav-number">3.2.2.5.</span> <span class="nav-text">HEAD资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OPTIONS资源"><span class="nav-number">3.2.2.6.</span> <span class="nav-text">OPTIONS资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通用操作"><span class="nav-number">3.2.2.7.</span> <span class="nav-text">通用操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#exchange方法"><span class="nav-number">3.2.2.7.1.</span> <span class="nav-text">exchange方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#execute方法"><span class="nav-number">3.2.2.7.2.</span> <span class="nav-text">execute方法</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-HATEOAS"><span class="nav-number">3.3.</span> <span class="nav-text">Spring HATEOAS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-REST-Docs"><span class="nav-number">3.4.</span> <span class="nav-text">Spring REST Docs</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Web-Flow"><span class="nav-number">4.</span> <span class="nav-text">Spring Web Flow</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置Web-Flow"><span class="nav-number">4.1.</span> <span class="nav-text">配置Web Flow</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置流程注册表"><span class="nav-number">4.1.1.</span> <span class="nav-text">配置流程注册表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#显式指定流程ID"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">显式指定流程ID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用位置模式注册流程"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">使用位置模式注册流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置流程位置基准路径"><span class="nav-number">4.1.1.3.</span> <span class="nav-text">设置流程位置基准路径</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#装配流程执行器"><span class="nav-number">4.1.2.</span> <span class="nav-text">装配流程执行器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#与Spring-MVC整合"><span class="nav-number">4.1.3.</span> <span class="nav-text">与Spring MVC整合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义流程映射"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">定义流程映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注册FlowHandlerAdapter"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">注册FlowHandlerAdapter</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流程"><span class="nav-number">4.2.</span> <span class="nav-text">流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义流程"><span class="nav-number">4.2.1.</span> <span class="nav-text">定义流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态"><span class="nav-number">4.2.2.</span> <span class="nav-text">状态</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#起始状态"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">起始状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#视图状态"><span class="nav-number">4.2.2.2.</span> <span class="nav-text">视图状态</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#绑定模型"><span class="nav-number">4.2.2.2.1.</span> <span class="nav-text">绑定模型</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#行为状态"><span class="nav-number">4.2.2.3.</span> <span class="nav-text">行为状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#决策状态"><span class="nav-number">4.2.2.4.</span> <span class="nav-text">决策状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#子流程状态"><span class="nav-number">4.2.2.5.</span> <span class="nav-text">子流程状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结束状态"><span class="nav-number">4.2.2.6.</span> <span class="nav-text">结束状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#转换"><span class="nav-number">4.2.3.</span> <span class="nav-text">转换</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#事件触发的转换"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">事件触发的转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异常触发的转换"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">异常触发的转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#默认转换"><span class="nav-number">4.2.3.3.</span> <span class="nav-text">默认转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#全局转换"><span class="nav-number">4.2.3.4.</span> <span class="nav-text">全局转换</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#行为"><span class="nav-number">4.2.4.</span> <span class="nav-text">行为</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义行为"><span class="nav-number">4.2.4.1.</span> <span class="nav-text">定义行为</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行行为"><span class="nav-number">4.2.4.2.</span> <span class="nav-text">执行行为</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#命名行为"><span class="nav-number">4.2.4.2.1.</span> <span class="nav-text">命名行为</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行点"><span class="nav-number">4.2.4.3.</span> <span class="nav-text">执行点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在行为状态中执行行为"><span class="nav-number">4.2.4.3.1.</span> <span class="nav-text">在行为状态中执行行为</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在决策状态中执行行为"><span class="nav-number">4.2.4.3.2.</span> <span class="nav-text">在决策状态中执行行为</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在流程的开始执行行为"><span class="nav-number">4.2.4.3.3.</span> <span class="nav-text">在流程的开始执行行为</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在状态的入口执行行为"><span class="nav-number">4.2.4.3.4.</span> <span class="nav-text">在状态的入口执行行为</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在视图渲染之前执行行为"><span class="nav-number">4.2.4.3.5.</span> <span class="nav-text">在视图渲染之前执行行为</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在转换执行时执行行为"><span class="nav-number">4.2.4.3.6.</span> <span class="nav-text">在转换执行时执行行为</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在状态的出口执行行为"><span class="nav-number">4.2.4.3.7.</span> <span class="nav-text">在状态的出口执行行为</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在流程的结束执行行为"><span class="nav-number">4.2.4.3.8.</span> <span class="nav-text">在流程的结束执行行为</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#行为的实现"><span class="nav-number">4.2.4.4.</span> <span class="nav-text">行为的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#POJO行为"><span class="nav-number">4.2.4.4.1.</span> <span class="nav-text">POJO行为</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#基于Action接口的行为"><span class="nav-number">4.2.4.4.2.</span> <span class="nav-text">基于Action接口的行为</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#基于MultiAction的行为"><span class="nav-number">4.2.4.4.3.</span> <span class="nav-text">基于MultiAction的行为</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理异常-1"><span class="nav-number">4.2.4.5.</span> <span class="nav-text">处理异常</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在POJO行为中处理异常"><span class="nav-number">4.2.4.5.1.</span> <span class="nav-text">在POJO行为中处理异常</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在MultiAction行为中处理异常"><span class="nav-number">4.2.4.5.2.</span> <span class="nav-text">在MultiAction行为中处理异常</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用-lt-exception-handler-gt-元素"><span class="nav-number">4.2.4.5.3.</span> <span class="nav-text">使用&lt;exception-handler&gt;元素</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理文件上传"><span class="nav-number">4.2.4.6.</span> <span class="nav-text">处理文件上传</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#输入输出"><span class="nav-number">4.2.5.</span> <span class="nav-text">输入输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流程变量"><span class="nav-number">4.2.6.</span> <span class="nav-text">流程变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#声明变量"><span class="nav-number">4.2.6.1.</span> <span class="nav-text">声明变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#作用域"><span class="nav-number">4.2.6.2.</span> <span class="nav-text">作用域</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#流程作用域"><span class="nav-number">4.2.6.2.1.</span> <span class="nav-text">流程作用域</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#视图作用域"><span class="nav-number">4.2.6.2.2.</span> <span class="nav-text">视图作用域</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#请求作用域"><span class="nav-number">4.2.6.2.3.</span> <span class="nav-text">请求作用域</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Flash作用域"><span class="nav-number">4.2.6.2.4.</span> <span class="nav-text">Flash作用域</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Conversation作用域"><span class="nav-number">4.2.6.2.5.</span> <span class="nav-text">Conversation作用域</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子流程"><span class="nav-number">4.2.7.</span> <span class="nav-text">子流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流程继承"><span class="nav-number">4.2.8.</span> <span class="nav-text">流程继承</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表达式语言"><span class="nav-number">4.3.</span> <span class="nav-text">表达式语言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流程持久化"><span class="nav-number">4.4.</span> <span class="nav-text">流程持久化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#保护流程"><span class="nav-number">4.5.</span> <span class="nav-text">保护流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试流程"><span class="nav-number">4.6.</span> <span class="nav-text">测试流程</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">周千涵</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:supremeadministrator@supercalifragilisticexpialidociouser.com" title="E-Mail → mailto:supremeadministrator@supercalifragilisticexpialidociouser.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周千涵</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
