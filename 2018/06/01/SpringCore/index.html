<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.supercalifragilisticexpialidociouser.com').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="Spring架构">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCore">
<meta property="og:url" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/index.html">
<meta property="og:site_name" content="人见人爱，花见花开，车见爆胎">
<meta property="og:description" content="Spring架构">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/SpringCore/Spring-framework.png">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/SpringCore/IoC-container.png">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/SpringCore/Bean.jpg">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/SpringCore/Scope-Proxy.png">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/SpringCore/AOP.png">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/SpringCore/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86.png">
<meta property="og:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/SpringCore/%E5%BC%95%E5%85%A5.png">
<meta property="article:published_time" content="2018-06-01T13:57:20.000Z">
<meta property="article:modified_time" content="2020-05-09T15:25:50.016Z">
<meta property="article:author" content="周千涵">
<meta property="article:tag" content="5.1.2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/SpringCore/Spring-framework.png">

<link rel="canonical" href="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>SpringCore | 人见人爱，花见花开，车见爆胎</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">人见人爱，花见花开，车见爆胎</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一个程序猿的笔记</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/06/01/SpringCore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringCore
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-06-01 21:57:20" itemprop="dateCreated datePublished" datetime="2018-06-01T21:57:20+08:00">2018-06-01</time>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Spring架构"><a href="#Spring架构" class="headerlink" title="Spring架构"></a>Spring架构</h1><p><img src="SpringCore/Spring-framework.png" alt="Spring-framework"></p>
<a id="more"></a>

<h1 id="IoC"><a href="#IoC" class="headerlink" title="IoC"></a>IoC</h1><p>IoC（Inversion of Control，控制反转），IoC能够让相互协作的软件组件保持<strong>松耦合</strong>。</p>
<p>IoC可分解为两种子类型：依赖查找和依赖注入（DI）。依赖查找有两种类型：依赖拉取（DL）和上下文依赖查找（CDL）。依赖注入则有构造器注入、setter注入等。</p>
<p>IoC容器是Spring框架的核心，它使用DI管理构成应用的组件。Spring IoC容器可分成两种不同类型：</p>
<ul>
<li><code>org.springframework.beans.factory.BeanFactory</code>：最简单的IoC容器。</li>
<li><code>org.springframework.context.ApplicationContext</code>：应用上下文，基于<code>BeanFactory</code>构建，并提供应用框架级别的服务（例如：事务、AOP、国际化等支持）。</li>
</ul>
<p>在Spring中，构成应用程序主干并由Spring IoC容器管理的对象称为bean。 bean是一个由Spring IoC容器实例化，装配（Wiring）和管理的对象。除此之外，bean只是应用程序中众多对象之一。 Bean及其之间的依赖关系反映在容器使用的配置元数据中。</p>
<p><img src="SpringCore/IoC-container.png" alt=""></p>
<h2 id="Bean的生命周期"><a href="#Bean的生命周期" class="headerlink" title="Bean的生命周期"></a>Bean的生命周期</h2><p><img src="SpringCore/Bean.jpg" alt="Bean"></p>
<ol>
<li>Spring 对 Bean进行实例化；</li>
<li>Spring将值和Bean的引用注入到Bean对应的属性中；</li>
<li>如果Bean实现了<code>BeanNameAware</code>接口，Spring将Bean的ID传递给<code>setBeanName</code>方法；</li>
<li>如果Bean实现了<code>BeanFactoryAware</code>接口，Spring将调用<code>setBeanFactory</code>方法，将<code>BeanFactory</code>容器实例传入；</li>
<li>如果Bean实现了<code>ApplicationContextAware</code>接口，Spring将调用<code>setApplicationContext</code>方法，将Bean所在的应用上下文的引用传入进来；</li>
<li>如果Bean实现了<code>BeanPostProcessor</code>接口，Spring将调用它们的<code>postProcessBeforeInitialization</code>方法；</li>
<li>如果Bean实现了<code>InitializingBean</code>接口，Spring将调用它们的<code>afterPropertiesSet</code>方法；</li>
<li>如果Bean使用<code>init-method</code>声明了自定义的初始化方法，该方法也会被调用；</li>
<li>如果Bean实现了<code>BeanPostProcessor</code>接口，Spring将调用它们的<code>postProcessAfterInitialization</code>方法；</li>
<li>此时，Bean已经准备就绪，可以被应用程序使用了，它们将一直驻留在应用上下文中，直到该应用上下文被销毁；</li>
<li>如果Bean实现了<code>DisposableBean</code>接口，Spring将调用它的<code>destroy</code>方法；</li>
<li>如果Bean使用<code>destroy-method</code>声明了自定义的销毁方法，该方法会被调用。</li>
</ol>
<h2 id="装配Bean"><a href="#装配Bean" class="headerlink" title="装配Bean"></a>装配Bean</h2><p>Spring 能过配置元数据（Configuration Metadata）来装配Bean。</p>
<h3 id="装配方式"><a href="#装配方式" class="headerlink" title="装配方式"></a>装配方式</h3><p>Spring提供了三种装配Bean的方法：</p>
<ul>
<li>在XML中进行显式装配；</li>
<li>在Java中进行显式装配；</li>
<li>隐式的Bean发现机制和自动装配。</li>
</ul>
<p>这些装配方式可以任意互相搭配，比如：可以选择使用XML装配一些Bean，使用基于Java的配置来装配另一些Bean，而将剩余的Bean让Spring去自动发现。</p>
<p>XML和基于Java的装配方式更集中，且不会对代码造成侵入。自动装配和基于Java的配置具有类型安全等好处。</p>
<p>通常建议尽可能地使用自动装配机制，当必须要显式装配Bean的时候（比如，有些源码不是由你来维护的，而当你需要为这些代码装配Bean时），推荐使用类型安全并且比XML更加强大的基于Java的装配。最后，只有当你想要使用便利的XML命名空间，并且在基于Java的配置中没有同样的实现时，才应该使用XML的配置。</p>
<h3 id="自动化装配"><a href="#自动化装配" class="headerlink" title="自动化装配"></a>自动化装配</h3><h4 id="创建可被发现的Bean"><a href="#创建可被发现的Bean" class="headerlink" title="创建可被发现的Bean"></a>创建可被发现的Bean</h4><p>首先，创建Bean的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> soundsystem;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CompactDisc</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">play</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，创建Bean的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> soundsystem;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SgtPeppers</span> <span class="keyword">implements</span> <span class="title">CompactDisc</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String title = <span class="string">"Sgt. Pepper's Lonely Hearts Club Band"</span>;  </span><br><span class="line">  <span class="keyword">private</span> String artist = <span class="string">"The Beatles"</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Playing "</span> + title + <span class="string">" by "</span> + artist);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现类上要带有<code>@Component</code>等标注，这样Spring才会发现并为该类创建Bean。</p>
<p>另外，<code>@Repository</code>、<code>@ Service</code>和<code>@Controller</code>是<code>@Component</code>的特殊化，用于更具体的用例（分别在持久性，服务和表示层中）。</p>
<h4 id="启用组件扫描"><a href="#启用组件扫描" class="headerlink" title="启用组件扫描"></a>启用组件扫描</h4><p>为了自动装配带有<code>@Component</code>等标注的Bean，需要启用组件扫描（默认是不启用的）。可以使用基于Java的配置或基于XML的配置来启用组件扫描。</p>
<p>基于Java的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> soundsystem;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayerConfig</span> </span>&#123; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@ComponentScan</code>标注默认指定的基础包是被<code>@ComponentScan</code>标注的配置类所在的包，即它会扫描该基础包以及其下的任意层次的子包，查找带有<code>@Component</code>标注的类。</p>
<p>如果要扫描不同的包（例如配置类放在单独的包中），或要扫描多个基础包，则需要显式指定要扫描的基础包。</p>
<p>最简单指定基础包的方式是通过<code>@ComponentScan</code>的<code>value</code>属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"foo.bar"</span>)</span><br></pre></td></tr></table></figure>

<p>另外，还可以使用<code>basePackages</code>或<code>basePackageClasses</code>属性来指定基础包。前者以字符串形式指定基础包，后者通过类或接口的class对象来指定，class对象所在的包即为基础包。而且，两者都可指定多个基础包：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan</span>(basePackages=&#123;<span class="string">"pkg1"</span>, <span class="string">"pkg2"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackageClasses=&#123;Foo<span class="class">.<span class="keyword">class</span>, <span class="title">Bar</span>.<span class="title">class</span>&#125;)</span></span><br></pre></td></tr></table></figure>

<p>基于XML的配置：（src/resources/META-INF/spring/soundsystem.xml）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:c</span>=<span class="string">"http://www.springframework.org/schema/c"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">		http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"soundsystem"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="自动装配"><a href="#自动装配" class="headerlink" title="自动装配"></a>自动装配</h4><p>在自动装配中，要将Bean与它的依赖装配在一起，需要借助标注<code>@Autowired</code>或<code>@Inject</code>（Java依赖注入规范）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> soundsystem;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayer</span> <span class="keyword">implements</span> <span class="title">MediaPlayer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> CompactDisc cd;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CDPlayer</span><span class="params">(CompactDisc cd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.cd = cd;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cd.play();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从Spring Framework 4.3开始，如果目标bean只定义了一个构造函数，则不再需要在该构造函数上使用<code>@Autowired</code>标注。但是，如果有几个构造函数可用，则必须标注至少一个构造函数，以便指导容器使用哪一个。</p>
</blockquote>
<p><code>@Autowired</code>标注不仅能够用在构造器上，还能用在类的任何方法上（通常是属性的setter方法上），方法甚至可以有多个参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompactDisc</span><span class="params">(CompactDisc cd)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.cd = cd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertDisc</span><span class="params">(CompactDisc cd)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.cd = cd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(MovieCatalog movieCatalog,</span></span></span><br><span class="line"><span class="function"><span class="params">                    CustomerPreferenceDao customerPreferenceDao)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.movieCatalog = movieCatalog;</span><br><span class="line">  <span class="keyword">this</span>.customerPreferenceDao = customerPreferenceDao;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您也可以将<code>@Autowired</code>应用于字段，甚至将其与构造函数混合，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieRecommender</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> CustomerPreferenceDao customerPreferenceDao;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> MovieCatalog movieCatalog;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MovieRecommender</span><span class="params">(CustomerPreferenceDao customerPreferenceDao)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.customerPreferenceDao = customerPreferenceDao;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您还可以通过将<code>@Autowired</code>应用于指定类型数组或集合（Collections）的字段或方法，则从<code>ApplicationContext</code>中将所有匹配指定类型的bean都装配到这个数组或集合中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MovieCatalog[] movieCatalogs;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMovieCatalogs</span><span class="params">(Set&lt;MovieCatalog&gt; movieCatalogs)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.movieCatalogs = movieCatalogs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMovieCatalogs</span><span class="params">(Map&lt;String, MovieCatalog&gt; movieCatalogs)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.movieCatalogs = movieCatalogs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Map</code>的键类型必须是<code>String</code>，它保存Bean的名称。</p>
<p><code>@Autowired</code>标注的<code>required</code>属性设置为<code>false</code>时，Spring会尝试执行自动装配，但是如果没有匹配的Bean，Spring将会让这个Bean处于未装配的状态。这时，如果在代码中没有进行null检查的话，这个处于未装配状态的属性有可能会出现<code>NullPointerException</code>异常。<code>required</code>属性的默认值是<code>true</code>，即如果没有匹配的Bean，那么在应用上下文创建的时候，Spring会抛出一个异常。</p>
<p><code>@Autowired</code>标注和<code>@Inject</code>标注都是按类型进行装配的。而<code>@Resource</code>标注是属于Java EE标准的，它默认按照Bean的ID进行装配，ID可以通过<code>name</code>属性进行指定。如果没有指定<code>name</code>属性，当标注写在字段上时，就默认取字段名进行查找；如果标注写在setter方法上，就默认取属性名进行装配。当找不到与ID匹配的bean时，才按照类型进行装配。但需要注意的是，<code>name</code>一旦指定，就只会按照ID进行装配。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span>(name=<span class="string">"userRepository"</span>)</span><br><span class="line"><span class="keyword">private</span> UserRepository userRepository;</span><br></pre></td></tr></table></figure>

<h3 id="基于Java的装配"><a href="#基于Java的装配" class="headerlink" title="基于Java的装配"></a>基于Java的装配</h3><h4 id="编写方法创建Bean"><a href="#编写方法创建Bean" class="headerlink" title="编写方法创建Bean"></a>编写方法创建Bean</h4><p>要在配置类中编写一个方法，该方法会创建所需类型的Bean，然后给这个方法加上<code>@Bean</code>标注：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> soundsystem;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayerConfig</span> </span>&#123;  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CompactDisc <span class="title">randomBeatlesCD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> choice = (<span class="keyword">int</span>) Math.floor(Math.random() * <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (choice == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> SgtPeppers();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> WhiteAlbum();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> HardDaysNight();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Revolver();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里，配置类上不需要加上<code>@ComponentScan</code>标注。</p>
</blockquote>
<p>标注<code>@Bean</code>的方法只会在首次请求时执行一次，以后每次请求都将被Spring拦截，并从应用上下文中返回相同的Bean。也就是说，默认情况下，Spring中的Bean都是<strong>单例的</strong>。</p>
<h4 id="编程装配"><a href="#编程装配" class="headerlink" title="编程装配"></a>编程装配</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> soundsystem;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayerConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CompactDisc <span class="title">compactDisc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SgtPeppers();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CDPlayer <span class="title">cdPlayer</span><span class="params">(CompactDisc compactDisc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CDPlayer(compactDisc);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，<code>cdPlayer</code>方法请求一个<code>CompactDisc</code>Bean作为参数。当Spring调用<code>cdPlayer</code>方法创建<code>CDPlayter</code>Bean时，它会自动装配一个<code>CompactDisc</code>到配置方法之中。这种方式不需要将<code>CompactDisc</code>声明到同一个配置类中，你可以将配置分散到多个配置类中。甚至不要求<code>CompactDisc</code>必须要在配置类中声明，也可是通过组件扫描自动发现或通过XML来配置。</p>
<p>下面还有一种方式也可以实现相同的装配效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> soundsystem;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CDPlayerConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CompactDisc <span class="title">compactDisc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SgtPeppers();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CDPlayer <span class="title">cdPlayer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CDPlayer(compactDisc());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式通过“调用”<code>@Bean</code>方法的方式来装配Bean（实际上每次调用<code>@Bean</code>方法都将被Spring拦截，只在首次调用时真正执行方法，后面将从IoC容器中直接返回相同的Bean）。</p>
<p>这种方式要求Bean与它的依赖Bean必须在同一个配置类中声明。</p>
<h3 id="基于XML的装配"><a href="#基于XML的装配" class="headerlink" title="基于XML的装配"></a>基于XML的装配</h3><h4 id="配置Bean"><a href="#配置Bean" class="headerlink" title="配置Bean"></a>配置Bean</h4><p>daos.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountDao"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"org.springframework.samples.jpetstore.dao.jpa.JpaAccountDao"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- additional collaborators and configuration for this bean go here --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"itemDao"</span> <span class="attr">class</span>=<span class="string">"org.springframework.samples.jpetstore.dao.jpa.JpaItemDao"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- more bean definitions for data access objects go here --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在基于XML的配置中，你不再需要直接手动创建Bean。当Spring发现<code>&lt;bean&gt;</code>元素时，它将会根据Bean配置的实例化方式来自动实例化Bean。</p>
<h4 id="实例化Bean"><a href="#实例化Bean" class="headerlink" title="实例化Bean"></a>实例化Bean</h4><h5 id="通过默认构造器实例化Bean"><a href="#通过默认构造器实例化Bean" class="headerlink" title="通过默认构造器实例化Bean"></a>通过默认构造器实例化Bean</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"exampleBean"</span> <span class="attr">class</span>=<span class="string">"examples.ExampleBean"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="通过静态工厂方法实例化Bean"><a href="#通过静态工厂方法实例化Bean" class="headerlink" title="通过静态工厂方法实例化Bean"></a>通过静态工厂方法实例化Bean</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"clientService"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"examples.ClientService"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">factory-method</span>=<span class="string">"createInstance"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>class</code>属性指定包含静态工厂方法的类。<code>factory-method</code>属性指定实例化Bean的静态工厂方法名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> ClientService clientService = <span class="keyword">new</span> ClientService();</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">ClientService</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClientService <span class="title">createInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> clientService;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="通过实例工厂方法实例化Bean"><a href="#通过实例工厂方法实例化Bean" class="headerlink" title="通过实例工厂方法实例化Bean"></a>通过实例工厂方法实例化Bean</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceLocator"</span> <span class="attr">class</span>=<span class="string">"examples.DefaultServiceLocator"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- inject any dependencies required by this locator bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"clientService"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">factory-bean</span>=<span class="string">"serviceLocator"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">factory-method</span>=<span class="string">"createClientServiceInstance"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">factory-bean</span>=<span class="string">"serviceLocator"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">factory-method</span>=<span class="string">"createAccountServiceInstance"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>factory-bean</code>属性指定包含实例工厂方法的Bean名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultServiceLocator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> ClientService clientService = <span class="keyword">new</span> ClientServiceImpl();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> AccountService accountService = <span class="keyword">new</span> AccountServiceImpl();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ClientService <span class="title">createClientServiceInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> clientService;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> AccountService <span class="title">createAccountServiceInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> accountService;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h4><h5 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h5><p>使用XML来配置构造器注入，可以使用<code>&lt;constructor-arg&gt;</code>元素或Spring 3.0引入的c-命名空间来配置。</p>
<p>使用<code>&lt;constructor-arg&gt;</code>元素配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"compactDisc"</span> <span class="attr">class</span>=<span class="string">"soundsystem.collections.BlankDisc"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"Sgt. Pepper's Lonely Hearts Club Band"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"The Beatles"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Sgt. Pepper's Lonely Hearts Club Band<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>With a Little Help from My Friends<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Lucy in the Sky with Diamonds<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Getting Better<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Fixing a Hole<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>She's Leaving Home<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Being for the Benefit of Mr. Kite!<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Within You Without You<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>When I'm Sixty-Four<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Lovely Rita<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Good Morning Good Morning<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Sgt. Pepper's Lonely Hearts Club Band (Reprise)<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>A Day in the Life<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cdPlayer"</span> <span class="attr">class</span>=<span class="string">"soundsystem.CDPlayer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"compactDisc"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以使用<code>type</code>属性显式指定构造函数参数的类型：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"exampleBean"</span> <span class="attr">class</span>=<span class="string">"examples.ExampleBean"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">"int"</span> <span class="attr">value</span>=<span class="string">"7500000"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">"java.lang.String"</span> <span class="attr">value</span>=<span class="string">"42"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以使用<code>index</code>属性显式指定构造函数参数的索引：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"exampleBean"</span> <span class="attr">class</span>=<span class="string">"examples.ExampleBean"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"7500000"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"42"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>还可以使用<code>name</code>属性显式指定构造函数参数名称：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"exampleBean"</span> <span class="attr">class</span>=<span class="string">"examples.ExampleBean"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"years"</span> <span class="attr">value</span>=<span class="string">"7500000"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"ultimateAnswer"</span> <span class="attr">value</span>=<span class="string">"42"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>为了使这项工作开箱即用，必须在启用调试标志的情况下编译代码，以便Spring可以从构造函数中查找参数名称。如果您不能或不想使用debug标志编译代码，则可以使用<code>@ConstructorProperties</code> JDK批注显式命名构造函数参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> examples;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleBean</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Fields omitted</span></span><br><span class="line">  <span class="meta">@ConstructorProperties</span>(&#123;<span class="string">"years"</span>, <span class="string">"ultimateAnswer"</span>&#125;)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ExampleBean</span><span class="params">(<span class="keyword">int</span> years, String ultimateAnswer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.years = years;</span><br><span class="line">    <span class="keyword">this</span>.ultimateAnswer = ultimateAnswer;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用c-命名空间来配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:c</span>=<span class="string">"http://www.springframework.org/schema/c"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"compactDisc"</span> <span class="attr">class</span>=<span class="string">"soundsystem.BlankDisc"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">c:_0</span>=<span class="string">"Sgt. Pepper's Lonely Hearts Club Band"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">c:_1</span>=<span class="string">"The Beatles"</span> /&gt;</span></span><br><span class="line">        </span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cdPlayer"</span> <span class="attr">class</span>=<span class="string">"soundsystem.CDPlayer"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">c:_-ref</span>=<span class="string">"compactDisc"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用c-命名空间来声明构造器参数有两种方式：</p>
<ul>
<li>通过构造器参数名：<ul>
<li><code>c:构造器参数名=&quot;字面量&quot;</code>：例如，<code>c:foo=&quot;value&quot;</code>。</li>
<li><code>c:构造器参数名-ref=&quot;要注入的Bean的ID&quot;</code>：例如，<code>c:bar-ref=&quot;beanID&quot;</code>。</li>
</ul>
</li>
<li>通过构造器参数的位置索引：<ul>
<li><code>c:_索引=&quot;字面量&quot;</code>：例如，<code>c:_0=&quot;value&quot;</code>。</li>
<li><code>c:_索引-ref=&quot;要注入的Bean的ID&quot;</code>：例如，<code>c:_1-ref=&quot;beanID&quot;</code>。</li>
<li>如果构造器只有一个参数，则索引可以省略。例如：<code>c:_=&quot;value&quot;</code>。</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意：通过构造器参数名方式，需要在编译代码的时候，将调试符号（debug symbol）保存在类代码中。如果你优化构建过程，将调试符号移除掉，那么这种方式可能就无法正常执行了。</p>
</blockquote>
<h5 id="属性注入"><a href="#属性注入" class="headerlink" title="属性注入"></a>属性注入</h5><p>对于强依赖建议使用构造器注入，而对于可选性的依赖则建议使用属性注入。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"compactDisc"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"soundsystem.properties.BlankDisc"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"title"</span> <span class="attr">value</span>=<span class="string">"Sgt. Pepper's Lonely Hearts Club Band"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"artist"</span> <span class="attr">value</span>=<span class="string">"The Beatles"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"tracks"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Sgt. Pepper's Lonely Hearts Club Band<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>With a Little Help from My Friends<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Lucy in the Sky with Diamonds<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Getting Better<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Fixing a Hole<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>She's Leaving Home<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Being for the Benefit of Mr. Kite!<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Within You Without You<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>When I'm Sixty-Four<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Lovely Rita<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Good Morning Good Morning<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Sgt. Pepper's Lonely Hearts Club Band (Reprise)<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>A Day in the Life<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cdPlayer"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"soundsystem.properties.CDPlayer"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">p:compactDisc-ref</span>=<span class="string">"compactDisc"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Spring提供了简洁的p-命名空间，作为<code>&lt;property&gt;</code>元素的替代方案。</p>
<p>p-命名空间的命名约定与c-命名空间的类似。</p>
<h4 id="装配集合"><a href="#装配集合" class="headerlink" title="装配集合"></a>装配集合</h4><p>如果装配的是集合，则只能使用<code>&lt;constructor-arg&gt;</code>元素和<code>&lt;property&gt;</code>元素来配置，而不能使用c-命名空间和p-命名空间来配置。</p>
<h5 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>a list element followed by a reference<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"myDataSource"</span> /&gt;</span></span><br><span class="line">    …</span><br><span class="line">  <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"someSet"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>just some string<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"myDataSource"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"someMap"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"an entry"</span> <span class="attr">value</span>=<span class="string">"just some string"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span> =<span class="string">"a ref"</span> <span class="attr">value-ref</span>=<span class="string">"myDataSource"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>映射的键和值、集合的值都可以是下列元素：</p>
<p>bean、ref、idref、list、set、map、props、value、null</p>
</blockquote>
<h5 id="java-util-Properties"><a href="#java-util-Properties" class="headerlink" title="java.util.Properties"></a>java.util.Properties</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- typed as a java.util.Properties --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"properties"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">    jdbc.driver.className=com.mysql.jdbc.Driver</span><br><span class="line">    jdbc.url=jdbc:mysql://localhost:3306/mydb</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- results in a setAdminEmails(java.util.Properties) call --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"adminEmails"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"administrator"</span>&gt;</span>administrator@example.org<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"support"</span>&gt;</span>support@example.org<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"development"</span>&gt;</span>development@example.org<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="使用util-命名空间"><a href="#使用util-命名空间" class="headerlink" title="使用util-命名空间"></a>使用util-命名空间</h4><table>
<thead>
<tr>
<th>元素</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;util:constant&gt;</code></td>
<td>引用某个类型的<code>public static</code>域，并将其暴露为Bean。</td>
</tr>
<tr>
<td><code>&lt;util:list&gt;</code></td>
<td>创建一个<code>java.util.List</code>类型的Bean。</td>
</tr>
<tr>
<td><code>&lt;util:map&gt;</code></td>
<td>创建一个<code>java.util.Map</code>类型的Bean。</td>
</tr>
<tr>
<td><code>&lt;util:properties&gt;</code></td>
<td>创建一个<code>java.util.Properties</code>类型的Bean。</td>
</tr>
<tr>
<td><code>util:property-path&gt;</code></td>
<td>引用一个Bean的属性（或内嵌属性），并将其暴露为Bean。</td>
</tr>
<tr>
<td><code>&lt;util:set&gt;</code></td>
<td>创建一个<code>java.util.Set</code>类型的Bean。</td>
</tr>
</tbody></table>
<p>例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/util </span></span></span><br><span class="line"><span class="tag"><span class="string">    http://www.springframework.org/schema/util/spring-util.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"compactDisc"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"soundsystem.properties.BlankDisc"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">p:title</span>=<span class="string">"Sgt. Pepper's Lonely Hearts Club Band"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">p:artist</span>=<span class="string">"The Beatles"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">p:tracks-ref</span>=<span class="string">"trackList"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"trackList"</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Sgt. Pepper's Lonely Hearts Club Band<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>With a Little Help from My Friends<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Lucy in the Sky with Diamonds<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Getting Better<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Fixing a Hole<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>She's Leaving Home<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Being for the Benefit of Mr. Kite!<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Within You Without You<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>When I'm Sixty-Four<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Lovely Rita<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Good Morning Good Morning<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Sgt. Pepper's Lonely Hearts Club Band (Reprise)<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>A Day in the Life<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="装配内嵌Bean"><a href="#装配内嵌Bean" class="headerlink" title="装配内嵌Bean"></a>装配内嵌Bean</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"outer"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- instead of using a reference to a target bean, simply define the target bean inline --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"target"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.example.Person"</span>&gt;</span> <span class="comment">&lt;!-- this is the inner bean --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"Fiona Apple"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">"25"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="装配复合属性"><a href="#装配复合属性" class="headerlink" title="装配复合属性"></a>装配复合属性</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"something"</span> <span class="attr">class</span>=<span class="string">"things.ThingOne"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"fred.bob.sammy"</span> <span class="attr">value</span>=<span class="string">"123"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>something</code>Bean有一个<code>fred</code>属性，<code>fred</code>有一个<code>bob</code>属性，<code>bob</code>有一个<code>sammy</code>属性，最后的<code>sammy</code>属性被设置为<code>123</code>。为了使它们工作，<code>fred</code>属性和它的<code>bob</code>属性不能为<code>null</code>。否则，抛出<code>NullPointerException</code>。</p>
<h4 id="装配空值和空串"><a href="#装配空值和空串" class="headerlink" title="装配空值和空串"></a>装配空值和空串</h4><p>空值：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span><span class="tag">&lt;<span class="name">null</span>/&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"email"</span>&gt;</span><span class="tag">&lt;<span class="name">null</span>/&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>空串：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="lt-idref-gt-元素"><a href="#lt-idref-gt-元素" class="headerlink" title="&lt;idref&gt;元素"></a><code>&lt;idref&gt;</code>元素</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"theTargetBean"</span> <span class="attr">class</span>=<span class="string">"..."</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"theClientBean"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetName"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">idref</span> <span class="attr">bean</span>=<span class="string">"theTargetBean"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>等价于：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"theTargetBean"</span> <span class="attr">class</span>=<span class="string">"..."</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"client"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetName"</span> <span class="attr">value</span>=<span class="string">"theTargetBean"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="使用depends-on属性"><a href="#使用depends-on属性" class="headerlink" title="使用depends-on属性"></a>使用<code>depends-on</code>属性</h4><p>如果bean是另一个bean的依赖项，那通常意味着将一个bean设置为另一个bean的属性。通常，您可以使用基于XML的配置元数据中的<code>&lt;ref /&gt;</code>元素来完成此操作。但是，有时bean之间的依赖关系不那么直接。例如，需要触发类中的静态初始化程序。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"beanOne"</span> <span class="attr">class</span>=<span class="string">"ExampleBean"</span> <span class="attr">depends-on</span>=<span class="string">"manager,accountDao"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"manager"</span> <span class="attr">ref</span>=<span class="string">"manager"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"manager"</span> <span class="attr">class</span>=<span class="string">"ManagerBean"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountDao"</span> <span class="attr">class</span>=<span class="string">"x.y.jdbc.JdbcAccountDao"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>depends-on</code>属性既指定初始化时间依赖关系，也指定销毁时间依赖关系。在给定的bean本身被销毁之前，首先销毁它依赖的bean。因此，依赖也可以控制关闭顺序。</p>
<h4 id="延迟初始化Bean"><a href="#延迟初始化Bean" class="headerlink" title="延迟初始化Bean"></a>延迟初始化Bean</h4><p>默认情况下，<code>ApplicationContext</code>实现会立即地创建和配置所有单例bean。如果不希望出现这种情况，可以通过<code>lazy-init</code>属性将bean定义为延迟初始化来阻止单例bean的预实例化。延迟初始化的bean告诉IoC容器在第一次请求时创建bean实例，而不是在启动时创建。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"lazy"</span> <span class="attr">class</span>=<span class="string">"com.something.ExpensiveToCreateBean"</span> <span class="attr">lazy-init</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>当一个延迟初始化的bean是一个非延迟初始化的单例bean的依赖项时，<code>ApplicationContext</code>会在启动时创建立即创建延迟初始化的bean，因为它必须满足单例的依赖关系。</p>
<p>还可以使用<code>&lt;beans /&gt;</code>元素上的<code>default-lazy-init</code>属性在容器级别控制延迟初始化：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">default-lazy-init</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- no beans will be pre-instantiated... --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="配置导入"><a href="#配置导入" class="headerlink" title="配置导入"></a>配置导入</h3><p>可以使用<code>@Import</code>标注将多个配置类组合在一起，还可以使用<code>@ImportResource</code>标注将XML配置文件导入配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(abc.FooConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">@ImportResource("classpath:bar-config.xml")</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Import</code>标注和<code>@ImportResource</code>标注都可以接受多个参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import</span>(&#123;abc.FooConfig<span class="class">.<span class="keyword">class</span>, <span class="title">xyz</span>.<span class="title">BarConfig</span>.<span class="title">class</span>&#125;)</span></span><br></pre></td></tr></table></figure>

<p>也可以将多个XML配置文件通过<code>&lt;import&gt;</code>组合到一个XML配置文件中：（app.xml）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"services.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"resources/messageSource.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"/resources/themeSource.xml"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bean1"</span> <span class="attr">class</span>=<span class="string">"..."</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bean2"</span> <span class="attr">class</span>=<span class="string">"..."</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面三个导入的配置文件都是相对路径（即使以<code>/</code>开头），它相对于当前执行导入的配置文件（<code>app.xml</code>）的位置。要使用绝对路径，要写成：<code>file:C:/config/services.xml</code> 或 <code>classpath:/config/services.xml</code>。</p>
<p>注意：<code>&lt;import&gt;</code>元素只能导入其他的XML配置文件，并不能导入配置类。但可以使用<code>&lt;bean&gt;</code>元素来将配置类导入XML配置文件中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"abc.FooConfig"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过导入将多个配置类或XML配置文件组合在一起，在实例化应用上下文时，只需要传入最高层次的那一个配置类或XML配置文件即可。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"app.xml"</span>);</span><br></pre></td></tr></table></figure>

<p>否则，就需要列出所有的配置类或XML配置文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(abc.FooConfig<span class="class">.<span class="keyword">class</span>, <span class="title">xyz</span>.<span class="title">BarConfig</span>.<span class="title">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Bean的命名"><a href="#Bean的命名" class="headerlink" title="Bean的命名"></a>Bean的命名</h3><p>每个Bean可以有一个或多个标识符，这些标识符在托管bean的容器中必须是唯一的。</p>
<p>在自动化装配中，通过将Bean标识符传递给标注<code>@Component</code>来为Bean显式命名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">"foo"</span>)</span><br></pre></td></tr></table></figure>

<p>自动化装配中，默认的命名是首字母小写的类名。例如，类名为<code>FooBar</code>，则Bean的默认名为<code>fooBar</code>。</p>
<p>另外，也可以使用Java依赖注入规范中的<code>@Named</code>标注来代替<code>@Component</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Named</span>(<span class="string">"foo"</span>)</span><br></pre></td></tr></table></figure>

<p>在基于Java的配置中，通过标注<code>@Bean</code>的<code>name</code>属性为Bean显式命名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name=<span class="string">"foo"</span>)</span><br></pre></td></tr></table></figure>

<p>在基于Java的配置中，Bean的默认ID是<code>@Bean</code>标注的方法名。例如，方法名为<code>fooBar</code>，则Bean的默认名为<code>fooBar</code>。</p>
<p>在基于XML的配置元数据中，使用<code>id</code>属性、<code>name</code>属性或两者来指定Bean标识符。<code>id</code>属性只能指定一个标识符，而<code>name</code>属性可以指定多个别名。别名之间使用逗号、分号或空白字符分隔。</p>
<p>在基于XML的配置中，Bean的默认ID是Bean的完全限定类名加<code>#计数</code>组成。例如：<code>abc.FooBar#0</code>。</p>
<h3 id="Spring-Profile"><a href="#Spring-Profile" class="headerlink" title="Spring Profile"></a>Spring Profile</h3><p>Spring Profile能够在<strong>运行时</strong>根据环境决定该创建哪个Bean和不创建哪个Bean。因此，同一个部署单元（可能会是WAR文件）能够适用于所有的环境，并且不需要重新构建。</p>
<h4 id="配置Profile"><a href="#配置Profile" class="headerlink" title="配置Profile"></a>配置Profile</h4><h5 id="在Java中配置Profile"><a href="#在Java中配置Profile" class="headerlink" title="在Java中配置Profile"></a>在Java中配置Profile</h5><p>在Java配置中，使用<code>@Profile</code>标注来指定某个Bean属于哪一个Profile。<code>@Profile</code>可以标注在类级别，也可以标注在方法级别。</p>
<p>标注在类级别：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Profile</span>(<span class="string">"qa"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QAProfileConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span>(destroyMethod=<span class="string">"close"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BasicDataSource dataSource = <span class="keyword">new</span> BasicDataSource();</span><br><span class="line">    dataSource.setUrl(<span class="string">"jdbc:h2:tcp://dbserver/~/test"</span>);</span><br><span class="line">    dataSource.setDriverClassName(<span class="string">"org.h2.Driver"</span>);</span><br><span class="line">    dataSource.setUsername(<span class="string">"sa"</span>);</span><br><span class="line">    dataSource.setPassword(<span class="string">"password"</span>);</span><br><span class="line">    dataSource.setInitialSize(<span class="number">20</span>);</span><br><span class="line">    dataSource.setMaxActive(<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>标注在<code>@Bean</code>方法上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span>(destroyMethod = <span class="string">"shutdown"</span>)</span><br><span class="line">  <span class="meta">@Profile</span>(<span class="string">"dev"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSource <span class="title">embeddedDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EmbeddedDatabaseBuilder()</span><br><span class="line">        .setType(EmbeddedDatabaseType.H2)</span><br><span class="line">        .addScript(<span class="string">"classpath:schema.sql"</span>)</span><br><span class="line">        .addScript(<span class="string">"classpath:test-data.sql"</span>)</span><br><span class="line">        .build();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Profile</span>(<span class="string">"prod"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSource <span class="title">jndiDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JndiObjectFactoryBean jndiObjectFactoryBean = <span class="keyword">new</span> JndiObjectFactoryBean();</span><br><span class="line">    jndiObjectFactoryBean.setJndiName(<span class="string">"jdbc/myDS"</span>);</span><br><span class="line">    jndiObjectFactoryBean.setResourceRef(<span class="keyword">true</span>);</span><br><span class="line">    jndiObjectFactoryBean.setProxyInterface(javax.sql.DataSource<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">return</span> (DataSource) jndiObjectFactoryBean.getObject();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，<code>@Profile</code>可以同时指定多个Profile：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(&#123;<span class="string">"dev"</span>, <span class="string">"test"</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><code>@Profile</code>还可以通过<code>!</code>来表示取反。例如：<code>@Profile(&quot;!test&quot;)</code>。</p>
<h5 id="在XML中配置Profile"><a href="#在XML中配置Profile" class="headerlink" title="在XML中配置Profile"></a>在XML中配置Profile</h5><p>在XML中通过<code>&lt;beans&gt;</code>元素的<code>profile</code>属性来配置Profile。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:jdbc</span>=<span class="string">"http://www.springframework.org/schema/jdbc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/jdbc</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/jdbc/spring-jdbc.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans.xsd"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">profile</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">jdbc:embedded-database</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">type</span>=<span class="string">"H2"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">"classpath:schema.sql"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">"classpath:test-data.sql"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">jdbc:embedded-database</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>还可以在根<code>&lt;beans&gt;</code>元素中嵌套定义<code>&lt;beans&gt;</code>元素，而不是为每个环境都创建一个Profile XML文件。这能够将所有的Profile Bean定义放到同一个XML文件中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:jdbc</span>=<span class="string">"http://www.springframework.org/schema/jdbc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:jee</span>=<span class="string">"http://www.springframework.org/schema/jee"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/jee</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/jee/spring-jee.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/jdbc</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/jdbc/spring-jdbc.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbc:embedded-database</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">type</span>=<span class="string">"H2"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">"classpath:schema.sql"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">"classpath:test-data.sql"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdbc:embedded-database</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">"qa"</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">destroy-method</span>=<span class="string">"close"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:url</span>=<span class="string">"jdbc:h2:tcp://dbserver/~/test"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:driverClassName</span>=<span class="string">"org.h2.Driver"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:username</span>=<span class="string">"sa"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:password</span>=<span class="string">"password"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:initialSize</span>=<span class="string">"20"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:maxActive</span>=<span class="string">"30"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">"prod"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jee:jndi-lookup</span> <span class="attr">id</span>=<span class="string">"dataSource"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">lazy-init</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">jndi-name</span>=<span class="string">"jdbc/myDatabase"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">resource-ref</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">proxy-interface</span>=<span class="string">"javax.sql.DataSource"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="激活Profile"><a href="#激活Profile" class="headerlink" title="激活Profile"></a>激活Profile</h4><p>已经配置了Profile的Bean，只有当指定的Profile激活时，相应的Bean才会被创建。而没有指定任何Profile的Bean，总是会被创建，与激活哪个Profile没有关系。</p>
<p>Spring通过两个属性来确定哪个Profile处于激活状态：</p>
<ul>
<li><code>spring.profiles.active</code></li>
<li><code>spring.profiles.default</code></li>
</ul>
<p>如果设置了<code>spring.profiles.active</code>属性，则它的值就是被激活的Profile。否则，Spring会继续查找<code>spring.profiles.default</code>属性的值。如果两个属性均未设置，那就没有激活的Profile，因此只会创建那些没有定义在Profile中的Bean。</p>
<p>这两个属性都可以同时指定多个Profile，使用逗号分隔。</p>
<p>有多种方式来设置这两个属性：</p>
<ul>
<li><p>作为<code>DispatcherServlet</code>的初始化参数：（web.xml）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>appServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>spring.profiles.default<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>作为Web应用的上下文参数：（web.xml）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>spring.profiles.default<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>qa,demo<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>作为JNDI条目；</p>
</li>
<li><p>作为环境变量；</p>
</li>
<li><p>作为JVM的系统属性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dspring.profiles.active=<span class="string">"profile1,profile2"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在集成测试类上，使用<code>@ActiveProfiles</code>标注设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfigTest</span> </span>&#123;</span><br><span class="line">  <span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  @<span class="title">ContextConfiguration</span>(<span class="title">classes</span></span>=DataSourceConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">  @ActiveProfiles("dev")</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DevDataSourceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shouldBeEmbeddedDatasource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      assertNotNull(dataSource);</span><br><span class="line">      JdbcTemplate jdbc = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">      List&lt;String&gt; results = jdbc.query(<span class="string">"select id, name from Things"</span>, <span class="keyword">new</span> RowMapper&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> rs.getLong(<span class="string">"id"</span>) + <span class="string">":"</span> + rs.getString(<span class="string">"name"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      </span><br><span class="line">      assertEquals(<span class="number">1</span>, results.size());</span><br><span class="line">      assertEquals(<span class="string">"1:A"</span>, results.get(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  @<span class="title">ContextConfiguration</span>(<span class="title">classes</span></span>=DataSourceConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">  @ActiveProfiles("prod")</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductionDataSourceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shouldBeEmbeddedDatasource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// should be null, because there isn't a datasource configured in JNDI</span></span><br><span class="line">      assertNull(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">  @ContextConfiguration("classpath:datasource-config.xml")</span><br><span class="line">  <span class="meta">@ActiveProfiles</span>(<span class="string">"dev"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DevDataSourceTest_XMLConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shouldBeEmbeddedDatasource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      assertNotNull(dataSource);</span><br><span class="line">      JdbcTemplate jdbc = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">      List&lt;String&gt; results = jdbc.query(<span class="string">"select id, name from Things"</span>, <span class="keyword">new</span> RowMapper&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> rs.getLong(<span class="string">"id"</span>) + <span class="string">":"</span> + rs.getString(<span class="string">"name"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      </span><br><span class="line">      assertEquals(<span class="number">1</span>, results.size());</span><br><span class="line">      assertEquals(<span class="string">"1:A"</span>, results.get(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">  @ContextConfiguration("classpath:datasource-config.xml")</span><br><span class="line">  <span class="meta">@ActiveProfiles</span>(<span class="string">"prod"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductionDataSourceTest_XMLConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span>(required=<span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shouldBeEmbeddedDatasource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// should be null, because there isn't a datasource configured in JNDI</span></span><br><span class="line">      assertNull(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>另外，还可以通过硬编码方式激活Profile：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AnnotationConfigApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">ctx.getEnvironment().setActiveProfiles(<span class="string">"development"</span>);</span><br><span class="line">ctx.register(SomeConfig<span class="class">.<span class="keyword">class</span>, <span class="title">StandaloneDataConfig</span>.<span class="title">class</span>, <span class="title">JndiDataConfig</span>.<span class="title">class</span>)</span>;</span><br><span class="line">ctx.refresh();</span><br></pre></td></tr></table></figure>

<h4 id="获取Profile的状态"><a href="#获取Profile的状态" class="headerlink" title="获取Profile的状态"></a>获取Profile的状态</h4><p><code>Environment</code>提供了一些方法来检查哪些Profile处于激活状态：</p>
<ul>
<li><code>String[] getActiveProfiles()</code>：返回激活Profile名称的数组；</li>
<li><code>String[] getDefaultProfiles()</code>：返回默认Profile名称的数组；</li>
<li><code>boolean acceptsProfiles(String ... profiles)</code>：如果<code>Environment</code>支持给定Profile，则返回<code>true</code>。</li>
</ul>
<h3 id="条件化的Bean"><a href="#条件化的Bean" class="headerlink" title="条件化的Bean"></a>条件化的Bean</h3><p>Spring 4.0引入了条件化的Bean机制，它可以自行设定条件来控制Bean的创建。它是比Profile机制更通用的机制。</p>
<p>例如，假设有一个名为<code>MagicBean</code>的类，我们希望只有设置了<code>magic</code>环境属性时，Spring才会实例化这个类。</p>
<p>首先，创建自定义条件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MagicExistsCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">    Environment env = context.getEnvironment();</span><br><span class="line">    <span class="keyword">return</span> env.containsProperty(<span class="string">"magic"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，条件化配置Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MagicConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Conditional</span>(MagicExistsCondition<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">MagicBean</span> <span class="title">magicBean</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MagicBean();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当条件的<code>matches</code>方法返回<code>true</code>时才会创建<code>MagicBean</code>的实例。</p>
<h3 id="处理自动装配的歧义性"><a href="#处理自动装配的歧义性" class="headerlink" title="处理自动装配的歧义性"></a>处理自动装配的歧义性</h3><p>在自动装配时，如果同时有多个Bean能够匹配，这时Spring就会抛出<code>NoUniqueBeanDefinitionException</code>异常。</p>
<p>Spring提供了两种方案来解决自动装配中的歧义性问题：你可以将可选的Bean中的某一个设置为首选（Primary），或者使用限定符（Qualifier）来帮助Spring将可选的Bean范围缩小到只有一个Bean。</p>
<h4 id="设置首选Bean"><a href="#设置首选Bean" class="headerlink" title="设置首选Bean"></a>设置首选Bean</h4><p>在Java配置中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IceCream</span> <span class="keyword">implements</span> <span class="title">Dessert</span> </span>&#123;…&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Dessert <span class="title">iceCream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> IceCream();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在XML配置中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"iceCream"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"com.desserteater.IceCream"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">primary</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>为了使首选Bean有效，同一类型的Bean中，最多只能有一个Bean被设置为首选。但是，<code>@Primary</code>并不能限制设置多个首选Bean发生，它只是标示一个优先的可选方案，这也是设置首选Bean方案的局限性。</p>
<p>当遇到歧义性时，Spring将会使用首选的Bean。</p>
<h4 id="使用限定符"><a href="#使用限定符" class="headerlink" title="使用限定符"></a>使用限定符</h4><h5 id="为Bean设置限定符"><a href="#为Bean设置限定符" class="headerlink" title="为Bean设置限定符"></a>为Bean设置限定符</h5><p>所有的Bean，如果没有显式设置限定符，都会给定一个默认的限定符，它与Bean的ID相同。</p>
<p>可以使用<code>@Qualifier</code>标注为Bean显式设置限定符：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Qualifier</span>(<span class="string">"cold"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IceCream</span> <span class="keyword">implements</span> <span class="title">Dessert</span> </span>&#123;…&#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Qualifier</span>(<span class="string">"cold"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Dessert <span class="title">iceCream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> IceCream();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用为Bean显式设置限定符的好处是，可以减少与Bean的ID的耦合度。</p>
<p>为Bean设置限定符的最佳实践是为Bean选择特征性或描述性的术语作为限定符。</p>
<h5 id="使用限定符注入"><a href="#使用限定符注入" class="headerlink" title="使用限定符注入"></a>使用限定符注入</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier</span>(<span class="string">"cold"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDessert</span><span class="params">(Dessert dessert)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.dessert = dessert;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，就只会将带有<code>cold</code>限定符的Bean注入。</p>
<h5 id="自定义限定符标注"><a href="#自定义限定符标注" class="headerlink" title="自定义限定符标注"></a>自定义限定符标注</h5><p>当多个Bean设置了相同的限定符时，就需要设置更多的限定符来区分它们。但是，很遗憾在Java中不允许同一条目上重复出现相同类型的多个标注。我们可以通过创建自定义的限定符标注来解决这个问题。</p>
<p>创建自定义限定符标注：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.CONSTRUCTOR, ElementType.FIELD, ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Cold &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.CONSTRUCTOR, ElementType.FIELD, ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Creamy &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.CONSTRUCTOR, ElementType.FIELD, ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Fruity &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>使用自定义限定符标注：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Cold</span></span><br><span class="line"><span class="meta">@Creamy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IceCream</span> <span class="keyword">implements</span> <span class="title">Dessert</span> </span>&#123;…&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Cold</span></span><br><span class="line"><span class="meta">@Fruity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Popsicle</span> <span class="keyword">implements</span> <span class="title">Dessert</span> </span>&#123;…&#125;</span><br></pre></td></tr></table></figure>

<p>则在注入点，可以使用下面方式将范围缩小到<code>IceCream</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Cold</span></span><br><span class="line"><span class="meta">@Creamy</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDessert</span><span class="params">(Dessert dessert)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.dessert = dessert;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Bean的作用域"><a href="#Bean的作用域" class="headerlink" title="Bean的作用域"></a>Bean的作用域</h3><p>Spring Bean有多种作用域：</p>
<ul>
<li>单例（<code>singleton</code>）：在整个应用中，只创建Bean的一个实例。</li>
<li>原型（<code>prototype</code>）：每次注入或者通过Spring应用上下文获取的时候，都会创建一个新的Bean实例。</li>
<li>会话（<code>session</code>）：在Web应用中，为每个会话创建一个Bean实例。</li>
<li>全局会话（<code>globalSession</code>）：类似于会话作用域，但仅在Portlet的Web应用中使用。</li>
<li>请求（<code>request</code>）：在Web应用中，为每个请求创建一个Bean实例。</li>
</ul>
<p>在默认情况下，Spring应用上下文中所有Bean都是单例的。可以通过<code>@Scope</code>标注为Bean显式选择其他的作用域：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Scope</span>(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Notepad</span> </span>&#123;…&#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Scope</span>(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Notepad <span class="title">notepad</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Notepad();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在XML配置文件中，可以使用<code>&lt;bean&gt;</code>元素的<code>scope</code>属性来设置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"notepad"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"com.myapp.Notepad"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">scope</span>=<span class="string">"prototype"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>会话和请求作用域只能在Web应用中使用，并且要在web.xml中做如下设置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  	org.springframework.web.context.request.RequestContextListener</span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="作用域代理"><a href="#作用域代理" class="headerlink" title="作用域代理"></a>作用域代理</h4><p>在使用会话或请求作用域时，会遇到将会话或请求作用域的Bean注入到单例Bean中的问题。因为，单例Bean是在Spring应用上下文加载的时候创建的，而这时要注入的会话或请求作用域的Bean还不存在。而且，系统中将会有多个会话或请求作用域的Bean，而单例Bean只有一个。</p>
<p>Spring通过注入作用域代理，而不是直接注入会话或请求作用域Bean来解决这个问题。作用域代理会暴露与它代理的会话或请求作用域Bean相同的方法，并将调用委托给<strong>当前会话或请求</strong>所对应的那一个会话或请求作用域Bean。</p>
<p><img src="SpringCore/Scope-Proxy.png" alt="Scope Proxy"></p>
<p>作用域代理有两种实现模式：</p>
<ul>
<li>基于接口的JDK代理（目标Bean是个接口）；</li>
<li>基于具体类的CGLib代理（目标Bean是个具体类）。</li>
</ul>
<p>作用域代理的实现模式用<code>@Scope</code>标注的<code>proxyMode</code>属性来设置：</p>
<ul>
<li><code>proxyMode=ScopedProxyMode.INTERFACES</code>：基于接口的JDK代理；</li>
<li><code>proxyMode=ScopedProxyMode.TARGET_CLASS</code>：基于具体类的CGLib代理。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Scope</span>(value=WebApplicationContext.SCOPE_SESSION, </span><br><span class="line">       proxyMode=ScopedProxyMode.INTERFACES)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ShoppingCart <span class="title">cart</span><span class="params">()</span> </span>&#123;…&#125;</span><br></pre></td></tr></table></figure>

<p><code>proxyMode</code>属性的默认值是<code>ScopedProxyMode.DEFAULT</code>，即不创建作用域代理。</p>
<p>在XML配置中，可以配置为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">	     <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cart"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"com.myapp.ShoppingCart"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">scope</span>=<span class="string">"session"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:scoped-proxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;aop:scoped-proxy&gt;</code>的作用与<code>proxyMode</code>属性相同。</p>
<p>默认情况下，<code>proxy-target-class</code>的值是<code>true</code>，即使用CGLib创建目标类的代理。</p>
<h2 id="应用上下文"><a href="#应用上下文" class="headerlink" title="应用上下文"></a>应用上下文</h2><p>Spring通过应用上下文（Application Context）装载bean的定义并把它们组装起来。Spring应用上下文全权负责对象的创建和组装。</p>
<p>常见的应用上下文实现：</p>
<ul>
<li><code>AnnotationConfigApplicationContext</code>：从一个或多个基于Java的配置类中加载Spring应用上下文。</li>
<li><code>AnnotationConfigWebApplicationContext</code>：从一个或多个基于Java的配置类中加载Spring Web应用上下文。</li>
<li><code>ClassPathXmlApplicationContext</code>：从类路径下的一个或多个XML配置文件中加载上下文定义。</li>
<li><code>FileSystemXmlApplicationContext</code>：从文件系统下的一个或多个XML配置文件中加载上下文定义。</li>
<li><code>XmlWebApplicationContext</code>：从Web应用下的一个或多个XML配置文件中加载上下文定义。</li>
</ul>
<h3 id="应用上下文实例化"><a href="#应用上下文实例化" class="headerlink" title="应用上下文实例化"></a>应用上下文实例化</h3><p>编程方式实例化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"services.xml"</span>, <span class="string">"daos.xml"</span>);</span><br><span class="line">  <span class="comment">//或者 ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);</span></span><br><span class="line">  <span class="comment">// 获取Bean</span></span><br><span class="line">  PetStoreService petStoreService = context.getBean(<span class="string">"petStore"</span>, PetStoreService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="comment">// 使用petStoreService</span></span><br><span class="line">List&lt;String&gt; userList = petStoreService.getUsernameList();</span><br><span class="line">  context.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Web应用中，可在<code>web.xml</code>中添加如下配置来自动实例化应用上下文：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/daoContext.xml /WEB-INF/applicationContext.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上下文参数<code>contextConfigLocation</code>的默认值是<code>/WEB-INF/applicationContext.xml</code>。</p>
<p>上下文参数<code>contextConfigLocation</code>的值可以是逗号、分号或空白字符分隔的多个文件。还支持Ant样式的路径模式。例如：</p>
<ul>
<li><code>/WEB-INF/*Context.xml</code>：匹配所有名称以<code>Context.xml</code>结尾且位于<code>WEB-INF</code>目录中的文件；</li>
<li><code>/WEB-INF/**/*Context.xml</code>：匹配<code>WEB-INF</code>的任何子目录中名称以<code>Context.xml</code>结尾的文件。</li>
</ul>
<h3 id="应用上下文事件"><a href="#应用上下文事件" class="headerlink" title="应用上下文事件"></a>应用上下文事件</h3><h1 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h1><h2 id="使用外部属性文件"><a href="#使用外部属性文件" class="headerlink" title="使用外部属性文件"></a>使用外部属性文件</h2><h3 id="声明属性源"><a href="#声明属性源" class="headerlink" title="声明属性源"></a>声明属性源</h3><p>Spring 使用<code>@PropertySource</code>标注来将外部属性文件声明为属性源，并在运行时加载到<code>Environment</code>中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:/com/soundsystem/app.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpressiveConfig</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">disc.title</span>=<span class="string">Sgt. Peppers Lonely Hearts Club Band</span></span><br><span class="line"><span class="meta">disc.artist</span>=<span class="string">The Beatles</span></span><br></pre></td></tr></table></figure>

<h3 id="获取外部属性"><a href="#获取外部属性" class="headerlink" title="获取外部属性"></a>获取外部属性</h3><h4 id="直接通过Environment对象获取"><a href="#直接通过Environment对象获取" class="headerlink" title="直接通过Environment对象获取"></a>直接通过<code>Environment</code>对象获取</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:/com/soundsystem/app.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpressiveConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  Environment env;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> BlankDisc <span class="title">disc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BlankDisc(env.getProperty(<span class="string">"disc.title"</span>),</span><br><span class="line">                         env.getProperty(<span class="string">"disc.artist"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当指定的属性不存在时，<code>getProperty</code>方法返回<code>null</code>。可以通过可选的第二个参数显式地给不存在的属性指定一个默认值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env.getProperty(<span class="string">"disc.title"</span>, <span class="string">"Rattle and Hum"</span>)</span><br></pre></td></tr></table></figure>

<p>如果希望在指定属性不存在时，抛出异常，而不是返回<code>null</code>，则可以使用<code>getRequiredProperty</code>方法。</p>
<p><code>getProperty</code>方法除了可以返回<code>String</code>类型的属性值外，也可以返回指定的类类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> connectionCount = env.getProperty(<span class="string">"db.connection.count"</span>, Integer<span class="class">.<span class="keyword">class</span>, 30)</span>;</span><br></pre></td></tr></table></figure>

<p>要检查某个属性是否存在，可以使用<code>containsProperty</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> titleExists = env.containsProperty(<span class="string">"disc.title"</span>);</span><br></pre></td></tr></table></figure>

<p>可以使用方法<code>getPropertyAsClass</code>将属性值解析为类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;CompactDisc&gt; cdClass = env.getPropertyAsClass(<span class="string">"disc.class"</span>, CompactDisc<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="使用属性占位符获取外部属性"><a href="#使用属性占位符获取外部属性" class="headerlink" title="使用属性占位符获取外部属性"></a>使用属性占位符获取外部属性</h4><p>Sprng的属性占位符是使用<code>${…}</code>形式包装的属性名称。</p>
<p>为了使用属性占位符，要配置一个<code>PropertyPlaceholderConfigurer</code> Bean或<code>PropertySourcesPlaceholderConfigurer</code> Bean（推荐）。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PropertySourcesPlaceholderConfigurer <span class="title">placeholderConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> PropertySourcesPlaceholderConfigurer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:property-placeholder</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在基于Java的配置中，可以使用<code>@Value</code>标注使用属性占位符来将外部属性注入到Bean中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlankDisc</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BlankDisc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  	@Value(<span class="string">"$&#123;disc.title&#125;"</span>)</span> String title,</span></span><br><span class="line"><span class="function">    @<span class="title">Value</span><span class="params">(<span class="string">"$&#123;disc.artist&#125;"</span>)</span> String artist) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.title = title;</span><br><span class="line">    <span class="keyword">this</span>.artist = artist;</span><br><span class="line">  &#125;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在基于XML配置中，则：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sgtPeppers"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"soundsystem.BlankDisc"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:title</span>=<span class="string">"$&#123;disc.title&#125;"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">c:artist</span>=<span class="string">"$&#123;disc.artist&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h2><h3 id="JDK的国际化支持"><a href="#JDK的国际化支持" class="headerlink" title="JDK的国际化支持"></a>JDK的国际化支持</h3><h4 id="格式化类"><a href="#格式化类" class="headerlink" title="格式化类"></a>格式化类</h4><p>JDK的<code>java.util</code>包中提供了几个支持国际化的格式化类，如<code>NumberFormat</code>、<code>DateFormat</code>和<code>MessageFormat</code>。</p>
<p><code>NumberFormat</code>的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Locale locale = <span class="keyword">new</span> Locale(<span class="string">"zh"</span>, <span class="string">"CN"</span>);</span><br><span class="line">NumberFormat currFmt = NumberFormat.getCurrencyInstance(locale);</span><br><span class="line"><span class="keyword">double</span> amount = <span class="number">123456.78</span>;</span><br><span class="line">System.out.println(currFmt.format(amount));</span><br></pre></td></tr></table></figure>

<p><code>DateFormat</code>的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Locale locale = <span class="keyword">new</span> Locale(<span class="string">"zh"</span>, <span class="string">"CN"</span>);</span><br><span class="line">DateFormat df = DateFormat.getDateInstance(DateFormat.MEDIUM, locale);</span><br><span class="line">Date date = <span class="keyword">new</span> Date();</span><br><span class="line">System.out.println(df.format(date));</span><br></pre></td></tr></table></figure>

<p><code>MessageFormat</code>的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//格式化消息串</span></span><br><span class="line">String pattern1 = <span class="string">"&#123;0&#125;，你好！你于&#123;1&#125;在工商银行存入&#123;2&#125;元。"</span>;</span><br><span class="line">String pattern2 = <span class="string">"At &#123;1,time,short&#125; On &#123;1,date,long&#125;, &#123;0&#125; paid &#123;2,number,currency&#125;."</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用于动态替换占位符的参数</span></span><br><span class="line">Object[] params = &#123;<span class="string">"John"</span>, <span class="keyword">new</span> GregorianCalendar().getTime(), <span class="number">1.0E3</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用默认的本地化对象格式化消息</span></span><br><span class="line">String msg1 = MessageFormat.format(pattern1, params);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用指定的本地化对象格式化消息</span></span><br><span class="line">MessageFormat mf = <span class="keyword">new</span> MessageFormat(pattern2, Locale.US);</span><br><span class="line">String msg2 = mf.format(params);</span><br><span class="line">System.out.println(msg1);</span><br><span class="line">System.out.println(msg2);</span><br></pre></td></tr></table></figure>

<h4 id="ResourceBundle"><a href="#ResourceBundle" class="headerlink" title="ResourceBundle"></a>ResourceBundle</h4><p>仅使用格式化类也可以提供国际化支持，但太笨拙了。JDK为此提供了方便加载及访问国际化资源文件的类<code>java.util.ResourceBundle</code>。</p>
<p>首先，为每个要支持的语言、地区创建如下命名的国际化资源文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">资源名_可选的语言代码_可选的国家或地区代码.properties</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resource_en_US.properties</span><br><span class="line">resource_en.properties</span><br><span class="line">resource.properties</span><br></pre></td></tr></table></figure>

<p>资源名相同，但语言代码、国家或地区代码不同的一组国际化资源文件应该放在同一个目录下，它们包含的属性名是相同的，但属性值各不相同。</p>
<p>其中<code>资源名.properties</code>为默认资源文件，即某个语言或地区在系统中找不到对应的资源文件时，就采用这个默认资源文件。</p>
<p>假设上面的<code>resource</code>资源文件都放在类路径根的<code>i18n</code>目录下，则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ResourceBundle rb = ResourceBundle.getBundle(<span class="string">"i18n/resource"</span>, Locale.CHINA);</span><br><span class="line">String msg = rb.getString(<span class="string">"greeting.common"</span>);</span><br></pre></td></tr></table></figure>

<p>如果消息中包含占位符，则可以使用<code>MessageFormat</code>来填充占位符：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Object[] params = &#123;<span class="string">"John"</span>, <span class="keyword">new</span> GregorianCalendar().getTime(), <span class="number">1.0E3</span>&#125;;</span><br><span class="line">String msgFmt = <span class="keyword">new</span> MessageFormat(rb.getString(<span class="string">"greeting.common"</span>), Locale.CHINA).format(params);</span><br></pre></td></tr></table></figure>

<h3 id="Spring的国际化支持"><a href="#Spring的国际化支持" class="headerlink" title="Spring的国际化支持"></a>Spring的国际化支持</h3><p>Spring提供了<code>MessageSource</code>接口，进一步简化了国际化的使用。这些接口提供了如下易用的方法：</p>
<ul>
<li><code>String getMessage(String code, Object[] args, String default, Locale loc)</code>：<code>code</code>是国际化消息中的属性名；<code>args</code>是用于传递给格式化串占位符的运行期参数；<code>default</code>是当在<code>MessageSource</code>中找不到对应属性名时，返回的默认值；<code>locale</code>是区域对象。</li>
<li><code>String getMessage(String code, Object[] args, Locale loc)</code>：与上面的方法类似，只是没有提供默认值。如果找不到该消息，则抛出<code>NoSuchMessageException</code>。</li>
<li><code>String getMessage(MessageSourceResolvable resolvable, Locale locale)</code>：<code>resolvable</code>封装了属性名、参数数组和默认消息。如果找不到该消息，则抛出<code>NoSuchMessageException</code>。</li>
</ul>
<p><code>MessageSource</code>的接口分别被<code>HierarchicalMessageSource</code>接口和<code>ApplicationContext</code>接口扩展，前者提供了分层次地解析消息的能力。</p>
<h4 id="ResourceBundleMessageSource"><a href="#ResourceBundleMessageSource" class="headerlink" title="ResourceBundleMessageSource"></a>ResourceBundleMessageSource</h4><p><code>ResourceBundleMessageSource</code>是<code>HierarchicalMessageSource</code>接口的一个实现类，它允许通过<code>beanName</code>属性指定一个国际化资源，或者通过<code>beanNames</code>指定一组国际化资源。底层还是使用<code>ResourceBundle</code>对象解析消息。</p>
<p>beans.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"messageSource"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"org.springframework.context.support.ResourceBundleMessageSource"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basenames"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>format<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>exceptions<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>windows<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>format.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">message</span>=<span class="string">Alligators rock!</span></span><br></pre></td></tr></table></figure>

<p>exceptions.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">argument.required</span>=<span class="string">The &#123;0&#125; argument is required.</span></span><br></pre></td></tr></table></figure>

<p>可以将上面的<code>messageSource</code>Bean注入其他Bean中，以使得其他Bean能访问国际化资源。但是，由于<code>ApplicationContext</code>也实现了<code>MessageSource</code>接口，从而可以直接在容器级别上使用国际化资源。</p>
<p>在加载<code>ApplicationContext</code>时，它会自动搜索上下文中定义的<code>MessageSource</code> Bean，且Bean必须具有名称<code>messageSource</code>。如果找到这样的Bean，则对<code>ApplicationContext</code>的<code>getMessage</code>方法的所有调用都被委托给<code>messageSource</code>Bean。如果未找到任何<code>messageSource</code>Bean，<code>ApplicationContext</code>将尝试在父级容器中查找<code>messageSource</code>Bean。如果找到，它将该bean用作<code>MessageSource</code>。如果<code>ApplicationContext</code>找不到任何消息源，则会实例化一个空的<code>DelegatingMessageSource</code>，以便能够接受对上面定义的方法的调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  MessageSource resources = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"beans.xml"</span>);</span><br><span class="line">  String message = resources.getMessage(<span class="string">"message"</span>, <span class="keyword">null</span>, <span class="string">"Default"</span>, <span class="keyword">null</span>);</span><br><span class="line">  System.out.println(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ReloadableResourceBundleMessageSource"><a href="#ReloadableResourceBundleMessageSource" class="headerlink" title="ReloadableResourceBundleMessageSource"></a>ReloadableResourceBundleMessageSource</h4><h2 id="其他资源"><a href="#其他资源" class="headerlink" title="其他资源"></a>其他资源</h2><h3 id="Resource接口"><a href="#Resource接口" class="headerlink" title="Resource接口"></a>Resource接口</h3><h1 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h1><h1 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h1><h1 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h1><h1 id="SpEL"><a href="#SpEL" class="headerlink" title="SpEL"></a>SpEL</h1><p>Spring 3引入了Spring表达式语言（Spring Expression Language，SpEL），它能够以一种强大和简洁的方式将值装配到Bean属性和构造器参数中。另外，SpEL还可用在依赖注入以外的地方。例如，Spring MVC中使用的Thymeleaf模板可以使用SpEL引用模型数据。</p>
<p>SpEL将在运行时计算它的值。</p>
<p>SpEL要放在<code>#{…}</code>中，而属性占位符是放在<code>${…}</code>中。</p>
<p>在Bean装配中，SpEL的使用方式与属性占位符基本相似。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlankDisc</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BlankDisc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  	@Value(<span class="string">"#&#123;systemProperties['disc.title']&#125;"</span>)</span> String title,</span></span><br><span class="line"><span class="function">    @<span class="title">Value</span><span class="params">(<span class="string">"#&#123;systemProperties['disc.artist']&#125;"</span>)</span> String artist) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.title = title;</span><br><span class="line">    <span class="keyword">this</span>.artist = artist;</span><br><span class="line">  &#125;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="表示字面量"><a href="#表示字面量" class="headerlink" title="表示字面量"></a>表示字面量</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#&#123;3.14&#125;</span><br><span class="line">#&#123;9.87E4&#125;</span><br><span class="line">#&#123;'Hello'&#125;</span><br><span class="line">#&#123;false&#125;</span><br></pre></td></tr></table></figure>

<h2 id="引用Bean"><a href="#引用Bean" class="headerlink" title="引用Bean"></a>引用Bean</h2><p>通过Bean ID引用其他Bean及它的成员：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#&#123;sgtPeppers.artist&#125;</span><br><span class="line">#&#123;artistSelector.selectArtist()&#125;</span><br><span class="line">#&#123;artistSelector.selectArtist()?.toUpperCase()&#125;</span><br></pre></td></tr></table></figure>

<p><code>?.</code>运算符确保只有在<code>selectArtist()</code>的返回值不是<code>null</code>时，SpEL才会调用<code>toUpperCase</code>方法。</p>
<h2 id="引用系统属性"><a href="#引用系统属性" class="headerlink" title="引用系统属性"></a>引用系统属性</h2><p>可以通过<code>systemProperties</code>对象引用系统属性：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;systemProperties['disc.title']&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用类型"><a href="#使用类型" class="headerlink" title="使用类型"></a>使用类型</h2><p>如果要在SpEL中访问类的静态方法和常量，可以使用<code>T()</code>运算符，它接收一个类为参数，返回一个<code>Class</code>对象。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(java.lang.Math).random()&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpEL运算符"><a href="#SpEL运算符" class="headerlink" title="SpEL运算符"></a>SpEL运算符</h2><table>
<thead>
<tr>
<th>运算符类型</th>
<th>运算符</th>
</tr>
</thead>
<tbody><tr>
<td>算术运算</td>
<td>+（加）、+（字符串连接）、-、*、/、%、^（乘方）</td>
</tr>
<tr>
<td>比较运算</td>
<td>&lt;、&gt;、==、&lt;=、&gt;=、lt、gt、eq、le、ge</td>
</tr>
<tr>
<td>逻辑运算</td>
<td>and、or、not、|</td>
</tr>
<tr>
<td>条件运算</td>
<td>?:（ternary）、?:（Elvis）</td>
</tr>
<tr>
<td>正则表达式</td>
<td>matches</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#&#123;2 * T(java.lang.Math).PI * circle.radius&#125;</span><br><span class="line">#&#123;disc.title + ' by ' + disc.artist&#125;</span><br><span class="line">#&#123;counter.total eq 100&#125;</span><br><span class="line">#&#123;scoreboard.score &gt; 1000 ? "Winner!" : "Loser"&#125;</span><br></pre></td></tr></table></figure>

<p>Elvis运算符的左操作数如果为<code>null</code>，则表达式的值为右操作数的值。否则，表达式的值就是左操作数的值：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;disc.title ?: 'Rattle and Hum'&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用正则表达式"><a href="#使用正则表达式" class="headerlink" title="使用正则表达式"></a>使用正则表达式</h2><p>SpEL通过<code>matches</code>运算符支持表达式中的模式匹配。如果与正则表达式相匹配，则返回<code>true</code>，否则返回<code>false</code>。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;admin.email matches '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.com'&#125;</span><br></pre></td></tr></table></figure>

<h2 id="计算集合和数组"><a href="#计算集合和数组" class="headerlink" title="计算集合和数组"></a>计算集合和数组</h2><h3 id="访问集合或数组元素"><a href="#访问集合或数组元素" class="headerlink" title="访问集合或数组元素"></a>访问集合或数组元素</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#&#123;jukebox.songs[T(java.lang.Math).random() * jukebox.songs.size()].title&#125;</span><br><span class="line">#&#123;'This is a test'[3]&#125;</span><br></pre></td></tr></table></figure>

<h3 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h3><h4 id=""><a href="#" class="headerlink" title=".?[]"></a><code>.?[]</code></h4><p>获取<code>jukebox</code>中<code>artist</code>属性为<code>&#39;Aerosmith&#39;</code>的所有歌曲：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;jukebox.songs.?[artist eq 'Aerosmith']&#125;</span><br></pre></td></tr></table></figure>

<h4 id="和"><a href="#和" class="headerlink" title=".^[]和.$[]"></a><code>.^[]</code>和<code>.$[]</code></h4><p><code>.^[]</code>和<code>.$[]</code>分别用来在集合中查询第一个匹配项和最后一个匹配项。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;jukebox.songs.^[artist eq 'Aerosmith']&#125;</span><br></pre></td></tr></table></figure>

<h4 id="-1"><a href="#-1" class="headerlink" title=".![]"></a><code>.![]</code></h4><p>投影运算符<code>.![]</code>会从集合的每个元素中选择特定属性放到另一个集合中。</p>
<p>例如：获取Aerosmith的所有歌曲名称的集合，而不是歌曲对象的集合：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;jukebox.songs.?[artist eq 'Aerosmith'].![title]&#125;</span><br></pre></td></tr></table></figure>

<h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><p>DI能够让相互协作的软件组件保持松散耦合，而面向切面编程（aspect-oriented programming，AOP）允许你把遍布应用各处的功能分离出来形成<strong>可重用</strong>的组件。</p>
<blockquote>
<p>虽然Spring的一个关键组件是AOP框架，但是Spring IoC容器不依赖于AOP（意味着如果您不想使用AOP，则不需要使用AOP），AOP补充了Spring IoC，以提供非常强大的中间件解决方案。</p>
</blockquote>
<p><strong>切面</strong>（Aspect）实现了跨越多种类型和对象的关注点（例如事务管理）的模块化。</p>
<p>可以把切面想象为覆盖在很多组件之上的一个外壳。应用是由那些实现各自业务功能的模块组成的。借助AOP，可以使用各种功能层去包裹核心业务层。这些层以声明的方式灵活地应用到系统中，你的核心应用甚至根本不知道它们的存在。</p>
<p><img src="SpringCore/AOP.png" alt="AOP"></p>
<h2 id="AOP术语"><a href="#AOP术语" class="headerlink" title="AOP术语"></a>AOP术语</h2><h3 id="通知（Advice）"><a href="#通知（Advice）" class="headerlink" title="通知（Advice）"></a>通知（Advice）</h3><p>在AOP术语中，切面在特定时候要完成的工作被称为<strong>通知</strong>。</p>
<p>Spring切面可以有5种类型的通知：</p>
<ul>
<li>前置通知（Before）：在接入点（即调用目标方法）之前执行通知功能。</li>
<li>后置通知（After）：在接入点之后，无论接入点是正常返回或异常退出，都要执行的通知。</li>
<li>返回通知（After-returning）：在接入点成功执行之后调用通知。</li>
<li>异常通知（After-throwing）：在接入点抛出异常后调用通知。</li>
<li>环绕通知（Around）：环绕接入点的通知，可以在接入点之前和之后执行自定义的行为。它还负责选择是继续执行接入点，还是通过返回自己的返回值或抛出异常来绕过接入点。</li>
</ul>
<h3 id="接入点（Join-Point）"><a href="#接入点（Join-Point）" class="headerlink" title="接入点（Join Point）"></a>接入点（Join Point）</h3><p>接入点是在应用执行过程中能够插入切面的时机点。这个点可以是调用方法时、抛出异常时，甚至修改一个字段时。切面代码可以利用这些点插入到应用的正常流程之中，并添加新的行为。</p>
<h3 id="切点（Pointcut）"><a href="#切点（Pointcut）" class="headerlink" title="切点（Pointcut）"></a>切点（Pointcut）</h3><p>切点用于定义通知被织入的具体位置（即一个或多个接入点）。</p>
<h3 id="切面（Aspect）"><a href="#切面（Aspect）" class="headerlink" title="切面（Aspect）"></a>切面（Aspect）</h3><p>切面是通知和切点的结合。通知和切点共同定义了切面的全部内容——它是什么，在何时（通知）和何处（切点）完成其功能。</p>
<h3 id="引入（Introduction）"><a href="#引入（Introduction）" class="headerlink" title="引入（Introduction）"></a>引入（Introduction）</h3><p>引入允许我们动态地向现有类添加新方法或属性。</p>
<h3 id="目标对象（Target-Object）"><a href="#目标对象（Target-Object）" class="headerlink" title="目标对象（Target Object）"></a>目标对象（Target Object）</h3><p>目标对象是被一个或多个切面通知的对象。</p>
<blockquote>
<p>在Spring AOP中，切面本身不能成为其他切面通知的目标。类上的<code>@Aspect</code>标注将其标记为切面，从而也将其从自动代理中排除。</p>
</blockquote>
<h3 id="AOP代理（AOP-Proxy）"><a href="#AOP代理（AOP-Proxy）" class="headerlink" title="AOP代理（AOP Proxy）"></a>AOP代理（AOP Proxy）</h3><p>AOP代理是由AOP框架创建的对象，用于实现切面契约（通知方法执行等）。在Spring Framework中，AOP代理是JDK动态代理或CGLIB代理。</p>
<p>在默认情况下，如果目标对象有实现接口，则Spring AOP代理使用标准JDK动态代理。否则，目标对象没有实现接口，则使用CGLIB代理。</p>
<h3 id="织入（Weaving）"><a href="#织入（Weaving）" class="headerlink" title="织入（Weaving）"></a>织入（Weaving）</h3><p>织入是把切面应用到目标对象的指定接入点上，并创建新的代理对象的过程。</p>
<p>根据不同的实现技术，AOP有三种织入方式：</p>
<ul>
<li>编译期织入：切面在目标类编译时被织入。这种方式需要特殊的编译器，AspectJ的织入编译器就是以这种方式织入切面的。</li>
<li>类加载期织入：切面在目标类加载到JVM时被织入。这种方式需要特殊的类加载器（ClassLoader），它可以在目标类被引入应用之前增强该目标类的字节码。AspectJ 5的加载时织入（load-time weaving，LTW）就支持以这种方式织入切面。</li>
<li>运行期织入：切面在应用运行的某个时刻被织入。一般情况下，在织入切面时，AOP容器会为目标对象动态地创建一个代理对象。代理对象封装目标Bean，并拦截目标Bean方法的调用。在将调用转发给真正的目标Bean方法之前，会执行切面逻辑。Spring AOP就是以这种方式织入切面的。这种方式比较适合在Servlet容器或应用服务器上使用。<br><img src="SpringCore/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86.png" alt="动态代理"></li>
</ul>
<h2 id="Spring对AOP的支持"><a href="#Spring对AOP的支持" class="headerlink" title="Spring对AOP的支持"></a>Spring对AOP的支持</h2><p>Spring提供了4种类型的AOP支持：</p>
<ul>
<li>基于代理的经典Spring AOP（不推荐）；</li>
<li>纯POJO切面；（使用XML配置，借助<code>aop</code>命名空间）</li>
<li>@AspectJ 风格声明的切面。；（使用标注配置。注：@AspectJ并不是一个标注，它只是一个风格的名称）</li>
<li>注入式AspectJ切面。（基于AspectJ）</li>
</ul>
<p>前三种类型本质上都是Spring基于代理的AOP，它们只支持方法级别的接入点。第三种类型中，@AspectJ 风格（即使用AspectJ的标注将常规Java类声明为切面）虽然来自AspectJ框架，但Spring只是借用它的标注和相应的解析库，而Spring AOP运行时仍然是基于动态代理的，没有对AspectJ的编译器和织入器的依赖。</p>
<p>而第四种类型实际上是Spring对AspectJ框架的集成，它除了支持方法接入点外，还支持字段和构造器接入点。</p>
<p>我们通常讲的Spring AOP是指前三种类型AOP支持。</p>
<h2 id="创建目标"><a href="#创建目标" class="headerlink" title="创建目标"></a>创建目标</h2><p>目标就是一些普通的Java接口或类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> concert;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Performance</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">perform</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用标注创建切面"><a href="#使用标注创建切面" class="headerlink" title="使用标注创建切面"></a>使用标注创建切面</h2><h3 id="启用-AspectJ支持"><a href="#启用-AspectJ支持" class="headerlink" title="启用@AspectJ支持"></a>启用@AspectJ支持</h3><p>首先，要确保AspectJ的 <code>aspectjweaver.jar</code>库在项目的类路径上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="声明切面"><a href="#声明切面" class="headerlink" title="声明切面"></a>声明切面</h3><p>首先，使用<code>@Aspect</code>标注将一个类声明为切面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> concert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Audience</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>切面类可以包含方法和字段，与任何其他类相同。它们还可以包含切点、通知和引入声明。</p>
<p>然后，将该切面注册为Bean。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Audience <span class="title">audience</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Audience();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果使用自动装配，则：</p>
<p>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>切面Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Audience</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="声明通知"><a href="#声明通知" class="headerlink" title="声明通知"></a>声明通知</h3><p>通知方法声明在切面类中，Spring使用AspectJ标注来声明通知方法：</p>
<table>
<thead>
<tr>
<th>标注</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@After</td>
<td>后置通知</td>
</tr>
<tr>
<td>@AfterReturning</td>
<td>返回通知</td>
</tr>
<tr>
<td>@AfterThrowing</td>
<td>异常通知</td>
</tr>
<tr>
<td>@Around</td>
<td>环绕通知</td>
</tr>
<tr>
<td>@Before</td>
<td>前置通知</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> concert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterReturning;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterThrowing;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Audience</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Before</span>(<span class="string">"execution(** concert.Performance.perform(..))"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">silenceCellPhones</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Silencing cell phones"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Before</span>(<span class="string">"execution(** concert.Performance.perform(..))"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeSeats</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	System.out.println(<span class="string">"Taking seats"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@AfterReturning</span>(<span class="string">"execution(** concert.Performance.perform(..))"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@AfterThrowing</span>(<span class="string">"execution(** concert.Performance.perform(..))"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demandRefund</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	System.out.println(<span class="string">"Demanding a refund"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在返回通知中访问返回值"><a href="#在返回通知中访问返回值" class="headerlink" title="在返回通知中访问返回值"></a>在返回通知中访问返回值</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterReturning;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterReturningExample</span> </span>&#123;</span><br><span class="line">  <span class="meta">@AfterReturning</span>(</span><br><span class="line">    pointcut=<span class="string">"com.xyz.myapp.SystemArchitecture.dataAccessOperation()"</span>,</span><br><span class="line">    returning=<span class="string">"retVal"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">(Object retVal)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>returning</code>属性中使用的名称必须与通知方法中的参数名称相对应。当接入点方法返回时，返回值作为相应的参数值传递给通知方法。<code>returning</code>子句还将仅限于匹配那些返回指定类型值的方法调用（在本例中为<code>Object</code>，它匹配任何返回值）。</p>
<h4 id="在异常通知中访问抛出的异常"><a href="#在异常通知中访问抛出的异常" class="headerlink" title="在异常通知中访问抛出的异常"></a>在异常通知中访问抛出的异常</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterThrowingExample</span> </span>&#123;</span><br><span class="line">  <span class="meta">@AfterThrowing</span>(</span><br><span class="line">    pointcut=<span class="string">"com.xyz.myapp.SystemArchitecture.dataAccessOperation()"</span>,</span><br><span class="line">    throwing=<span class="string">"ex"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRecoveryActions</span><span class="params">(DataAccessException ex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>throwing</code>属性中使用的名称必须与通知方法中的参数名称相对应。当通过抛出异常退出接入点时，异常将作为相应的参数值传递给通知方法。 <code>throwing</code>子句还将仅限于匹配那些抛出指定类型异常的方法调用（在本例中为<code>DataAccessException</code>）。</p>
<h4 id="创建环绕通知"><a href="#创建环绕通知" class="headerlink" title="创建环绕通知"></a>创建环绕通知</h4><p>环绕通知使用<code>@Around</code>标注声明。环绕通知方法的第一个参数必须是<code>ProceedingJoinPoint</code>类型。</p>
<p>在通知方法体内，调用<code>ProceedingJoinPoint</code>的<code>proceed</code>方法会导致执行接入点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> concert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Audience</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Pointcut</span>(<span class="string">"execution(** concert.Performance.perform(..))"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performance</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Around</span>(<span class="string">"performance()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">watchPerformance</span><span class="params">(ProceedingJoinPoint jp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">"Silencing cell phones"</span>);</span><br><span class="line">      System.out.println(<span class="string">"Taking seats"</span>);</span><br><span class="line">      jp.proceed();</span><br><span class="line">    	System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    	System.out.println(<span class="string">"Demanding a refund"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>proceed</code>方法可以不带参数，也可以传入<code>Object []</code>参数。数组中的值将传递给接入点方法的参数。另外，<code>proceed</code>方法的返回值就是接入点方法的返回值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around</span>(<span class="string">"execution(List&lt;Account&gt; find*(..)) &amp;&amp; "</span> +</span><br><span class="line">        <span class="string">"com.xyz.myapp.SystemArchitecture.inDataAccessLayer() &amp;&amp; "</span> +</span><br><span class="line">        <span class="string">"args(accountHolderNamePattern)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">preProcessQueryPattern</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ProceedingJoinPoint pjp,</span></span></span><br><span class="line"><span class="function"><span class="params">    String accountHolderNamePattern)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  String newPattern = preProcess(accountHolderNamePattern);</span><br><span class="line">  <span class="keyword">return</span> pjp.proceed(<span class="keyword">new</span> Object[] &#123;newPattern&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通知执行顺序"><a href="#通知执行顺序" class="headerlink" title="通知执行顺序"></a>通知执行顺序</h4><p>当多个通知都想在同一个接入点执行时，优先级高的前置通知先执行，优先级高的后置通知、返回通知和异常通知后执行。</p>
<p>不同切面的通知的优先级由切面优先级决定，切面可以通过实现<code>org.springframework.core.Ordered</code> 接口或使用<code>@Order</code>标注标记来定义优先级。<code>Ordered.getValue()</code> 返回的值或标注的值越小，优先级越高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentOperationExecutor</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_RETRIES = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> maxRetries = DEFAULT_MAX_RETRIES;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> order = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxRetries</span><span class="params">(<span class="keyword">int</span> maxRetries)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.maxRetries = maxRetries;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.order;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(<span class="keyword">int</span> order)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.order = order;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Around</span>(<span class="string">"com.xyz.myapp.SystemArchitecture.businessService()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">doConcurrentOperation</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> numAttempts = <span class="number">0</span>;</span><br><span class="line">    PessimisticLockingFailureException lockFailureException;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      numAttempts++;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span>(PessimisticLockingFailureException ex) &#123;</span><br><span class="line">        lockFailureException = ex;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(numAttempts &lt;= <span class="keyword">this</span>.maxRetries);</span><br><span class="line">    <span class="keyword">throw</span> lockFailureException;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"concurrentOperationExecutor"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"com.xyz.myapp.service.impl.ConcurrentOperationExecutor"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxRetries"</span> <span class="attr">value</span>=<span class="string">"3"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在Spring AOP中同一切面中的通知无法确定优先级，因此，它们同时应用到同一接入点的执行顺序是不确定的。</p>
<h3 id="声明切点"><a href="#声明切点" class="headerlink" title="声明切点"></a>声明切点</h3><p>有两种方法声明切点：</p>
<ul>
<li>在声明通知时，将切点表达式作为AspectJ通知标注的参数即可（参见前面<code>Audience</code>切面的声明）。</li>
<li>声明命名切点。</li>
</ul>
<h4 id="命名切点"><a href="#命名切点" class="headerlink" title="命名切点"></a>命名切点</h4><p>但如果相同的切点表达式要在多个地方重用，则使用单独声明的命名切点会比较方便。</p>
<p>命名切点由两部分组成：由<code>@Pointcut</code>标注的切点表达式和切点签名（即返回类型为<code>void</code>的方法）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> concert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterReturning;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.AfterThrowing;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Audience</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Pointcut</span>(<span class="string">"execution(** concert.Performance.perform(..))"</span>)  <span class="comment">// the pointcut expression</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performance</span><span class="params">()</span> </span>&#123;&#125;  <span class="comment">// the pointcut signature</span></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Before</span>(<span class="string">"performance()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">silenceCellPhones</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	System.out.println(<span class="string">"Silencing cell phones"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Before</span>(<span class="string">"performance()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeSeats</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	System.out.println(<span class="string">"Taking seats"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@AfterReturning</span>(<span class="string">"performance()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@AfterThrowing</span>(<span class="string">"performance()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demandRefund</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	System.out.println(<span class="string">"Demanding a refund"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>命名切点的声明与引用它的通知可以分属在不同的类中：</p>
<p>声明切点的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.someapp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemArchitecture</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A join point is in the web layer if the method is defined</span></span><br><span class="line"><span class="comment">     * in a type in the com.xyz.someapp.web package or any sub-package</span></span><br><span class="line"><span class="comment">     * under that.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"within(com.xyz.someapp.web..*)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inWebLayer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A join point is in the service layer if the method is defined</span></span><br><span class="line"><span class="comment">     * in a type in the com.xyz.someapp.service package or any sub-package</span></span><br><span class="line"><span class="comment">     * under that.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"within(com.xyz.someapp.service..*)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inServiceLayer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A join point is in the data access layer if the method is defined</span></span><br><span class="line"><span class="comment">     * in a type in the com.xyz.someapp.dao package or any sub-package</span></span><br><span class="line"><span class="comment">     * under that.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"within(com.xyz.someapp.dao..*)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inDataAccessLayer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A business service is the execution of any method defined on a service</span></span><br><span class="line"><span class="comment">     * interface. This definition assumes that interfaces are placed in the</span></span><br><span class="line"><span class="comment">     * "service" package, and that implementation types are in sub-packages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If you group service interfaces by functional area (for example,</span></span><br><span class="line"><span class="comment">     * in packages com.xyz.someapp.abc.service and com.xyz.someapp.def.service) then</span></span><br><span class="line"><span class="comment">     * the pointcut expression "execution(* com.xyz.someapp..service.*.*(..))"</span></span><br><span class="line"><span class="comment">     * could be used instead.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Alternatively, you can write the expression using the 'bean'</span></span><br><span class="line"><span class="comment">     * PCD, like so "bean(*Service)". (This assumes that you have</span></span><br><span class="line"><span class="comment">     * named your Spring service beans in a consistent fashion.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(* com.xyz.someapp..service.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">businessService</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A data access operation is the execution of any method defined on a</span></span><br><span class="line"><span class="comment">     * dao interface. This definition assumes that interfaces are placed in the</span></span><br><span class="line"><span class="comment">     * "dao" package, and that implementation types are in sub-packages.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(* com.xyz.someapp.dao.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dataAccessOperation</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引用切点的通知：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AroundExample</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"com.xyz.myapp.SystemArchitecture.businessService()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doBasicProfiling</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// start stopwatch</span></span><br><span class="line">        Object retVal = pjp.proceed();</span><br><span class="line">        <span class="comment">// stop stopwatch</span></span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>命名切点的可见性取决于切点签名的可见性。</p>
<h3 id="通知参数"><a href="#通知参数" class="headerlink" title="通知参数"></a>通知参数</h3><p>通过返回通知可获取接入点方法的返回值，通过异常通知可获取接入点方法抛出的异常。通过<code>args()</code>指示符的绑定形式（即接受参数名而不是参数类型），则可以将接入点方法的参数传递给通知方法。</p>
<blockquote>
<p>其实，通过通知方法的<code>JoinPoint</code>类型参数，也可以获取接入点方法参数。</p>
</blockquote>
<p>例如：获取接入点方法的第一个参数，且该参数是<code>Account</code>类型，并将它传递给通知方法的<code>account</code>参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(<span class="string">"com.xyz.myapp.SystemArchitecture.dataAccessOperation() &amp;&amp; args(account,..)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"com.xyz.myapp.SystemArchitecture.dataAccessOperation() &amp;&amp; args(account,..)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">accountDataAccessOperation</span><span class="params">(Account account)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span>(<span class="string">"accountDataAccessOperation(account)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="处理泛型参数"><a href="#处理泛型参数" class="headerlink" title="处理泛型参数"></a>处理泛型参数</h4><p>Spring AOP还可以处理泛型参数：</p>
<p>目标接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Sample</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">sampleGenericMethod</span><span class="params">(T param)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">sampleGenericCollectionMethod</span><span class="params">(Collection&lt;T&gt; param)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将要拦截的接入点方法的泛型参数限制为<code>MyType</code>，并将<code>param</code>参数传递给通知方法的对应参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(<span class="string">"execution(* ..Sample+.sampleGenericMethod(*)) &amp;&amp; args(param)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeSampleMethod</span><span class="params">(MyType param)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Advice implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此方法不适用于泛型集合。因此，您无法按如下方式定义切入点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(<span class="string">"execution(* ..Sample+.sampleGenericCollectionMethod(*)) &amp;&amp; args(param)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeSampleMethod</span><span class="params">(Collection&lt;MyType&gt; param)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Advice implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只能将通知方法参数设置成<code>Collection&lt;?&gt; param</code>，并手动检查元素的类型。</p>
<h4 id="确定参数名"><a href="#确定参数名" class="headerlink" title="确定参数名"></a>确定参数名</h4><p>由于通过Java反射机制是无法获取方法的参数名的，为此，Spring AOP使用如下策略来确定切点表达式中参数名与通知方法参数名的对应：</p>
<ol>
<li><p>如果用户已显式指定参数名称，则使用指定的参数名称。通知和切点标注都有一个可选的<code>argNames</code>属性，您可以使用该属性显式指定方法的参数名称，这些参数名称在运行时可用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(value=<span class="string">"com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)"</span>,</span><br><span class="line">        argNames=<span class="string">"bean,auditable"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">audit</span><span class="params">(JoinPoint jp, Object bean, Auditable auditable)</span> </span>&#123;</span><br><span class="line">    AuditCode code = auditable.value();</span><br><span class="line">    <span class="comment">// ... use code, bean, and jp</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：如果通知方法的第一个参数是<code>JoinPoint</code>、<code>ProceedingJoinPoint</code>或<code>JoinPoint.StaticPart</code>类型，<code>argNames</code>属性将不包含该参数名。</p>
</li>
<li><p>如果没有指定<code>argNames</code>属性，Spring AOP会查看该类的调试信息，并尝试从局部变量表中确定参数名称。</p>
<blockquote>
<p>如果@Aspect切面被AspectJ编译器编译过，则不需要设置<code>argNames</code>属性。因为，AspectJ编译器会保留必要的信息。</p>
</blockquote>
</li>
<li><p>如果代码编译时没有保留调试信息，则Spring AOP会尝试推断绑定变量与参数的配对（例如，如果只有一个变量绑定在切入点表达式中，并且通知方法只接受一个参数，那么配对很明显）。如果给定可用信息仍不足以确定变量的绑定，则抛出<code>AmbiguousBindingException</code>。</p>
</li>
<li><p>如果上述所有策略都失败，则抛出<code>IllegalArgumentException</code>。</p>
</li>
</ol>
<h3 id="访问当前接入点"><a href="#访问当前接入点" class="headerlink" title="访问当前接入点"></a>访问当前接入点</h3><p>在环绕通知中，通知方法第一个参数必须声明为<code>ProceedingJoinPoint</code>类型。其实任何通知，都可以将它的第一个参数声明为<code>org.aspectj.lang.JoinPoint</code>类型，它是<code>ProceedingJoinPoint</code>父类，提供了许多方法来访问当前接入点信息，包括接入点方法参数。</p>
<ul>
<li><code>getArgs()</code>：返回接入点方法的参数。</li>
<li><code>getThis()</code>：返回代理对象。</li>
<li><code>getTarget()</code>：返回目标对象。</li>
<li><code>getSignature()</code>：返回接入点的方法签名。</li>
</ul>
<h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>在Spring中，切面只是与它所包装的目标Bean实现了相同接口的代理。如果除了实现目标Bean的接口外，代理还暴露了新接口，这就是AOP中的引入。引入相当于为目标Bean动态添加了新的接口。</p>
<p>引入有点类似其他语言中的扩展类。</p>
<p><img src="SpringCore/%E5%BC%95%E5%85%A5.png" alt="引入"></p>
<p>当代理中目标Bean接口的方法被调用时，代理将调用委托给目标Bean实例；而当代理中新暴露接口的方法被调用时，它将调用委托给实现了这个新接口的某个其他对象。实际上，代理对象的实现被拆分到多个类中。</p>
<p>假设，希望为所有实现了<code>Performance</code>的类型动态实现<code>Encoreable</code>接口。</p>
<p>Encoreable接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> concert;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Encoreable</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">performEncore</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>声明引入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> concert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.DeclareParents;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncoreableIntroducer</span> </span>&#123;</span><br><span class="line">  <span class="meta">@DeclareParents</span>(value=<span class="string">"concert.Performance+"</span>, defaultImpl=DefaultEncoreable<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">static</span> <span class="title">Encoreable</span> <span class="title">encoreable</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@DeclareParents</code>标注由三部分组成：</p>
<ul>
<li><code>value</code>属性指定了哪种类型的Bean要引入（动态实现）新接口。</li>
<li><code>defaultImpl</code>属性指定了引入的新接口的实现类。</li>
<li><code>@DeclareParents</code>标记的静态属性指明了要引入的新接口。这里是<code>Encoreable</code>接口。</li>
</ul>
<p>最后，与其他切面一样，也要将该引入注册为Bean：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"concert.EncoreableIntroducer"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样，所有实现了<code>Performance</code>的类型也动态实现<code>Encoreable</code>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Encoreable encoreable = (Encoreable) context.getBean(<span class="string">"myPerformance"</span>);</span><br></pre></td></tr></table></figure>



<h2 id="在XML中声明切面"><a href="#在XML中声明切面" class="headerlink" title="在XML中声明切面"></a>在XML中声明切面</h2><h3 id="启用-AspectJ支持-1"><a href="#启用-AspectJ支持-1" class="headerlink" title="启用@AspectJ支持"></a>启用@AspectJ支持</h3><p>首先，要确保AspectJ的 <code>aspectjweaver.jar</code>库在项目的类路径上。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">	     <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="声明切面-1"><a href="#声明切面-1" class="headerlink" title="声明切面"></a>声明切面</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">"audienceAspect"</span> <span class="attr">ref</span>=<span class="string">"audience"</span>&gt;</span></span><br><span class="line">    …</span><br><span class="line">  <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"audience"</span> <span class="attr">class</span>=<span class="string">"concert.Audience"</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="声明通知-1"><a href="#声明通知-1" class="headerlink" title="声明通知"></a>声明通知</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"audience"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:before</span></span></span><br><span class="line"><span class="tag">      <span class="attr">pointcut</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">method</span>=<span class="string">"silenceCellPhones"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:before</span></span></span><br><span class="line"><span class="tag">      <span class="attr">pointcut</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">method</span>=<span class="string">"takeSeats"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:after-returning</span></span></span><br><span class="line"><span class="tag">      <span class="attr">pointcut</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">method</span>=<span class="string">"applause"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:after-throwing</span></span></span><br><span class="line"><span class="tag">      <span class="attr">pointcut</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">method</span>=<span class="string">"demandRefund"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此外，后置通知使用<code>&lt;aop:after&gt;</code>元素。</p>
<h4 id="在返回通知中访问返回值-1"><a href="#在返回通知中访问返回值-1" class="headerlink" title="在返回通知中访问返回值"></a>在返回通知中访问返回值</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">"afterReturningExample"</span> <span class="attr">ref</span>=<span class="string">"aBean"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:after-returning</span></span></span><br><span class="line"><span class="tag">    <span class="attr">pointcut-ref</span>=<span class="string">"dataAccessOperation"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">returning</span>=<span class="string">"retVal"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">method</span>=<span class="string">"doAccessCheck"</span>/&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>doAccessCheck</code>方法必须声明一个名为<code>retVal</code>的参数。此参数的类型以与<code>@AfterReturning</code>所述相同的方式约束匹配。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccessCheck</span><span class="params">(Object retVal)</span> </span>&#123;…&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在异常通知中访问抛出的异常-1"><a href="#在异常通知中访问抛出的异常-1" class="headerlink" title="在异常通知中访问抛出的异常"></a>在异常通知中访问抛出的异常</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">"afterThrowingExample"</span> <span class="attr">ref</span>=<span class="string">"aBean"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:after-throwing</span></span></span><br><span class="line"><span class="tag">    <span class="attr">pointcut-ref</span>=<span class="string">"dataAccessOperation"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">throwing</span>=<span class="string">"dataAccessEx"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">method</span>=<span class="string">"doRecoveryActions"</span>/&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>doRecoveryActions</code>方法必须声明一个名为<code>dataAccessEx</code>的参数。此参数的类型以与<code>@AfterThrowing</code>相同的方式约束匹配。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRecoveryActions</span><span class="params">(DataAccessException dataAccessEx)</span> </span>&#123;…&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建环绕通知-1"><a href="#创建环绕通知-1" class="headerlink" title="创建环绕通知"></a>创建环绕通知</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"audience"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span></span></span><br><span class="line"><span class="tag">      <span class="attr">id</span>=<span class="string">"performance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">expression</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:around</span></span></span><br><span class="line"><span class="tag">      <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">method</span>=<span class="string">"watchPerformance"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="声明切点-1"><a href="#声明切点-1" class="headerlink" title="声明切点"></a>声明切点</h3><h4 id="命名切点-1"><a href="#命名切点-1" class="headerlink" title="命名切点"></a>命名切点</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"audience"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span></span></span><br><span class="line"><span class="tag">      <span class="attr">id</span>=<span class="string">"performance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">expression</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:before</span></span></span><br><span class="line"><span class="tag">      <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">method</span>=<span class="string">"silenceCellPhones"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:before</span></span></span><br><span class="line"><span class="tag">      <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">method</span>=<span class="string">"takeSeats"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:after-returning</span></span></span><br><span class="line"><span class="tag">      <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">method</span>=<span class="string">"applause"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:after-throwing</span></span></span><br><span class="line"><span class="tag">      <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">method</span>=<span class="string">"demandRefund"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;aop:pointcut&gt;</code>放在<code>&lt;aop:aspect&gt;</code>元素内时，这个命名切点只能为所有切面的所有通知所共享。如果将<code>&lt;aop:pointcut&gt;</code>放在<code>&lt;aop:config&gt;</code>元素内时，则该命名切点可以为所有切面所共享。</p>
<h3 id="通知参数-1"><a href="#通知参数-1" class="headerlink" title="通知参数"></a>通知参数</h3><h4 id="确定参数名-1"><a href="#确定参数名-1" class="headerlink" title="确定参数名"></a>确定参数名</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:before</span></span></span><br><span class="line"><span class="tag">  <span class="attr">pointcut</span>=<span class="string">"com.xyz.lib.Pointcuts.anyPublicMethod() and @annotation(auditable)"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">method</span>=<span class="string">"audit"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">arg-names</span>=<span class="string">"auditable"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="引入-1"><a href="#引入-1" class="headerlink" title="引入"></a>引入</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"audience"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:declare-parents</span></span></span><br><span class="line"><span class="tag">      <span class="attr">types-matching</span>=<span class="string">"concert.Performance+"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">implement-interface</span>=<span class="string">"concert.Encoreable"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">default-impl</span>=<span class="string">"concert.DefaultEncoreable"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"audience"</span> <span class="attr">class</span>=<span class="string">"concert.Audience"</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>除了使用<code>default-impl</code>属性以完全限定名形式设定<code>Encoreable</code>接口的实现类外，还可以使用<code>delegate-ref</code>属性来引用实现类的Bean：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"audience"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:declare-parents</span></span></span><br><span class="line"><span class="tag">      <span class="attr">types-matching</span>=<span class="string">"concert.Performance+"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">implement-interface</span>=<span class="string">"concert.Encoreable"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">delegate-ref</span>=<span class="string">"encoreableDelegate"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"encoreableDelegate"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">class</span>=<span class="string">"concert.DefaultEncoreable"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"audience"</span> <span class="attr">class</span>=<span class="string">"concert.Audience"</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Advisor"><a href="#Advisor" class="headerlink" title="Advisor"></a>Advisor</h3><p>Advisor的概念来自Spring AOP，在AspectJ中没有直接的等价物。</p>
<p>Advisor可看成是只包含一个切点和一个通知的切面，并且通知表示为一个Bean，且要实现相应的<a href="https://docs.spring.io/spring/docs/5.1.1.RELEASE/spring-framework-reference/core.html#aop-api-advice-types" target="_blank" rel="noopener">通知接口</a>。</p>
<p>Advisor最常见的是与事务性通知一起使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"businessService"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">expression</span>=<span class="string">"execution(* com.xyz.myapp.service.*.*(..))"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:advisor</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pointcut-ref</span>=<span class="string">"businessService"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">advice-ref</span>=<span class="string">"tx-advice"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"tx-advice"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="AspectJ切面"><a href="#AspectJ切面" class="headerlink" title="AspectJ切面"></a>AspectJ切面</h2><p>当Spring AOP不能满足需求时，我们必须转向更为强大的AspectJ。</p>
<h3 id="声明AspectJ切面"><a href="#声明AspectJ切面" class="headerlink" title="声明AspectJ切面"></a>声明AspectJ切面</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package concert;</span><br><span class="line">public aspect CriticAspect &#123;</span><br><span class="line">  public CriticAspect() &#123;&#125;</span><br><span class="line">  pointcut performance(): execution(* perform(..));</span><br><span class="line">  afterReturning(): performance() &#123;</span><br><span class="line">    System.out.println(criticismEngine.getCriticism());</span><br><span class="line">  &#125;</span><br><span class="line">  private CriticismEngine criticismEngine;</span><br><span class="line">  public void setCriticismEngine(CriticismEngine criticismEngine) &#123;</span><br><span class="line">    this.criticismEngine &#x3D; criticismEngine;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注入AspectJ切面"><a href="#注入AspectJ切面" class="headerlink" title="注入AspectJ切面"></a>注入AspectJ切面</h3><p>使用AspectJ切面时，根本不需要Spring就可以织入到我们的应用中。但如果想使用Spring的依赖注入为AspectJ切面注入协作者，那就还需要在Spring配置中把AspectJ切面声明为一个Spring Bean。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.springinaction.springidol.CriticAspect"</span> <span class="attr">factory-method</span>=<span class="string">"aspectOf"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"criticismEngine"</span> <span class="attr">ref</span>=<span class="string">"criticismEngine"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意：AspectJ切面是由AspectJ在运行期创建的，而不是由Spring容器初始化的，因此要使用<code>factory-method</code>指定的工厂方法来获得切面的引用。</p>
<h2 id="切点表达式语言"><a href="#切点表达式语言" class="headerlink" title="切点表达式语言"></a>切点表达式语言</h2><p>在Spring AOP中，使用AspectJ的切点表达式语言来定义切点。</p>
<blockquote>
<p>Spring AOP仅支持AspectJ切点表达式语言的一个子集，要获得完整AspectJ切点表达式语言支持，请使用注入式AspectJ切面。</p>
</blockquote>
<h3 id="AspectJ切点指示符"><a href="#AspectJ切点指示符" class="headerlink" title="AspectJ切点指示符"></a>AspectJ切点指示符</h3><p>Spring AOP支持的AspectJ切点指示符有：</p>
<table>
<thead>
<tr>
<th>AspectJ指示符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>args()</td>
<td>限制接入点必须具有指定类型参数。</td>
</tr>
<tr>
<td>@args()</td>
<td>限制接入点的方法参数的类必须由指定的标注标记。</td>
</tr>
<tr>
<td>execution()</td>
<td>用于匹配接入点的执行方法。</td>
</tr>
<tr>
<td>this()</td>
<td>限制AOP代理对象本身必须是指定类的实例（包含了子类的实例）。</td>
</tr>
<tr>
<td>target()</td>
<td>限制目标对象必须是指定类的实例（包含了子类的实例）。</td>
</tr>
<tr>
<td>@target()</td>
<td>限制目标对象必须是由指定的标注标记的类的实例（包含了子类的实例）。</td>
</tr>
<tr>
<td>within()</td>
<td>限制接入点必须定义在指定的类中。</td>
</tr>
<tr>
<td>@within()</td>
<td>限制接入点必须定义在由指定的标注标记的类中。</td>
</tr>
<tr>
<td>@annotation()</td>
<td>限制接入点必须带有指定标注。</td>
</tr>
</tbody></table>
<blockquote>
<p>只有<code>execution()</code>指示符是实际执行匹配的，其他指示符都是用来限制匹配的。</p>
<p>AspectJ框架中，<code>this()</code>和<code>target()</code>都引用相同的对象——目标对象。 Spring AOP是一个基于代理的系统，它区分代理对象本身（绑定到<code>this()</code>）和代理后面的目标对象（绑定到<code>target()</code>）。</p>
<p>由于Spring的AOP框架基于代理的本质，根据定义，目标对象内的调用不会被截获。对于JDK代理，只能拦截代理上的公共接口方法调用。使用CGLIB，代理上的公共和受保护方法调用被截获（如果需要，甚至是包可见的方法）。但是，通过代理进行的常见交互应始终通过公共签名进行设计。</p>
</blockquote>
<h4 id="execution-指示符"><a href="#execution-指示符" class="headerlink" title="execution()指示符"></a><code>execution()</code>指示符</h4><p>一般形式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">execution(modifiers-pattern? ret-type-pattern </span><br><span class="line">          declaring-type-pattern?name-pattern(param-pattern)</span><br><span class="line">          throws-pattern?)</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<ul>
<li><code>execution(public * *(..))</code>：匹配任何公有方法的执行。</li>
<li><code>execution(* set*(..))</code>：匹配名称以set开头的任何方法的执行。</li>
<li><code>execution(* com.xyz.service.AccountService.*(..))</code>：匹配<code>com.xyz.service.AccountService</code> 接口定义的任何方法的执行。其中<code>com.xyz.service.AccountService.</code>部分就是<code>declaring-type-pattern</code>。</li>
<li><code>execution(* com.xyz.service.*.*(..))</code>：匹配<code>com.xyz.service</code>包中定义的任何方法的执行。</li>
<li><code>execution(* com.xyz.service..*.*(..))</code>：匹配<code>com.xyz.service</code>包及其任意层次子包中定义的任何方法的执行。</li>
<li><code>execution(* com.xyz..AccountService.*())</code>：匹配<code>com.xyz</code>包及其任意层次子包中的<code>AccountService</code>接口定义的任何无参方法的执行。</li>
<li><code>execution(* com.xyz.service.AccountService+.*(*))</code>：匹配<code>com.xyz.service.AccountService</code> 接口及其子类型定义的任何只有一个参数的方法的执行。</li>
<li><code>execution(public * *(*, String))</code>：匹配任何带两个参数的公有方法的执行，并且方法的第一个参数是任意类型，第二个参数是<code>String</code>类型。</li>
<li><code>execution(* (!com.xyz.service.AccountService+).*(..))</code>：匹配除了<code>com.xyz.service.AccountService</code> 接口及其子类型之外定义的任何方法的执行。</li>
<li><code>execution(public * *(java.util.Date))</code>：匹配任何带有一个<code>java.util.Date</code>参数的公有方法的执行。</li>
<li><code>execution(* *(..) throws IllegalArgumentException, ArrayIndexOutOfBoundsException)</code>：匹配任何抛出<code>IllegalArgumentException</code>或<code>ArrayIndexOutOfBoundsException</code>异常的方法的执行。</li>
<li><code>execution(* (com.xyz.service.AccountService+ &amp;&amp; java.io.Serializable+).*(..))</code>：匹配实现了<code>com.xyz.service.AccountService</code> 接口及其子类型，以及<code>java.io.Serializable</code>接口及其子类型的类型中定义的任何方法的执行。</li>
</ul>
<h4 id="within-指示符"><a href="#within-指示符" class="headerlink" title="within()指示符"></a><code>within()</code>指示符</h4><p>示例：</p>
<ul>
<li><code>within(com.xyz.service.*)</code>：在<code>com.xyz.service</code>包中的任何接入点。</li>
<li><code>within(com.xyz.service..*)</code>：在<code>com.xyz.service</code>包及其任意层次子包中的任何接入点。</li>
</ul>
<h4 id="within-指示符-1"><a href="#within-指示符-1" class="headerlink" title="@within()指示符"></a><code>@within()</code>指示符</h4><p>示例：</p>
<ul>
<li><code>@within(org.springframework.transaction.annotation.Transactional)</code>：目标对象的声明类型具有<code>@Transactional</code>标注的任何接入点。</li>
</ul>
<h4 id="this-指示符"><a href="#this-指示符" class="headerlink" title="this()指示符"></a><code>this()</code>指示符</h4><p>示例：</p>
<ul>
<li><code>this(com.xyz.service.AccountService)</code>：代理对象实现<code>AccountService</code>接口的任何接入点。</li>
</ul>
<p>绑定形式的<code>this()</code>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsageTracking</span> </span>&#123;</span><br><span class="line">    <span class="meta">@DeclareParents</span>(value=<span class="string">"com.xzy.myapp.service.*+"</span>, defaultImpl=DefaultUsageTracked<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">static</span> <span class="title">UsageTracked</span> <span class="title">mixin</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"com.xyz.myapp.SystemArchitecture.businessService() &amp;&amp; this(usageTracked)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordUsage</span><span class="params">(UsageTracked usageTracked)</span> </span>&#123;</span><br><span class="line">        usageTracked.incrementUseCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="target-指示符"><a href="#target-指示符" class="headerlink" title="target()指示符"></a><code>target()</code>指示符</h4><p>示例：</p>
<ul>
<li><code>target(com.xyz.service.AccountService)</code>：目标对象实现<code>AccountService</code>接口的任何接入点。</li>
</ul>
<h4 id="target-指示符-1"><a href="#target-指示符-1" class="headerlink" title="@target()指示符"></a><code>@target()</code>指示符</h4><p>示例：</p>
<ul>
<li><code>@target(org.springframework.transaction.annotation.Transactional)</code>：目标对象的任何接入点，且目标对象是具有<code>@Transactional</code>标注的类的实例。</li>
</ul>
<h4 id="args-指示符"><a href="#args-指示符" class="headerlink" title="args()指示符"></a><code>args()</code>指示符</h4><p>示例：</p>
<ul>
<li><code>args(java.io.Serializable)</code>：采用单个参数的任何接入点，以及在<strong>运行时</strong>传递的参数是<code>Serializable</code>。注：<code>execution(* *(java.io.Serializable))</code>是在执行时匹配，即匹配方法签名。</li>
</ul>
<h4 id="args-指示符-1"><a href="#args-指示符-1" class="headerlink" title="@args()指示符"></a><code>@args()</code>指示符</h4><p>示例：</p>
<ul>
<li><code>@args(com.xyz.security.Classified)</code>：采用单个参数的任何接入点，并且传递的参数的运行时类型具有<code>@Classified</code>标注</li>
</ul>
<h4 id="annotation-指示符"><a href="#annotation-指示符" class="headerlink" title="@annotation()指示符"></a><code>@annotation()</code>指示符</h4><p>示例：</p>
<ul>
<li><code>@annotation(org.springframework.transaction.annotation.Transactional)</code>：具有<code>@Transactional</code>标注的任何接入点。</li>
</ul>
<h4 id="bean-指示符"><a href="#bean-指示符" class="headerlink" title="bean()指示符"></a><code>bean()</code>指示符</h4><p>此外，Spring AOP还支持一个专有的切点指示符<code>bean()</code>。此切点指示符允许您将接入点的匹配限制为特定命名的一个或一组Spring Bean（使用通配符<code>*</code>）。切点指示符<code>bean()</code>具有以下形式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bean(idOrNameOfBean)</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<ul>
<li><code>bean(*Service)</code>：名称与通配符表达式<code>* Service</code>匹配的Spring Bean上的任何接入点。</li>
</ul>
<h4 id="指示符的绑定形式"><a href="#指示符的绑定形式" class="headerlink" title="指示符的绑定形式"></a>指示符的绑定形式</h4><p><code>args()</code>、<code>this()</code>、<code>target()</code>、<code>@target()</code>、<code>@within()</code>、<code>@annotation()</code>、<code>@args()</code>等指示符还可以使用绑定形式。（也参见“通知参数”）</p>
<p>通过绑定形式可以将匹配的对象传递给通知方法的相应参数。</p>
<p>例如：</p>
<p>接入点的标注：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Auditable &#123;</span><br><span class="line">  <span class="function">AuditCode <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通知：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(<span class="string">"com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; @annotation(auditable)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">audit</span><span class="params">(Auditable auditable)</span> </span>&#123;</span><br><span class="line">  AuditCode code = auditable.value();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="切点运算符"><a href="#切点运算符" class="headerlink" title="切点运算符"></a>切点运算符</h3><p>可以使用<code>&amp;&amp;</code>（或<code>and</code>）、<code>||</code>（或<code>or</code>）和<code>!</code>（或<code>not</code>）运算符来组合切入点表达式。</p>
<p>示例：</p>
<ul>
<li><code>execution(* concert.Performance.perform()) and !bean(&#39;woodstock&#39;)</code>：匹配Bean ID不为<code>woodstock</code>的<code>Performance</code> Bean的<code>perform()</code>方法执行。</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/5-1-2/" rel="tag"># 5.1.2</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/05/22/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%B9%B3%E5%8F%B0/" rel="prev" title="微信公众平台">
      <i class="fa fa-chevron-left"></i> 微信公众平台
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/06/01/SpringWeb/" rel="next" title="SpringWeb">
      SpringWeb <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring架构"><span class="nav-number">1.</span> <span class="nav-text">Spring架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IoC"><span class="nav-number">2.</span> <span class="nav-text">IoC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Bean的生命周期"><span class="nav-number">2.1.</span> <span class="nav-text">Bean的生命周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#装配Bean"><span class="nav-number">2.2.</span> <span class="nav-text">装配Bean</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#装配方式"><span class="nav-number">2.2.1.</span> <span class="nav-text">装配方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自动化装配"><span class="nav-number">2.2.2.</span> <span class="nav-text">自动化装配</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建可被发现的Bean"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">创建可被发现的Bean</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启用组件扫描"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">启用组件扫描</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自动装配"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">自动装配</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于Java的装配"><span class="nav-number">2.2.3.</span> <span class="nav-text">基于Java的装配</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#编写方法创建Bean"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">编写方法创建Bean</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编程装配"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">编程装配</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于XML的装配"><span class="nav-number">2.2.4.</span> <span class="nav-text">基于XML的装配</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置Bean"><span class="nav-number">2.2.4.1.</span> <span class="nav-text">配置Bean</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实例化Bean"><span class="nav-number">2.2.4.2.</span> <span class="nav-text">实例化Bean</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#通过默认构造器实例化Bean"><span class="nav-number">2.2.4.2.1.</span> <span class="nav-text">通过默认构造器实例化Bean</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过静态工厂方法实例化Bean"><span class="nav-number">2.2.4.2.2.</span> <span class="nav-text">通过静态工厂方法实例化Bean</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过实例工厂方法实例化Bean"><span class="nav-number">2.2.4.2.3.</span> <span class="nav-text">通过实例工厂方法实例化Bean</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#依赖注入"><span class="nav-number">2.2.4.3.</span> <span class="nav-text">依赖注入</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#构造器注入"><span class="nav-number">2.2.4.3.1.</span> <span class="nav-text">构造器注入</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#属性注入"><span class="nav-number">2.2.4.3.2.</span> <span class="nav-text">属性注入</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#装配集合"><span class="nav-number">2.2.4.4.</span> <span class="nav-text">装配集合</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#列表"><span class="nav-number">2.2.4.4.1.</span> <span class="nav-text">列表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#集合"><span class="nav-number">2.2.4.4.2.</span> <span class="nav-text">集合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#映射"><span class="nav-number">2.2.4.4.3.</span> <span class="nav-text">映射</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#java-util-Properties"><span class="nav-number">2.2.4.4.4.</span> <span class="nav-text">java.util.Properties</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用util-命名空间"><span class="nav-number">2.2.4.5.</span> <span class="nav-text">使用util-命名空间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#装配内嵌Bean"><span class="nav-number">2.2.4.6.</span> <span class="nav-text">装配内嵌Bean</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#装配复合属性"><span class="nav-number">2.2.4.7.</span> <span class="nav-text">装配复合属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#装配空值和空串"><span class="nav-number">2.2.4.8.</span> <span class="nav-text">装配空值和空串</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lt-idref-gt-元素"><span class="nav-number">2.2.4.9.</span> <span class="nav-text">&lt;idref&gt;元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用depends-on属性"><span class="nav-number">2.2.4.10.</span> <span class="nav-text">使用depends-on属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#延迟初始化Bean"><span class="nav-number">2.2.4.11.</span> <span class="nav-text">延迟初始化Bean</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置导入"><span class="nav-number">2.2.5.</span> <span class="nav-text">配置导入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bean的命名"><span class="nav-number">2.2.6.</span> <span class="nav-text">Bean的命名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Profile"><span class="nav-number">2.2.7.</span> <span class="nav-text">Spring Profile</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置Profile"><span class="nav-number">2.2.7.1.</span> <span class="nav-text">配置Profile</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在Java中配置Profile"><span class="nav-number">2.2.7.1.1.</span> <span class="nav-text">在Java中配置Profile</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在XML中配置Profile"><span class="nav-number">2.2.7.1.2.</span> <span class="nav-text">在XML中配置Profile</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#激活Profile"><span class="nav-number">2.2.7.2.</span> <span class="nav-text">激活Profile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取Profile的状态"><span class="nav-number">2.2.7.3.</span> <span class="nav-text">获取Profile的状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#条件化的Bean"><span class="nav-number">2.2.8.</span> <span class="nav-text">条件化的Bean</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理自动装配的歧义性"><span class="nav-number">2.2.9.</span> <span class="nav-text">处理自动装配的歧义性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#设置首选Bean"><span class="nav-number">2.2.9.1.</span> <span class="nav-text">设置首选Bean</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用限定符"><span class="nav-number">2.2.9.2.</span> <span class="nav-text">使用限定符</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#为Bean设置限定符"><span class="nav-number">2.2.9.2.1.</span> <span class="nav-text">为Bean设置限定符</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用限定符注入"><span class="nav-number">2.2.9.2.2.</span> <span class="nav-text">使用限定符注入</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#自定义限定符标注"><span class="nav-number">2.2.9.2.3.</span> <span class="nav-text">自定义限定符标注</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bean的作用域"><span class="nav-number">2.2.10.</span> <span class="nav-text">Bean的作用域</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作用域代理"><span class="nav-number">2.2.10.1.</span> <span class="nav-text">作用域代理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用上下文"><span class="nav-number">2.3.</span> <span class="nav-text">应用上下文</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#应用上下文实例化"><span class="nav-number">2.3.1.</span> <span class="nav-text">应用上下文实例化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用上下文事件"><span class="nav-number">2.3.2.</span> <span class="nav-text">应用上下文事件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#资源"><span class="nav-number">3.</span> <span class="nav-text">资源</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用外部属性文件"><span class="nav-number">3.1.</span> <span class="nav-text">使用外部属性文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#声明属性源"><span class="nav-number">3.1.1.</span> <span class="nav-text">声明属性源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取外部属性"><span class="nav-number">3.1.2.</span> <span class="nav-text">获取外部属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#直接通过Environment对象获取"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">直接通过Environment对象获取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用属性占位符获取外部属性"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">使用属性占位符获取外部属性</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#国际化"><span class="nav-number">3.2.</span> <span class="nav-text">国际化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK的国际化支持"><span class="nav-number">3.2.1.</span> <span class="nav-text">JDK的国际化支持</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#格式化类"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">格式化类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ResourceBundle"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">ResourceBundle</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring的国际化支持"><span class="nav-number">3.2.2.</span> <span class="nav-text">Spring的国际化支持</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ResourceBundleMessageSource"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">ResourceBundleMessageSource</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ReloadableResourceBundleMessageSource"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">ReloadableResourceBundleMessageSource</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他资源"><span class="nav-number">3.3.</span> <span class="nav-text">其他资源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Resource接口"><span class="nav-number">3.3.1.</span> <span class="nav-text">Resource接口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#校验"><span class="nav-number">4.</span> <span class="nav-text">校验</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据绑定"><span class="nav-number">5.</span> <span class="nav-text">数据绑定</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#类型转换"><span class="nav-number">6.</span> <span class="nav-text">类型转换</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SpEL"><span class="nav-number">7.</span> <span class="nav-text">SpEL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#表示字面量"><span class="nav-number">7.1.</span> <span class="nav-text">表示字面量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引用Bean"><span class="nav-number">7.2.</span> <span class="nav-text">引用Bean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引用系统属性"><span class="nav-number">7.3.</span> <span class="nav-text">引用系统属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用类型"><span class="nav-number">7.4.</span> <span class="nav-text">使用类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpEL运算符"><span class="nav-number">7.5.</span> <span class="nav-text">SpEL运算符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用正则表达式"><span class="nav-number">7.6.</span> <span class="nav-text">使用正则表达式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#计算集合和数组"><span class="nav-number">7.7.</span> <span class="nav-text">计算集合和数组</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#访问集合或数组元素"><span class="nav-number">7.7.1.</span> <span class="nav-text">访问集合或数组元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#过滤"><span class="nav-number">7.7.2.</span> <span class="nav-text">过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#null"><span class="nav-number">7.7.2.1.</span> <span class="nav-text">.?[]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#和"><span class="nav-number">7.7.2.2.</span> <span class="nav-text">.^[]和.$[]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#-1"><span class="nav-number">7.7.2.3.</span> <span class="nav-text">.![]</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AOP"><span class="nav-number">8.</span> <span class="nav-text">AOP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AOP术语"><span class="nav-number">8.1.</span> <span class="nav-text">AOP术语</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通知（Advice）"><span class="nav-number">8.1.1.</span> <span class="nav-text">通知（Advice）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#接入点（Join-Point）"><span class="nav-number">8.1.2.</span> <span class="nav-text">接入点（Join Point）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#切点（Pointcut）"><span class="nav-number">8.1.3.</span> <span class="nav-text">切点（Pointcut）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#切面（Aspect）"><span class="nav-number">8.1.4.</span> <span class="nav-text">切面（Aspect）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引入（Introduction）"><span class="nav-number">8.1.5.</span> <span class="nav-text">引入（Introduction）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#目标对象（Target-Object）"><span class="nav-number">8.1.6.</span> <span class="nav-text">目标对象（Target Object）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOP代理（AOP-Proxy）"><span class="nav-number">8.1.7.</span> <span class="nav-text">AOP代理（AOP Proxy）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#织入（Weaving）"><span class="nav-number">8.1.8.</span> <span class="nav-text">织入（Weaving）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring对AOP的支持"><span class="nav-number">8.2.</span> <span class="nav-text">Spring对AOP的支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建目标"><span class="nav-number">8.3.</span> <span class="nav-text">创建目标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用标注创建切面"><span class="nav-number">8.4.</span> <span class="nav-text">使用标注创建切面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启用-AspectJ支持"><span class="nav-number">8.4.1.</span> <span class="nav-text">启用@AspectJ支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明切面"><span class="nav-number">8.4.2.</span> <span class="nav-text">声明切面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明通知"><span class="nav-number">8.4.3.</span> <span class="nav-text">声明通知</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在返回通知中访问返回值"><span class="nav-number">8.4.3.1.</span> <span class="nav-text">在返回通知中访问返回值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在异常通知中访问抛出的异常"><span class="nav-number">8.4.3.2.</span> <span class="nav-text">在异常通知中访问抛出的异常</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建环绕通知"><span class="nav-number">8.4.3.3.</span> <span class="nav-text">创建环绕通知</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通知执行顺序"><span class="nav-number">8.4.3.4.</span> <span class="nav-text">通知执行顺序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明切点"><span class="nav-number">8.4.4.</span> <span class="nav-text">声明切点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#命名切点"><span class="nav-number">8.4.4.1.</span> <span class="nav-text">命名切点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通知参数"><span class="nav-number">8.4.5.</span> <span class="nav-text">通知参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#处理泛型参数"><span class="nav-number">8.4.5.1.</span> <span class="nav-text">处理泛型参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#确定参数名"><span class="nav-number">8.4.5.2.</span> <span class="nav-text">确定参数名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问当前接入点"><span class="nav-number">8.4.6.</span> <span class="nav-text">访问当前接入点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引入"><span class="nav-number">8.4.7.</span> <span class="nav-text">引入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在XML中声明切面"><span class="nav-number">8.5.</span> <span class="nav-text">在XML中声明切面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启用-AspectJ支持-1"><span class="nav-number">8.5.1.</span> <span class="nav-text">启用@AspectJ支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明切面-1"><span class="nav-number">8.5.2.</span> <span class="nav-text">声明切面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明通知-1"><span class="nav-number">8.5.3.</span> <span class="nav-text">声明通知</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在返回通知中访问返回值-1"><span class="nav-number">8.5.3.1.</span> <span class="nav-text">在返回通知中访问返回值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在异常通知中访问抛出的异常-1"><span class="nav-number">8.5.3.2.</span> <span class="nav-text">在异常通知中访问抛出的异常</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建环绕通知-1"><span class="nav-number">8.5.3.3.</span> <span class="nav-text">创建环绕通知</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明切点-1"><span class="nav-number">8.5.4.</span> <span class="nav-text">声明切点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#命名切点-1"><span class="nav-number">8.5.4.1.</span> <span class="nav-text">命名切点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通知参数-1"><span class="nav-number">8.5.5.</span> <span class="nav-text">通知参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#确定参数名-1"><span class="nav-number">8.5.5.1.</span> <span class="nav-text">确定参数名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引入-1"><span class="nav-number">8.5.6.</span> <span class="nav-text">引入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Advisor"><span class="nav-number">8.5.7.</span> <span class="nav-text">Advisor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AspectJ切面"><span class="nav-number">8.6.</span> <span class="nav-text">AspectJ切面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#声明AspectJ切面"><span class="nav-number">8.6.1.</span> <span class="nav-text">声明AspectJ切面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注入AspectJ切面"><span class="nav-number">8.6.2.</span> <span class="nav-text">注入AspectJ切面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#切点表达式语言"><span class="nav-number">8.7.</span> <span class="nav-text">切点表达式语言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AspectJ切点指示符"><span class="nav-number">8.7.1.</span> <span class="nav-text">AspectJ切点指示符</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#execution-指示符"><span class="nav-number">8.7.1.1.</span> <span class="nav-text">execution()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#within-指示符"><span class="nav-number">8.7.1.2.</span> <span class="nav-text">within()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#within-指示符-1"><span class="nav-number">8.7.1.3.</span> <span class="nav-text">@within()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#this-指示符"><span class="nav-number">8.7.1.4.</span> <span class="nav-text">this()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#target-指示符"><span class="nav-number">8.7.1.5.</span> <span class="nav-text">target()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#target-指示符-1"><span class="nav-number">8.7.1.6.</span> <span class="nav-text">@target()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#args-指示符"><span class="nav-number">8.7.1.7.</span> <span class="nav-text">args()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#args-指示符-1"><span class="nav-number">8.7.1.8.</span> <span class="nav-text">@args()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#annotation-指示符"><span class="nav-number">8.7.1.9.</span> <span class="nav-text">@annotation()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bean-指示符"><span class="nav-number">8.7.1.10.</span> <span class="nav-text">bean()指示符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指示符的绑定形式"><span class="nav-number">8.7.1.11.</span> <span class="nav-text">指示符的绑定形式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#切点运算符"><span class="nav-number">8.7.2.</span> <span class="nav-text">切点运算符</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">周千涵</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:supremeadministrator@supercalifragilisticexpialidociouser.com" title="E-Mail → mailto:supremeadministrator@supercalifragilisticexpialidociouser.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周千涵</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
