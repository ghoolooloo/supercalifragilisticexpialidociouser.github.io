<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.supercalifragilisticexpialidociouser.com').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="人见人爱，花见花开，车见爆胎">
<meta property="og:url" content="https://blog.supercalifragilisticexpialidociouser.com/page/2/index.html">
<meta property="og:site_name" content="人见人爱，花见花开，车见爆胎">
<meta property="article:author" content="周千涵">
<meta property="article:tag" content="note">
<meta property="article:tag" content="programming">
<meta property="article:tag" content="学习">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="开发">
<meta property="article:tag" content="IT">
<meta property="article:tag" content="技术">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.supercalifragilisticexpialidociouser.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>人见人爱，花见花开，车见爆胎</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">人见人爱，花见花开，车见爆胎</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一个程序猿的笔记</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/11/26/SpringCache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/26/SpringCache/" class="post-title-link" itemprop="url">SpringCache</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-26 14:06:52" itemprop="dateCreated datePublished" datetime="2018-11-26T14:06:52+08:00">2018-11-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>尽管Spring自身并没有实现缓存解决方案，但是它对缓存功能提供了声明式的支持，能够与多种流行的缓存实现进行集成。</p>
<p>Spring对缓存的支持有两种方式：</p>
<ul>
<li>注解驱动的缓存；</li>
<li>XML声明的缓存。</li>
</ul>
<h1 id="启用缓存"><a href="#启用缓存" class="headerlink" title="启用缓存"></a>启用缓存</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfig</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:cache</span>=<span class="string">"http://www.springframework.org/schema/cache"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/cache</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/cache/spring-cache.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cache:annotation-driven</span> /&gt;</span></span><br><span class="line">  …</span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="配置缓存管理器"><a href="#配置缓存管理器" class="headerlink" title="配置缓存管理器"></a>配置缓存管理器</h1><p>Spring内置了许多缓存管理器实现：</p>
<ul>
<li>SimpleCacheManager</li>
<li>NoOpCacheManager</li>
<li>ConcurrentMapCacheManager</li>
<li>CompositeCacheManager</li>
<li>EhCacheCacheManager</li>
<li>JCacheCacheManager：基于JCache（JSR-107）</li>
<li>RedisCacheManager：来自于Spring Data Redis</li>
<li>GemfireCacheManager：来自于Spring Data GemFire</li>
<li>CaffeineCacheManager</li>
</ul>
<h2 id="配置EhCache缓存"><a href="#配置EhCache缓存" class="headerlink" title="配置EhCache缓存"></a>配置EhCache缓存</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.sf.ehcache.CacheManager;</span><br><span class="line">…</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> EhCacheCacheManager <span class="title">cacheManager</span><span class="params">(CacheManager cm)</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="keyword">new</span> EhCacheCacheManager(cm);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> EhCacheManagerFactoryBean <span class="title">ehcache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  EhCacheManagerFactoryBean ehCacheFactoryBean =   <span class="keyword">new</span> EhCacheManagerFactoryBean();</span><br><span class="line">  ehCacheFactoryBean.setConfigLocation(<span class="keyword">new</span> ClassPathResource(<span class="string">"com/habuma/spittr/cache/ehcache.xml"</span>));</span><br><span class="line">  <span class="keyword">return</span> ehCacheFactoryBean;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：Spring和EhCache都定义有<code>CacheManager</code>类型。这里，将EhCache的<code>CacheManager</code>注入到Spring的<code>EhCacheCacheManager</code>（Spring的<code>CacheManager</code>实现）之中。</p>
<p>Spring提供了<code>EhCacheManagerFactoryBean</code>来生成EhCache的<code>CacheManager</code>，因此，也要把它注册成一个Bean。</p>
<p>EhCache自身的配置定义在一个XML文件中，这里是<code>ehcache.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ehcache</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"spittleCache"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">maxBytesLocalHeap</span>=<span class="string">"50m"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">timeToLiveSeconds</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置Redis缓存"><a href="#配置Redis缓存" class="headerlink" title="配置Redis缓存"></a>配置Redis缓存</h2><p>Spring Data Redis提供了<code>RedisCacheManager</code>，它会与一个Redis服务器协作，并通过<code>RedisTemplate</code>将缓存条目存储到Redis中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(RedisTemplate redisTemplate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(redisTemplate);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JedisConnectionFactory jedisConnectionFactory =</span><br><span class="line">      <span class="keyword">new</span> JedisConnectionFactory();</span><br><span class="line">    jedisConnectionFactory.afterPropertiesSet();</span><br><span class="line">    <span class="keyword">return</span> jedisConnectionFactory;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, String&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisCF)</span> </span>&#123;</span><br><span class="line">    RedisTemplate&lt;String, String&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;String, String&gt;();</span><br><span class="line">    redisTemplate.setConnectionFactory(redisCF);</span><br><span class="line">    redisTemplate.afterPropertiesSet();</span><br><span class="line">    <span class="keyword">return</span> redisTemplate;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置多个缓存管理器"><a href="#配置多个缓存管理器" class="headerlink" title="配置多个缓存管理器"></a>配置多个缓存管理器</h2><p>可以使用<code>CompositeCacheManager</code>来配置多个缓存管理器，它会迭代这些缓存管理器，以查找之前所缓存的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    net.sf.ehcache.CacheManager cm,</span></span></span><br><span class="line"><span class="function"><span class="params">    javax.cache.CacheManager jcm)</span> </span>&#123;</span><br><span class="line">  CompositeCacheManager cacheManager = <span class="keyword">new</span> CompositeCacheManager();</span><br><span class="line">  List&lt;CacheManager&gt; managers = <span class="keyword">new</span> ArrayList&lt;CacheManager&gt;();</span><br><span class="line">  managers.add(<span class="keyword">new</span> JCacheCacheManager(jcm));</span><br><span class="line">  managers.add(<span class="keyword">new</span> EhCacheCacheManager(cm));</span><br><span class="line">  managers.add(<span class="keyword">new</span> RedisCacheManager(redisTemplate()));</span><br><span class="line">  cacheManager.setCacheManagers(managers);</span><br><span class="line">  <span class="keyword">return</span> cacheManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="为方法添加标注以支持缓存"><a href="#为方法添加标注以支持缓存" class="headerlink" title="为方法添加标注以支持缓存"></a>为方法添加标注以支持缓存</h1><p>Spring提供的缓存标注：</p>
<table>
<thead>
<tr>
<th>标注</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@Cacheable</td>
<td>表明Spring在调用方法之前，首先应该在缓存中查找方法的返回值。如果这个值能够找到，就会返回缓存的值。否则，这个方法就会被调用，返回值会放到缓存之中。</td>
</tr>
<tr>
<td>@CachePut</td>
<td>表示Spring应该将方法的返回值放到缓存中。在方法的调用前并不会检查缓存，方法始终都会被调用。</td>
</tr>
<tr>
<td>@CacheEvict</td>
<td>表示Spring应该在缓存中清除一个或多个条目。</td>
</tr>
<tr>
<td>@Caching</td>
<td>这是一个分组标注，能够同时应用多个其他的缓存标注。</td>
</tr>
</tbody></table>
<h2 id="填充缓存"><a href="#填充缓存" class="headerlink" title="填充缓存"></a>填充缓存</h2><p><code>@Cacheable</code>和<code>@CachePut</code>都可填充缓存。它们的一些共有属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>String[]</td>
<td>要使用的缓存名称。</td>
</tr>
<tr>
<td>condition</td>
<td>String</td>
<td>SpEL表达式，如果得到的值是<code>false</code>，就不会将缓存应用到方法调用上。</td>
</tr>
<tr>
<td>key</td>
<td>String</td>
<td>SpEL表达式，用来计算自定义的缓存key。</td>
</tr>
<tr>
<td>unless</td>
<td>String</td>
<td>SpEL表达式，如果得到的值是<code>true</code>，返回值不会放到缓存之中。</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(<span class="string">"spittleCache"</span>)  <span class="comment">//缓存名称是spittleCache</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Spittle <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.queryForObject(</span><br><span class="line">      SELECT_SPITTLE_BY_ID,</span><br><span class="line">      <span class="keyword">new</span> SpittleRowMapper(),</span><br><span class="line">      id);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (EmptyResultDataAccessException e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的程序，将<code>@Cacheable</code>放在实现类的方法上，这样，只有该实现类的方法才应用缓存。如果将<code>@Cacheable</code>放在接口的方法声明上，则所有实现该接口的类的重写方法都会应用缓存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(<span class="string">"spittleCache"</span>)</span><br><span class="line"><span class="function">Spittle <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="自定义缓存key"><a href="#自定义缓存key" class="headerlink" title="自定义缓存key"></a>自定义缓存key</h3><p>默认的缓存key是基于方法的参数来确定的。上面程序中，缓存的key是传递到<code>findOne</code>方法的<code>id</code>参数。</p>
<p>可以使用<code>@Cacheable</code>和<code>@CachePut</code>标注的<code>key</code>属性来自定义缓存key：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CachePut</span>(value=<span class="string">"spittleCache"</span>, key=<span class="string">"#result.id"</span>)</span><br><span class="line"><span class="function">Spittle <span class="title">save</span><span class="params">(Spittle spittle)</span></span>;</span><br></pre></td></tr></table></figure>

<p>Spring提供了多个用来定义缓存规则的SpEL扩展：</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>#root.args</code></td>
<td>传递给缓存方法的参数，形式为数组。</td>
</tr>
<tr>
<td><code>#root.caches</code></td>
<td>该方法执行时所对应的缓存，形式为数组。</td>
</tr>
<tr>
<td><code>#root.target</code></td>
<td>目标对象。</td>
</tr>
<tr>
<td><code>#root.targetClass</code></td>
<td>目标对象的类，是<code>#root.target.class</code>的简写形式。</td>
</tr>
<tr>
<td><code>#root.method</code></td>
<td>缓存方法。</td>
</tr>
<tr>
<td><code>#root.methodName</code></td>
<td>缓存方法的名称，是<code>#root.method.name</code>的简写形式。</td>
</tr>
<tr>
<td><code>#result</code></td>
<td>方法调用的返回值（不能用在<code>@Cacheable</code>标注上）。</td>
</tr>
<tr>
<td><code>#参数名或索引</code></td>
<td>任意的方法参数名（如<code>#argName</code>）或参数索引（如<code>#a0</code>或<code>#p0</code>）。</td>
</tr>
</tbody></table>
<h3 id="条件化缓存"><a href="#条件化缓存" class="headerlink" title="条件化缓存"></a>条件化缓存</h3><p><code>@Cacheable</code>和<code>@CachePut</code>提供了两个属性用以实现条件化缓存：<code>unless</code>和<code>condition</code>。</p>
<p><code>unless</code>属性只能阻止将对象放进缓存，但是在这个方法调用的时候，依然会去缓存中进行查找，如果找到匹配的值，就会返回找到的值。</p>
<p><code>condition</code>的表达式计算结果为<code>false</code>，则在这个方法调用的过程中，缓存是被禁用的。就是说，不会去缓存进行查找，同时返回值也不会放进缓存中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(value=<span class="string">"spittleCache"</span></span><br><span class="line">           unless=<span class="string">"#result.message.contains('NoCache')"</span></span><br><span class="line">           condition=<span class="string">"#id &gt;= 10"</span>)</span><br><span class="line"><span class="function">Spittle <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br></pre></td></tr></table></figure>

<p>另外，<code>unless</code>属性只有在缓存方法有返回值时才开始发挥作用。而<code>condition</code>肩负着在方法上禁用缓存的任务，因此它不能等到方法返回时再确定是否该关闭缓存。这意味着它的表达式必须要在进入方法时进行计算，所以我们不能通过<code>#result</code>引用返回值。</p>
<h2 id="移除缓存条目"><a href="#移除缓存条目" class="headerlink" title="移除缓存条目"></a>移除缓存条目</h2><p><code>@CacheEvict</code>并不会往缓存中添加任何东西。相反，如果带有<code>@CacheEvict</code>标注的方法被调用的话，那么会有一个或更多的条目会在缓存中移除。</p>
<blockquote>
<p>注意：<code>@CacheEvict</code>可以应用在返回值为<code>void</code>的方法上，而<code>@Cacheable</code>和<code>@CachePut</code>只能用在返回值不是<code>void</code>的方法上。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheEvict</span>(<span class="string">"spittleCache"</span>)</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">long</span> spittleId)</span></span>;</span><br></pre></td></tr></table></figure>

<p>被删除条目的key与传递进来的<code>spittleId</code>参数的值相同。</p>
<p><code>@CacheEvict</code>的属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>String[]</td>
<td>要使用的缓存名称。</td>
</tr>
<tr>
<td>key</td>
<td>String</td>
<td>SpEL表达式，用来计算自定义的缓存key。</td>
</tr>
<tr>
<td>condition</td>
<td>String</td>
<td>SpEL表达式，如果得到的值是<code>false</code>，则缓存不会应用到方法调用上。</td>
</tr>
<tr>
<td>allEntries</td>
<td>boolean</td>
<td>如果为<code>true</code>，特定缓存的所有条目都会被移除掉。</td>
</tr>
<tr>
<td>beforeInvocation</td>
<td>boolean</td>
<td>如果为<code>true</code>，则在方法调用之前移除条目。如果为<code>false</code>（默认值），则在方法成功调用之后再移除条目。</td>
</tr>
</tbody></table>
<h1 id="使用XML声明缓存"><a href="#使用XML声明缓存" class="headerlink" title="使用XML声明缓存"></a>使用XML声明缓存</h1><p>如果你不希望在自己的源码中添加Spring的标注，或者你需要在没有源码的Bean上应用缓存功能。这时就需要使用XML的方式来声明缓存。</p>
<table>
<thead>
<tr>
<th>元素</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;cache:annotation-driven&gt;</code></td>
<td>启用标注驱动的缓存。等同于Java配置中的<code>@EnableCaching</code>。</td>
</tr>
<tr>
<td><code>&lt;cache:advice&gt;</code></td>
<td>定义缓存通知（advice）。结合<code>&lt;aop:advisor&gt;</code>，将通知应用到切点上。</td>
</tr>
<tr>
<td><code>&lt;cache:caching&gt;</code></td>
<td>在缓存通知中，定义一组特定的缓存规则。</td>
</tr>
<tr>
<td><code>&lt;cache:cacheable&gt;</code></td>
<td>指明某个方法要进行缓存。等同于<code>@Cacheable</code>。</td>
</tr>
<tr>
<td><code>&lt;cache:cache-put&gt;</code></td>
<td>指明某个方法要填充缓存，但不会考虑缓存中是否已有配置的值。等同于<code>@CachePut</code>。</td>
</tr>
<tr>
<td><code>&lt;cache:cache-evict&gt;</code></td>
<td>指明某个方法要从缓存中移除一个或多个条目。等同于<code>@CacheEvict</code>。</td>
</tr>
</tbody></table>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">    xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">    xmlns:cache=<span class="string">"http://www.springframework.org/schema/cache"</span></span><br><span class="line">    xmlns:aop=<span class="string">"http://www.springframework.org/schema/aop"</span></span><br><span class="line">    xsi:schemaLocation=<span class="string">"http://www.springframework.org/schema/aop</span></span><br><span class="line"><span class="string">      http://www.springframework.org/schema/aop/spring-aop.xsd</span></span><br><span class="line"><span class="string">      http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">      http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">      http://www.springframework.org/schema/cache</span></span><br><span class="line"><span class="string">      http://www.springframework.org/schema/cache/spring-cache.xsd"</span>&gt;</span><br><span class="line">  &lt;aop:config&gt;</span><br><span class="line">  &lt;aop:advisor advice-ref=<span class="string">"cacheAdvice"</span></span><br><span class="line">    pointcut=<span class="string">"execution(* com.habuma.spittr.db.SpittleRepository.*(..))"</span>/&gt;</span><br><span class="line">  &lt;/aop:config&gt;</span><br><span class="line">  &lt;cache:advice id=<span class="string">"cacheAdvice"</span>&gt;</span><br><span class="line">    &lt;cache:caching&gt;</span><br><span class="line">      &lt;cache:cacheable cache=<span class="string">"spittleCache"</span> method=<span class="string">"findRecent"</span> /&gt;</span><br><span class="line">      &lt;cache:cacheable cache=<span class="string">"spittleCache"</span> method=<span class="string">"findOne"</span> /&gt;</span><br><span class="line">      &lt;cache:cacheable cache=<span class="string">"spittleCache"</span> method=<span class="string">"findBySpitterId"</span> /&gt;</span><br><span class="line">      &lt;cache:cache-put cache=<span class="string">"spittleCache"</span> method=<span class="string">"save"</span> key=<span class="string">"#result.id"</span> /&gt;</span><br><span class="line">      &lt;cache:cache-evict cache=<span class="string">"spittleCache"</span> method=<span class="string">"remove"</span> /&gt;</span><br><span class="line">    &lt;/cache:caching&gt;</span><br><span class="line">  &lt;/cache:advice&gt;</span><br><span class="line">  &lt;bean id=<span class="string">"cacheManager"</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.cache.concurrent.ConcurrentMapCacheManager"</span> /&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>在<code>&lt;cache:advice&gt;</code>中可包含任意数量的<code>&lt;cache:caching&gt;</code>元素。</p>
<p>另外，如果缓存管理器的ID不是<code>cacheManager</code>的话，则还要在<code>&lt;cache:advice&gt;</code>中通过<code>cache-manager</code>属性显式指定。</p>
<p>如果<code>&lt;cache:caching&gt;</code>下的所有<code>&lt;cache:cacheable&gt;</code>、<code>&lt;cache:cache-put&gt;</code>、<code>&lt;cache:cache-evict&gt;</code>元素的<code>cache</code>、<code>condition</code>、<code>key</code>或<code>method</code>属性都引用相同的名字，则可以在<code>&lt;cache:caching&gt;</code>元素的对应属性上统一指定：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache:advice</span> <span class="attr">id</span>=<span class="string">"cacheAdvice"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cache:caching</span> <span class="attr">cache</span>=<span class="string">"spittleCache"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache:cacheable</span> <span class="attr">method</span>=<span class="string">"findRecent"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache:cacheable</span> <span class="attr">method</span>=<span class="string">"findOne"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache:cacheable</span> <span class="attr">method</span>=<span class="string">"findBySpitterId"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache:cache-put</span> <span class="attr">method</span>=<span class="string">"save"</span> <span class="attr">key</span>=<span class="string">"#result.id"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache:cache-evict</span> <span class="attr">method</span>=<span class="string">"remove"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cache:caching</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cache:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此外，<code>&lt;cache:cacheable&gt;</code>、<code>&lt;cache:cache-put&gt;</code>也有<code>unless</code>属性。<code>&lt;cache:cache-evict&gt;</code>有<code>all-entries</code>和<code>before-invocation</code>属性。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/11/16/SpringDA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/16/SpringDA/" class="post-title-link" itemprop="url">SpringDA</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-16 10:34:40" itemprop="dateCreated datePublished" datetime="2018-11-16T10:34:40+08:00">2018-11-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h1><h2 id="配置数据源"><a href="#配置数据源" class="headerlink" title="配置数据源"></a>配置数据源</h2><h3 id="使用JNDI数据源"><a href="#使用JNDI数据源" class="headerlink" title="使用JNDI数据源"></a>使用JNDI数据源</h3><p>通过JNDI获取数据源的好处在于数据源完全可以在应用程序之外进行管理。另外，在应用服务器中管理的数据源通常以池的方式组织，具备更好的性能，并且还支持系统管理员对其进行热切换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JndiObjectFactoryBean <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  JndiObjectFactoryBean jndiObjectFB = <span class="keyword">new</span> JndiObjectFactoryBean();</span><br><span class="line">  jndiObjectFB.setJndiName(<span class="string">"jdbc/SpittrDS"</span>);</span><br><span class="line">  jndiObjectFB.setResourceRef(<span class="keyword">true</span>);</span><br><span class="line">  jndiObjectFB.setProxyInterface(javax.sql.DataSource<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="keyword">return</span> jndiObjectFB;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jee:jndi-lookup</span> <span class="attr">id</span>=<span class="string">"dataSource"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">jndi-name</span>=<span class="string">"/jdbc/SpitterDS"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">resource-ref</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果应用程序运行在Java应用服务器中，你需要将<code>resource-ref</code>属性设置为<code>true</code>，这样给定的<code>jndi-name</code>将会自动添加<code>java:comp/env/</code>前缀。</p>
</blockquote>
<h3 id="使用数据源连接池"><a href="#使用数据源连接池" class="headerlink" title="使用数据源连接池"></a>使用数据源连接池</h3><p>使用数据源连接池也是配置数据源的不错选择。</p>
<p>Spring支持多种开源的连接池实现：</p>
<ul>
<li>BoneCP</li>
<li>Apache Commons DBCP</li>
<li>c3p0</li>
</ul>
<h4 id="DBCP"><a href="#DBCP" class="headerlink" title="DBCP"></a>DBCP</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BasicDataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  BasicDataSource ds = <span class="keyword">new</span> BasicDataSource();</span><br><span class="line">  ds.setDriverClassName(<span class="string">"org.h2.Driver"</span>);</span><br><span class="line">  ds.setUrl(<span class="string">"jdbc:h2:tcp://localhost/~/spitter"</span>);</span><br><span class="line">  ds.setUsername(<span class="string">"sa"</span>);</span><br><span class="line">  ds.setPassword(<span class="string">""</span>);</span><br><span class="line">  ds.setInitialSize(<span class="number">5</span>);</span><br><span class="line">  ds.setMaxActive(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> ds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:driverClassName</span>=<span class="string">"org.h2.Driver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:url</span>=<span class="string">"jdbc:h2:tcp://localhost/~/spitter"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:username</span>=<span class="string">"sa"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:password</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:initialSize</span>=<span class="string">"5"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:maxActive</span>=<span class="string">"10"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>BasicDataSource</code>的池配置属性：</p>
<table>
<thead>
<tr>
<th>池配置属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>initialSize</td>
<td>池启动时创建的初始连接数量。</td>
</tr>
<tr>
<td>maxActive</td>
<td>同一时间可从池中分配的最多连接数。如果设置为0，则表示无限制。</td>
</tr>
<tr>
<td>maxIdle</td>
<td>池里不会被释放的最多空闲连接数。如果设置为0，则表示无限制。</td>
</tr>
<tr>
<td>maxOpenPreparedStatements</td>
<td>在同一时间能够从语句池中分配的预处理语句的最大数量。如果设置为0，则表示无限制。</td>
</tr>
<tr>
<td>maxWait</td>
<td>在抛出异常之前，池等待连接回收的最大时间（当没有可用连接时）。如果设置为-1，则表示无限等待。</td>
</tr>
<tr>
<td>minEvictableIdleTimeMillis</td>
<td>连接在池中保持空闲而不被回收的最大时间。</td>
</tr>
<tr>
<td>minIdle</td>
<td>在不创建新连接的情况下，池中保持空闲的最小连接数。</td>
</tr>
<tr>
<td>poolPreparedStatements</td>
<td>是否对预处理语句进行池管理。（布尔值）</td>
</tr>
</tbody></table>
<h3 id="使用JDBC驱动的数据源"><a href="#使用JDBC驱动的数据源" class="headerlink" title="使用JDBC驱动的数据源"></a>使用JDBC驱动的数据源</h3><p>在Spring中，通过JDBC驱动定义数据源是最简单的配置方式。Spring提供了三个这样的数据源类：</p>
<ul>
<li>DriverManagerDataSource：在每个连接请求时都会返回一个新建的连接。</li>
<li>SimpleDriverDataSource：类似<code>DriverManagerDataSource</code>。</li>
<li>SingleConnectionDataSource：在每个连接请求时都会返回同一个连接。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  DriverManagerDataSource ds = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">  ds.setDriverClassName(<span class="string">"org.h2.Driver"</span>);</span><br><span class="line">  ds.setUrl(<span class="string">"jdbc:h2:tcp://localhost/~/spitter"</span>);</span><br><span class="line">  ds.setUsername(<span class="string">"sa"</span>);</span><br><span class="line">  ds.setPassword(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">return</span> ds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:driverClassName</span>=<span class="string">"org.h2.Driver"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:url</span>=<span class="string">"jdbc:h2:tcp://localhost/~/spitter"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:username</span>=<span class="string">"sa"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">p:password</span>=<span class="string">""</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用JDBC驱动的数据源都没有提供连接池功能，通常适合小应用或开发环境。</p>
<h3 id="使用嵌入式数据源"><a href="#使用嵌入式数据源" class="headerlink" title="使用嵌入式数据源"></a>使用嵌入式数据源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> EmbeddedDatabaseBuilder()</span><br><span class="line">    .setType(EmbeddedDatabaseType.H2)</span><br><span class="line">    .addScript(<span class="string">"classpath:schema.sql"</span>)</span><br><span class="line">    .addScript(<span class="string">"classpath:test-data.sql"</span>)</span><br><span class="line">    .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:jdbc</span>=<span class="string">"http://www.springframework.org/schema/jdbc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">"http://www.springframework.org/schema/c"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/jdbc</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/jdbc/spring-jdbc-3.1.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">jdbc:embeddeddatabase</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">type</span>=<span class="string">"H2"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">"com/habuma/spitter/db/jdbc/schema.sql"</span>/&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbc:script</span> <span class="attr">location</span>=<span class="string">"com/habuma/spitter/db/jdbc/test-data.sql"</span>/&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">jdbc:embedded-database</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>嵌入式的数据源适合于开发或测试环境。</p>
<h3 id="使用profile选择数据源"><a href="#使用profile选择数据源" class="headerlink" title="使用profile选择数据源"></a>使用profile选择数据源</h3><p>参见《SpringCore》的“Spring Profile”。</p>
<h2 id="使用JDBC模板"><a href="#使用JDBC模板" class="headerlink" title="使用JDBC模板"></a>使用JDBC模板</h2><p>Spring将数据访问的样板代码抽象到模板类中。Spring为JDBC提供了三个模板类：</p>
<ul>
<li><code>JdbcTemplate</code></li>
<li><code>NamedParameterJdbcTemplate</code>：是对<code>JdbcTemplate</code>的包装，以提供命名参数而不是传统的JDBC <code>?</code> 占位符。</li>
<li><code>SimpleJdbcTemplate</code>（已废弃）</li>
</ul>
<h3 id="注册JDBC模板"><a href="#注册JDBC模板" class="headerlink" title="注册JDBC模板"></a>注册JDBC模板</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在内部，<code>JdbcTemplate</code>将会捕获所有可能抛出的<code>SQLException</code>，并将通用的<code>SQLException</code>转换为独立于持久化方案的Spring数据访问异常，然后将其重新抛出。并且Spring的数据访问异常都继承自<code>DataAccessException</code>异常，都是运行时异常。因而，没有必要捕获Spring所抛出的数据访问异常。</p>
<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcSpitterRepository</span> <span class="keyword">implements</span> <span class="title">SpitterRepository</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String INSERT_SPITTER = <span class="string">"insert into Spitter (username, password, fullname, email, updateByEmail) values (?, ?, ?, ?, ?)"</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> JdbcOperations jdbcOperations;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JdbcSpitterRepository</span><span class="params">(JdbcOperations jdbcOperations)</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">this</span>.jdbcOperations = jdbcOperations;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSpitter</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">    jdbcOperations.update(</span><br><span class="line">      INSERT_SPITTER,</span><br><span class="line">      spitter.getUsername(),</span><br><span class="line">      spitter.getPassword(),</span><br><span class="line">      spitter.getFullName(),</span><br><span class="line">      spitter.getEmail(),</span><br><span class="line">      spitter.isUpdateByEmail());</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：<code>JdbcTemplate</code>实现了<code>JdbcOperations</code>接口。</p>
<p>标注<code>@Repository</code>使得该类被注册成为一个数据访问Bean。</p>
<h3 id="读取数据"><a href="#读取数据" class="headerlink" title="读取数据"></a>读取数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcSpitterRepository</span> <span class="keyword">implements</span> <span class="title">SpitterRepository</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SELECT_SPITTER_BY_ID = <span class="string">"select id, username, password, fullname, email, updateByEmail from Spitter where id=?"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> JdbcOperations jdbcOperations;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JdbcSpitterRepository</span><span class="params">(JdbcOperations jdbcOperations)</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">this</span>.jdbcOperations = jdbcOperations;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Spitter <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> jdbcOperations.queryForObject(</span><br><span class="line">      SELECT_SPITTER_BY_ID, </span><br><span class="line">      <span class="keyword">new</span> SpitterRowMapper(), </span><br><span class="line">      id);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SpitterRowMapper</span> <span class="keyword">implements</span> <span class="title">RowMapper</span>&lt;<span class="title">Spitter</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Spitter <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Spitter(</span><br><span class="line">        rs.getLong(<span class="string">"id"</span>),</span><br><span class="line">        rs.getString(<span class="string">"username"</span>),</span><br><span class="line">        rs.getString(<span class="string">"password"</span>),</span><br><span class="line">        rs.getString(<span class="string">"fullName"</span>),</span><br><span class="line">        rs.getString(<span class="string">"email"</span>),</span><br><span class="line">        rs.getBoolean(<span class="string">"updateByEmail"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用Lambda表达式"><a href="#使用Lambda表达式" class="headerlink" title="使用Lambda表达式"></a>使用Lambda表达式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Spitter <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> jdbcOperations.queryForObject (</span><br><span class="line">    SELECT_SPITTER_BY_ID,</span><br><span class="line">    (rs, rowNum) -&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Spitter(</span><br><span class="line">        rs.getLong(<span class="string">"id"</span>),</span><br><span class="line">        rs.getString(<span class="string">"username"</span>),</span><br><span class="line">        rs.getString(<span class="string">"password"</span>),</span><br><span class="line">        rs.getString(<span class="string">"fullName"</span>),</span><br><span class="line">        rs.getString(<span class="string">"email"</span>),</span><br><span class="line">        rs.getBoolean(<span class="string">"updateByEmail"</span>));</span><br><span class="line">    &#125;,</span><br><span class="line">    id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，我们还可以使用Java 8的方法引用，在单独的方法中定义映射逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Spitter <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> jdbcOperations.queryForObject(</span><br><span class="line">    SELECT_SPITTER_BY_ID, </span><br><span class="line">    <span class="keyword">this</span>::mapSpitter, </span><br><span class="line">    id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Spitter <span class="title">mapSpitter</span><span class="params">(ResultSet rs, <span class="keyword">int</span> row)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Spitter(</span><br><span class="line">    rs.getLong(<span class="string">"id"</span>),</span><br><span class="line">    rs.getString(<span class="string">"username"</span>),</span><br><span class="line">    rs.getString(<span class="string">"password"</span>),</span><br><span class="line">    rs.getString(<span class="string">"fullName"</span>),</span><br><span class="line">    rs.getString(<span class="string">"email"</span>),</span><br><span class="line">    rs.getBoolean(<span class="string">"updateByEmail"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用命名参数"><a href="#使用命名参数" class="headerlink" title="使用命名参数"></a>使用命名参数</h3><p>注册<code>NamedParameterJdbcTemplate</code>  Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> NamedParameterJdbcTemplate <span class="title">jdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> NamedParameterJdbcTemplate(dataSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Repository：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String INSERT_SPITTER = <span class="string">"insert into Spitter (username, password, fullname, email, updateByEmail) values (:username, :password, :fullname, :email, :updateByEmail)"</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSpitter</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">  Map&lt;String, Object&gt; paramMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">  paramMap.put(<span class="string">"username"</span>, spitter.getUsername());</span><br><span class="line">  paramMap.put(<span class="string">"password"</span>, spitter.getPassword());</span><br><span class="line">  paramMap.put(<span class="string">"fullname"</span>, spitter.getFullName());</span><br><span class="line">  paramMap.put(<span class="string">"email"</span>, spitter.getEmail());</span><br><span class="line">  paramMap.put(<span class="string">"updateByEmail"</span>, spitter.isUpdateByEmail());</span><br><span class="line">  jdbcOperations.update(INSERT_SPITTER, paramMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用SimpleJdbcInsert-与SimpleJdbcCall"><a href="#使用SimpleJdbcInsert-与SimpleJdbcCall" class="headerlink" title="使用SimpleJdbcInsert 与SimpleJdbcCall"></a>使用<code>SimpleJdbcInsert</code> 与<code>SimpleJdbcCall</code></h2><h2 id="使用RDBMS-对象"><a href="#使用RDBMS-对象" class="headerlink" title="使用RDBMS 对象"></a>使用RDBMS 对象</h2><h1 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h1><h1 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h1><h2 id="Hibernate"><a href="#Hibernate" class="headerlink" title="Hibernate"></a>Hibernate</h2><h3 id="注册Session工厂Bean"><a href="#注册Session工厂Bean" class="headerlink" title="注册Session工厂Bean"></a>注册Session工厂Bean</h3><p>Hibernate主要是通过<code>org.hibernate.Session</code>接口提供数据访问功能。</p>
<p>获取Hibernate Session对象的标准方式是借助于Hibernate的<code>SessionFactory</code>接口的实现类，它主要负责Hibernate Session的打开、关闭及管理。</p>
<p>Spring提供了<code>org.springframework.orm.hibernate5.LocalSessionFactoryBean</code>来获取Hibernate SessionFactory。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalSessionFactoryBean <span class="title">sessionFactory</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">  LocalSessionFactoryBean sfb = <span class="keyword">new</span> LocalSessionFactoryBean();</span><br><span class="line">  sfb.setDataSource(dataSource);</span><br><span class="line">  sfb.setPackagesToScan(<span class="keyword">new</span> String[] &#123; <span class="string">"com.habuma.spittr.domain"</span> &#125;);</span><br><span class="line">  Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">  props.setProperty(<span class="string">"dialect"</span>, <span class="string">"org.hibernate.dialect.H2Dialect"</span>);</span><br><span class="line">  sfb.setHibernateProperties(props);</span><br><span class="line">  <span class="keyword">return</span> sfb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建Repository"><a href="#创建Repository" class="headerlink" title="创建Repository"></a>创建Repository</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HibernateSpitterRepository</span> <span class="keyword">implements</span> <span class="title">SpitterRepository</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HibernateSpitterRepository</span><span class="params">(SessionFactory sessionFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sessionFactory = sessionFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Session <span class="title">currentSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sessionFactory.getCurrentSession();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">count</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> findAll().size();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Spitter <span class="title">save</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">    Serializable id = currentSession().save(spitter);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Spitter((Long) id, </span><br><span class="line">                       spitter.getUsername(), </span><br><span class="line">                       spitter.getPassword(), </span><br><span class="line">                       spitter.getFullName(), </span><br><span class="line">                       spitter.getEmail(), </span><br><span class="line">                       spitter.isUpdateByEmail());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Spitter <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Spitter) currentSession().get(Spitter<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>; </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Spitter <span class="title">findByUsername</span><span class="params">(String username)</span> </span>&#123;		</span><br><span class="line">    <span class="keyword">return</span> (Spitter) currentSession() </span><br><span class="line">      .createCriteria(Spitter<span class="class">.<span class="keyword">class</span>) </span></span><br><span class="line">      .add(Restrictions.eq("username", username))</span><br><span class="line">      .list().get(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Spitter&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (List&lt;Spitter&gt;) currentSession().createCriteria(Spitter<span class="class">.<span class="keyword">class</span>).<span class="title">list</span>()</span>; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="注册PersistenceExceptionTranslationPostProcessor"><a href="#注册PersistenceExceptionTranslationPostProcessor" class="headerlink" title="注册PersistenceExceptionTranslationPostProcessor"></a>注册<code>PersistenceExceptionTranslationPostProcessor</code></h4><p>当我们直接使用Hibernate上下文的<code>Session</code>，而不是<code>HibernateTemplate</code>（不推荐）时，为了给不使用模板的Hibernate Repository添加异常转换功能，只需要在Spring应用上下文中添加一个<code>PersistenceExceptionTranslationPostProcessor</code> Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanPostProcessor <span class="title">persistenceTranslation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> PersistenceExceptionTranslationPostProcessor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PersistenceExceptionTranslationPostProcessor</code>是一个Bean后置处理器，它会在所有拥有<code>@Repository</code>标注的类上添加一个通知器（Advisor），这样就会捕获任何平台相关的异常，并以Spring的数据访问异常重新抛出。</p>
<h2 id="JPA"><a href="#JPA" class="headerlink" title="JPA"></a>JPA</h2><h3 id="配置实体管理器工厂"><a href="#配置实体管理器工厂" class="headerlink" title="配置实体管理器工厂"></a>配置实体管理器工厂</h3><h4 id="使用LocalEntityManagerFactoryBean"><a href="#使用LocalEntityManagerFactoryBean" class="headerlink" title="使用LocalEntityManagerFactoryBean"></a>使用LocalEntityManagerFactoryBean</h4><p>只能在简单的部署环境中使用此选项，例如单体应用程序和集成测试。</p>
<p><code>LocalEntityManagerFactoryBean</code>生成应用程序管理的实体管理器，不能引用现有的JDBC DataSource bean定义，也不存在对全局事务的支持。此外，持久化类的编织（字节码转换）是特定于提供者的，通常需要在启动时指定特定的JVM代理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalEntityManagerFactoryBean <span class="title">entityManagerFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LocalEntityManagerFactoryBean emfb = <span class="keyword">new</span> LocalEntityManagerFactoryBean();</span><br><span class="line">  emfb.setPersistenceUnitName(<span class="string">"spitterPU"</span>);</span><br><span class="line">  <span class="keyword">return</span> emfb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>持久化单元的信息是配置在一个名为<code>persistence.xml</code>文件中的，该文件必须位于类路径下的<code>META-INF</code>目录中。</p>
<p>persistence.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">persistence</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/persistence"</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">persistence-unit</span> <span class="attr">name</span>=<span class="string">"spitterPU"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.habuma.spittr.domain.Spitter<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.habuma.spittr.domain.Spittle<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"toplink.jdbc.driver"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">value</span>=<span class="string">"org.hsqldb.jdbcDriver"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"toplink.jdbc.url"</span> </span></span><br><span class="line"><span class="tag">                <span class="attr">value</span>= <span class="string">"jdbc:hsqldb:hsql://localhost/spitter/spitter"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"toplink.jdbc.user"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">value</span>=<span class="string">"sa"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"toplink.jdbc.password"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">persistence-unit</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">persistence</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="使用LocalContainerEntityManagerFactoryBean"><a href="#使用LocalContainerEntityManagerFactoryBean" class="headerlink" title="使用LocalContainerEntityManagerFactoryBean"></a>使用LocalContainerEntityManagerFactoryBean</h4><p><code>LocalContainerEntityManagerFactoryBean</code>生成容器管理的实体管理器，提供了完整的JPA功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  	DataSource dataSource, JpaVendorAdapter jpaVendorAdapter)</span> </span>&#123;</span><br><span class="line">  LocalContainerEntityManagerFactoryBean emfb =</span><br><span class="line">    <span class="keyword">new</span> LocalContainerEntityManagerFactoryBean();</span><br><span class="line">  emfb.setDataSource(dataSource);</span><br><span class="line">  emfb.setJpaVendorAdapter(jpaVendorAdapter);</span><br><span class="line">  emfb.setPackagesToScan(<span class="string">"com.habuma.spittr.domain"</span>);</span><br><span class="line">  <span class="keyword">return</span> emfb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JpaVendorAdapter <span class="title">jpaVendorAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  HibernateJpaVendorAdapter adapter = <span class="keyword">new</span> HibernateJpaVendorAdapter();</span><br><span class="line">  adapter.setDatabase(<span class="string">"HSQL"</span>);</span><br><span class="line">  adapter.setShowSql(<span class="keyword">true</span>);</span><br><span class="line">  adapter.setGenerateDdl(<span class="keyword">false</span>);</span><br><span class="line">  adapter.setDatabasePlatform(<span class="string">"org.hibernate.dialect.HSQLDialect"</span>);</span><br><span class="line">  <span class="keyword">return</span> adapter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BasicDataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据源信息既可以配置在Spring应用上下文中，也可以配置在<code>persistence.xml</code>文件中，而且前者优先级更高。</p>
<p>jpaVendorAdapter属性用于指明所使用的是哪一个厂商的JPA实现。Spring提供了多个JPA厂商适配器：</p>
<ul>
<li>EclipseLinkJpaVendorAdapter</li>
<li>HibernateJpaVendorAdapter</li>
<li>OpenJpaVendorAdapter</li>
<li>TopLinkJpaVendorAdapter（已废弃）</li>
</ul>
<p>packagesToScan属性指定了自动扫描的包名，在该包中带有<code>@Entity</code>标注类将被当作实体类。</p>
<h4 id="从JNDI中获取实体管理器工厂"><a href="#从JNDI中获取实体管理器工厂" class="headerlink" title="从JNDI中获取实体管理器工厂"></a>从JNDI中获取实体管理器工厂</h4><p>部署到Java EE服务器时，可以使用此选项。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JndiObjectFactoryBean <span class="title">entityManagerFactory</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  JndiObjectFactoryBean jndiObjectFB = <span class="keyword">new</span> JndiObjectFactoryBean();</span><br><span class="line">  jndiObjectFB.setJndiName(<span class="string">"jdbc/SpittrDS"</span>);</span><br><span class="line">  <span class="keyword">return</span> jndiObjectFB;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jee:jndi-lookup</span> <span class="attr">id</span>=<span class="string">"emf"</span> <span class="attr">jndi-name</span>=<span class="string">"persistence/spitterPU"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="创建基于JPA的Repository"><a href="#创建基于JPA的Repository" class="headerlink" title="创建基于JPA的Repository"></a>创建基于JPA的Repository</h3><h4 id="注入EntityManagerFactory"><a href="#注入EntityManagerFactory" class="headerlink" title="注入EntityManagerFactory"></a>注入EntityManagerFactory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaSpitterRepository</span> <span class="keyword">implements</span> <span class="title">SpitterRepository</span> </span>&#123;</span><br><span class="line">  <span class="meta">@PersistenceUnit</span></span><br><span class="line">  <span class="keyword">private</span> EntityManagerFactory emf;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSpitter</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">    emf.createEntityManager().persist(spitter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Spitter <span class="title">getSpitterById</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> emf.createEntityManager().find(Spitter<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveSpitter</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">    emf.createEntityManager().merge(spitter);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="直接注入EntityManager"><a href="#直接注入EntityManager" class="headerlink" title="直接注入EntityManager"></a>直接注入EntityManager</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaSpitterRepository</span> <span class="keyword">implements</span> <span class="title">SpitterRepository</span> </span>&#123;</span><br><span class="line">  <span class="meta">@PersistenceContext</span></span><br><span class="line">  <span class="keyword">private</span> EntityManager em;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSpitter</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">    em.persist(spitter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Spitter <span class="title">getSpitterById</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> em.find(Spitter<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveSpitter</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">    em.merge(spitter);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EntityManager</code>并不是线程安全的，一般来讲并不适合注入到像Repository这样的单例bean中。但是，<code>@PersistenceContext</code>标注并不会真正注入<code>EntityManager</code>，而是注入一个<code>EntityManager</code>代理。真正的<code>EntityManager</code>是与当前事务相关联的那一个，如果不存在这样的<code>EntityManager</code>，就会创建一个新的。这样，我们就能始终以线程安全的方式使用实体管理器。</p>
<h4 id="注册PersistenceAnnotationBeanPostProcessor"><a href="#注册PersistenceAnnotationBeanPostProcessor" class="headerlink" title="注册PersistenceAnnotationBeanPostProcessor"></a>注册PersistenceAnnotationBeanPostProcessor</h4><p>由于<code>@PersistenceUnit</code>和<code>@PersistenceContext</code>并不是Spring的标注，而是JPA规范的。为了让Spring理解这个标注，并注入<code>EntityManagerFactory</code>或<code>EntityManager</code>，我们必须要注册<code>PersistenceAnnotationBeanPostProcessor</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PersistenceAnnotationBeanPostProcessor <span class="title">paPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> PersistenceAnnotationBeanPostProcessor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，如果你已经使用了<code>&lt;context:annotation-config&gt;</code>或<code>&lt;context:component-scan&gt;</code>，则不需要显式注册<code>PersistenceAnnotationBeanPostProcessor</code>。因为，这些配置会自动注册<code>PersistenceAnnotationBeanPostProcessor</code> Bean。</p>
<h4 id="注册PersistenceExceptionTranslationPostProcessor-1"><a href="#注册PersistenceExceptionTranslationPostProcessor-1" class="headerlink" title="注册PersistenceExceptionTranslationPostProcessor"></a>注册PersistenceExceptionTranslationPostProcessor</h4><p>由于没有使用模板类（已废弃）来处理异常，所以我们需要为Repository添加<code>@Repository</code>标注。因而，需要注册一个<code>PersistenceExceptionTranslationPostProcessor</code> Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanPostProcessor <span class="title">persistenceTranslation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> PersistenceExceptionTranslationPostProcessor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不管对于JPA，还是Hibernate，异常转换都不是强制要求的。如果你希望在Repository中抛出特定的JPA或Hibernate异常，只需要不注册<code>PersistenceExceptionTranslationPostProcessor</code> Bean即可。但是使用Spring的数据访问异常，以后切换持久化机制会更容易。</p>
</blockquote>
<h1 id="Spring-Data"><a href="#Spring-Data" class="headerlink" title="Spring Data"></a>Spring Data</h1><p>Spring Data能够让我们只编写Repository接口，而不需要实现类。</p>
<h2 id="Spring-Data-JDBC"><a href="#Spring-Data-JDBC" class="headerlink" title="Spring Data JDBC"></a>Spring Data JDBC</h2><h2 id="Spring-Data-JPA"><a href="#Spring-Data-JPA" class="headerlink" title="Spring Data JPA"></a>Spring Data JPA</h2><h3 id="启用Spring-Data-JPA"><a href="#启用Spring-Data-JPA" class="headerlink" title="启用Spring Data JPA"></a>启用Spring Data JPA</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span>(basePackages=<span class="string">"com.habuma.spittr.db"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaConfiguration</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:jpa</span>=<span class="string">"http://www.springframework.org/schema/data/jpa"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/data/jpa</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/data/jpa/spring-jpa-1.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jpa:repositories</span> <span class="attr">base-package</span>=<span class="string">"com.habuma.spittr.db"</span> /&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Spring Data会扫描<code>basePackages</code>指定的包下所有扩展自<code>Repository</code>接口的所有接口。如果发现了扩展自<code>Repository</code>的接口，它会自动生成（在应用启动的时候）这个接口的实现。</p>
<h3 id="创建Repository接口"><a href="#创建Repository接口" class="headerlink" title="创建Repository接口"></a>创建Repository接口</h3><p>自己创建的Repository接口必须扩展自<code>Repository</code>接口，通常扩展<code>JpaRepository</code>接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpitterRepository</span></span></span><br><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Spitter</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>JpaRepository</code>接口本身提供了18个常用的持久化方法，而无需你编写任何实现代码。除了这些预先提供的方法外，我们还可以使用多种方式为Spring Data JPA编写自定义的查询方法。</p>
<h4 id="根据方法签名定义查询方法"><a href="#根据方法签名定义查询方法" class="headerlink" title="根据方法签名定义查询方法"></a>根据方法签名定义查询方法</h4><p>Spring Data为Repository方法的签名定义了一组小型的邻域特定语言（DSL）。具体地说，Repository方法是由一个动词、一个可选的主题（Subject）、关键词<code>By</code>以及一个断言组成。</p>
<p>在创建Repository实现的时候，Spring Data会根据方法的签名自动实现这些方法。</p>
<p>Spring Data允许的动词有：<code>get</code>、<code>read</code>、<code>find</code>和<code>count</code>。其中，<code>get</code>、<code>read</code>、<code>find</code>是同义的，都用于查询数据并返回对象。而<code>count</code>则会返回匹配对象的数量，而不是对象本身。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpitterRepository</span></span></span><br><span class="line"><span class="class">  	<span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Spitter</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function">Spitter <span class="title">findByUsername</span><span class="params">(String username)</span></span>;  <span class="comment">//可以只返回一个对象</span></span><br><span class="line">  <span class="function">List&lt;Spitter&gt; <span class="title">readSpittersByFirstnameOrLastname</span><span class="params">(String first, String last)</span></span>;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="SpringDA/repository-method-signatures.png" alt="Repository方法签名"></p>
<p>Repository方法的主题是可选的，并且可以随便命名。例如<code>readSpittersByFirstnameOrLastname</code>、<code>readByFirstnameOrLastname</code>、<code>readThoseThingsWeWantByFirstnameOrLastname</code>都是没有区别的。要查询的对象类型是通过参数化的<code>JpaRepository</code>接口确定的，而不是方法名称中的主题。</p>
<p>在省略主题的时候，有一种例外：如果主题的名称以<code>Distinct</code>开头的话，那么在生成查询的时候会确保所返回结果集中不包含重复记录。</p>
<p>断言指定了一个或多个限制结果的条件，每个条件必须引用一个属性（方法参数），并且还可以指定一种比较操作。如果省略比较操作符，则默认是相等比较操作。</p>
<p>比较操作（同一行的比较操作是同义的）：</p>
<ul>
<li><p>IsAfter、After、IsGreaterThan、GreaterThan</p>
</li>
<li><p>IsGreaterThanEqual、GreaterThanEqual</p>
</li>
<li><p>IsBefore、Before、IsLessThan、LessThan</p>
</li>
<li><p>IsLessThanEqual、LessThanEqual</p>
</li>
<li><p>IsBetween、Between</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;Order&gt; <span class="title">findByShippingDateBetween</span><span class="params">(Date start, Date end)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>IsNull、Null</p>
</li>
<li><p>IsNotNull、NotNull</p>
</li>
<li><p>IsIn、In</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;Pet&gt; <span class="title">findPetsByBreedIn</span><span class="params">(List&lt;String&gt; breed)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>IsNotIn、NotIn</p>
</li>
<li><p>IsStartingWith、StartingWith、StartsWith</p>
</li>
<li><p>IsEndingWith、EndingWith、EndsWith</p>
</li>
<li><p>IsContaining、Containing、Contains</p>
</li>
<li><p>IsLike、Like</p>
</li>
<li><p>IsNotLike、NotLike</p>
</li>
<li><p>IsTrue、True</p>
</li>
<li><p>IsFalse、False</p>
</li>
<li><p>Is、Equals</p>
</li>
<li><p>IsNot、Not</p>
</li>
</ul>
<p>条件之间是通过<code>And</code>或<code>Or</code>连接的。</p>
<p>在处理<code>String</code>类型的属性时，条件中可以包含<code>IgnoringCase</code>或<code>IgnoresCase</code>（两者是同义的），这样在执行对比时就不会考虑字符的大小写。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;Spitter&gt; <span class="title">readByFirstnameIgnoringCaseOrLastnameIgnoresCase</span><span class="params">(String first, String last)</span></span>;</span><br></pre></td></tr></table></figure>

<p>如果所有<code>String</code>类型的属性都要忽略大小写，则只需在所有条件的后面添加<code>AllIgnoringCase</code>或<code>AllIgnoresCase</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;Spitter&gt; <span class="title">readByFirstnameOrLastnameAllIgnoresCase</span><span class="params">(String first, String last)</span></span>;</span><br></pre></td></tr></table></figure>

<p>注意：属性名是无关紧要的，但是它们的顺序必须与方法参数相匹配。</p>
<p>最后，我们还可以在方法名称的结尾处添加<code>OrderBy…Asc</code>（升序）或<code>OrderBy…Desc</code>（降序），实现对结果集的排序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;Spitter&gt; <span class="title">readByFirstnameOrLastnameOrderByLastnameAsc</span><span class="params">(String first, String last)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">List&lt;Spitter&gt; <span class="title">readByFirstnameOrLastnameOrderByFirstnameDesc</span><span class="params">(String first, String last)</span></span>;</span><br></pre></td></tr></table></figure>

<p>如果要根据多个属性排序，只需将其依序添加到<code>OrderBy</code>之后即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;Spitter&gt; <span class="title">readByFirstnameOrLastnameOrderByLastnameAscFirstnameDesc</span><span class="params">(String first, String last)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="使用-Query标注声明自定义查询"><a href="#使用-Query标注声明自定义查询" class="headerlink" title="使用@Query标注声明自定义查询"></a>使用<code>@Query</code>标注声明自定义查询</h4><p><code>@Query</code>仅限于单个JPA查询。</p>
<p>如果所需的数据无法通过方法名称进行恰当地描述，那么我们可以使用<code>@Query</code>标注，为Spring Data提供要执行的查询：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query</span>(<span class="string">"select s from Spitter s where s.email like '%gmail.com'"</span>)</span><br><span class="line"><span class="function">List&lt;Spitter&gt; <span class="title">findAllGmailSpitters</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>我们依然不需要编写<code>findAllGmailSpitters</code>方法的实现，只需提供查询即可。</p>
<p>带参数的查询：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query</span>(<span class="string">"select u from User u where u.emailAddress = ?1"</span>)</span><br><span class="line"><span class="function">User <span class="title">findByEmailAddress</span><span class="params">(String emailAddress)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>?1</code>表明<code>u.emailAddress</code>将映射到查询方法的第一个参数。</p>
<h4 id="混合自定义查询"><a href="#混合自定义查询" class="headerlink" title="混合自定义查询"></a>混合自定义查询</h4><p>如果我们需要Repository所提供的功能是无法用Spring Data的方法命名约定来描述的，甚至无法用<code>@Query</code>标注设置查询来实现的。这时，Spring Data允许我们自己实现该功能，并且仍然保留Spring Data的其他便利。</p>
<p>当Spring Data JPA为Repository接口生成实现的时候，它还会查找名字与接口相同，并且添加了<code>Impl</code>后缀（默认）的一个类。如果这个类存在的话，Spring Data JPA将会把它的方法与Spring Data JPA所生成的方法合并在一起。对于<code>SpitterRepository</code>接口而言，要查找的类名为<code>SpitterRepositoryImpl</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpitterRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">SpitterSweeper</span> </span>&#123;</span><br><span class="line">  <span class="meta">@PersistenceContext</span></span><br><span class="line">  <span class="keyword">private</span> EntityManager em;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">eliteSweep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String update =</span><br><span class="line">      <span class="string">"UPDATE Spitter spitter "</span> +</span><br><span class="line">      <span class="string">"SET spitter.status = 'Elite' "</span> +</span><br><span class="line">      <span class="string">"WHERE spitter.status = 'Newbie' "</span> +</span><br><span class="line">      <span class="string">"AND spitter.id IN ("</span> +</span><br><span class="line">      <span class="string">"SELECT s FROM Spitter s WHERE ("</span> +</span><br><span class="line">      <span class="string">" SELECT COUNT(spittles) FROM s.spittles spittles) &gt; 10000 )"</span>;</span><br><span class="line">    <span class="keyword">return</span> em.createQuery(update).executeUpdate();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpitterSweeper</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">eliteSweep</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：<code>SpitterRepositoryImpl</code>并不需要实现<code>SpitterRepository</code>接口，将它与Spring Data 的 Repository关联起来的是它的名字。但是，要确保<code>eliteSweep</code>方法也被声明在<code>SpitterRepository</code>接口中。要实现这点，同时避免代码重复的最简单方式是修改<code>SpitterRepository</code>接口，让它扩展<code>SpitterSweeper</code>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SpitterRepository</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Spitter</span>, <span class="title">Long</span>&gt;,</span></span><br><span class="line"><span class="class">            <span class="title">SpitterSweeper</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，<code>Impl</code>后缀只是默认的做法，可以通过<code>@EnableJpaRepository</code>的<code>repositoryImplementationPostfix</code>属性来自定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableJpaRepositories</span>(</span><br><span class="line">  basePackages=<span class="string">"com.habuma.spittr.db"</span>,</span><br><span class="line">  repositoryImplementationPostfix=<span class="string">"Helper"</span>)</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jpa:repositories</span> <span class="attr">base-package</span>=<span class="string">"com.habuma.spittr.db"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">repository-impl-postfix</span>=<span class="string">"Helper"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样，Spring Data JPA将会查找名为<code>SpitterRepositoryHelper</code>的类，用它来匹配<code>SpitterRepository</code>接口。</p>
<h2 id="Spring-Data-MongoDB"><a href="#Spring-Data-MongoDB" class="headerlink" title="Spring Data MongoDB"></a>Spring Data MongoDB</h2><h3 id="配置MongoDB"><a href="#配置MongoDB" class="headerlink" title="配置MongoDB"></a>配置MongoDB</h3><p>为了使用Spring Data MongoDB，我们要在Spring配置中添加如下配置：</p>
<ul>
<li>启用Spring Data MongoDB的自动化Repository生成功能；</li>
<li>注册<code>MongoClient</code>，以便访问MongoDB数据库；</li>
<li>注册<code>MongoTemplate</code> Bean，实现基于模板的数据库访问。</li>
</ul>
<p>配置方法一：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories</span>(basePackages=<span class="string">"orders.db"</span>)  <span class="comment">//Enable MongoDB repositories</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span>  <span class="comment">//MongoClient bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> MongoFactoryBean <span class="title">mongo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MongoFactoryBean mongo = <span class="keyword">new</span> MongoFactoryBean();</span><br><span class="line">    mongo.setHost(<span class="string">"localhost"</span>);</span><br><span class="line">    <span class="keyword">return</span> mongo;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span>  <span class="comment">//MongoTemplate bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> MongoOperations <span class="title">mongoTemplate</span><span class="params">(Mongo mongo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MongoTemplate(mongo, <span class="string">"OrdersDB"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置方法二：让配置类扩展<code>AbstractMongoConfiguration</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories</span>(<span class="string">"orders.db"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MongoConfig</span> <span class="keyword">extends</span> <span class="title">AbstractMongoConfiguration</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> String <span class="title">getDatabaseName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"OrdersDB"</span>;  <span class="comment">//指定数据库名</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Mongo <span class="title">mongo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MongoClient();  <span class="comment">//创建Mongo客户端（Mongo运行在本地的27017端口）</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果MongoDB运行在其他机器上时，那么在创建<code>MongoClient</code>的时候进行指定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Mongo <span class="title">mongo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> MongoClient(<span class="string">"mongodbserver"</span>);</span><br><span class="line">  <span class="comment">//return new MongoClient("mongodbserver", 37017); //使用37017端口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果MongoDB运行在生产配置上，可能启用了认证功能，这时还需要提供应用的凭证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Environment env;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mongo <span class="title">mongo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  MongoCredential credential = MongoCredential.createMongoCRCredential(</span><br><span class="line">    env.getProperty(<span class="string">"mongo.username"</span>), </span><br><span class="line">    <span class="string">"OrdersDB"</span>,</span><br><span class="line">    env.getProperty(<span class="string">"mongo.password"</span>).toCharArray());</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MongoClient(</span><br><span class="line">    <span class="keyword">new</span> ServerAddress(<span class="string">"localhost"</span>, <span class="number">37017</span>),</span><br><span class="line">    Arrays.asList(credential));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置方法三：基于XML</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mongo</span>=<span class="string">"http://www.springframework.org/schema/data/mongo"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/data/mongo</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/data/mongo/spring-mongo.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mongo:repositories</span> <span class="attr">base-package</span>=<span class="string">"orders.db"</span> /&gt;</span><span class="comment">&lt;!--启用Repository生成功能--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mongo:mongo</span> /&gt;</span><span class="comment">&lt;!--声明Mongo Client--&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--创建MongoTemplate Bean--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mongoTemplate"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"org.springframework.data.mongodb.core.MongoTemplate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"mongo"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"OrdersDB"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="对象-文档映射"><a href="#对象-文档映射" class="headerlink" title="对象-文档映射"></a>对象-文档映射</h3><p>Spring Data MongoDB提供的对象-文档映射标注：</p>
<table>
<thead>
<tr>
<th>标注</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@Document</td>
<td>将领域对象映射到Mongo文档，类似于JPA的<code>@Entity</code>。</td>
</tr>
<tr>
<td>@Id</td>
<td>标示ID域。</td>
</tr>
<tr>
<td>@DbRef</td>
<td>标示某个域要引用其他的文档，这个文档有可能位于另外一个数据库中。</td>
</tr>
<tr>
<td>@Field</td>
<td>为文档域指定自定义的元数据。</td>
</tr>
<tr>
<td>@Version</td>
<td>标示版本域。</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="meta">@Field</span>(<span class="string">"client"</span>)  <span class="comment">//现在属性customer将会映射到client文档域，而不是默认的customer文档域</span></span><br><span class="line">  <span class="keyword">private</span> String customer;</span><br><span class="line">  <span class="keyword">private</span> String type;</span><br><span class="line">  <span class="keyword">private</span> Collection&lt;Item&gt; items = <span class="keyword">new</span> LinkedHashSet&lt;Item&gt;();</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getCustomer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> customer;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomer</span><span class="params">(String customer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.customer = customer;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.type = type;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Collection&lt;Item&gt; <span class="title">getItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> items;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItems</span><span class="params">(Collection&lt;Item&gt; items)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.items = items;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">private</span> Order order;</span><br><span class="line">  <span class="keyword">private</span> String product;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">double</span> price;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> quantity;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Order <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getProduct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> product;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProduct</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.product = product;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> price;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(<span class="keyword">double</span> price)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.price = price;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getQuantity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> quantity;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setQuantity</span><span class="params">(<span class="keyword">int</span> quantity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.quantity = quantity;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他的属性并没有添加标注，除非将属性设置为瞬时态（transient）的，否则Java对象中所有的域都会持久化为文档的域。并且如果我们不使用<code>@Field</code>标注进行设置的话，那么文档域中的名字将会与对应的Java属性名相同。</p>
<p>与关系型数据库不同，<code>items</code>属性是直接内嵌到<code>Order</code>文档中的。我们没必要为<code>Item</code>类添加<code>@Document</code>标注，也没有必要为它的域指定<code>@Id</code>。因为我们不会单独将<code>Item</code>持久化为文档。当然，可以使用<code>@Field</code>为<code>Item</code>的属性自定义元数据。</p>
<h3 id="创建Repository接口-1"><a href="#创建Repository接口-1" class="headerlink" title="创建Repository接口"></a>创建Repository接口</h3><p>自己创建的MongoDB Repository接口必须扩展自<code>Repository</code>接口，通常扩展<code>MongoRepository</code>接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderRepository</span></span></span><br><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Order</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MongoRepository</code>接口的第一个参数是带有<code>@Document</code>标注的对象类型，也就是该Repository要处理的类型；第二个参数是带有<code>@Id</code>标注的属性类型。</p>
<h4 id="根据方法签名定义查询方法-1"><a href="#根据方法签名定义查询方法-1" class="headerlink" title="根据方法签名定义查询方法"></a>根据方法签名定义查询方法</h4><p>Spring Data JPA支持的方法签名约定也适用于Spring Data MongoDB。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderRepository</span></span></span><br><span class="line"><span class="class">  	<span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Order</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function">List&lt;Order&gt; <span class="title">findByCustomer</span><span class="params">(String c)</span></span>;</span><br><span class="line">  <span class="function">List&lt;Order&gt; <span class="title">findByCustomerLike</span><span class="params">(String c)</span></span>;</span><br><span class="line">  <span class="function">List&lt;Order&gt; <span class="title">findByCustomerAndType</span><span class="params">(String c, String t)</span></span>;</span><br><span class="line">  <span class="function">List&lt;Order&gt; <span class="title">findByCustomerLikeAndType</span><span class="params">(String c, String t)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-Query标注声明自定义查询-1"><a href="#使用-Query标注声明自定义查询-1" class="headerlink" title="使用@Query标注声明自定义查询"></a>使用<code>@Query</code>标注声明自定义查询</h4><p><code>@Query</code>标注也可以用在MongoDB上，唯一的区别是：MongoDB的<code>@Query</code>标注接受的是一个JSON查询，而不是JPA查询。</p>
<p>例如：查询<code>customer</code>的名称为<code>&#39;Chuck Wagon&#39;</code>的指定类型订单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query</span>(<span class="string">"&#123;'customer': 'Chuck Wagon', 'type' : ?0&#125;"</span>)  <span class="comment">//???到底是?0还是?1</span></span><br><span class="line"><span class="function">List&lt;Order&gt; <span class="title">findChucksOrders</span><span class="params">(String t)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="混合自定义查询-1"><a href="#混合自定义查询-1" class="headerlink" title="混合自定义查询"></a>混合自定义查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderOperations</span> </span>&#123;</span><br><span class="line">	<span class="function">List&lt;Order&gt; <span class="title">findOrdersByType</span><span class="params">(String t)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">OrderOperations</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> MongoOperations mongo;  <span class="comment">//注入MongoTemplate</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">findOrdersByType</span><span class="params">(String t)</span> </span>&#123;</span><br><span class="line">    String type = t.equals(<span class="string">"NET"</span>) ? <span class="string">"WEB"</span> : t;</span><br><span class="line">    Criteria where = Criteria.where(<span class="string">"type"</span>).is(t);</span><br><span class="line">    Query query = Query.query(where);</span><br><span class="line">    <span class="keyword">return</span> mongo.find(query, Order<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderRepository</span></span></span><br><span class="line"><span class="class">  	<span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Order</span>, <span class="title">String</span>&gt;, <span class="title">OrderOperations</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-Data-Neo4j"><a href="#Spring-Data-Neo4j" class="headerlink" title="Spring Data Neo4j"></a>Spring Data Neo4j</h2><p>文档型数据库会将数据存储到粗粒度的文档中，而图数据库会将数据存储到多个细粒度的节点中，这些节点之间通过关系建立关联。图数据库中的一个节点通常会对应数据库中的一个概念（Concept），它会具备描述节点状态的属性。连接两个节点的关联关系可能也会带有属性。</p>
<p>图数据库比文档数据库更加通用，可能会成为关系型数据库的无模式（Schemaless）替代方案。</p>
<h3 id="配置Neo4j"><a href="#配置Neo4j" class="headerlink" title="配置Neo4j"></a>配置Neo4j</h3><h4 id="基于Java的配置"><a href="#基于Java的配置" class="headerlink" title="基于Java的配置"></a>基于Java的配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableNeo</span>4jRepositories(basePackages=<span class="string">"orders.db"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Neo4jConfig</span> <span class="keyword">extends</span> <span class="title">Neo4jConfiguration</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Neo4jConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setBasePackage(<span class="string">"orders"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span>(destroyMethod=<span class="string">"shutdown"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> GraphDatabaseService <span class="title">graphDatabaseService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GraphDatabaseFactory()</span><br><span class="line">      .newEmbeddedDatabase(<span class="string">"/tmp/graphdb"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@EnableNeo4jRepositories</code>标注能够让Spring Data Neo4j自动生成Neo4j Repository实现，它的<code>basePackages</code>属性设置为<code>orders.db</code>包，这样它就会扫描这个包来查找扩展<code>Repository</code>接口的接口。</p>
<p><code>setBasePackage</code>方法告诉Spring Data Neo4j要在<code>orders</code>包中查找<strong>模型类</strong>。</p>
<p>上面<code>graphDatabaseService</code>方法创建了嵌入式的Neo4j数据库。在Neo4j中，嵌入式数据库不要与内存数据库相混淆。这里的“嵌入式”是指数据库引擎与应用运行在同一个JVM中，作为应用的一部分，而不是独立的服务器。数据依然会持久化到文件系统中（在本例中，也就是<code>/tmp/graghdb</code>中）。</p>
<p>如果要连接远程Neo4j数据库，我们需要<code>spring-data-neo4j-rest</code>库在类路径下。这样，我们就可以配置<code>SpringRestGraphDatabase</code>来通过RESTful API来访问远程的Neo4j数据库：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(destroyMethod=<span class="string">"shutdown"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> GraphDatabaseService <span class="title">graphDatabaseService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> SpringRestGraphDatabase(</span><br><span class="line">    <span class="string">"http://graphdbserver:7474/db/data/"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果远程数据库需要认证，则还要提供应用的凭证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(destroyMethod=<span class="string">"shutdown"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> GraphDatabaseService <span class="title">graphDatabaseService</span><span class="params">(Environment env)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> SpringRestGraphDatabase(</span><br><span class="line">    <span class="string">"http://graphdbserver:7474/db/data/"</span>,</span><br><span class="line">    env.getProperty(<span class="string">"db.username"</span>), env.getProperty(<span class="string">"db.password"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="基于XML的配置"><a href="#基于XML的配置" class="headerlink" title="基于XML的配置"></a>基于XML的配置</h4><p>嵌入式数据库配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:neo4j</span>=<span class="string">"http://www.springframework.org/schema/data/neo4j"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/data/neo4j</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/data/neo4j/spring-neo4j.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">neo4j:config</span></span></span><br><span class="line">                storeDirectory="/tmp/graphdb" &lt;!--数据存储的位置--&gt;</span><br><span class="line">                base-package="orders" /&gt;<span class="comment">&lt;!--模型类的基础包--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">neo4j:repositories</span> <span class="attr">base-package</span>=<span class="string">"orders.db"</span> /&gt;</span><span class="comment">&lt;!--启用Repository生成功能，并指定扫描Repository的基础包--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>远程Neo4j数据库配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">neo4j:config</span> <span class="attr">base-package</span>=<span class="string">"orders"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">graphDatabaseService</span>=<span class="string">"graphDatabaseService"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"graphDatabaseService"</span> <span class="attr">class</span>=</span></span><br><span class="line"><span class="tag">      "<span class="attr">org.springframework.data.neo4j.rest.SpringRestGraphDatabase</span>"&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"http://graphdbserver:7474/db/data/"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"db.username"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"db.password"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="对象-实体映射"><a href="#对象-实体映射" class="headerlink" title="对象-实体映射"></a>对象-实体映射</h3><p>Neo4j定义了两种类型的实体：</p>
<ul>
<li>节点（Node）：反映了应用中的事物。</li>
<li>关联关系（Relationship）：定义了这些事物是如何联系在一起的。</li>
</ul>
<p>Spring Data Neo4j的标注：</p>
<table>
<thead>
<tr>
<th>标注</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@NodeEntity</td>
<td>将Java类型声明为节点实体。</td>
</tr>
<tr>
<td>@RelationshipEntity</td>
<td>将Java类型声明为关联关系实体。</td>
</tr>
<tr>
<td>@StartNode</td>
<td>将某个属性声明为关联关系实体的开始节点。</td>
</tr>
<tr>
<td>@EndNode</td>
<td>将某个属性声明为关联关系实体的结束节点。</td>
</tr>
<tr>
<td>@Fetch</td>
<td>将实体的属性声明为立即加载。</td>
</tr>
<tr>
<td>@GraphId</td>
<td>将某个属性设置为实体的ID域（类型必须是<code>Long</code>）。Neo4j上所有实体（不管是节点实体，还是关联关系实体）必需要有一个图ID。</td>
</tr>
<tr>
<td>@GraphProperty</td>
<td>显式声明某个属性。</td>
</tr>
<tr>
<td>@GraphTraversal</td>
<td>声明某个属性会自动提供一个<code>iterable</code>元素，这个元素是图遍历所构建的。</td>
</tr>
<tr>
<td>@Indexed</td>
<td>声明某个属性应该被索引。</td>
</tr>
<tr>
<td>@Labels</td>
<td>为<code>@NodeEntity</code>声明标签。</td>
</tr>
<tr>
<td>@Query</td>
<td>声明某个属性会自动提供一个<code>iterable</code>元素，这个元素是执行给定的Cypher查询所构建的。</td>
</tr>
<tr>
<td>@QueryResult</td>
<td>声明某个Java或接口能够持有查询的结果。</td>
</tr>
<tr>
<td>@RelatedTo</td>
<td>通过某个属性，声明当前的<code>@NodeEntity</code>与另外一个<code>@NodeEntity</code>之间的关联关系。</td>
</tr>
<tr>
<td>@RelatedToVia</td>
<td>在<code>@NodeEntity</code>上声明某个属性，指定其引用该节点所属的某一个<code>@RelationshipEntity</code>。</td>
</tr>
<tr>
<td>@RelationshipType</td>
<td>将某个域声明为关联实体类型。</td>
</tr>
<tr>
<td>@ResultColumn</td>
<td>在带有<code>@QueryResult</code>标注的类型上，将某个属性声明为获取查询结果集中的某个特定列。</td>
</tr>
</tbody></table>
<h4 id="简单关联关系示例"><a href="#简单关联关系示例" class="headerlink" title="简单关联关系示例"></a>简单关联关系示例</h4><p><img src="SpringDA/neo4j-simple.png" alt="关系本身不包含任何属性"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NodeEntity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">  <span class="meta">@GraphId</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">private</span> String customer;</span><br><span class="line">  <span class="keyword">private</span> String type;</span><br><span class="line">  <span class="meta">@RelatedTo</span>(type=<span class="string">"HAS_ITEMS"</span>)</span><br><span class="line">  <span class="keyword">private</span> Set&lt;Item&gt; items = <span class="keyword">new</span> LinkedHashSet&lt;Item&gt;();</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NodeEntity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">  <span class="meta">@GraphId</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">private</span> String product;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">double</span> price;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> quantity;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实体中没有带任何标注的属性（例如：<code>customer</code>等），只要它们不是瞬态的，都会成为数据库中节点的属性。</p>
<p><code>Order</code>和<code>Item</code>之间的关联关系很简单，关系本身并不包含任何的数据。因此，<code>@RelatedTo</code>标注就足以定义关联关系。</p>
<h4 id="关联关系实体示例"><a href="#关联关系实体示例" class="headerlink" title="关联关系实体示例"></a>关联关系实体示例</h4><p><img src="SpringDA/neo4j-relationship-entity.png" alt="关联关系实体自身具有属性"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RelationshipEntity</span>(type=<span class="string">"HAS_LINE_ITEM_FOR"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LineItem</span> </span>&#123;</span><br><span class="line">  <span class="meta">@GraphId</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="meta">@StartNode</span></span><br><span class="line">  <span class="keyword">private</span> Order order;  <span class="comment">//开始节点</span></span><br><span class="line">  <span class="meta">@EndNode</span></span><br><span class="line">  <span class="keyword">private</span> Product product;  <span class="comment">//结束节点</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> quantity;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建Repository接口-2"><a href="#创建Repository接口-2" class="headerlink" title="创建Repository接口"></a>创建Repository接口</h3><p>自己创建的Neo4j Repository接口必须扩展自<code>Repository</code>接口，通常扩展<code>GraphRepository</code>接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderRepository</span> <span class="keyword">extends</span> <span class="title">GraphRepository</span>&lt;<span class="title">Order</span>&gt; </span>&#123;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="根据方法签名定义查询方法-2"><a href="#根据方法签名定义查询方法-2" class="headerlink" title="根据方法签名定义查询方法"></a>根据方法签名定义查询方法</h4><p>Spring Data JPA支持的方法签名约定也适用于Spring Data Neo4j。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderRepository</span> <span class="keyword">extends</span> <span class="title">GraphRepository</span>&lt;<span class="title">Order</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function">List&lt;Order&gt; <span class="title">findByCustomer</span><span class="params">(String customer)</span></span>;</span><br><span class="line">  <span class="function">List&lt;Order&gt; <span class="title">findByCustomerAndType</span><span class="params">(String customer, String type)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-Query标注声明自定义查询-2"><a href="#使用-Query标注声明自定义查询-2" class="headerlink" title="使用@Query标注声明自定义查询"></a>使用<code>@Query</code>标注声明自定义查询</h4><p>在Spring Data Neo4j中，<code>@Query</code>标注使用的是Cypher查询。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query</span>(<span class="string">"match (o:Order)-[:HAS_ITEMS]-&gt;(i:Item) "</span> +</span><br><span class="line">       <span class="string">"where i.product='Spring in Action' return o"</span>)</span><br><span class="line"><span class="function">List&lt;Order&gt; <span class="title">findSiAOrders</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="混合自定义查询-2"><a href="#混合自定义查询-2" class="headerlink" title="混合自定义查询"></a>混合自定义查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderOperations</span> </span>&#123;</span><br><span class="line">  <span class="function">List&lt;Order&gt; <span class="title">findSiAOrders</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderRepository</span></span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">GraphRepository</span>&lt;<span class="title">Order</span>&gt;, <span class="title">OrderOperations</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">OrderOperations</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Neo4jOperations neo4j;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">OrderRepositoryImpl</span><span class="params">(Neo4jOperations neo4j)</span> </span>&#123; <span class="comment">//注入Neo4jTemplate</span></span><br><span class="line">    <span class="keyword">this</span>.neo4j = neo4j;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">findSiAOrders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Result&lt;Map&lt;String, Object&gt;&gt; result = neo4j.query(</span><br><span class="line">      <span class="string">"match (o:Order)-[:HAS_ITEMS]-&gt;(i:Item) "</span> +</span><br><span class="line">      <span class="string">"where i.product='Spring in Action' return o"</span>,</span><br><span class="line">      EndResult&lt;Order&gt; endResult = result.to(Order<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">      <span class="keyword">return</span> IteratorUtil.asList(endResult);</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-Data-Redis"><a href="#Spring-Data-Redis" class="headerlink" title="Spring Data Redis"></a>Spring Data Redis</h2><p>Redis是一种key-value存储的数据库，它可看作是持久化的哈希Map。</p>
<p>Spring Data的自动生成Repository功能并没有应用到Redis上。Spring Data Redis主要是通过模板来访问数据库。</p>
<h3 id="配置Redis的连接工厂"><a href="#配置Redis的连接工厂" class="headerlink" title="配置Redis的连接工厂"></a>配置Redis的连接工厂</h3><p>Redis连接工厂会生成到Redis数据库服务器的连接。Spring Data Redis为四种Redis客户端实现提供了连接工厂：</p>
<ul>
<li>JedisConnectionFactory</li>
<li>JredisConnectionFactory</li>
<li>LettuceConnectionFactory</li>
<li>SrpConnectionFactory</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisConnectionFactory <span class="title">redisCF</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> JedisConnectionFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面通过默认构造器创建的连接工厂会向<code>localhost</code>上的<code>6379</code>端口创建连接，并且没有密码。下面的配置将连接远程需要认证的服务器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisConnectionFactory <span class="title">redisCF</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  JedisConnectionFactory cf = <span class="keyword">new</span> JedisConnectionFactory();</span><br><span class="line">  cf.setHostName(<span class="string">"redis-server"</span>);</span><br><span class="line">  cf.setPort(<span class="number">7379</span>);</span><br><span class="line">  cf.setPassword(<span class="string">"foobared"</span>);</span><br><span class="line">  <span class="keyword">return</span> cf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用RedisTemplate"><a href="#使用RedisTemplate" class="headerlink" title="使用RedisTemplate"></a>使用RedisTemplate</h3><p>不使用模板的直接访问Redis，需要操作字节数组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RedisConnectionFactory cf = ...;</span><br><span class="line">RedisConnection conn = cf.getConnection();</span><br><span class="line"></span><br><span class="line">conn.set(<span class="string">"greeting"</span>.getBytes(), <span class="string">"Hello World"</span>.getBytes());</span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] greetingBytes = conn.get(<span class="string">"greeting"</span>.getBytes());</span><br><span class="line">String greeting = <span class="keyword">new</span> String(greetingBytes);</span><br></pre></td></tr></table></figure>

<p>Spring Data Redis提供了两个模板来简化Redis数据访问：</p>
<ul>
<li>RedisTemplate</li>
<li>StringRedisTempate：key和value都是<code>String</code>类型。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RedisConnectionFactory cf = ...;</span><br><span class="line">RedisTemplate&lt;String, Product&gt; redis = <span class="keyword">new</span> RedisTemplate&lt;String, Product&gt;();</span><br><span class="line">redis.setConnectionFactory(cf);</span><br></pre></td></tr></table></figure>

<p><code>RedisTemplate</code>的第一个泛型参数是key的类型，第二个是value的类型。</p>
<p>如果你经常使用<code>RedisTemplate</code>或<code>StringRedisTempate</code>，可以将它们注册为Bean，然后注入到需要的地方：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> StringRedisTemplate <span class="title">stringRedisTemplate</span><span class="params">(RedisConnectionFactory cf)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> StringRedisTemplate(cf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RedisTemplate</code>的很多功能是以子API的形式提供的：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>子API接口（返回值类型）</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>opsForValue()</td>
<td>ValueOperations&lt;K, V&gt;</td>
<td>操作简单值的条目。</td>
</tr>
<tr>
<td>opsForList()</td>
<td>ListOperations&lt;K, V&gt;</td>
<td>操作list值的条目。</td>
</tr>
<tr>
<td>opsForSet()</td>
<td>SetOperations&lt;K, V&gt;</td>
<td>操作set值的条目。</td>
</tr>
<tr>
<td>opsForZSet()</td>
<td>ZSetOperations&lt;K, V&gt;</td>
<td>操作ZSet值（排序的set）的条目。</td>
</tr>
<tr>
<td>opsForHash()</td>
<td>HashOperations&lt;K, HK, HV&gt;</td>
<td>操作hash值的条目。</td>
</tr>
<tr>
<td>boundValueOps(K)</td>
<td>BoundValueOperations&lt;K, V&gt;</td>
<td>以绑定指定key的方式，操作简单值的条目。</td>
</tr>
<tr>
<td>boundListOps(K)</td>
<td>BoundListOperations&lt;K, V&gt;</td>
<td>以绑定指定key的方式，操作list值的条目。</td>
</tr>
<tr>
<td>boundSetOps(K)</td>
<td>BoundSetOperations&lt;K, V&gt;</td>
<td>以绑定指定key的方式，操作set值的条目。</td>
</tr>
<tr>
<td>boundZSetOps(K)</td>
<td>BoundZSetOperations&lt;K, V&gt;</td>
<td>以绑定指定key的方式，操作ZSet值的条目。</td>
</tr>
<tr>
<td>boundHashOps(K)</td>
<td>BoundHashOperations&lt;K, V&gt;</td>
<td>以绑定指定key的方式，操作hash值的条目。</td>
</tr>
</tbody></table>
<h4 id="操作简单值"><a href="#操作简单值" class="headerlink" title="操作简单值"></a>操作简单值</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis.opsForValue().set(product.getSku(), product);</span><br><span class="line"></span><br><span class="line">Product product = redis.opsForValue().get(<span class="string">"123456"</span>);<span class="comment">//如果给定的key不存在，则返回null</span></span><br></pre></td></tr></table></figure>

<h4 id="操作List类型值"><a href="#操作List类型值" class="headerlink" title="操作List类型值"></a>操作List类型值</h4><p>在List条目的尾部添加一个值，如果指定key的列表不存在，则会创建一个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.opsForList().rightPush(<span class="string">"cart"</span>, product);</span><br></pre></td></tr></table></figure>

<p>在列表条目的头部添加一个值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.opsForList().leftPush(<span class="string">"cart"</span>, product);</span><br></pre></td></tr></table></figure>

<p>从列表中弹出（获取并删除）一个值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Product first = redis.opsForList().leftPop(<span class="string">"cart"</span>);</span><br><span class="line">Product last = redis.opsForList().rightPop(<span class="string">"cart"</span>);</span><br></pre></td></tr></table></figure>

<p>获取指定范围内的一个或多个值（不会删除列表中任何元素）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Product&gt; products = redis.opsForList().range(<span class="string">"cart"</span>, <span class="number">2</span>, <span class="number">12</span>); <span class="comment">//从索引为2（包含）到索引为12（不包含）</span></span><br></pre></td></tr></table></figure>

<p>如果范围超出了列表的边界，那么只会返回索引在范围内的元素。如果该索引范围内没有元素的话，将会返回一个空的列表。</p>
<h4 id="操作Set类型值"><a href="#操作Set类型值" class="headerlink" title="操作Set类型值"></a>操作Set类型值</h4><p>往Set中添加一个元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.opsForSet().add(<span class="string">"cart"</span>, product);</span><br></pre></td></tr></table></figure>

<p>差集、交集、并集：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Product&gt; diff = redis.opsForSet().difference(<span class="string">"cart1"</span>, <span class="string">"cart2"</span>);</span><br><span class="line">List&lt;Product&gt; union = redis.opsForSet().union(<span class="string">"cart1"</span>, <span class="string">"cart2"</span>);</span><br><span class="line">List&lt;Product&gt; isect = redis.opsForSet().isect(<span class="string">"cart1"</span>, <span class="string">"cart2"</span>);</span><br></pre></td></tr></table></figure>

<p>移除元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.opsForSet().remove(product);</span><br></pre></td></tr></table></figure>

<p>随机获取Set中的一个元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Product random = redis.opsForSet().randomMember(<span class="string">"cart"</span>);</span><br></pre></td></tr></table></figure>

<p>因为Set没有索引和内部排序，无法精准定位某个元素。</p>
<h4 id="将操作绑定到指定key上"><a href="#将操作绑定到指定key上" class="headerlink" title="将操作绑定到指定key上"></a>将操作绑定到指定key上</h4><p>假如我们需要对某个key上的数据进行一系列操作，不希望每次都会指定同一个key多次。使用以<code>bound</code>开头的方法，只需要绑定一次key，则后续的操作都是针对该key：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BoundListOperations&lt;String, Product&gt; cart = redis.boundListOps(<span class="string">"cart"</span>);</span><br><span class="line">Product popped = cart.rightPop();</span><br><span class="line">cart.rightPush(product1);</span><br><span class="line">cart.rightPush(product2);</span><br><span class="line">cart.rightPush(product3);</span><br></pre></td></tr></table></figure>

<h3 id="使用key和value的序列化器"><a href="#使用key和value的序列化器" class="headerlink" title="使用key和value的序列化器"></a>使用key和value的序列化器</h3><p>当某个条目保存到Redis时，key和value都会使用Redis序列化器进行序列化。Spring Data Redis提供了多个这样的序列化器：</p>
<ul>
<li>GenericToStringSerializer：使用Spring转换服务进行序列化；</li>
<li>JacksonJsonRedisSerializer：使用Jackson 1，将对象序列化为JSON；</li>
<li>Jackson2JsonRedisSerializer：使用Jackson 2，将对象序列化为JSON；</li>
<li>JdkSerializationRedisSerializer：使用Java序列化；（RedisTemplate的默认序列化器）</li>
<li>OxmSerializer：使用Spring O/X映射的编排器（marshaler）和解排器（unmarshaler）实现序列化，用于XML序列化；</li>
<li>StringRedisSerializer：序列化String类型的key和value。（StringRedisTemplate的默认序列化器）</li>
</ul>
<p>假设当使用RedisTemplate时，我们希望将Product类型的value序列为JSON，而key是String类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Product&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory cf)</span> </span>&#123;</span><br><span class="line">  RedisTemplate&lt;String, Product&gt; redis = <span class="keyword">new</span> RedisTemplate&lt;String, Product&gt;();</span><br><span class="line">  redis.setConnectionFactory(cf);</span><br><span class="line">  redis.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">  redis.setValueSerializer(<span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;Product&gt;(Product<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">  <span class="keyword">return</span> redis;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="事务管理"><a href="#事务管理" class="headerlink" title="事务管理"></a>事务管理</h1><p>事务（Transaction）允许你将几个操作组合成一个要么全部发生，要么全部不发生的工作单元。</p>
<p><img src="SpringDA/%E8%B4%AD%E7%A5%A8%E4%BA%8B%E5%8A%A1.png" alt="购票事务"></p>
<h2 id="事务的特性"><a href="#事务的特性" class="headerlink" title="事务的特性"></a>事务的特性</h2><p>原子性（Atomic）：原子性确保事务中的所有操作全部发生或全部不发生。如果所有的活动都成功了，事务也就成功了。如果任意一个活动失败了，整个事务也失败并回滚。</p>
<p>一致性（Consistent）：一旦事务完成（不管成功还是失败），系统必须确保它所建模的业务处于一致状态。现实的数据不应该被损坏。</p>
<p>隔离性（Isolated）：事务允许多个用户对相同的数据进行操作，每个用户的操作不会与其他用户纠缠在一起。因此，事务应该被彼此隔离，避免发生同步读写相同数据的事情（注意：隔离性往往涉及到锁定数据库中的行或表）。</p>
<p>持久性（Durable）：一旦事务完成，事务的结果应该持久化，这样就能从任何的系统崩溃中恢复过来。</p>
<h2 id="Spring对事务管理的支持"><a href="#Spring对事务管理的支持" class="headerlink" title="Spring对事务管理的支持"></a>Spring对事务管理的支持</h2><p>传统上，Java EE开发人员有两种事务管理选择：全局或本地事务，这两种事务都有很大的局限性。</p>
<p>全局事务使您可以使用多个事务资源，通常是关系数据库和消息队列。应用程序服务器通过JTA管理全局事务，这是一个繁琐的API（部分原因是它的异常模型）。此外，JTA <code>UserTransaction</code>通常需要从JNDI获取，这意味着您还需要使用JNDI才能使用JTA。全局事务的使用限制了应用程序代码的任何潜在重用，因为JTA通常仅在应用程序服务器环境中可用。</p>
<p>以前，使用全局事务的首选方法是通过EJB CMT（容器管理事务）。 CMT是一种声明式事务管理（与程序化事务管理不同）。 EJB CMT消除了与事务相关的JNDI查找的需要，尽管使用EJB本身需要使用JNDI。它消除了编写Java代码以控制事务的大部分但不是全部的需要。重要的缺点是CMT与JTA和应用服务器环境相关联。此外，仅当选择在EJB中（或至少在事务EJB外观之后）实现业务逻辑时，它才可用。</p>
<p>本地事务是特定于资源的，例如与JDBC连接关联的事务。本地事务可能更容易使用，但具有明显的缺点：它们无法跨多个事务资源工作。例如，使用JDBC连接管理事务的代码无法在全局JTA事务中运行。由于应用程序服务器不参与事务管理，因此无法确保跨多个资源的正确性。 另一个缺点是本地事务对编程模型是侵入性的。</p>
<p>Spring解决了全局和本地事务的缺点。它允许应用程序开发人员在任何环境中使用一致的编程模型您编写一次代码，它可以从不同环境中的不同事务管理策略中受益。 Spring Framework提供了声明式和编程式事务管理。大多数用户更喜欢声明式事务管理，我们建议在大多数情况下使用。</p>
<p>不像EJB与JTA耦合在一起，Spring通过回调机制将实际的事务实现从事务性的代码中抽象出来。实际上，Spring对事务的支持甚至不需要JTA的实现。如果你的应用程序只使用一种持久化资源，Spring可以使用持久化机制本身所提供的事务性支持，这包括JDBC、Hibernate以及JPA。但是如果应用程序的事务跨多个资源，那么Spring会使用第三方（应用服务器）的JTA实现来支持分布式（XA）事务。</p>
<h2 id="事务管理器"><a href="#事务管理器" class="headerlink" title="事务管理器"></a>事务管理器</h2><p>Spring并不直接管理事务，而是提供了多种事务管理器，它们将事务管理的职责委托给JTA或其他持久化机制所提供的平台相关的事务实现。</p>
<p><img src="SpringDA/%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8.png" alt="事务管理器"></p>
<h3 id="JDBC事务"><a href="#JDBC事务" class="headerlink" title="JDBC事务"></a>JDBC事务</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="JPA事务"><a href="#JPA事务" class="headerlink" title="JPA事务"></a>JPA事务</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.JpaTransactionManager"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"entityManagerFactory"</span> <span class="attr">ref</span>=<span class="string">"entityManagerFactory"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>JpaTransactionManager</code>将与由工厂所产生的JPA <code>EntityManager</code>合作来构建事务。</p>
<p><code>JpaTransactionManager</code>还支持将事务应用于简单的JDBC操作这中，这些JDBC操作所使用的<code>DataSource</code>与<code>EntityManagerFactory</code>所使用的<code>DataSource</code>必须是相同的。为了做到这一点，<code>JpaTransactionManager</code>必须装配一个<code>JpaDialect</code>实现。例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jpaDialect"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.vendor.EclipseLinkJpaDialect"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后，将<code>JpaDialect</code> Bean装配到<code>JtaTransactionManager</code>中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.JtaTransactionManager"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"entityManagerFactory"</span> <span class="attr">ref</span>=<span class="string">"entityManagerFactory"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaDialect"</span> <span class="attr">ref</span>=<span class="string">"jpaDialect"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Hibernate事务"><a href="#Hibernate事务" class="headerlink" title="Hibernate事务"></a>Hibernate事务</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.orm.hibernate5.HibernateTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sessionFactory"</span> <span class="attr">ref</span>=<span class="string">"sessionFactory"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="JTA事务"><a href="#JTA事务" class="headerlink" title="JTA事务"></a>JTA事务</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.transaction.jta.JtaTransactionManager"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>JtaTransactionManager</code>不需要了解<code>DataSource</code>（或任何其他特定资源），因为它使用容器的全局事务管理基础结构。</p>
<h2 id="编程式事务"><a href="#编程式事务" class="headerlink" title="编程式事务"></a>编程式事务</h2><p>声明式事务只能在方法级别声明事务，如果想更好地控制事务边界，则编码式事务是唯一的办法。</p>
<p>首先，注入<code>TransactionTemplate</code> 实例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"spitterService"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"com.habuma.spitter.service.SpitterServiceImpl"</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"txTemplate"</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.transaction.support.TransactionTemplate"</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"transactionManager"</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后，通过<code>TransactionTemplate</code>来添加事务性边界：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveSpittle</span><span class="params">(<span class="keyword">final</span> Spittle spittle)</span> </span>&#123;</span><br><span class="line">  txTemplate.execute(<span class="keyword">new</span> TransactionCallback&lt;Void&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doInTransaction</span><span class="params">(TransactionStatus txStatus)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        spitterDao.saveSpittle(spittle);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        txStatus.setRollbackOnly();</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="声明式事务"><a href="#声明式事务" class="headerlink" title="声明式事务"></a>声明式事务</h2><p>Spring对声明式事务的支持是通过使用Spring AOP框架实现的。</p>
<p>Spring通过<code>tx</code>命名空间或<code>@Transactional</code>标注来声明事务。</p>
<h3 id="定义事务属性"><a href="#定义事务属性" class="headerlink" title="定义事务属性"></a>定义事务属性</h3><p><img src="SpringDA/%E4%BA%8B%E5%8A%A1%E5%B1%9E%E6%80%A7.png" alt="事务属性"></p>
<h4 id="传播行为"><a href="#传播行为" class="headerlink" title="传播行为"></a>传播行为</h4><p>传播行为（Propagation Behavior）定义了客户端与被调用方法之间的事务边界。也就是说，定义了何时创建一个事务或何时使用已有的事务。</p>
<table>
<thead>
<tr>
<th>传播行为</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>PROPAGATION_MANDATORY</td>
<td>表示该方法必须在事务中运行。如果当前事务不存在，则会抛出一个异常。</td>
</tr>
<tr>
<td>PROPAGATION_NESTED</td>
<td>表示如果当前已经存在一个事务，则该方法将会在嵌套事务中运行。嵌套的事务可以独立于当前事务进行单独地提交或回滚。如果当前事务不存在，则其行为与<code>PROPAGATION_REQUIRED</code>一样。注意各厂商对这种传播行为的支持是有所差异的。</td>
</tr>
<tr>
<td>PROPAGATION_NEVER</td>
<td>表示当前方法不应该运行在事务上下文中。如果当前正有一个事务在运行，则会抛出异常。</td>
</tr>
<tr>
<td>PROPAGATION_NOT_SUPPORTED</td>
<td>表示该方法不应该运行在事务中，如果存在当前事务，在该方法运行期间，当前事务将被挂起。如果使用<code>JTATransactionManager</code>，则需要访问<code>TransactionManager</code>。</td>
</tr>
<tr>
<td>PROPAGATION_REQUIRED</td>
<td>表示当前方法必须运行在事务中。如果当前事务存在，方法将会在该事务中运行。否则，会启动一个新的事务。</td>
</tr>
<tr>
<td>PROPAGATION_REQUIRES_NEW</td>
<td>表示当前方法必须运行在它自己的事务中（这意味着事务边界与方法自己的边界是一样的：方法在开始执行时启动一个新事务，并在方法返回或抛出异常时结束该事务）。一个新的事务将被启动，如果存在当前事务，在该方法执行期间，当前事务会被挂起；如果使用<code>JTATransactionManager</code>，则需要访问<code>TransactionManager</code>。</td>
</tr>
<tr>
<td>PROPAGATION_SUPPORTS</td>
<td>表示当前方法不需要事务上下文，但是如果存在当前事务，则该方法会在这个事务中运行。</td>
</tr>
</tbody></table>
<h4 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h4><p>隔离级别（Isolation Level）定义了一个事务可能受其他并发事务影响的程度。</p>
<p>多个事务并发运行时，可能会导致以下问题：</p>
<ul>
<li>脏读（Dirty Reads）：脏读发生在一个事务读取了另一个事务改写但尚未提交的数据时。如果改写在稍后被回滚，则第一个事务获取的数据就是无效的。</li>
<li>不可重复读（Nonrepeatable Read）：不可重复读发生在一个事务执行相同的查询两次或两次以上，但是每次都得到不同的数据时。这通常是因为另一个并发事务在两次查询期间更新了数据。</li>
<li>幻读（Phantom Read）：幻读与不可重复读类似，它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现多了一些原本不存在的记录。</li>
</ul>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ISOLATION_DEFAULT</td>
<td>使用后端数据库默认的隔离级别。</td>
</tr>
<tr>
<td>ISOLATION_READ_UNCOMMITTED</td>
<td>允许读取尚未提交的数据变更，可能会导致脏读、幻读或不可重复读。</td>
</tr>
<tr>
<td>ISOLATION_READ_COMMITTED</td>
<td>允许读取并发事务已经提交的数据。可以阻止脏读，但是幻读或不可重复读仍有可能发生。</td>
</tr>
<tr>
<td>ISOLATION_REPEATABLE_READ</td>
<td>对同一字段的多次读取结果是一致的，除非数据是被本事务自己所修改。可以阻止脏读和不可重复读，但幻读仍有可能发生。</td>
</tr>
<tr>
<td>ISOLATION_SERIALIZABLE</td>
<td>完全服从ACID的隔离级别，确保阻止脏读、不可重复读以及幻读。这是最慢的事务隔离级别，因为它通常是通过完全锁定事务相关的数据库表来实现的。</td>
</tr>
</tbody></table>
<h4 id="只读"><a href="#只读" class="headerlink" title="只读"></a>只读</h4><p>如果事务只对后端的数据库进行读操作，数据库可以利用事务的只读特性来进行一些特定的优化。</p>
<p>因为只读优化是在事务启动的时候由数据库实施的，只有对那些具备启动一个新事务的传播行为（PROPAGATION_REQUIRED、PROPAGATION_REQUIRES_NEW、PROPAGATION_NESTED）的方法来说，将事务声明为只读才有意义。</p>
<p>另外，如果采用Hibernate作为持久化机制，则将事务声明为只读会导致Hibernate的<code>flush</code>模式被设置为<code>FLUSH_NEVER</code>。这会告诉Hibernate避免和数据库进行不必要的对象同步，并将所有的更新延迟到事务结束。</p>
<h4 id="事务超时"><a href="#事务超时" class="headerlink" title="事务超时"></a>事务超时</h4><p>事务不能运行太长时间，因为事务可能涉及对后端数据库的锁定，长时间的事务会不必要地占用数据库资源。事务超时（Timeout）是指声明一个事务，在特定的秒数后自动回滚，而不是等待其结束。</p>
<p>因为超时时钟会在事务开始时启动，因此，只有对那些具备启动一个新事务的传播行为（PROPAGATION_REQUIRED、PROPAGATION_REQUIRES_NEW、PROPAGATION_NESTED）的方法来说，声明事务超时才有意义。</p>
<h4 id="回滚规则"><a href="#回滚规则" class="headerlink" title="回滚规则"></a>回滚规则</h4><p>回滚规则定义了哪些异常会导致事务回滚而哪些不会。默认情况下，事务只有在遇到运行期异常时才会回滚，而在遇到检查型异常时不会回滚（这一行为与EJB的回滚行为是一致的）。</p>
<h3 id="在XML中定义事务"><a href="#在XML中定义事务" class="headerlink" title="在XML中定义事务"></a>在XML中定义事务</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"txManager"</span>&gt;</span><span class="comment">&lt;!--声明事务性策略--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"save*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span> <span class="attr">propagation</span>=<span class="string">"SUPPORTS"</span> <span class="attr">read-only</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"spitterServiceOperation"</span> </span></span><br><span class="line"><span class="tag">                  <span class="attr">expression</span>=<span class="string">"execution(* *..SpitterService.*(..))"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> <span class="attr">pointcut-ref</span>=<span class="string">"spitterServiceOperation"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line">  …</span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>事务属性是通过<code>&lt;tx:method&gt;</code>元素的属性来定义的：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>isolation</td>
<td>指定事务的隔离级别。</td>
</tr>
<tr>
<td>propagation</td>
<td>定义事务的传播规则。</td>
</tr>
<tr>
<td>read-only</td>
<td>指定事务是否为只读。</td>
</tr>
<tr>
<td>rollback-for</td>
<td>指定事务对于哪些检查型异常应当回滚，而不提交。</td>
</tr>
<tr>
<td>no-rollback-for</td>
<td>指定事务对于哪些异常应当继续运行，而不回滚。</td>
</tr>
<tr>
<td>timeout</td>
<td>对于长时间运行的事务定义超时时间。</td>
</tr>
</tbody></table>
<p>当使用<code>&lt;tx:advice&gt;</code>来声明事务时，你还需要一个事务管理器。如果事务管理器的<code>id</code>为<code>transactionManager</code>，则可以省略<code>transaction-manager</code>属性。否则，必须显式指定。</p>
<p><code>&lt;tx:advice&gt;</code>只是定义了AOP通知，用于把事务边界通知给方法，但没有声明哪些Bean应该被通知——我们需要一个切点来做这件事。这就是<code>&lt;aop:pointcut&gt;</code>和<code>&lt;aop:advisor&gt;</code>要做的事。</p>
<h3 id="定义标注驱动的事务"><a href="#定义标注驱动的事务" class="headerlink" title="定义标注驱动的事务"></a>定义标注驱动的事务</h3><p>首先，在XML中配置启用标注驱动的事务：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"txManager"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>transaction-manager</code>属性的默认值是<code>transactionManager</code>。</p>
<p><code>&lt;tx:annotation-driven</code>元素告诉Spring检查上下文中所有的Bean，并查找使用<code>@Transactional</code>标注的Bean（不管这个标注是用在类级别上，还是方法级别上）。对于每个使用<code>@Transactional</code>标注的Bean，<code>&lt;tx:annotation-driven</code>会自动为它添加事务通知。通知的事务属性是通过<code>@Transactional</code>标注的参数来定义的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>(propagation=Propagation.SUPPORTS, readOnly=<span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpitterServiceImpl</span> <span class="keyword">implements</span> <span class="title">SpitterService</span> </span>&#123;</span><br><span class="line">  …</span><br><span class="line">  <span class="meta">@Transactional</span>(propagation=Propagation.REQUIRED, readOnly=<span class="keyword">false</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSpitter</span><span class="params">(Spitter spitter)</span> </span>&#123;</span><br><span class="line">    …</span><br><span class="line">  &#125;</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/11/12/SpringSecurity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/12/SpringSecurity/" class="post-title-link" itemprop="url">SpringSecurity</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-12 09:46:19" itemprop="dateCreated datePublished" datetime="2018-11-12T09:46:19+08:00">2018-11-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Spring Security是为基于Spring的应用程序提供声明式安全保护的安全框架。</p>
<p>Spring Security最初被称为Acegi Security。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/11/12/SpringSecurity/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/11/01/Red/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/01/Red/" class="post-title-link" itemprop="url">Red</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-01 09:32:24" itemprop="dateCreated datePublished" datetime="2018-11-01T09:32:24+08:00">2018-11-01</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><a href="https://www.red-lang.org/" target="_blank" rel="noopener">Red</a>是一个全栈的编程语言，它是<a href="http://rebol.com/" target="_blank" rel="noopener">Rebol</a>的开源替代方案。</p>
<p>Red程序可解释执行，也可以编译并生成单个可执行文件。</p>
<p>Red是跨平台的，有一个原生的、跨平台的GUI系统，并有UI方言和绘图方言。</p>
<p>Red技术栈由两个层次组成：Red语言（高级）、Red/System（低级DSL，用于系统编程）。</p>
<p>Red社区：<a href="https://gitter.im/red/red" target="_blank" rel="noopener">https://gitter.im/red/red</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/11/01/Red/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/10/08/SpringTesting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/08/SpringTesting/" class="post-title-link" itemprop="url">SpringTesting</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-08 15:24:42" itemprop="dateCreated datePublished" datetime="2018-10-08T15:24:42+08:00">2018-10-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ContextConfiguration</span>(<span class="title">classes</span></span>=FooConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">CDPlayerTest</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SpringJUnit4ClassRunner</code>在测试开始时自动创建Spring的应用上下文。</p>
<p>标注<code>@ContextConfiguration</code>告诉Spring应用上下文去哪里加载配置。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/09/15/Python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/15/Python/" class="post-title-link" itemprop="url">Python</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-15 12:15:06" itemprop="dateCreated datePublished" datetime="2018-09-15T12:15:06+08:00">2018-09-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/09/15/Python/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/08/29/Smalltalk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/29/Smalltalk/" class="post-title-link" itemprop="url">Smalltalk</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-29 10:29:20" itemprop="dateCreated datePublished" datetime="2018-08-29T10:29:20+08:00">2018-08-29</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Smalltalk是一个面向对象的、动态类型的编程语言。</p>
<p>IDE：<a href="https://pharo.org/" target="_blank" rel="noopener">Pharo</a>、<a href="https://squeak.org/" target="_blank" rel="noopener">Squeak</a></p>
<h1 id="词法"><a href="#词法" class="headerlink" title="词法"></a>词法</h1><h2 id="字符集"><a href="#字符集" class="headerlink" title="字符集"></a>字符集</h2><ul>
<li>a-z</li>
<li>A-Z</li>
<li>0-9</li>
<li>.+/*~&lt;&gt;@%|&amp;?</li>
<li>blank, tab, cr, ff, lf</li>
</ul>
<h2 id="标识符"><a href="#标识符" class="headerlink" title="标识符"></a>标识符</h2><p>全局变量的首字母必须大写，局部变量的首字母必须小写。</p>
<h2 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h2><p>关键字实际上是以冒号结尾的标识符（例如<code>keyword:</code>），它只有在它形成“关键字消息”的时候才有意义。</p>
<h2 id="保留字"><a href="#保留字" class="headerlink" title="保留字"></a>保留字</h2><p> <code>nil</code>、<code>true</code>、<code>false</code>、<code>self</code>、<code>super</code>和<code>Smalltalk</code></p>
<p><code>self</code>引用消息接收者。</p>
<p><code>super</code>引用定义当前代码的对象的父类，而不是引用接收者的父类。</p>
<h2 id="数值"><a href="#数值" class="headerlink" title="数值"></a>数值</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span>        <span class="comment">"十进制数5"</span></span><br><span class="line"><span class="number">16</span>r7f    <span class="comment">"十六进制数7f"</span></span><br><span class="line">基数r111 <span class="comment">"任意进制数11"</span></span><br><span class="line"><span class="number">2e-5</span>     <span class="comment">"浮点数"</span></span><br><span class="line"><span class="number">22</span>/<span class="number">7</span>     <span class="comment">"分数"</span></span><br></pre></td></tr></table></figure>

<h2 id="字符"><a href="#字符" class="headerlink" title="字符"></a>字符</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$h</span>    <span class="comment">"字符h"</span></span><br><span class="line"><span class="string">$ </span>    <span class="comment">"$后跟一个空格表示空格字符"</span></span><br></pre></td></tr></table></figure>

<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'这是字符串'</span></span><br><span class="line"><span class="string">'I'</span><span class="string">'m here'</span></span><br><span class="line"></span><br><span class="line">x := <span class="string">'String'</span>, <span class="string">'Concatenation'</span>.                    <span class="comment">"string concatenation"</span></span><br></pre></td></tr></table></figure>

<p>字符串中的单引号，使用两个单引号（<code>&#39;&#39;</code>）表示。</p>
<h2 id="布尔值"><a href="#布尔值" class="headerlink" title="布尔值"></a>布尔值</h2><p><code>true</code>：<code>True</code>类的唯一实例。</p>
<p><code>false</code>：<code>False</code>类的唯一实例。</p>
<h2 id="空值"><a href="#空值" class="headerlink" title="空值"></a>空值</h2><p> <code>nil</code>：代表未初始化的值。</p>
<h2 id="符号"><a href="#符号" class="headerlink" title="符号"></a>符号</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">#red</span>    <span class="comment">"符号red"</span></span><br></pre></td></tr></table></figure>

<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">"这是注释"</span></span><br></pre></td></tr></table></figure>

<h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><p>Smalltalk中的变量是没有类型的，即它可以引用任意类型对象。因此，声明变量时，不需要指定类型。</p>
<p>Smalltalk的对象是有类型的（实际上是类）。</p>
<p>变量必须在使用前声明。</p>
<h2 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h2><h3 id="全局作用域"><a href="#全局作用域" class="headerlink" title="全局作用域"></a>全局作用域</h3><p>在<code>Smalltalk</code>字典中定义，对所有对象可见。</p>
<p>全局变量命名，约定以大写字母开始。</p>
<h3 id="方法临时作用域"><a href="#方法临时作用域" class="headerlink" title="方法临时作用域"></a>方法临时作用域</h3><p>在方法内部声明，只在方法内部可见。</p>
<p>方法临时变量要在方法体的开头处声明。</p>
<p>方法临时变量命名，约定以小写字母开始。</p>
<h3 id="块临时作用域"><a href="#块临时作用域" class="headerlink" title="块临时作用域"></a>块临时作用域</h3><p>在块中声明，只在块中可见。</p>
<h3 id="池作用域"><a href="#池作用域" class="headerlink" title="池作用域"></a>池作用域</h3><p>在字典对象中的变量。</p>
<h3 id="方法参数作用域"><a href="#方法参数作用域" class="headerlink" title="方法参数作用域"></a>方法参数作用域</h3><h3 id="块参数作用域"><a href="#块参数作用域" class="headerlink" title="块参数作用域"></a>块参数作用域</h3><h3 id="类作用域"><a href="#类作用域" class="headerlink" title="类作用域"></a>类作用域</h3><p>类变量在类和类的实例中可见。</p>
<p>类变量命名，约定以大写字母开始。</p>
<h3 id="类实例作用域"><a href="#类实例作用域" class="headerlink" title="类实例作用域"></a>类实例作用域</h3><p>类实例变量只在类中可见，在实例中不可见。相当于，java中的<code>private static</code>。</p>
<p>类实例变量命名，约定以大写字母开始。</p>
<h3 id="实例变量作用域"><a href="#实例变量作用域" class="headerlink" title="实例变量作用域"></a>实例变量作用域</h3><p>实例变量只在对象中可见，相当于私有成员变量。</p>
<p>实例变量命名，约定以小写字母开始。</p>
<h2 id="局部变量声明"><a href="#局部变量声明" class="headerlink" title="局部变量声明"></a>局部变量声明</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| x y |</span><br></pre></td></tr></table></figure>

<p>声明了两个局部变量<code>x</code>和<code>y</code>。</p>
<h1 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h1><h2 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x := <span class="number">5.</span></span><br><span class="line">x := y := z := <span class="number">6.</span></span><br><span class="line">x := (y := <span class="number">6</span>) + <span class="number">1.</span></span><br></pre></td></tr></table></figure>

<h2 id="块"><a href="#块" class="headerlink" title="块"></a>块</h2><p>块（也叫闭包）也是对象。</p>
<p>除非有显式的返回，否则块的值是它的最后一个表达式的值 。</p>
<p>块可以嵌套。</p>
<p>块的一般形式：</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ 参数 | 局部变量声明 表达式 ]</span><br></pre></td></tr></table></figure>

<p>无参块：</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ y := <span class="number">1.</span> z := <span class="number">2.</span> ]</span><br></pre></td></tr></table></figure>

<p>带参数块：</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">| block |</span><br><span class="line">block := [:x :y | x * <span class="number">2</span> + y].</span><br><span class="line">block value: <span class="number">5</span> value: <span class="number">3</span>     <span class="comment">"结果为13"</span></span><br></pre></td></tr></table></figure>

<p>块也是对象，value是它的一个方法，它的作用就是返回块的结果。</p>
<h2 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h2><p>消息实际上就是方法调用。</p>
<h3 id="一元消息"><a href="#一元消息" class="headerlink" title="一元消息"></a>一元消息</h3><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">object unaryMessage     <span class="comment">"相当于Java：object.unaryMessage()"</span></span><br><span class="line">myDept manager name last  <span class="comment">"相当于Java：myDept.manager().name().last()"</span></span><br></pre></td></tr></table></figure>

<p>上面例子中，<code>object</code>是接收者，而<code>unaryMessage</code>是发送给接收者的消息。</p>
<p><code>myDept</code>是接收者，<code>manager</code>是发送给<code>myDept</code>的消息，<code>name</code>是发送给<code>myDept manager</code>的结果的消息，<code>last</code>是发送给<code>myDept manager name</code>的结果的消息。这形成了一个消息链。</p>
<h3 id="二元消息"><a href="#二元消息" class="headerlink" title="二元消息"></a>二元消息</h3><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span> + <span class="number">3</span>  <span class="comment">"5是接收者对象，(+ 3)是消息，这个消息带一个参数3。"</span></span><br></pre></td></tr></table></figure>

<p>预定义的二元消息：</p>
<p>+</p>
<p>-</p>
<p>*</p>
<p>/</p>
<p>**：幂</p>
<p>//：整除</p>
<p>\：求模</p>
<p>&lt;</p>
<p>&lt;=</p>
<p>&gt;</p>
<p>&gt;=</p>
<p>=：内容相等</p>
<p>~=：内容不相等</p>
<p>==：引用相等</p>
<p>~~：引用不相等</p>
<p>&amp;：逻辑与</p>
<p>|：逻辑或</p>
<p>,：拼接两个集合</p>
<p>@：创建Point类的实例</p>
<p>-&gt;：创建Association类的实例</p>
<h3 id="关键字消息"><a href="#关键字消息" class="headerlink" title="关键字消息"></a>关键字消息</h3><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'elephant'</span> copyFrom: <span class="number">3</span> to: <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p><code>&#39;elephant&#39;</code>是接收者对象，<code>(copyFrom: 3 to: 5)</code>是消息，这个消息有两个关键字<code>copyFrom:</code>和<code>to:</code>，每个关键字带一个参数。</p>
<p>上面例子相当于Java：<code>&quot;elephant&quot;.copyFromTo(3, 5)</code>。</p>
<p>Smalltalk没有内在的控制结构，其他语言中的条件语句、循环语句，在Smalltalk中就是一个关键字消息。</p>
<h3 id="消息优先级"><a href="#消息优先级" class="headerlink" title="消息优先级"></a>消息优先级</h3><p>一元消息优先级最高，二元消息其次，关键字消息最低。</p>
<p>通过圆括号可以改变优先级。</p>
<p>同等优先级下，从左到右进行运算。</p>
<h3 id="消息级联"><a href="#消息级联" class="headerlink" title="消息级联"></a>消息级联</h3><p>分号表示消息级联：</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|p|</span><br><span class="line">p := <span class="type">Client</span> new</span><br><span class="line">  name: <span class="string">'Jack'</span>;</span><br><span class="line">  age: <span class="number">32</span>;</span><br><span class="line">  address: <span class="string">'Earth'</span>.</span><br></pre></td></tr></table></figure>

<p>相当于：</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|p|</span><br><span class="line">p := <span class="type">Client</span> new.</span><br><span class="line">p name: <span class="string">'Jack'</span>.</span><br><span class="line">p age: <span class="number">32.</span></span><br><span class="line">p address: <span class="string">'Earth'</span>.</span><br></pre></td></tr></table></figure>



<h1 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h1><p>Smalltalk中，集合的索引都是从1开始。</p>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">| b x y sum max |</span><br><span class="line">x := #(<span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span>).                                 <span class="comment">"constant array"</span></span><br><span class="line">x := <span class="type">Array</span> with: <span class="number">5</span> with: <span class="number">4</span> with: <span class="number">3</span> with: <span class="number">2.</span>      <span class="comment">"create array with up to 4 elements"</span></span><br><span class="line">x := <span class="type">Array</span> new: <span class="number">4.</span>                               <span class="comment">"allocate an array with specified size"</span></span><br><span class="line">x                                                <span class="comment">"set array elements"</span></span><br><span class="line">   at: <span class="number">1</span> put: <span class="number">5</span>;</span><br><span class="line">   at: <span class="number">2</span> put: <span class="number">4</span>;</span><br><span class="line">   at: <span class="number">3</span> put: <span class="number">3</span>;</span><br><span class="line">   at: <span class="number">4</span> put: <span class="number">2.</span></span><br><span class="line">b := x isEmpty.                                  <span class="comment">"test if array is empty"</span></span><br><span class="line">y := x size.                                     <span class="comment">"array size"</span></span><br><span class="line">y := x at: <span class="number">4.</span>                                    <span class="comment">"get array element at index"</span></span><br><span class="line">b := x includes: <span class="number">3.</span>                              <span class="comment">"test if element is in array"</span></span><br><span class="line">y := x copyFrom: <span class="number">2</span> to: <span class="number">4.</span>                        <span class="comment">"subarray"</span></span><br><span class="line">y := x indexOf: <span class="number">3</span> ifAbsent: [<span class="number">0</span>].                 <span class="comment">"first position of element within array"</span></span><br><span class="line">y := x occurrencesOf: <span class="number">3.</span>                         <span class="comment">"number of times object in collection"</span></span><br><span class="line">x do: [:a | <span class="type">Transcript</span> show: a printString; cr]. <span class="comment">"iterate over the array"</span></span><br><span class="line">b := x conform: [:a | (a &gt;= <span class="number">1</span>) &amp; (a &lt;= <span class="number">4</span>)].      <span class="comment">"test if all elements meet condition"</span></span><br><span class="line">y := x select: [:a | a &gt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that pass test"</span></span><br><span class="line">y := x reject: [:a | a &lt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that fail test"</span></span><br><span class="line">y := x collect: [:a | a + a].                    <span class="comment">"transform each element for new collection"</span></span><br><span class="line">y := x detect: [:a | a &gt; <span class="number">3</span>] ifNone: [].          <span class="comment">"find position of first element that passes test"</span></span><br><span class="line">sum := <span class="number">0.</span> x do: [:a | sum := sum + a]. sum.      <span class="comment">"sum array elements"</span></span><br><span class="line">sum := <span class="number">0.</span> <span class="number">1</span> to: (x size) </span><br><span class="line">            do: [:a | sum := sum + (x at: a)].   <span class="comment">"sum array elements"</span></span><br><span class="line">sum := x inject: <span class="number">0</span> into: [:a :c | a + c].        <span class="comment">"sum array elements"</span></span><br><span class="line">max := x inject: <span class="number">0</span> into: [:a :c | (a &gt; c)        <span class="comment">"find max element in array"</span></span><br><span class="line">   ifTrue: [a]</span><br><span class="line">   ifFalse: [c]].</span><br><span class="line">y := x shuffled.                                 <span class="comment">"randomly shuffle collection"</span></span><br><span class="line">y := x asArray.                                  <span class="comment">"convert to array"</span></span><br><span class="line"><span class="comment">"y := x asByteArray."</span>                            <span class="comment">"note: this instruction not available on Squeak"</span></span><br><span class="line">y := x asWordArray.                              <span class="comment">"convert to word array"</span></span><br><span class="line">y := x asOrderedCollection.                      <span class="comment">"convert to ordered collection"</span></span><br><span class="line">y := x asSortedCollection.                       <span class="comment">"convert to sorted collection"</span></span><br><span class="line">y := x asBag.                                    <span class="comment">"convert to bag collection"</span></span><br><span class="line">y := x asSet.                                    <span class="comment">"convert to set collection"</span></span><br></pre></td></tr></table></figure>

<p>数组元素的类型可以不相同。</p>
<h2 id="有序集合"><a href="#有序集合" class="headerlink" title="有序集合"></a>有序集合</h2><p>类似一个可扩展的数组 。</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">| b x y sum max |</span><br><span class="line">x := <span class="type">OrderedCollection</span> </span><br><span class="line">     with: <span class="number">4</span> with: <span class="number">3</span> with: <span class="number">2</span> with: <span class="number">1.</span>            <span class="comment">"create collection with up to 4 elements"</span></span><br><span class="line">x := <span class="type">OrderedCollection</span> new.                      <span class="comment">"allocate collection"</span></span><br><span class="line">x add: <span class="number">3</span>; add: <span class="number">2</span>; add: <span class="number">1</span>; add: <span class="number">4</span>; yourself.      <span class="comment">"add element to collection"</span></span><br><span class="line">y := x addFirst: <span class="number">5.</span>                              <span class="comment">"add element at beginning of collection"</span></span><br><span class="line">y := x removeFirst.                              <span class="comment">"remove first element in collection"</span></span><br><span class="line">y := x addLast: <span class="number">6.</span>                               <span class="comment">"add element at end of collection"</span></span><br><span class="line">y := x removeLast.                               <span class="comment">"remove last element in collection"</span></span><br><span class="line">y := x addAll: #(<span class="number">7</span> <span class="number">8</span> <span class="number">9</span>).                         <span class="comment">"add multiple elements to collection"</span></span><br><span class="line">y := x removeAll: #(<span class="number">7</span> <span class="number">8</span> <span class="number">9</span>).                      <span class="comment">"remove multiple elements from collection"</span></span><br><span class="line">x at: <span class="number">2</span> put: <span class="number">3.</span>                                  <span class="comment">"set element at index"</span></span><br><span class="line">y := x remove: <span class="number">5</span> ifAbsent: [].                   <span class="comment">"remove element from collection"</span></span><br><span class="line">b := x isEmpty.                                  <span class="comment">"test if empty"</span></span><br><span class="line">y := x size.                                     <span class="comment">"number of elements"</span></span><br><span class="line">y := x at: <span class="number">2.</span>                                    <span class="comment">"retrieve element at index"</span></span><br><span class="line">y := x first.                                    <span class="comment">"retrieve first element in collection"</span></span><br><span class="line">y := x last.                                     <span class="comment">"retrieve last element in collection"</span></span><br><span class="line">b := x includes: <span class="number">5.</span>                              <span class="comment">"test if element is in collection"</span></span><br><span class="line">y := x copyFrom: <span class="number">2</span> to: <span class="number">3.</span>                        <span class="comment">"subcollection"</span></span><br><span class="line">y := x indexOf: <span class="number">3</span> ifAbsent: [<span class="number">0</span>].                 <span class="comment">"first position of element within collection"</span></span><br><span class="line">y := x occurrencesOf: <span class="number">3.</span>                         <span class="comment">"number of times object in collection"</span></span><br><span class="line">x do: [:a | <span class="type">Transcript</span> show: a printString; cr]. <span class="comment">"iterate over the collection"</span></span><br><span class="line">b := x conform: [:a | (a &gt;= <span class="number">1</span>) &amp; (a &lt;= <span class="number">4</span>)].      <span class="comment">"test if all elements meet condition"</span></span><br><span class="line">y := x select: [:a | a &gt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that pass test"</span></span><br><span class="line">y := x reject: [:a | a &lt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that fail test"</span></span><br><span class="line">y := x collect: [:a | a + a].                    <span class="comment">"transform each element for new collection"</span></span><br><span class="line">y := x detect: [:a | a &gt; <span class="number">3</span>] ifNone: [].          <span class="comment">"find position of first element that passes test"</span></span><br><span class="line">sum := <span class="number">0.</span> x do: [:a | sum := sum + a]. sum.      <span class="comment">"sum elements"</span></span><br><span class="line">sum := <span class="number">0.</span> <span class="number">1</span> to: (x size) </span><br><span class="line">            do: [:a | sum := sum + (x at: a)].   <span class="comment">"sum elements"</span></span><br><span class="line">sum := x inject: <span class="number">0</span> into: [:a :c | a + c].        <span class="comment">"sum elements"</span></span><br><span class="line">max := x inject: <span class="number">0</span> into: [:a :c | (a &gt; c)        <span class="comment">"find max element in collection"</span></span><br><span class="line">   ifTrue: [a]</span><br><span class="line">   ifFalse: [c]].</span><br><span class="line">y := x shuffled.                                 <span class="comment">"randomly shuffle collection"</span></span><br><span class="line">y := x asArray.                                  <span class="comment">"convert to array"</span></span><br><span class="line">y := x asOrderedCollection.                      <span class="comment">"convert to ordered collection"</span></span><br><span class="line">y := x asSortedCollection.                       <span class="comment">"convert to sorted collection"</span></span><br><span class="line">y := x asBag.                                    <span class="comment">"convert to bag collection"</span></span><br><span class="line">y := x asSet.                                    <span class="comment">"convert to set collection"</span></span><br></pre></td></tr></table></figure>

<h2 id="排序集合"><a href="#排序集合" class="headerlink" title="排序集合"></a>排序集合</h2><p> 类似于OrderedCollection，但可指定排序标准。</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">x := <span class="type">SortedCollection</span> </span><br><span class="line">     with: <span class="number">4</span> with: <span class="number">3</span> with: <span class="number">2</span> with: <span class="number">1.</span>              <span class="comment">"create collection with up to 4 elements"</span></span><br><span class="line">x := <span class="type">SortedCollection</span> new.                         <span class="comment">"allocate collection"</span></span><br><span class="line">x := <span class="type">SortedCollection</span> sortBlock: [:a :c | a &gt; c].  <span class="comment">"set sort criteria"</span></span><br><span class="line">x add: <span class="number">3</span>; add: <span class="number">2</span>; add: <span class="number">1</span>; add: <span class="number">4</span>; yourself.        <span class="comment">"add element to collection"</span></span><br><span class="line">y := x addFirst: <span class="number">5.</span>                                <span class="comment">"add element at beginning of collection"</span></span><br><span class="line">y := x removeFirst.                                <span class="comment">"remove first element in collection"</span></span><br><span class="line">y := x addLast: <span class="number">6.</span>                                 <span class="comment">"add element at end of collection"</span></span><br><span class="line">y := x removeLast.                                 <span class="comment">"remove last element in collection"</span></span><br><span class="line">y := x addAll: #(<span class="number">7</span> <span class="number">8</span> <span class="number">9</span>).                           <span class="comment">"add multiple elements to collection"</span></span><br><span class="line">y := x removeAll: #(<span class="number">7</span> <span class="number">8</span> <span class="number">9</span>).                        <span class="comment">"remove multiple elements from collection"</span></span><br><span class="line">y := x remove: <span class="number">5</span> ifAbsent: [].                     <span class="comment">"remove element from collection"</span></span><br><span class="line">b := x isEmpty.                                    <span class="comment">"test if empty"</span></span><br><span class="line">y := x size.                                       <span class="comment">"number of elements"</span></span><br><span class="line">y := x at: <span class="number">2.</span>                                      <span class="comment">"retrieve element at index"</span></span><br><span class="line">y := x first.                                      <span class="comment">"retrieve first element in collection"</span></span><br><span class="line">y := x last.                                       <span class="comment">"retrieve last element in collection"</span></span><br><span class="line">b := x includes: <span class="number">4.</span>                                <span class="comment">"test if element is in collection"</span></span><br><span class="line">y := x copyFrom: <span class="number">2</span> to: <span class="number">3.</span>                          <span class="comment">"subcollection"</span></span><br><span class="line">y := x indexOf: <span class="number">3</span> ifAbsent: [<span class="number">0</span>].                   <span class="comment">"first position of element within collection"</span></span><br><span class="line">y := x occurrencesOf: <span class="number">3.</span>                           <span class="comment">"number of times object in collection"</span></span><br><span class="line">x do: [:a | <span class="type">Transcript</span> show: a printString; cr].   <span class="comment">"iterate over the collection"</span></span><br><span class="line">b := x conform: [:a | (a &gt;= <span class="number">1</span>) &amp; (a &lt;= <span class="number">4</span>)].        <span class="comment">"test if all elements meet condition"</span></span><br><span class="line">y := x select: [:a | a &gt; <span class="number">2</span>].                       <span class="comment">"return collection of elements that pass test"</span></span><br><span class="line">y := x reject: [:a | a &lt; <span class="number">2</span>].                       <span class="comment">"return collection of elements that fail test"</span></span><br><span class="line">y := x collect: [:a | a + a].                      <span class="comment">"transform each element for new collection"</span></span><br><span class="line">y := x detect: [:a | a &gt; <span class="number">3</span>] ifNone: [].            <span class="comment">"find position of first element that passes test"</span></span><br><span class="line">sum := <span class="number">0.</span> x do: [:a | sum := sum + a]. sum.        <span class="comment">"sum elements"</span></span><br><span class="line">sum := <span class="number">0.</span> <span class="number">1</span> to: (x size) </span><br><span class="line">            do: [:a | sum := sum + (x at: a)].     <span class="comment">"sum elements"</span></span><br><span class="line">sum := x inject: <span class="number">0</span> into: [:a :c | a + c].          <span class="comment">"sum elements"</span></span><br><span class="line">max := x inject: <span class="number">0</span> into: [:a :c | (a &gt; c)          <span class="comment">"find max element in collection"</span></span><br><span class="line">   ifTrue: [a]</span><br><span class="line">   ifFalse: [c]].</span><br><span class="line">y := x asArray.                                     <span class="comment">"convert to array"</span></span><br><span class="line">y := x asOrderedCollection.                         <span class="comment">"convert to ordered collection"</span></span><br><span class="line">y := x asSortedCollection.                          <span class="comment">"convert to sorted collection"</span></span><br><span class="line">y := x asBag.                                       <span class="comment">"convert to bag collection"</span></span><br><span class="line">y := x asSet.                                       <span class="comment">"convert to set collection"</span></span><br></pre></td></tr></table></figure>

<h2 id="包"><a href="#包" class="headerlink" title="包"></a>包</h2><p> 类似于OrderedCollection，但元素没有特定的顺序。 </p>
 <figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">x := <span class="type">Bag</span> with: <span class="number">4</span> with: <span class="number">3</span> with: <span class="number">2</span> with: <span class="number">1.</span>        <span class="comment">"create collection with up to 4 elements"</span></span><br><span class="line">x := <span class="type">Bag</span> new.                                    <span class="comment">"allocate collection"</span></span><br><span class="line">x add: <span class="number">4</span>; add: <span class="number">3</span>; add: <span class="number">1</span>; add: <span class="number">2</span>; yourself.      <span class="comment">"add element to collection"</span></span><br><span class="line">x add: <span class="number">3</span> withOccurrences: <span class="number">2.</span>                     <span class="comment">"add multiple copies to collection"</span></span><br><span class="line">y := x addAll: #(<span class="number">7</span> <span class="number">8</span> <span class="number">9</span>).                         <span class="comment">"add multiple elements to collection"</span></span><br><span class="line">y := x removeAll: #(<span class="number">7</span> <span class="number">8</span> <span class="number">9</span>).                      <span class="comment">"remove multiple elements from collection"</span></span><br><span class="line">y := x remove: <span class="number">4</span> ifAbsent: [].                   <span class="comment">"remove element from collection"</span></span><br><span class="line">b := x isEmpty.                                  <span class="comment">"test if empty"</span></span><br><span class="line">y := x size.                                     <span class="comment">"number of elements"</span></span><br><span class="line">b := x includes: <span class="number">3.</span>                              <span class="comment">"test if element is in collection"</span></span><br><span class="line">y := x occurrencesOf: <span class="number">3.</span>                         <span class="comment">"number of times object in collection"</span></span><br><span class="line">x do: [:a | <span class="type">Transcript</span> show: a printString; cr]. <span class="comment">"iterate over the collection"</span></span><br><span class="line">b := x conform: [:a | (a &gt;= <span class="number">1</span>) &amp; (a &lt;= <span class="number">4</span>)].      <span class="comment">"test if all elements meet condition"</span></span><br><span class="line">y := x select: [:a | a &gt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that pass test"</span></span><br><span class="line">y := x reject: [:a | a &lt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that fail test"</span></span><br><span class="line">y := x collect: [:a | a + a].                    <span class="comment">"transform each element for new collection"</span></span><br><span class="line">y := x detect: [:a | a &gt; <span class="number">3</span>] ifNone: [].          <span class="comment">"find position of first element that passes test"</span></span><br><span class="line">sum := <span class="number">0.</span> x do: [:a | sum := sum + a]. sum.      <span class="comment">"sum elements"</span></span><br><span class="line">sum := x inject: <span class="number">0</span> into: [:a :c | a + c].        <span class="comment">"sum elements"</span></span><br><span class="line">max := x inject: <span class="number">0</span> into: [:a :c | (a &gt; c)        <span class="comment">"find max element in collection"</span></span><br><span class="line">   ifTrue: [a]</span><br><span class="line">   ifFalse: [c]].</span><br><span class="line">y := x asOrderedCollection.                       <span class="comment">"convert to ordered collection"</span></span><br><span class="line">y := x asSortedCollection.                        <span class="comment">"convert to sorted collection"</span></span><br><span class="line">y := x asBag.                                     <span class="comment">"convert to bag collection"</span></span><br><span class="line">y := x asSet.                                     <span class="comment">"convert to set collection"</span></span><br></pre></td></tr></table></figure>

<h2 id="集"><a href="#集" class="headerlink" title="集"></a>集</h2><p> 像Bag一样，但不允许重复元素。</p>
<h3 id="IdentitySet"><a href="#IdentitySet" class="headerlink" title="IdentitySet"></a>IdentitySet</h3><p> 使用同一测试（即<code>==</code>而非<code>=</code>） </p>
 <figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">x := <span class="type">Set</span> with: <span class="number">4</span> with: <span class="number">3</span> with: <span class="number">2</span> with: <span class="number">1.</span>        <span class="comment">"create collection with up to 4 elements"</span></span><br><span class="line">x := <span class="type">Set</span> new.                                    <span class="comment">"allocate collection"</span></span><br><span class="line">x add: <span class="number">4</span>; add: <span class="number">3</span>; add: <span class="number">1</span>; add: <span class="number">2</span>; yourself.      <span class="comment">"add element to collection"</span></span><br><span class="line">y := x addAll: #(<span class="number">7</span> <span class="number">8</span> <span class="number">9</span>).                         <span class="comment">"add multiple elements to collection"</span></span><br><span class="line">y := x removeAll: #(<span class="number">7</span> <span class="number">8</span> <span class="number">9</span>).                      <span class="comment">"remove multiple elements from collection"</span></span><br><span class="line">y := x remove: <span class="number">4</span> ifAbsent: [].                   <span class="comment">"remove element from collection"</span></span><br><span class="line">b := x isEmpty.                                  <span class="comment">"test if empty"</span></span><br><span class="line">y := x size.                                     <span class="comment">"number of elements"</span></span><br><span class="line">x includes: <span class="number">4.</span>                                   <span class="comment">"test if element is in collection"</span></span><br><span class="line">x do: [:a | <span class="type">Transcript</span> show: a printString; cr]. <span class="comment">"iterate over the collection"</span></span><br><span class="line">b := x conform: [:a | (a &gt;= <span class="number">1</span>) &amp; (a &lt;= <span class="number">4</span>)].      <span class="comment">"test if all elements meet condition"</span></span><br><span class="line">y := x select: [:a | a &gt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that pass test"</span></span><br><span class="line">y := x reject: [:a | a &lt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that fail test"</span></span><br><span class="line">y := x collect: [:a | a + a].                    <span class="comment">"transform each element for new collection"</span></span><br><span class="line">y := x detect: [:a | a &gt; <span class="number">3</span>] ifNone: [].          <span class="comment">"find position of first element that passes test"</span></span><br><span class="line">sum := <span class="number">0.</span> x do: [:a | sum := sum + a]. sum.      <span class="comment">"sum elements"</span></span><br><span class="line">sum := x inject: <span class="number">0</span> into: [:a :c | a + c].        <span class="comment">"sum elements"</span></span><br><span class="line">max := x inject: <span class="number">0</span> into: [:a :c | (a &gt; c)        <span class="comment">"find max element in collection"</span></span><br><span class="line">   ifTrue: [a]</span><br><span class="line">   ifFalse: [c]].</span><br><span class="line">y := x asArray.                                  <span class="comment">"convert to array"</span></span><br><span class="line">y := x asOrderedCollection.                      <span class="comment">"convert to ordered collection"</span></span><br><span class="line">y := x asSortedCollection.                       <span class="comment">"convert to sorted collection"</span></span><br><span class="line">y := x asBag.                                    <span class="comment">"convert to bag collection"</span></span><br><span class="line">y := x asSet.                                    <span class="comment">"convert to set collection"</span></span><br></pre></td></tr></table></figure>

<h3 id="Interval"><a href="#Interval" class="headerlink" title="Interval"></a>Interval</h3><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">| b x y sum max |</span><br><span class="line">x := <span class="type">Interval</span> from: <span class="number">5</span> to: <span class="number">10.</span>                     <span class="comment">"create interval object"</span></span><br><span class="line">x := <span class="number">5</span> to: <span class="number">10.</span></span><br><span class="line">x := <span class="type">Interval</span> from: <span class="number">5</span> to: <span class="number">10</span> by: <span class="number">2.</span>               <span class="comment">"create interval object with specified increment"</span></span><br><span class="line">x := <span class="number">5</span> to: <span class="number">10</span> by: <span class="number">2.</span></span><br><span class="line">b := x isEmpty.                                   <span class="comment">"test if empty"</span></span><br><span class="line">y := x size.                                      <span class="comment">"number of elements"</span></span><br><span class="line">x includes: <span class="number">9.</span>                                    <span class="comment">"test if element is in collection"</span></span><br><span class="line">x do: [:k | <span class="type">Transcript</span> show: k printString; cr].  <span class="comment">"iterate over interval"</span></span><br><span class="line">b := x conform: [:a | (a &gt;= <span class="number">1</span>) &amp; (a &lt;= <span class="number">4</span>)].       <span class="comment">"test if all elements meet condition"</span></span><br><span class="line">y := x select: [:a | a &gt; <span class="number">7</span>].                      <span class="comment">"return collection of elements that pass test"</span></span><br><span class="line">y := x reject: [:a | a &lt; <span class="number">2</span>].                      <span class="comment">"return collection of elements that fail test"</span></span><br><span class="line">y := x collect: [:a | a + a].                     <span class="comment">"transform each element for new collection"</span></span><br><span class="line">y := x detect: [:a | a &gt; <span class="number">3</span>] ifNone: [].           <span class="comment">"find position of first element that passes test"</span></span><br><span class="line">sum := <span class="number">0.</span> x do: [:a | sum := sum + a]. sum.       <span class="comment">"sum elements"</span></span><br><span class="line">sum := <span class="number">0.</span> <span class="number">1</span> to: (x size) </span><br><span class="line">            do: [:a | sum := sum + (x at: a)].    <span class="comment">"sum elements"</span></span><br><span class="line">sum := x inject: <span class="number">0</span> into: [:a :c | a + c].         <span class="comment">"sum elements"</span></span><br><span class="line">max := x inject: <span class="number">0</span> into: [:a :c | (a &gt; c)         <span class="comment">"find max element in collection"</span></span><br><span class="line">   ifTrue: [a]</span><br><span class="line">   ifFalse: [c]].</span><br><span class="line">y := x asArray.                                   <span class="comment">"convert to array"</span></span><br><span class="line">y := x asOrderedCollection.                       <span class="comment">"convert to ordered collection"</span></span><br><span class="line">y := x asSortedCollection.                        <span class="comment">"convert to sorted collection"</span></span><br><span class="line">y := x asBag.                                     <span class="comment">"convert to bag collection"</span></span><br><span class="line">y := x asSet.                                     <span class="comment">"convert to set collection"</span></span><br></pre></td></tr></table></figure>

<h3 id="关联表"><a href="#关联表" class="headerlink" title="关联表"></a>关联表</h3><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| x y |</span><br><span class="line">x := <span class="symbol">#myVar</span>-&gt;<span class="string">'hello'</span>.</span><br><span class="line">y := x key.</span><br><span class="line">y := x value.</span><br></pre></td></tr></table></figure>

<h3 id="字典和同一字典"><a href="#字典和同一字典" class="headerlink" title="字典和同一字典"></a>字典和同一字典</h3><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">| b x y |</span><br><span class="line">x := <span class="type">Dictionary</span> new.                   <span class="comment">"allocate collection"</span></span><br><span class="line">x add: <span class="symbol">#a</span>-&gt;<span class="number">4</span>; </span><br><span class="line">  add: <span class="symbol">#b</span>-&gt;<span class="number">3</span>; </span><br><span class="line">  add: <span class="symbol">#c</span>-&gt;<span class="number">1</span>; </span><br><span class="line">  add: <span class="symbol">#d</span>-&gt;<span class="number">2</span>; yourself.                <span class="comment">"add element to collection"</span></span><br><span class="line">x at: <span class="symbol">#e</span> put: <span class="number">3.</span>                       <span class="comment">"set element at index"</span></span><br><span class="line">b := x isEmpty.                        <span class="comment">"test if empty"</span></span><br><span class="line">y := x size.                           <span class="comment">"number of elements"</span></span><br><span class="line">y := x at: <span class="symbol">#a</span> ifAbsent: [].            <span class="comment">"retrieve element at index"</span></span><br><span class="line">y := x keyAtValue: <span class="number">3</span> ifAbsent: [].     <span class="comment">"retrieve key for given value with error block"</span></span><br><span class="line">y := x removeKey: <span class="symbol">#e</span> ifAbsent: [].     <span class="comment">"remove element from collection"</span></span><br><span class="line">b := x includes: <span class="number">3.</span>                    <span class="comment">"test if element is in values collection"</span></span><br><span class="line">b := x includesKey: <span class="symbol">#a</span>.                <span class="comment">"test if element is in keys collection"</span></span><br><span class="line">y := x occurrencesOf: <span class="number">3.</span>               <span class="comment">"number of times object in collection"</span></span><br><span class="line">y := x keys.                           <span class="comment">"set of keys"</span></span><br><span class="line">y := x values.                         <span class="comment">"bag of values"</span></span><br><span class="line">x do: [:a | <span class="type">Transcript</span> show: a printString; cr].            <span class="comment">"iterate over the values collection"</span></span><br><span class="line">x keysDo: [:a | <span class="type">Transcript</span> show: a printString; cr].        <span class="comment">"iterate over the keys collection"</span></span><br><span class="line">x associationsDo: [:a | <span class="type">Transcript</span> show: a printString; cr].<span class="comment">"iterate over the associations"</span></span><br><span class="line">x keysAndValuesDo: [:aKey :aValue | <span class="type">Transcript</span>              <span class="comment">"iterate over keys and values"</span></span><br><span class="line">   show: aKey printString; space;</span><br><span class="line">   show: aValue printString; cr].</span><br><span class="line">b := x conform: [:a | (a &gt;= <span class="number">1</span>) &amp; (a &lt;= <span class="number">4</span>)].      <span class="comment">"test if all elements meet condition"</span></span><br><span class="line">y := x select: [:a | a &gt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that pass test"</span></span><br><span class="line">y := x reject: [:a | a &lt; <span class="number">2</span>].                     <span class="comment">"return collection of elements that fail test"</span></span><br><span class="line">y := x collect: [:a | a + a].                    <span class="comment">"transform each element for new collection"</span></span><br><span class="line">y := x detect: [:a | a &gt; <span class="number">3</span>] ifNone: [].          <span class="comment">"find position of first element that passes test"</span></span><br><span class="line">sum := <span class="number">0.</span> x do: [:a | sum := sum + a]. sum.      <span class="comment">"sum elements"</span></span><br><span class="line">sum := x inject: <span class="number">0</span> into: [:a :c | a + c].        <span class="comment">"sum elements"</span></span><br><span class="line">max := x inject: <span class="number">0</span> into: [:a :c | (a &gt; c)        <span class="comment">"find max element in collection"</span></span><br><span class="line">   ifTrue: [a]</span><br><span class="line">   ifFalse: [c]].</span><br><span class="line">y := x asArray.                                   <span class="comment">"convert to array"</span></span><br><span class="line">y := x asOrderedCollection.                       <span class="comment">"convert to ordered collection"</span></span><br><span class="line">y := x asSortedCollection.                        <span class="comment">"convert to sorted collection"</span></span><br><span class="line">y := x asBag.                                     <span class="comment">"convert to bag collection"</span></span><br><span class="line">y := x asSet.                                     <span class="comment">"convert to set collection"</span></span><br><span class="line"></span><br><span class="line"><span class="type">Smalltalk</span> at: <span class="symbol">#CMRGlobal</span> put: <span class="string">'CMR entry'</span>.        <span class="comment">"put global in Smalltalk Dictionary"</span></span><br><span class="line">x := <span class="type">Smalltalk</span> at: <span class="symbol">#CMRGlobal</span>.                    <span class="comment">"read global from Smalltalk Dictionary"</span></span><br><span class="line"><span class="type">Transcript</span> show: (<span class="type">CMRGlobal</span> printString).         <span class="comment">"entries are directly accessible by name"</span></span><br><span class="line"><span class="type">Smalltalk</span> keys do: [ :k |                         <span class="comment">"print out all classes"</span></span><br><span class="line">   ((<span class="type">Smalltalk</span> at: k) isKindOf: <span class="type">Class</span>)</span><br><span class="line">      ifFalse: [<span class="type">Transcript</span> show: k printString; cr]].</span><br><span class="line"><span class="type">Smalltalk</span> at: <span class="symbol">#CMRDictionary</span> put: (<span class="type">Dictionary</span> new). <span class="comment">"set up user defined dictionary"</span></span><br><span class="line"><span class="type">CMRDictionary</span> at: <span class="symbol">#MyVar1</span> put: <span class="string">'hello1'</span>.            <span class="comment">"put entry in dictionary"</span></span><br><span class="line"><span class="type">CMRDictionary</span> add: <span class="symbol">#MyVar2</span>-&gt;<span class="string">'hello2'</span>.               <span class="comment">"add entry to dictionary use key-&gt;value combo"</span></span><br><span class="line"><span class="type">CMRDictionary</span> size.                                 <span class="comment">"dictionary size"</span></span><br><span class="line"><span class="type">CMRDictionary</span> keys do: [ :k |                       <span class="comment">"print out keys in dictionary"</span></span><br><span class="line">   <span class="type">Transcript</span> show: k printString; cr].</span><br><span class="line"><span class="type">CMRDictionary</span> values do: [ :k |                     <span class="comment">"print out values in dictionary"</span></span><br><span class="line">   <span class="type">Transcript</span> show: k printString; cr].</span><br><span class="line"><span class="type">CMRDictionary</span> keysAndValuesDo: [:aKey :aValue |     <span class="comment">"print out keys and values"</span></span><br><span class="line">   <span class="type">Transcript</span></span><br><span class="line">      show: aKey printString;</span><br><span class="line">      space;</span><br><span class="line">      show: aValue printString;</span><br><span class="line">      cr].</span><br><span class="line"><span class="type">CMRDictionary</span> associationsDo: [:aKeyValue |           <span class="comment">"another iterator for printing key values"</span></span><br><span class="line">   <span class="type">Transcript</span> show: aKeyValue printString; cr].</span><br><span class="line"><span class="type">Smalltalk</span> removeKey: <span class="symbol">#CMRGlobal</span> ifAbsent: [].         <span class="comment">"remove entry from Smalltalk dictionary"</span></span><br><span class="line"><span class="type">Smalltalk</span> removeKey: <span class="symbol">#CMRDictionary</span> ifAbsent: [].     <span class="comment">"remove user dictionary from Smalltalk dictionary"</span></span><br></pre></td></tr></table></figure>

<h3 id="内部流"><a href="#内部流" class="headerlink" title="内部流"></a>内部流</h3><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h1><p>语句使用<code>.</code>作为分隔符，最后一条语句不需要加<code>.</code>号。</p>
<h2 id="返回语句"><a href="#返回语句" class="headerlink" title="返回语句"></a>返回语句</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^ 返回对象</span><br></pre></td></tr></table></figure>

<h2 id="表达式语句"><a href="#表达式语句" class="headerlink" title="表达式语句"></a>表达式语句</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x := <span class="number">5.</span></span><br></pre></td></tr></table></figure>

<h3 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h3><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tries &gt; <span class="number">5</span></span><br><span class="line">  ifTrue: [^ <span class="string">'Too many tries'</span>]</span><br><span class="line">  ifFalse: [^ <span class="string">'Trying again'</span>].</span><br><span class="line">  </span><br><span class="line">x &gt; <span class="number">10</span></span><br><span class="line">  ifTrue: [x &gt; <span class="number">5</span></span><br><span class="line">    ifTrue: [<span class="string">'A'</span>]</span><br><span class="line">  	ifFalse: [<span class="string">'B'</span>]]</span><br><span class="line">  ifFalse: [<span class="string">'C'</span>].</span><br></pre></td></tr></table></figure>

<h3 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h3><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">| x y |</span><br><span class="line">x := <span class="number">4.</span> y := <span class="number">1.</span></span><br><span class="line">[x &gt; <span class="number">0</span>] whileTrue: [x := x - <span class="number">1.</span> y := y * <span class="number">2</span>].     <span class="comment">"while true loop"</span></span><br><span class="line">[x &gt;= <span class="number">4</span>] whileFalse: [x := x + <span class="number">1.</span> y := y * <span class="number">2</span>].   <span class="comment">"while false loop"</span></span><br><span class="line">x timesRepeat: [y := y * <span class="number">2</span>].                     <span class="comment">"times repeat loop (i := 1 to x)"</span></span><br><span class="line"><span class="number">1</span> to: x do: [:a | y := y * <span class="number">2</span>].                   <span class="comment">"for loop"</span></span><br><span class="line"><span class="number">1</span> to: x by: <span class="number">2</span> do: [:a | y := y / <span class="number">2</span>].             <span class="comment">"for loop with specified increment"</span></span><br><span class="line">#(<span class="number">5</span> <span class="number">4</span> <span class="number">3</span>) do: [:a | x := x + a].                  <span class="comment">"iterate over array elements"</span></span><br></pre></td></tr></table></figure>



<h1 id="类"><a href="#类" class="headerlink" title="类"></a>类</h1><p>类是定义某种对象特性的对象。</p>
<h2 id="创建实例"><a href="#创建实例" class="headerlink" title="创建实例"></a>创建实例</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AClass</span> new   <span class="comment">"相当于Java：new AClass()"</span></span><br></pre></td></tr></table></figure>



<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>任何方法都会至少有一个返回值，如果有显式返回，默认将会返回<code>^self</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/07/03/Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/03/Kubernetes/" class="post-title-link" itemprop="url">Kubernetes</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-07-03 08:21:46" itemprop="dateCreated datePublished" datetime="2018-07-03T08:21:46+08:00">2018-07-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Kubernetes是一个容器编排引擎，它是Google Omega（之前叫Borg）的开源版本。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/07/03/Kubernetes/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/06/26/C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/26/C/" class="post-title-link" itemprop="url">C</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-06-26 10:22:06" itemprop="dateCreated datePublished" datetime="2018-06-26T10:22:06+08:00">2018-06-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>C语言是一门很接近底层的过程性高级编程语言，是高性能计算的主要选择，例如：系统编程。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/06/26/C/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.supercalifragilisticexpialidociouser.com/2018/06/09/Flex-Bison/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="周千涵">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人见人爱，花见花开，车见爆胎">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/09/Flex-Bison/" class="post-title-link" itemprop="url">Flex-Bison</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-06-09 16:26:12" itemprop="dateCreated datePublished" datetime="2018-06-09T16:26:12+08:00">2018-06-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Flex"><a href="#Flex" class="headerlink" title="Flex"></a>Flex</h1><p>Flex是一个词法分析生成器，用于生成词法分析器。</p>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><h3 id="编写Flex程序"><a href="#编写Flex程序" class="headerlink" title="编写Flex程序"></a>编写Flex程序</h3><p>Flex程序的扩展名通常为<code>.l</code>或<code>.lex</code>。</p>
<p>wc.l：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* 定义部分 *&#x2F;</span><br><span class="line">%&#123;</span><br><span class="line">int chars &#x3D; 0;</span><br><span class="line">int words &#x3D; 0;</span><br><span class="line">int lines &#x3D; 0;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">&#x2F;* 规则部分 *&#x2F;</span><br><span class="line">[a-zA-Z]+	&#123; words++; chars +&#x3D; strlen(yytext); &#125;</span><br><span class="line">\n		&#123; chars++; lines++; &#125;</span><br><span class="line">.		&#123; chars++; &#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">&#x2F;* 用户子例程 *&#x2F;</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">  yylex();</span><br><span class="line">  printf(&quot;%8d%8d%8d\n&quot;, lines, words, chars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>yylex()</code>，会开始读取输入，直到动作代码识别出一个记号（token），并返回这个记号（通常是返回记号编号，本次记号值保存在自定义的全局变量中，本次匹配的输入文本保存在全局变量<code>yytext</code>中）。每次<code>ylex</code> 返回时，它会记住当前处理的位置。当程序再次调用<code>yylex()</code>时，词法分析器会从这个位置开始继续分析输入。如果动作代码没有返回，则词法分析将会立即继续分析输入。例如，匹配空白字符的模式并不返回，所以词法分析器会继续分析接下来的输入。</p>
<h3 id="生成词法分析器"><a href="#生成词法分析器" class="headerlink" title="生成词法分析器"></a>生成词法分析器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ flex wc.l</span><br></pre></td></tr></table></figure>

<p>这将生成<code>lex.yy.c</code>。</p>
<h3 id="构建程序"><a href="#构建程序" class="headerlink" title="构建程序"></a>构建程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cc -o wc -lfl lex.yy.c</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>-lfl</code>表示链接一个叫<code>fl</code>的Flex库，该库提供了一些辅助例程，例如自带的<code>main</code> 程序可以帮助快速编程和调试。如果不需要这些工具，则该库是可选的。</p>
</blockquote>
<p>这将生成<code>wc</code>可执行程序。</p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wc</span><br><span class="line">The boy stood on the burning deck</span><br><span class="line">shelling peanuts by the peck</span><br><span class="line">^D</span><br><span class="line"></span><br><span class="line">2 12 63</span><br></pre></td></tr></table></figure>

<blockquote>
<p>wc从控制台读取输入。</p>
</blockquote>
<h2 id="Flex程序结构"><a href="#Flex程序结构" class="headerlink" title="Flex程序结构"></a>Flex程序结构</h2><p>Flex程序由三个部分构成：定义部分、规则部分和用户子例程（subroutine）。三个部分通过<code>%%</code>行分隔。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...定义部分...</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">...规则部分...</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">...用户子例程...</span><br></pre></td></tr></table></figure>

<p>“定义部分”和“规则部分”是必需部分，而“用户子例程”和它前面的<code>%%</code>是可选的。</p>
<h3 id="定义部分"><a href="#定义部分" class="headerlink" title="定义部分"></a>定义部分</h3><p>定义部分包括选项、文字块、定义、开始条件和转换。</p>
<p>以空白字符开始的行将被原样复制到C文件中。</p>
<h3 id="规则部分"><a href="#规则部分" class="headerlink" title="规则部分"></a>规则部分</h3><p>规则部分包括模式行和C代码。</p>
<p>规则部分包含的C代码是指以空白字符开始的行，或者是处于<code>%{</code> 和 <code>%}</code>之间的内容，它们会被原封不动地复制到<code>yylex</code> 函数中。</p>
<p>模式行包含一个模式和动作（模式匹配输入时所执行的C代码），两者之间使用若干空白字符分隔。如果C代码超过一条语句或跨越多行，则必须用<code>{</code> 和 <code>}</code> （或者<code>%{</code> 和 <code>%}</code>）括起来。</p>
<p>当Flex词法分析器运行时，它将输入依次与模式行的模式进行匹配。每当它发现一个匹配，它就执行与这个模式关联的C代码。</p>
<p>如果模式后面紧跟一个竖线（<code>|</code>）而不是C代码，则表示该模式与下一模式共用相同的C代码。</p>
<p>当输入无法匹配任何模式时，则执行<code>ECHO</code>宏（将所有没有被匹配的输入，原样输出到<code>yyout</code>。它等价于<code>fprintf(yyout, &quot;%s&quot;, yytext);</code>）。也可以通过<code>%option nodefault</code> 、命令行参数<code>-s</code>或者命令行参数<code>--nodefault</code>来禁用这个默认行为。</p>
<h3 id="用户子例程"><a href="#用户子例程" class="headerlink" title="用户子例程"></a>用户子例程</h3><p>用户子例程中的内容将被Flex原样复制到C文件。</p>
<p>这个部分通常包括规则中需要调用的例程，在大型程序里，这些支撑代码通常会放在另外一个单独的源文件中。</p>
<h2 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h2><h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><ul>
<li><code>.</code>：匹配除换行符（<code>\n</code>）以外的任意单一字符。</li>
<li><code>[]</code>：字符类，可以匹配方括号中的任意一个字符。<br>字符类中第一个字符是<code>^</code>时，表示匹配除了方括号内字符以外的任意一个字符。<br>字符类中的<code>-</code>表示字符范围，例如：<code>[a-z]</code> 表示任意小写字母。<br>字符类中可以识别转义序列。<br>字符<code>-</code>和<code>]</code>如果是方括号内第一个字符，则表示普通字符。</li>
<li><code>{-}</code>：匹配左侧字符类减去右侧字符类的结果中的任一字符。</li>
<li><code>{+}</code>：匹配左侧字符类加上右侧字符类的结果中的任一字符。</li>
<li><code>*</code>：匹配零个或多个紧接在前面的模式。</li>
<li><code>+</code>：匹配一个或多个紧接在前面的模式。</li>
<li><code>?</code>：匹配零个或一个紧接在前面的模式。</li>
<li><code>{N}</code>：匹配N个紧接在前面的模式。</li>
<li><code>{N, M}</code>：匹配N至M个（包含N和M个）紧接在前面的模式。<code>M</code>可以省略，即<code>{N,}</code>表示匹配至少N个紧接在前面的模式。<code>{1,}</code>与<code>+</code>意义相同，<code>{0,}</code>与<code>*</code>意义相同。</li>
<li><code>{模式名}</code>：引用这个名字的模式。</li>
<li><code>\</code>：表示元字符自身或C语言转义序列。</li>
<li><code>()</code>：把一系列的正则表达式组合在一起。</li>
<li><code>|</code>：匹配左侧模式或右侧模式。</li>
<li><code>“…”</code>：所有引号中的字符将基于字面意义被解释。</li>
<li><code>/</code>：尾部上下文（trailing context），匹配斜线前的模式，但是要求其后紧跟着斜线后的模式。斜线后匹配的内容不会被“消耗掉”，它们会返还给输入，以便于后续匹配。每个模式行只允许一个尾部上下文操作符，而且一个模式行不能既有斜线又有尾部<code>$</code>。</li>
<li><code>^</code>：当它是模式的第一个字符时，匹配一行的开始。它出现在方括号中第一个字符表示补集。其他情况下，它没有特殊含义。</li>
<li><code>$</code>：当它是模式的最后一个字符时，匹配一行的结束（相当于<code>/\n</code>），否则没有特殊含义。</li>
<li><code>&lt;起始状态名或起始状态名列表&gt;</code>：只出现在模式的开头，表示该模式仅在给定的起始状态下被应用。</li>
<li><code>&lt;&lt;EOF&gt;&gt;</code>：匹配文件末尾。这个伪模式通常用来进行清理工作、切换到其他文件等等。</li>
</ul>
<h3 id="处理二义性模式"><a href="#处理二义性模式" class="headerlink" title="处理二义性模式"></a>处理二义性模式</h3><p>Flex通过两个简单规则来解决模式的二义性：</p>
<ul>
<li>匹配输入时匹配尽可能多的字符串；</li>
<li>如果两个模式都可以匹配的话，匹配在程序中更早出现的模式。</li>
</ul>
<h2 id="上下文相关性"><a href="#上下文相关性" class="headerlink" title="上下文相关性"></a>上下文相关性</h2><p>Flex提供了多种方式来做到模式的左上下文相关和右上下文相关，也就是与记号的上文和下文相关。</p>
<h3 id="左上下文相关"><a href="#左上下文相关" class="headerlink" title="左上下文相关"></a>左上下文相关</h3><p>有三种方法可以做到左上下文相关：</p>
<ul>
<li>特殊的行首模式字符（模式开关的<code>^</code>）；</li>
<li>起始状态；</li>
<li>显式代码。</li>
</ul>
<p>显式代码例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">int flag &#x3D; 0;</span><br><span class="line">%&#125;</span><br><span class="line">%%</span><br><span class="line">a &#123;flag &#x3D; 1;&#125;</span><br><span class="line">b &#123;flag &#x3D; 2;&#125;</span><br><span class="line">zzz &#123;</span><br><span class="line">  switch(flag) &#123;</span><br><span class="line">    case 1: a_zzz_token(); break;</span><br><span class="line">    case 2: b_zzz_token(); break;</span><br><span class="line">    default: plain_zzz_token(); break;</span><br><span class="line">  &#125;</span><br><span class="line">  flag &#x3D; 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="右上下文相关"><a href="#右上下文相关" class="headerlink" title="右上下文相关"></a>右上下文相关</h3><p>也有三种方法可以做到右上下文相关：</p>
<ul>
<li>特殊的行尾模式字符（模式结尾的<code>$</code>，等价于<code>/\n</code>）；</li>
<li>斜线操作符<code>/</code>；</li>
<li><code>yyless()</code>。</li>
</ul>
<p><code>yyless()</code>让词法分析器推回刚刚读取到的字符，它的参数表明需要保留的字符个数。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abcde &#123;yyless(3);&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子与<code>abc/de</code>模式的效果基本一致，因为<code>yyless(3)</code>保留三个字符<code>abc</code>，并推回剩下的二个字符<code>de</code>。唯一的差别是在这个例子里，<code>yytext</code>包含所有5个字符，而且<code>yyleng</code>的值是5而不是3。</p>
<h2 id="定义（替换）"><a href="#定义（替换）" class="headerlink" title="定义（替换）"></a>定义（替换）</h2><p>定义（或替换）用于为正则表达式命名，然后在规则部分通过<code>{名字}</code>来引用它们。这个名字所代表的正则表达式将被代入到模式中，并且该正则表达式会被认为已经用圆括号括起。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DIG [0-9]</span><br><span class="line">%%</span><br><span class="line">&#123;DIG&#125;+  process_integer();</span><br><span class="line">&#123;DIG&#125;+\.&#123;DIG&#125;*  |</span><br><span class="line">\.&#123;DIG&#125;+  process_real();</span><br></pre></td></tr></table></figure>



<h2 id="输入管理"><a href="#输入管理" class="headerlink" title="输入管理"></a>输入管理</h2><p>除非你另做安排，否则词法分析器总是通过名为<code>yyin</code>读取输入。<code>yyin</code>默认是标准输入<code>stdin</code>。</p>
<h3 id="从文件读取输入"><a href="#从文件读取输入" class="headerlink" title="从文件读取输入"></a>从文件读取输入</h3><p>为让它从文件中读取输入，只需在第一次调用<code>yylex</code>之前，把任何打开的文件赋予<code>yyin</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="keyword">int</span> chars = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> words = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> lines = <span class="number">0</span>;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">[a-zA-Z]+	&#123; words++; chars += <span class="built_in">strlen</span>(yytext); &#125;</span><br><span class="line">\n		&#123; chars++; lines++; &#125;</span><br><span class="line">.		&#123; chars++; &#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">main(argc, argv)</span><br><span class="line"><span class="keyword">int</span> argc;</span><br><span class="line"><span class="keyword">char</span> **argv;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!(yyin = fopen(argv[<span class="number">1</span>], <span class="string">"r"</span>))) &#123;</span><br><span class="line">      perror(argv[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">return</span> (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  yylex();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%8d%8d%8d\n"</span>, lines, words, chars);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">yywrap() &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>词法分析器到达<code>yyin</code>（是<code>FILE *</code>类型）的结束位置时，它将调用<code>yywrap()</code>。这样做的目的是，当有另一个输入文件时，<code>yywrap</code> 可以调整<code>yyin</code> 的值并且通过返回0来重新开始词法分析。如果要结束词法分析，则返回1，同时词法分析器会返回一个零记号来表明文件结束。</p>
<p><code>fl</code>库中包含一个默认的<code>yywrap()</code>，它总是返回1。如果你的词法分析器不使用<code>yywrap()</code> 来切换文件，可以使用选项<code>%option noyywrap</code>来移除对<code>yywrap()</code>的调用。特殊记号<code>&lt;&lt;EOF&gt;&gt;</code>通常是更好的处理文件结束情况的方式。</p>
<h3 id="读取多个文件"><a href="#读取多个文件" class="headerlink" title="读取多个文件"></a>读取多个文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">%option noyywrap</span><br><span class="line"></span><br><span class="line">%&#123;</span><br><span class="line">int chars &#x3D; 0;</span><br><span class="line">int words &#x3D; 0;</span><br><span class="line">int lines &#x3D; 0;</span><br><span class="line"></span><br><span class="line">int totchars &#x3D; 0;</span><br><span class="line">int totwords &#x3D; 0;</span><br><span class="line">int totlines &#x3D; 0;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">[a-zA-Z]+	&#123; words++; chars +&#x3D; strlen(yytext); &#125;</span><br><span class="line">\n		&#123; chars++; lines++; &#125;</span><br><span class="line">.		&#123; chars++; &#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">  int i;</span><br><span class="line"></span><br><span class="line">  if(argc &lt; 2) &#123; &#x2F;* just read stdin *&#x2F;</span><br><span class="line">    yylex();</span><br><span class="line">    printf(&quot;%8d%8d%8d\n&quot;, lines, words, chars);</span><br><span class="line">    return 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  for(i &#x3D; 1; i &lt; argc; i++) &#123;</span><br><span class="line">    FILE *f &#x3D; fopen(argv[i], &quot;r&quot;);</span><br><span class="line">  </span><br><span class="line">    if(!f) &#123;</span><br><span class="line">      perror(argv[1]);</span><br><span class="line">      return (1);</span><br><span class="line">    &#125;</span><br><span class="line">    yyrestart(f);</span><br><span class="line">    yylex();</span><br><span class="line">    fclose(f);</span><br><span class="line">    printf(&quot;%8d%8d%8d %s\n&quot;, lines, words, chars, argv[i]);</span><br><span class="line">    totchars +&#x3D; chars; chars &#x3D; 0;</span><br><span class="line">    totwords +&#x3D; words; words &#x3D; 0;</span><br><span class="line">    totlines +&#x3D; lines; lines &#x3D; 0;</span><br><span class="line">  &#125;</span><br><span class="line">  if(argc &gt; 1)</span><br><span class="line">    printf(&quot;%8d%8d%8d total\n&quot;, totlines, totwords, totchars);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当需要顺序读取多个文件时，我们每打开一个文件就调用一次<code>yyrestart(fp)</code>，把词法分析器的输入切换到新的标准输入输出文件<code>fp</code>。宏<code>YY_NEW_FILE</code> 等同于<code>yyrestart(yyin)</code>。</p>
<h3 id="输入缓冲区"><a href="#输入缓冲区" class="headerlink" title="输入缓冲区"></a>输入缓冲区</h3><p>词法分析器实际上并不是直接读取输入来分析，而是先将输入读取到缓冲区，再从缓冲区中读取字符进行分析。</p>
<p>Flex使用宏<code>YY_BUFFER_STATE</code> 来表示输入缓冲区。</p>
<p>我们可以使用<code>yy_create_buffer</code>来为标准输入输出文件中创建缓冲区，使用<code>yy_scan_string</code> 为字符串（以空字符结尾）创建缓冲区，使用<code>yy_scan_buffer</code>为长度确定的数据流创建缓冲区。</p>
<p>使用<code>yy_switch_to_buffer</code>切换到新的缓冲区。</p>
<h3 id="读取输入"><a href="#读取输入" class="headerlink" title="读取输入"></a>读取输入</h3><p>每当输入缓冲区为空时，词法分析器就会调用宏<code>YY_INPUT</code>来读取输入到当前缓冲区。</p>
<p>出于最大的灵活性的考虑，你可以重新定义宏<code>YY_INPUT</code>。</p>
<p>另外，Flex还提供了两个在动作代码中比较有用的宏：<code>input()</code>和<code>unput()</code>。每次调用<code>input()</code> 将返回输入流的下一个字符，它可以帮助我们读取一小段输入而不用定义相应的模式。每次对<code>unput(c)</code> 的调用将把字符<code>c</code>推回到输入流。</p>
<h2 id="记号"><a href="#记号" class="headerlink" title="记号"></a>记号</h2><p>记号实际上有两个组成部分：记号编号和记号值。</p>
<p>记号编号是一个整数，通常从258开始（这样可以避免与文字字符记号产生冲突，bison就是自动从258开始指派每个记号的编号）。</p>
<p>记号值用于区分一组相似的记号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">   enum yytokentype &#123;</span><br><span class="line">     NUMBER &#x3D; 258,</span><br><span class="line">     ADD &#x3D; 259,</span><br><span class="line">     SUB &#x3D; 260,</span><br><span class="line">     MUL &#x3D; 261,</span><br><span class="line">     DIV &#x3D; 262,</span><br><span class="line">     ABS &#x3D; 263,</span><br><span class="line">     EOL &#x3D; 264 &#x2F;* end of line *&#x2F;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   int yylval;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line">&quot;+&quot;	&#123; return ADD; &#125;</span><br><span class="line">&quot;-&quot;	&#123; return SUB; &#125;</span><br><span class="line">&quot;*&quot;	&#123; return MUL; &#125;</span><br><span class="line">&quot;&#x2F;&quot;	&#123; return DIV; &#125;</span><br><span class="line">&quot;|&quot;     &#123; return ABS; &#125;</span><br><span class="line">[0-9]+	&#123; yylval &#x3D; atoi(yytext); return NUMBER; &#125;</span><br><span class="line">\n      &#123; return EOL; &#125;</span><br><span class="line">[ \t]   &#123; &#x2F;* ignore white space *&#x2F; &#125;</span><br><span class="line">.	&#123; printf(&quot;Mystery character %c\n&quot;, *yytext); &#125;</span><br><span class="line">%%</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">  int tok;</span><br><span class="line"></span><br><span class="line">  while(tok &#x3D; yylex()) &#123;</span><br><span class="line">    printf(&quot;%d&quot;, tok);</span><br><span class="line">    if(tok &#x3D;&#x3D; NUMBER) printf(&quot; &#x3D; %d\n&quot;, yylval);</span><br><span class="line">    else printf(&quot;\n&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h2><h2 id="文字块"><a href="#文字块" class="headerlink" title="文字块"></a>文字块</h2><h2 id="起始状态"><a href="#起始状态" class="headerlink" title="起始状态"></a>起始状态</h2><p>Flex有一个强大的特性——起始状态（start state，也称为起始条件、起始规则），它允许我们指定在特定时刻哪些模式可以被用来匹配。</p>
<p>词法分析器从状态0（也可用<code>INITIAL</code>）开始，它是默认的起始状态。其他所有状态必须在定义部分通过<code>%s</code>或<code>%x</code>来声明。</p>
<p>要从一个起始状态切换到另一个起始状态，要使用宏<code>BEGIN</code>，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%x MYSTATE</span><br><span class="line">%%</span><br><span class="line">… &#123;BEGIN MYSTATE;&#125;</span><br><span class="line">…</span><br><span class="line">&lt;MYSTATE&gt;…  &#123;BEGIN INITIAL;&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Bison"><a href="#Bison" class="headerlink" title="Bison"></a>Bison</h1><p>Bison是一个语法分析生成器，用于生成语法分析器。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">周千涵</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:supremeadministrator@supercalifragilisticexpialidociouser.com" title="E-Mail → mailto:supremeadministrator@supercalifragilisticexpialidociouser.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周千涵</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
